# Инструкции по развертыванию на удаленном сервере

## Проблема: Ошибка 500 на странице каталога товаров

После исправления кнопки "Создать товар" каталог товаров перестал работать из-за отсутствия миграций для категорий товаров.

## Решение

### Вариант 1: Применить миграции (рекомендуется)

Если вы хотите использовать категории товаров:

```bash
# Подключитесь к серверу
ssh user@klonmone.ru

# Перейдите в директорию проекта
cd /path/to/imperia_klon/imperia

# Примените миграции
python manage.py migrate

# Перезапустите сервер (если используется systemd)
sudo systemctl restart gunicorn
# или
sudo systemctl restart uwsgi
# или перезапустите через supervisor
```

### Вариант 2: Код уже исправлен (работает без категорий)

Код был исправлен и теперь работает **даже без применения миграций**. Страница товаров будет работать, но категории будут отключены.

Просто обновите код на сервере:

```bash
# Подключитесь к серверу
ssh user@klonmone.ru

# Перейдите в директорию проекта
cd /path/to/imperia_klon

# Обновите код из репозитория
git pull origin main

# Перезапустите сервер
sudo systemctl restart gunicorn
# или другой способ перезапуска вашего сервера
```

## Проверка

После обновления кода или применения миграций проверьте:

1. Откройте https://klonmone.ru/products/
2. Страница должна загружаться без ошибок
3. Если миграции применены - категории будут отображаться в левой колонке
4. Если миграции не применены - категории не будут отображаться, но страница будет работать

## Решение проблемы с collectstatic

Если при деплое возникает ошибка `ImproperlyConfigured: You're using the staticfiles app without having set the STATIC_ROOT setting`, это уже исправлено в коде. Просто обновите код на сервере:

```bash
git pull origin main
```

После этого `collectstatic` будет работать корректно, так как `STATIC_ROOT` теперь установлен в `BASE_DIR / "staticfiles"`.

## Что было исправлено

1. **Проверка существования таблицы категорий** - код проверяет наличие таблицы `core_productcategory` в базе данных перед использованием
2. **Безопасный select_related** - не используется `select_related("category")`, если таблица не существует
3. **Безопасная загрузка категорий** - категории загружаются только если таблица существует
4. **Обработка ошибок** - все операции с категориями обернуты в try-except
5. **Исправлена ошибка шаблона** - добавлен закрывающий тег `{% endblock %}` для блока `content`
6. **Добавлен STATIC_ROOT** - исправлена ошибка `collectstatic` при деплое

## Логи для диагностики

Если проблема сохраняется, проверьте логи:

```bash
# Логи Django
tail -f /path/to/logs/django.log

# Логи сервера (nginx/apache)
tail -f /var/log/nginx/error.log
# или
tail -f /var/log/apache2/error.log

# Логи Gunicorn
journalctl -u gunicorn -f
```

