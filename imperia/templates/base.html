{% load access %}
{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Imperia{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">


<style>

  html, body{height:100%}
body{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  background:#F2F2F7;
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif;
  font-size:16px;
}

/* –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º */
.wrap{flex:1 0 auto}

/* —Ñ—É—Ç–µ—Ä –ø—Ä–∏–∂–∏–º–∞–µ—Ç—Å—è –≤–Ω–∏–∑ */
.footer{
  margin-top:auto;                /* –≤–∞–∂–Ω–æ */
  background:#fff;
  border-top:1px solid var(--border);
}
.footer-inner{
  max-width:1100px;margin:0 auto;padding:14px 16px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  color:var(--muted);font-size:14px;
}
.footer a{color:var(--primary);font-weight:600}
.footer a:hover{text-decoration:underline}
@media (max-width:940px){
  .footer-inner{flex-direction:column;align-items:flex-start;gap:6px}
}


/* —Ç–µ–º–∞ */
  :root{
    color-scheme: light;
    --bg:#F2F2F7;
    --card:#FFFFFF;
    --text:#1C1C1E;
    --muted:#6E6E73;
    --border:rgba(60,60,67,.12);
    --primary:#0A84FF; --primary-600:#0077ED;
    --ring:rgba(10,132,255,.22);
    --shadow:0 8px 18px rgba(0,0,0,.06);
    --r-md:14px; --r-lg:18px; --pad:20px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:ui-sans-serif,-apple-system,"SF Pro Text","Segoe UI",Roboto,Arial}
  a{color:inherit;text-decoration:none}

  /* topbar */
  .topbar{
    position:sticky; top:0; z-index:40;
    background:rgba(255,255,255,.86);
    backdrop-filter:saturate(180%) blur(18px);
    -webkit-backdrop-filter:saturate(180%) blur(18px);
    border-bottom:1px solid var(--border);
  }
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;
                max-width:1100px;margin:0 auto;padding:12px 16px;gap:12px}
  .brand{font-weight:800}
  .brand a{color:var(--primary)}

/* NAV */
.nav{display:flex;align-items:center;gap:6px;margin-left:10px}
.nav a{
  padding:8px 12px;border-radius:10px;font-weight:600;font-size:14px;
}
.nav a:hover{background:#222; color:#fff}      /* –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî —Ç—ë–º–Ω—ã–π */
.nav a.active{
  background:#000;                              /* –∞–∫—Ç–∏–≤–Ω–∞—è ‚Äî —á—ë—Ä–Ω—ã–π —Ñ–æ–Ω */
  color:#fff;                                   /* –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
}
.nav a.active:hover{
  background:#000;                              /* –Ω–µ –º–µ–Ω—è–µ–º –ø—Ä–∏ hover */
  color:#fff;
}

  /* user box */
  .avatar-sm{width:36px;height:36px;border-radius:50%;object-fit:cover;
             background:#E9E9EB;display:grid;place-items:center;font-weight:700;
             color:#374151;pointer-events:none;box-shadow:inset 0 0 0 1px var(--border)}
  .userbox{position:relative;display:flex;align-items:center;gap:10px}
  .hello{font-size:13px;color:var(--muted)} .name{font-weight:700}
  .userbtn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
           background:#fff;border:1px solid var(--border);cursor:pointer;
           transition:box-shadow .15s,border-color .15s,transform .05s}
  .userbtn:hover{border-color:rgba(60,60,67,.18)}
  .userbtn:active{transform:translateY(1px)}
  .userbtn:focus{outline:none;box-shadow:0 0 0 6px var(--ring)}
  .caret{font-size:12px;opacity:.6}

  .menu{
    position:absolute;right:0;top:calc(100% + 8px);
    background:#fff;border:1px solid var(--border);border-radius:18px;
    box-shadow:var(--shadow);min-width:220px;display:none;overflow:hidden;
  }
  .menu.open{display:block}
  .menu a,.menu button{
    display:flex;align-items:center;gap:10px;width:100%;
    padding:12px 14px;background:transparent;border:0;cursor:pointer;font-size:14px;
    color:var(--text);
  }
  .menu a:hover,.menu button:hover{background:#EAF2FF;color:#0A84FF}
  .menu a:active,.menu button:active{background:#DDEBFF}

  /* content */
  .wrap{max-width:1100px;margin:0 auto;padding:var(--pad)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);
        box-shadow:var(--shadow);padding:var(--pad)}
  .card h1,.card h2{margin:0 0 14px}
  .muted{color:var(--muted)}

  /* forms */
  .field{margin:12px 0}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="email"],input[type="url"],input[type="tel"],
  input[type="date"],input[type="number"],input[type="password"],textarea,select{
    width:100%;padding:12px 14px;background:#fff;border:1px solid var(--border);
    border-radius:12px;font-size:15px;line-height:1.35;
    transition:border-color .15s,box-shadow .15s,background .15s;
  }
  textarea{min-height:120px;resize:vertical}
  input:focus,textarea:focus,select:focus{
    outline:none;border-color:rgba(10,132,255,.45);box-shadow:0 0 0 6px var(--ring);
  }

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;
       padding:0 16px;border-radius:12px;border:1px solid transparent;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn-primary:hover{background:var(--primary-600)}
  .btn-secondary{background:#F2F3F5;color:#1C1C1E;border:1px solid var(--border)}
  .btn-link{background:transparent;border:0;color:var(--primary);height:auto;padding:0}

  .grid{display:grid;gap:16px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media (max-width:940px){.grid-2{grid-template-columns:1fr}.wrap{padding:16px}.topbar-inner{padding:10px 12px}}
  /* --- Profile helpers --- */
.profile-header{display:flex;align-items:center;gap:16px;margin:12px 0 20px}
.avatar{width:88px;height:88px;border-radius:50%;object-fit:cover;background:#E9E9EB;
        box-shadow:inset 0 0 0 1px var(--border);flex:0 0 88px}
.avatar--placeholder{display:grid;place-items:center;color:var(--muted);font-weight:700}

/* –ø—Ä–µ–≤—å—é –±–æ–ª—å—à–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π "–ò–∑–º–µ–Ω–∏—Ç—å" */
.avatar-lg{width:120px;height:120px;border-radius:50%;object-fit:cover;background:#E9E9EB;
           box-shadow:inset 0 0 0 1px var(--border);flex:0 0 120px}

/* —á–∏–ø—ã —Ä–æ–ª–µ–π */
.badges span{display:inline-block;background:#EAF2FF;color:#0A84FF;border-radius:999px;
             padding:4px 10px;margin-right:6px;font-weight:600}

/* —Å–µ—Ç–∫–∞ —Ñ–æ—Ä–º—ã 2 –∫–æ–ª–æ–Ω–∫–∏ (—É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å .grid-2, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media (max-width:940px){.grid-2{grid-template-columns:1fr}}

/* –º–µ–ª–∫–∏–µ –ø–æ–¥–ø–∏—Å–∏ */
.note{color:var(--muted)}

/* —Å–ø—Ä—è—Ç–∞—Ç—å "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç / –û—á–∏—Å—Ç–∏—Ç—å" —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ ClearableFileInput */
.clearable-file-input a,
.clearable-file-input label[for$="-clear_id"],
.clearable-file-input input[type="checkbox"]{display:none !important}

/* —Å–ø—Ä—è—Ç–∞—Ç—å —Å–∞–º <input type="file">, –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ pickAvatar */
#id_avatar{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;
}

</style>
  <script>
  // –æ—Ç–∫–ª—é—á–∞–µ–º reset –æ—Ç Tailwind, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏
  tailwind = { config: { corePlugins: { preflight: false } } };
</script>
<script src="https://cdn.tailwindcss.com"></script>

  {% block extra_head %}{% endblock %}
</head>
<body>
  <header class="topbar">
     <div class="topbar-inner">
      <div style="display:flex;align-items:center;gap:8px">
        <a href="{% url 'post_login_router' %}" class="brand" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">
         <img src="{% static 'img/log.png' %}" alt="IndigoFlow ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–æ–º" width="50" height="50">
        </a>

        <!-- NAV: –ì–ª–∞–≤–Ω–∞—è / –¢–æ–≤–∞—Ä—ã -->
         {% with current=request.resolver_match.url_name %}
          <nav class="nav">
  {# –û–ø–µ—Ä–∞—Ç–æ—Ä #}
  {% if request.user|in_groups:"operator" %}
    <a href="{% url 'core:operator_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'operator_dashboard' %}active{% endif %}">
      –û–ø–µ—Ä–∞—Ç–æ—Ä
    </a>
  {% endif %}

  {# –£–ø—Ä–∞–≤–ª—è—é—â–∏–π #}
  {% if request.user|in_groups:"director" %}
    <a href="{% url 'core:director_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'director_dashboard' %}active{% endif %}">
      –£–ø—Ä–∞–≤–ª—è—é—â–∏–π
    </a>
  {% endif %}

  {# –¢–æ–≤–∞—Ä—ã #}
  <a href="{% url 'product-list' %}"
     class="{% if request.resolver_match.url_name == 'product-list' %}active{% endif %}">
    –¢–æ–≤–∞—Ä—ã
  </a>

  {# –°–∫–ª–∞–¥ ‚Äî –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö #}
  {% if request.user|in_groups:"warehouse,director" %}
              <a href="{% url 'warehouse_new_dashboard' %}"
              class="{% if request.resolver_match.url_name == 'warehouse_new_dashboard' or request.resolver_match.url_name == 'warehouse_dashboard' or request.resolver_match.url_name == 'warehouse_detail' or request.resolver_match.url_name == 'put_away' or request.resolver_match.url_name == 'move_between_bins' %}active{% endif %}">
              –°–∫–ª–∞–¥
              </a>
              {% endif %}

  {# –ö–ª–∏–µ–Ω—Ç—ã #}
  {% if show_clients_link %}
    <a href="{% url 'core:counterparty_list' %}"
       class="{% if request.resolver_match.url_name == 'counterparty_list' %}active{% endif %}">
      –ö–ª–∏–µ–Ω—Ç—ã
    </a>
  {% endif %}
</nav>
        {% endwith %}
      </div>

      <div class="userbox">
        {% if request.user.is_authenticated %}
          {% if profile and profile.avatar %}
            <img src="{{ profile.avatar.url }}" class="avatar-sm" alt="avatar">
          {% else %}
            <div class="avatar-sm">
              {% firstof request.user.first_name|slice:":1"|upper request.user.username|slice:":1"|upper %}
            </div>
          {% endif %}

          <button class="userbtn" id="userMenuBtn" type="button" aria-haspopup="true" aria-expanded="false">
            <span class="hello">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,</span>
            <span class="name">{% firstof request.user.first_name request.user.username %}</span>
            <span class="caret">‚ñæ</span>
          </button>

          <div class="menu" id="userMenu">
            <a href="{% url 'profile' %}">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'password_change' %}">üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
            <a href="{% url 'logout' %}">‚Ü™ –í—ã–π—Ç–∏</a>
          </div>
        {% else %}
          <a href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        {% endif %}
      </div>
    </div>
  </header>

  <main class="wrap">
    {% block content %}{% endblock %}
  </main>

  <script>
    (function(){
      const btn = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if(!btn || !menu) return;
      const toggle = () => { menu.classList.toggle('open'); };
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
      document.addEventListener('click', ()=>{ if(menu.classList.contains('open')) menu.classList.remove('open'); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') menu.classList.remove('open'); });
    })();
  </script>

  {% block extra_js %}{% endblock %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>

{# Flash messages #}
{% if messages %}
  <div id="flash-root" class="fixed top-4 right-4 z-[1000] space-y-2 w-[min(92vw,420px)]">
    {% for message in messages %}
      <div
        class="flash-item rounded-xl px-4 py-3 shadow ring-1 text-sm flex items-start gap-3
               {% if message.tags == 'error' %} bg-red-50 text-red-800 ring-red-200
               {% elif message.tags == 'warning' %} bg-amber-50 text-amber-900 ring-amber-200
               {% elif message.tags == 'success' %} bg-green-50 text-green-800 ring-green-200
               {% elif message.tags == 'info' %} bg-blue-50 text-blue-800 ring-blue-200
               {% else %} bg-gray-50 text-gray-800 ring-gray-200 {% endif %}">
        <div class="min-w-0 break-words">{{ message }}</div>
        <button type="button" class="ml-auto shrink-0 rounded-md px-2 py-1 text-xs opacity-70 hover:opacity-100"
                onclick="this.closest('.flash-item')?.remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  (function () {
    const items = document.querySelectorAll('#flash-root .flash-item');
    items.forEach((el, idx) => {
      // –ª—ë–≥–∫–∞—è —Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å—á–µ–∑–∞–ª–∏ –≤—Å–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      const delay = 5000 + idx * 200;
      setTimeout(() => {
        el.style.transition = 'opacity .25s, transform .25s';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-6px)';
        setTimeout(() => el.remove(), 300);
      }, delay);
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('#flash-root .flash-item').forEach(el => el.remove());
      }
    });
  })();
</script>
<footer class="footer" role="contentinfo" aria-label="–ù–∏–∂–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∞–π—Ç–∞">
  <div class="footer-inner">
    <div>IndigoFlow ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–æ–º ¬© 2025</div>
    <div>
      <a href="https://www.incodingo.pro" target="_blank" rel="noopener noreferrer">
        www.incodingo.pro
      </a>
    </div>
  </div>
</footer>
</body>
</html>
