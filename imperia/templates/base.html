{% load access %}
{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Imperia{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

 <style>

  /* ====== –¢–µ–º–∞ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====== */
  :root{
    color-scheme: light;
    --bg:#F2F2F7;
    --card:#FFFFFF;
    --text:#1C1C1E;
    --muted:#6E6E73;
    --border:rgba(60,60,67,.12);
    --primary:#0A84FF; --primary-600:#0077ED;
    --ring:rgba(10,132,255,.22);
    --shadow:0 8px 18px rgba(0,0,0,.06);
    --r-md:14px; --r-lg:18px; --pad:20px;

    /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    --container:1280px;
    --gutter-x:24px;
  }
  @media (min-width:1600px){
    :root{ --container:1440px; --gutter-x:32px; }
  }
  @media (max-width:940px){
    :root{ --gutter-x:16px; }
  }

  html,body{height:100%}
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; flex-direction:column;
    background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial,sans-serif;
    font-size:16px;
  }
  a{color:inherit; text-decoration:none}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.95);
          backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);
          border-bottom:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,.05)}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;
                max-width:var(--container);margin:0 auto;padding:12px var(--gutter-x);gap:12px;flex-wrap:wrap}

  /* NAV */
  .nav{display:flex;align-items:center;gap:4px;margin-left:12px;flex-wrap:wrap}
  .nav a{padding:8px 14px;border-radius:10px;font-weight:600;font-size:14px;transition:all 0.2s ease;white-space:nowrap}
  .nav a:hover{background:rgba(10,132,255,0.1);color:var(--primary)}
  .nav a.active{background:var(--primary);color:#fff}
  .nav a.active:hover{background:var(--primary-600);color:#fff}

  /* User */
  .avatar-sm{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#E9E9EB;
             display:grid;place-items:center;font-weight:700;color:#374151;pointer-events:none;
             box-shadow:inset 0 0 0 1px var(--border)}
  .userbox{position:relative;display:flex;align-items:center;gap:10px}
  .hello{font-size:13px;color:var(--muted)} .name{font-weight:700}
  .userbtn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;
           border:1px solid var(--border);cursor:pointer;transition:box-shadow .15s,border-color .15s,transform .05s}
  .userbtn:hover{border-color:rgba(60,60,67,.18)} .userbtn:active{transform:translateY(1px)}
  .userbtn:focus{outline:none;box-shadow:0 0 0 6px var(--ring)} .caret{font-size:12px;opacity:.6}
  .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--border);
        border-radius:18px;box-shadow:var(--shadow);min-width:220px;display:none;overflow:hidden}
  .menu.open{display:block}
  .menu a,.menu button{display:flex;align-items:center;gap:10px;width:100%;padding:12px 14px;background:transparent;
                       border:0;cursor:pointer;font-size:14px;color:var(--text)}
  .menu a:hover,.menu button:hover{background:#EAF2FF;color:#0A84FF}
  .menu a:active,.menu button:active{background:#DDEBFF}

  /* Content */
/* –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ */
.wrap{
  flex: 1 0 auto;
  max-width: var(--container);   /* 1280px –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  margin: 0 auto;
  padding: var(--pad) var(--gutter-x);
  width: 100%;
}

/* –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã ‚Äî –∏–¥—É—Ç –ü–û–°–õ–ï –±–∞–∑–æ–≤–æ–≥–æ –∏ –≤—ã–∏–≥—Ä—ã–≤–∞—é—Ç –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç–∏ */
main.wrap.wrap--xl ~ footer .footer-inner     { max-width: 1440px; }
main.wrap.wrap--xxl ~ footer .footer-inner    { max-width: 1600px; }
main.wrap.wrap--fluid ~ footer .footer-inner  { max-width: min(92vw, 1680px); }

  /* Forms */
  .field{margin:12px 0}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="email"],input[type="url"],input[type="tel"],
  input[type="date"],input[type="number"],input[type="password"],textarea,select{
    width:100%;padding:12px 14px;background:#fff;border:1px solid var(--border);border-radius:12px;font-size:15px;line-height:1.35;
    transition:border-color .15s,box-shadow .15s,background .15s}
  textarea{min-height:120px;resize:vertical}
  input:focus,textarea:focus,select:focus{outline:none;border-color:rgba(10,132,255,.45);box-shadow:0 0 0 6px var(--ring)}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:42px;padding:0 16px;border-radius:12px;border:1px solid transparent;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn-primary:hover{background:var(--primary-600)}
  .btn-secondary{background:#F2F3F5;color:#1C1C1E;border:1px solid var(--border)}
  .btn-link{background:transparent;border:0;color:var(--primary);height:auto;padding:0}

  /* Cards */
  .card{background:var(--card);border-radius:var(--r-lg);padding:var(--pad);box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:20px}
  .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
  .card-title{font-size:24px;font-weight:700;margin:0;color:var(--text)}
  .card-subtitle{font-size:14px;color:var(--muted);margin-top:4px}
  .stat-card{background:var(--card);border-radius:var(--r-lg);padding:20px;box-shadow:var(--shadow);border:1px solid var(--border);text-align:center;transition:transform 0.2s,box-shadow 0.2s}
  .stat-card:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(0,0,0,.1)}
  .stat-value{font-size:32px;font-weight:700;color:var(--primary);margin:8px 0}
  .stat-label{font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  
  .grid{display:grid;gap:16px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
  
  @media (max-width:940px){
    .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
    .topbar-inner{padding:10px var(--gutter-x);flex-wrap:wrap}
    .nav{margin-left:0;margin-top:8px;width:100%}
    .userbox .hello{display:none}
    .stat-value{font-size:28px}
    .card-title{font-size:20px}
  }
  @media (max-width:640px){
    .topbar-inner{flex-direction:column;align-items:stretch;gap:8px}
    .nav{overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;padding-bottom:4px}
    .nav::-webkit-scrollbar{display:none}
    .userbox{justify-content:space-between;width:100%}
    .card{padding:16px}
    .card-title{font-size:18px}
    .stat-card{padding:16px}
    .stat-value{font-size:24px}
  }

  /* Footer */
  .footer{margin-top:auto;background:#fff;border-top:1px solid var(--border)}
  .footer-inner{max-width:var(--container);margin:0 auto;padding:14px var(--gutter-x);
                display:flex;align-items:center;justify-content:space-between;gap:12px;color:var(--muted);font-size:14px}
  .footer a{color:var(--primary);font-weight:600}
  .footer a:hover{text-decoration:underline}
  @media (max-width:940px){.footer-inner{flex-direction:column;align-items:flex-start;gap:6px}}

  /* –†–∞–∑–Ω–æ–µ */
  .profile-header{display:flex;align-items:center;gap:16px;margin:12px 0 20px}
  .avatar{width:88px;height:88px;border-radius:50%;object-fit:cover;background:#E9E9EB;box-shadow:inset 0 0 0 1px var(--border);flex:0 0 88px}
  .avatar--placeholder{display:grid;place-items:center;color:var(--muted);font-weight:700}
  .avatar-lg{width:120px;height:120px;border-radius:50%;object-fit:cover;background:#E9E9EB;box-shadow:inset 0 0 0 1px var(--border);flex:0 0 120px}
  .badges span{display:inline-block;background:#EAF2FF;color:#0A84FF;border-radius:999px;padding:4px 10px;margin-right:6px;font-weight:600}
  .note{color:var(--muted)}
  .clearable-file-input a,
  .clearable-file-input label[for$="-clear_id"],
  .clearable-file-input input[type="checkbox"]{display:none!important}
  #id_avatar{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

   /* ===== Requests UI (—á/–± –º–∏–Ω–∏–º–∞–ª–∏–∑–º) ===== */
.rq-container { display: grid; gap: 16px; }
.rq-title { font-size: 22px; font-weight: 700; }
.rq-mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
.rq-meta { display:flex; gap:12px; flex-wrap:wrap; color:#666; margin-top:6px; align-items:center; }

.rq-chip { padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#111; background:#fff; }
.rq-chip--submitted { border-color:#999; }
.rq-chip--approved { border-color:#222; background:#111; color:#fff; }
.rq-chip--to_pick { border-color:#111; }
.rq-chip--in_progress { border-color:#111; }
.rq-chip--ready_to_ship { border-color:#111; }
.rq-chip--done { border-color:#111; background:#111; color:#fff; }
.rq-chip--rejected, .rq-chip--canceled { border-color:#bbb; color:#777; }

.rq-steps { display:flex; gap:8px; padding:0; margin:4px 0 0; list-style:none; flex-wrap:wrap; }
.rq-step { padding:6px 10px; border:1px dashed #ddd; border-radius:10px; font-size:12px; color:#777; }
.rq-step.is-done { border-style:solid; border-color:#111; color:#111; }

.rq-actions { position: sticky; top: 0; background: var(--bg, #f6f6f8); padding: 8px 0; z-index: 5; }
.rq-actions__row { display:flex; gap:8px; flex-wrap:wrap; }

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.rq-card { border:1px solid #e6e6ea; border-radius:12px; background:#fff; }
.rq-card__head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
.rq-card h2 { font-size:16px; font-weight:600; margin:0; }

/* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ */
.rq-additem { display:grid; grid-template-columns: 1.5fr 120px 1fr auto; gap:8px; align-items:end; }
.rq-additem__field select, .rq-additem__qty input, .rq-additem__note input { width:100%; }

/* –¢–∞–±–ª–∏—Ü–∞ */
.rq-table { display:grid; }
.rq-trow { display:grid; grid-template-columns: 1.4fr 120px 1fr; gap:8px; padding:10px 14px; }
.rq-trow--head { background:#fafafa; border-bottom:1px solid #eee; font-weight:600; }
.rq-trow + .rq-trow { border-top:1px solid #f0f0f0; }
.ta-right { text-align:right; }
.muted { color:#777; }
.rq-empty { padding:16px; color:#999; }
</style>

  <script>
  // –æ—Ç–∫–ª—é—á–∞–µ–º reset –æ—Ç Tailwind, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏
  tailwind = { config: { corePlugins: { preflight: false } } };
</script>
<script src="https://cdn.tailwindcss.com"></script>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <header class="topbar">
     <div class="topbar-inner">
      <div style="display:flex;align-items:center;gap:8px">
        <a href="{% url 'post_login_router' %}" class="brand" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é" style="display:flex;align-items:center;gap:10px;text-decoration:none">
          <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg, #0ea5e9, #0369a1);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(14,165,233,0.2)">
            <img src="{% static 'img/log.png' %}" alt="IndigoFlow" width="36" height="36" style="object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1))">
          </div>
          <span style="font-weight:700;font-size:18px;color:var(--text);display:none">IndigoFlow</span>
        </a>

        <!-- NAV: –ì–ª–∞–≤–Ω–∞—è / –¢–æ–≤–∞—Ä—ã -->
         {% with current=request.resolver_match.url_name %}
          <nav class="nav">

  {# –û–ø–µ—Ä–∞—Ç–æ—Ä #}
  {% if request.user|in_groups:"operator" %}
    <a href="{% url 'operator_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'operator_dashboard' %}active{% endif %}">
      –û–ø–µ—Ä–∞—Ç–æ—Ä
    </a>
  {% endif %}



  {# –ú–µ–Ω–µ–¥–∂–µ—Ä #}
  {% if request.user|in_groups:"manager" %}
    <a href="{% url 'manager_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'manager_dashboard' %}active{% endif %}">
      –ú–µ–Ω–µ–¥–∂–µ—Ä
    </a>
  {% endif %}


            {# warehouse #}
  {% if request.user|in_groups:"warehouse" %}
    <a href="{% url 'warehouse_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'warehouse_dashboard' %}active{% endif %}">
      –ö–ª–∞–¥–æ–≤—â–∏–∫
    </a>
  {% endif %}


  {# –£–ø—Ä–∞–≤–ª—è—é—â–∏–π #}
  {% if request.user|in_groups:"director" %}
    <a href="{% url 'director_dashboard' %}"
       class="{% if request.resolver_match.url_name == 'director_dashboard' %}active{% endif %}">
      –£–ø—Ä–∞–≤–ª—è—é—â–∏–π
    </a>
  {% endif %}

  {# –¢–æ–≤–∞—Ä—ã #}
  <a href="{% url 'product-list' %}"
     class="{% if request.resolver_match.url_name == 'product-list' %}active{% endif %}">
    –¢–æ–≤–∞—Ä—ã
  </a>
            {# –ó–∞—è–≤–∫–∏ #}
            {% if request.user.is_authenticated %}
  <a href="{% url 'core:request_list' %}"
     class="{% if 'request' in request.resolver_match.url_name %}active{% endif %}">
    –ó–∞–∫–∞–∑—ã
  </a>
{% endif %}



  {# –°–∫–ª–∞–¥ ‚Äî –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö #}
  {% if request.user|in_groups:"warehouse,director" %}
    <a href="{% url 'warehouse_new_dashboard' %}"
       class="{% if 'warehouse' in request.resolver_match.url_name and request.resolver_match.url_name != 'warehouse_dashboard' %}active{% endif %}">
      –°–∫–ª–∞–¥
    </a>
  {% endif %}





  {# –ö–ª–∏–µ–Ω—Ç—ã #}
  {% if show_clients_link %}
    <a href="{% url 'core:counterparty_list' %}"
       class="{% if request.resolver_match.url_name == 'counterparty_list' %}active{% endif %}">
      –ö–ª–∏–µ–Ω—Ç—ã
    </a>
  {% endif %}

</nav>
        {% endwith %}
      </div>
      <div class="userbox">
        {% if request.user.is_authenticated %}
          {% if profile and profile.avatar %}
            <img src="{{ profile.avatar.url }}" class="avatar-sm" alt="avatar">
          {% else %}
            <div class="avatar-sm">
              {% firstof request.user.first_name|slice:":1"|upper request.user.username|slice:":1"|upper %}
            </div>
          {% endif %}

          <button class="userbtn" id="userMenuBtn" type="button" aria-haspopup="true" aria-expanded="false">
            <span class="hello">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,</span>
            <span class="name">{% firstof request.user.first_name request.user.username %}</span>
            <span class="caret">‚ñæ</span>
          </button>

          <div class="menu" id="userMenu">
            <a href="{% url 'profile' %}">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'password_change' %}">üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
            <a href="{% url 'logout' %}">‚Ü™ –í—ã–π—Ç–∏</a>
          </div>
        {% else %}
          <a href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        {% endif %}
      </div>
    </div>
  </header>

<main class="wrap {% block wrap_mod %}{% endblock %}">
  {% block content %}{% endblock %}
</main>  <!-- –ù–ï –∑–∞–±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—å -->

  <script>
    (function(){
      const btn = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if(!btn || !menu) return;
      const toggle = () => { menu.classList.toggle('open'); };
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
      document.addEventListener('click', ()=>{ if(menu.classList.contains('open')) menu.classList.remove('open'); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') menu.classList.remove('open'); });
    })();
  </script>

  {% block extra_js %}{% endblock %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>

{# Flash messages #}
{% if messages %}
  <div id="flash-root" class="fixed top-4 right-4 z-[1000] space-y-2 w-[min(92vw,420px)]">
    {% for message in messages %}
      <div
        class="flash-item rounded-xl px-4 py-3 shadow ring-1 text-sm flex items-start gap-3
               {% if message.tags == 'error' %} bg-red-50 text-red-800 ring-red-200
               {% elif message.tags == 'warning' %} bg-amber-50 text-amber-900 ring-amber-200
               {% elif message.tags == 'success' %} bg-green-50 text-green-800 ring-green-200
               {% elif message.tags == 'info' %} bg-blue-50 text-blue-800 ring-blue-200
               {% else %} bg-gray-50 text-gray-800 ring-gray-200 {% endif %}">
        <div class="min-w-0 break-words">{{ message }}</div>
        <button type="button" class="ml-auto shrink-0 rounded-md px-2 py-1 text-xs opacity-70 hover:opacity-100"
                onclick="this.closest('.flash-item')?.remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  (function () {
    const items = document.querySelectorAll('#flash-root .flash-item');
    items.forEach((el, idx) => {
      // –ª—ë–≥–∫–∞—è —Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å—á–µ–∑–∞–ª–∏ –≤—Å–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      const delay = 5000 + idx * 200;
      setTimeout(() => {
        el.style.transition = 'opacity .25s, transform .25s';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-6px)';
        setTimeout(() => el.remove(), 300);
      }, delay);
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('#flash-root .flash-item').forEach(el => el.remove());
      }
    });
  })();
</script>
<footer class="footer" role="contentinfo" aria-label="–ù–∏–∂–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∞–π—Ç–∞">
  <div class="footer-inner">
    <div>IndigoFlow ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–æ–º ¬© 2025</div>
    <div>
      <a href="https://www.incodingo.pro" target="_blank" rel="noopener noreferrer">
        www.incodingo.pro
      </a>
    </div>
  </div>
</footer>
</body>
</html>
