{% extends "base.html" %}
{% block title %}Мои заявки (контрагенты){% endblock %}

{% block content %}
<!--<div class="flex items-center justify-between mb-5">-->
<!--  <h1 class="text-2xl font-semibold">Мои заявки</h1>-->
<!--  <a href="{% url 'core:counterparty_request_create' %}"-->
<!--     class="rounded-xl bg-black text-white px-4 py-2 hover:opacity-90">-->
<!--    + Новая заявка-->
<!--  </a>-->
<!--</div>-->

{# Панель фильтров #}
<form method="get" class="mb-4 grid gap-3 md:grid-cols-3">
  <div class="md:col-span-2">
    <input type="search" name="q" value="{{ request.GET.q|default:'' }}"
           placeholder="Поиск по ИНН или наименованию…"
           class="w-full rounded-xl border px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500" />
  </div>
  <div class="flex items-center gap-2">
    {# быстрые фильтры статуса — просто ссылки на тот же URL с нужным status #}
    {% with s=request.GET.status %}
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}status="
         class="rounded-full border px-3 py-1 text-sm {% if not s %}bg-black text-white border-black{% else %}hover:bg-gray-100{% endif %}">
        Все
      </a>
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}status=pending"
         class="rounded-full border px-3 py-1 text-sm {% if s == 'pending' %}bg-yellow-500 text-white border-yellow-500{% else %}hover:bg-gray-100{% endif %}">
        Ожидают
      </a>
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}status=approved"
         class="rounded-full border px-3 py-1 text-sm {% if s == 'approved' %}bg-green-600 text-white border-green-600{% else %}hover:bg-gray-100{% endif %}">
        Подтверждённые
      </a>
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}status=rejected"
         class="rounded-full border px-3 py-1 text-sm {% if s == 'rejected' %}bg-red-600 text-white border-red-600{% else %}hover:bg-gray-100{% endif %}">
        Отклонённые
      </a>
    {% endwith %}
  </div>
</form>

{# Карточки заявок #}
{% if requests %}
  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
    {% for r in requests %}
      <div class="rounded-2xl border shadow-sm hover:shadow-md transition p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-gray-500">ИНН</div>
            <div class="font-mono text-sm">{{ r.inn }}</div>
          </div>
          {# бейдж статуса #}
          {% if r.status == 'pending' %}
            <span class="shrink-0 rounded-full bg-yellow-100 text-yellow-800 text-xs px-2 py-1">Ожидает</span>
          {% elif r.status == 'approved' %}
            <span class="shrink-0 rounded-full bg-green-100 text-green-800 text-xs px-2 py-1">Подтверждена</span>
          {% elif r.status == 'rejected' %}
            <span class="shrink-0 rounded-full bg-red-100 text-red-800 text-xs px-2 py-1">Отклонена</span>
          {% else %}
            <span class="shrink-0 rounded-full bg-gray-100 text-gray-800 text-xs px-2 py-1">—</span>
          {% endif %}
        </div>

        <div class="mt-3">
          <div class="text-sm text-gray-500">Наименование</div>
          <div class="font-medium">{{ r.name }}</div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-gray-500">Создана</div>
            <div>{{ r.created_at|date:"d.m.Y H:i" }}</div>
          </div>
          <div>
            <div class="text-gray-500">Файлы</div>
            <div>
              {% with dc=r.documents.count %}
                {% if dc %}<span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs">{{ dc }}</span>{% else %}—{% endif %}
              {% endwith %}
            </div>
          </div>
        </div>

        {# если отклонена — покажем комментарий ревьюера #}
        {% if r.status == 'rejected' and r.reviewer_comment %}
          <div class="mt-3 rounded-xl bg-red-50 text-red-800 text-xs px-3 py-2">
            Причина: {{ r.reviewer_comment }}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="rounded-2xl border border-dashed p-8 text-center text-gray-500">
    Заявок пока нет. Нажми «Новая заявка», чтобы создать первую.
  </div>
{% endif %}

{# Пагинация (опционально): если во view передан page_obj #}
{% if page_obj %}
  <div class="mt-6 flex items-center justify-center gap-2">
    {% if page_obj.has_previous %}
      <a class="rounded-lg border px-3 py-1 hover:bg-gray-50"
         href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Назад</a>
    {% endif %}
    <span class="text-sm text-gray-600">Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="rounded-lg border px-3 py-1 hover:bg-gray-50"
         href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Вперёд</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
