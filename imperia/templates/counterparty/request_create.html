{# templates/counterparty/request_create.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}Новая заявка на контрагента{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-4">Новая заявка на контрагента</h1>

{# инфо-блок #}
<div class="rounded-xl border p-4 mb-5 text-sm text-gray-700">
  После отправки заявка попадёт на подтверждение оператору/директору.
  Ответственный менеджер проставится автоматически как автор заявки.
</div>

<form method="post" enctype="multipart/form-data" class="space-y-5">
  {% csrf_token %}

  {# общие ошибки формы #}
  {% if form.non_field_errors %}
    <div class="rounded-md bg-red-50 text-red-700 px-3 py-2 text-sm">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <div class="grid grid-cols-1 gap-4">

    {# ИНН + автоматический поиск в ЕГРЮЛ по Enter #}
    <div>
      {{ form.inn.label_tag }}
      <div style="position:relative">
        {{ form.inn }}
        <div id="egrul-loading" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:14px">
          Поиск...
        </div>
      </div>
      {% if form.inn.errors %}<div class="text-red-600 text-sm">{{ form.inn.errors }}</div>{% endif %}
      <div style="margin-top:6px;font-size:13px;color:var(--muted)">
        Введите ИНН и нажмите Enter для автоматического поиска в ЕГРЮЛ
      </div>
      <button type="button" id="btn-egrul" style="display:none">Найти в ЕГРЮЛ</button>
    </div>

    {# Краткое и полное наименование #}
    <div>
      {{ form.name.label_tag }}
      {{ form.name }}
      {% if form.name.errors %}<div class="text-red-600 text-sm">{{ form.name.errors }}</div>{% endif %}
    </div>

    <div>
      {{ form.full_name.label_tag }}
      {{ form.full_name }}
      {% if form.full_name.errors %}<div class="text-red-600 text-sm">{{ form.full_name.errors }}</div>{% endif %}
    </div>

    {# КПП / ОГРН / Страна #}
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        {{ form.kpp.label_tag }}
        {{ form.kpp }}
        {% if form.kpp.errors %}<div class="text-red-600 text-sm">{{ form.kpp.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.ogrn.label_tag }}
        {{ form.ogrn }}
        {% if form.ogrn.errors %}<div class="text-red-600 text-sm">{{ form.ogrn.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.registration_country.label_tag }}
        {{ form.registration_country }}
        {% if form.registration_country.errors %}<div class="text-red-600 text-sm">{{ form.registration_country.errors }}</div>{% endif %}
      </div>
    </div>

    {# Юр. адрес #}
    <div>
      {{ form.address.label_tag }}
      {{ form.address }}
      {% if form.address.errors %}<div class="text-red-600 text-sm">{{ form.address.errors }}</div>{% endif %}
    </div>

    {# Фактический/доставки + подсказки #}
    <div>
      {{ form.actual_address.label_tag }}
      {{ form.actual_address }}
      {% if form.actual_address.errors %}<div class="text-red-600 text-sm">{{ form.actual_address.errors }}</div>{% endif %}
    </div>

    {# Банк: наименование / БИК / счёт / корреспондентский счет #}
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        {{ form.bank_name.label_tag }}
        {{ form.bank_name }}
        {% if form.bank_name.errors %}<div class="text-red-600 text-sm">{{ form.bank_name.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.bank_bik.label_tag }}
        {{ form.bank_bik }}
        {% if form.bank_bik.errors %}<div class="text-red-600 text-sm">{{ form.bank_bik.errors }}</div>{% endif %}
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        {{ form.bank_account.label_tag }}
        {{ form.bank_account }}
        {% if form.bank_account.errors %}<div class="text-red-600 text-sm">{{ form.bank_account.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.bank_corr_account.label_tag }}
        {{ form.bank_corr_account }}
        {% if form.bank_corr_account.errors %}<div class="text-red-600 text-sm">{{ form.bank_corr_account.errors }}</div>{% endif %}
      </div>
    </div>

    {# Сайт #}
    <div>
      {{ form.website.label_tag }}
      {{ form.website }}
      {% if form.website.errors %}<div class="text-red-600 text-sm">{{ form.website.errors }}</div>{% endif %}
    </div>
  </div>

  {# ======= СКАНЫ ДОКУМЕНТОВ (formset) ======= #}
  <div class="rounded-xl border p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Сканы документов</h2>
      <button type="button" id="add-doc" class="rounded-xl border px-3 py-1">Добавить файл</button>
    </div>

    {{ doc_formset.management_form }}

    <div id="doc-forms" class="space-y-3">
      {% for f in doc_formset.forms %}
        {{ f.id }} {# скрытое поле id для существующих #}
        <div class="border rounded-lg p-3">
          <div class="grid md:grid-cols-3 gap-4 items-start">
            <div>
              {{ f.title.label_tag }}
              {{ f.title }}
              {% if f.title.errors %}<div class="text-red-600 text-sm">{{ f.title.errors }}</div>{% endif %}
            </div>
            <div>
              {{ f.file.label_tag }}
              {{ f.file }}
              {% if f.file.errors %}<div class="text-red-600 text-sm">{{ f.file.errors }}</div>{% endif %}

              {% if f.instance.pk and f.instance.file %}
                <div class="mt-1 text-sm">
                  <a href="{{ f.instance.file.url }}" target="_blank" class="text-blue-600 underline">Просмотреть текущий файл</a>
                </div>
              {% endif %}
            </div>
            <div class="pt-6">
              {% if f.DELETE %}
                <label class="inline-flex items-center gap-2 text-red-600">
                  {{ f.DELETE }} удалить
                </label>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Пустой шаблон для добавления новой строки через JS #}
    <template id="doc-empty">
      <div class="border rounded-lg p-3">
        <div class="grid md:grid-cols-3 gap-4 items-start">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Название</label>
            REPLACE_TITLE
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Файл</label>
            REPLACE_FILE
          </div>
          <div></div>
        </div>
      </div>
    </template>

    {# ошибки formset уровня набора #}
    {% if doc_formset.non_form_errors %}
      <div class="rounded-md bg-red-50 text-red-700 px-3 py-2 text-sm mt-3">
        {{ doc_formset.non_form_errors }}
      </div>
    {% endif %}
  </div>

  <div class="flex gap-2">
    <button type="submit" class="rounded-xl bg-black text-white px-4 py-2">
      Отправить на подтверждение
    </button>
    <a href="javascript:history.back()" class="rounded-xl border px-4 py-2">Отмена</a>
  </div>
</form>

{# ===== JS: ЕГРЮЛ и подсказки адресов – как у формы операторов ===== #}
<script>
  // 1) Автозаполнение из ЕГРЮЛ по Enter
  (function () {
    const innInput = document.getElementById('id_inn');
    const btn = document.getElementById('btn-egrul');
    const loadingEl = document.getElementById('egrul-loading');
    
    if (!innInput) return;

    const lookupUrl = "{% url 'core:counterparty_lookup_inn' %}";

    async function performLookup() {
      const inn = (innInput.value || '').trim();

      if (!/^\d{10}(\d{2})?$/.test(inn)) {
        alert('Введите корректный ИНН: 10 (юр.лицо) или 12 (ИП) цифр.');
        innInput.focus();
        return;
      }

      if (loadingEl) loadingEl.style.display = 'block';
      if (btn) btn.disabled = true;
      innInput.disabled = true;

      try {
        const resp = await fetch(`${lookupUrl}?inn=${encodeURIComponent(inn)}`, { method: 'GET' });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          alert(data.error || 'Не удалось получить данные ЕГРЮЛ');
          return;
        }

        const d = data.data || {};
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el && (val ?? '') !== '') el.value = val;
        };

        setVal('id_name', d.name);
        setVal('id_full_name', d.full_name);
        setVal('id_kpp', d.kpp);
        setVal('id_ogrn', d.ogrn);
        setVal('id_registration_country', d.registration_country || 'РОССИЯ');
        setVal('id_address', d.address);
        setVal('id_website', d.website);

        if (loadingEl) {
          loadingEl.style.color = '#10b981';
          loadingEl.textContent = '✓ Данные загружены';
          setTimeout(() => {
            loadingEl.style.display = 'none';
            loadingEl.style.color = '';
            loadingEl.textContent = 'Поиск...';
          }, 2000);
        }
      } catch (e) {
        console.error(e);
        alert('Ошибка запроса к ЕГРЮЛ.');
        if (loadingEl) loadingEl.style.display = 'none';
      } finally {
        if (btn) btn.disabled = false;
        innInput.disabled = false;
      }
    }

    // Обработка Enter в поле ИНН
    innInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        performLookup();
      }
    });

    // Кнопка как fallback
    if (btn) {
      btn.addEventListener('click', performLookup);
    }
  })();

  // 2) Подсказки адресов (OSM Nominatim)
  (function () {
    const input = document.getElementById('id_actual_address');
    if (!input) return;

    const boxId = 'addr-suggest-box';
    let box = document.getElementById(boxId);
    if (!box) {
      box = document.createElement('div');
      box.id = boxId;
      box.className = 'hidden absolute z-50 mt-1 w-full rounded-lg border bg-white shadow';
      const wrapper = document.createElement('div');
      wrapper.className = 'relative';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      wrapper.appendChild(box);
    }

    const endpoint = "{% url 'core:address_suggest_osm' %}";
    let timer = null;
    let lastQuery = '';

    function hideBox() { box.classList.add('hidden'); box.innerHTML = ''; }
    function showBox() { box.classList.remove('hidden'); }
    function esc(s) { return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function render(items) {
      if (!items || !items.length) { hideBox(); return; }
      box.innerHTML = items.map(it => `
        <button type="button" class="w-full text-left px-3 py-2 hover:bg-gray-100 focus:bg-gray-100" data-value="${esc(it.value)}">
          ${esc(it.value)}
        </button>`).join('');
      showBox();
    }

    async function fetchSuggest(q) {
      try {
        const resp = await fetch(`${endpoint}?q=${encodeURIComponent(q)}`, { headers: {"X-Requested-With": "XMLHttpRequest"} });
        const data = await resp.json();
        render((data && data.suggestions) || []);
      } catch (e) {
        console.error(e);
        hideBox();
      }
    }

    function debounce(fn, ms) {
      return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
    }

    const onType = debounce(() => {
      const q = (input.value || '').trim();
      if (!q) { hideBox(); return; }
      if (q === lastQuery) return;
      lastQuery = q;
      fetchSuggest(q);
    }, 300);

    input.addEventListener('input', onType);
    input.addEventListener('focus', () => { if (box.innerHTML.trim()) showBox(); });
    input.addEventListener('blur', () => setTimeout(hideBox, 150));

    box.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-value]');
      if (!btn) return;
      input.value = btn.getAttribute('data-value') || '';
      hideBox();
    });

    input.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideBox(); });
  })();

  // 3) Динамическое добавление строк formset для документов
  (function () {
    const addBtn = document.getElementById('add-doc');
    if (!addBtn) return;

    // По умолчанию мы используем prefix='docs' во view.
    const totalInput = document.querySelector('input[name="docs-TOTAL_FORMS"]');
    const container  = document.getElementById('doc-forms');
    const tmplEl     = document.getElementById('doc-empty');

    if (!totalInput || !container || !tmplEl) return;

    const tmpl = tmplEl.innerHTML;

    addBtn.addEventListener('click', function () {
      const idx = parseInt(totalInput.value || '0', 10);
      const prefix = 'docs';

      const titleHtml = `<input type="text" name="${prefix}-${idx}-title" class="w-full rounded-xl border px-3 py-2">`;
      const fileHtml  = `<input type="file" name="${prefix}-${idx}-file" class="w-full rounded-xl border px-3 py-2">`;

      let html = tmpl.replace('REPLACE_TITLE', titleHtml)
                     .replace('REPLACE_FILE', fileHtml);

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      container.appendChild(wrapper.firstElementChild);

      totalInput.value = idx + 1;
    });
  })();
</script>

<script>
// Автодополнение банков для заявки на контрагента
(function() {
  const bankNameInput = document.querySelector('input[name="bank_name"]');
  const bankBikInput = document.querySelector('input[name="bank_bik"]');
  
  if (!bankNameInput || !bankBikInput) return;
  
  let autocompleteList = null;
  let searchTimeout = null;
  let selectedBank = null;
  
  function createAutocompleteList() {
    if (autocompleteList) {
      autocompleteList.remove();
    }
    
    const list = document.createElement('div');
    list.style.cssText = 'position:absolute;z-index:1000;background:white;border:1px solid #ccc;border-radius:8px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.15);margin-top:4px;width:100%;';
    
    const wrapper = bankNameInput.closest('div') || bankNameInput.parentElement;
    if (wrapper) {
      wrapper.style.position = 'relative';
      wrapper.appendChild(list);
    }
    
    autocompleteList = list;
    return list;
  }
  
  function hideAutocomplete() {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
  }
  
  function selectBank(bank) {
    selectedBank = bank;
    bankNameInput.value = bank.name;
    bankBikInput.value = bank.bik;
    
    // Заполняем корреспондентский счет, если он есть
    const bankCorrAccountInput = document.querySelector('input[name="bank_corr_account"]');
    if (bankCorrAccountInput && bank.ks) {
      bankCorrAccountInput.value = bank.ks;
    }
    
    hideAutocomplete();
  }
  
  async function searchBanks(query) {
    if (query.length < 3) {
      hideAutocomplete();
      return;
    }
    
    try {
      const response = await fetch(`{% url 'core:bank_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (!data.ok || !data.banks || data.banks.length === 0) {
        hideAutocomplete();
        return;
      }
      
      if (!autocompleteList) {
        createAutocompleteList();
      }
      
      autocompleteList.innerHTML = '';
      
      data.banks.forEach(bank => {
        const item = document.createElement('div');
        item.style.cssText = 'padding:10px 14px;cursor:pointer;border-bottom:1px solid #eee;transition:background-color 0.15s;';
        const ksInfo = bank.ks ? ` / К/С: ${bank.ks}` : '';
        item.innerHTML = `
          <div style="font-weight:500;font-size:14px">${bank.name}</div>
          <div style="font-size:12px;color:#666;font-family:monospace;margin-top:2px">БИК: ${bank.bik}${ksInfo}</div>
        `;
        item.onmouseover = () => item.style.backgroundColor = '#f5f5f5';
        item.onmouseout = () => item.style.backgroundColor = '';
        item.onclick = () => selectBank(bank);
        autocompleteList.appendChild(item);
      });
      
    } catch (error) {
      console.error('Ошибка поиска банков:', error);
      hideAutocomplete();
    }
  }
  
  bankNameInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Если значение изменилось после выбора банка, сбрасываем БИК
    if (selectedBank && query !== selectedBank.name) {
      selectedBank = null;
      bankBikInput.value = '';
    }
    
    if (query.length >= 3) {
      searchTimeout = setTimeout(() => searchBanks(query), 300);
    } else {
      hideAutocomplete();
    }
  });
  
  // Закрытие при клике вне списка
  document.addEventListener('click', function(e) {
    if (autocompleteList && !autocompleteList.contains(e.target) && e.target !== bankNameInput) {
      hideAutocomplete();
    }
  });
  
  // Закрытие по Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && autocompleteList) {
      hideAutocomplete();
    }
  });
})();
</script>
{% endblock %}
