{% extends "base.html" %}
{% block title %}Профиль — Imperia{% endblock %}

{% block content %}
<div class="profile-header">
  {% if p_form.instance.avatar %}
    <img src="{{ p_form.instance.avatar.url }}" class="avatar" alt="avatar">
  {% else %}
    <div class="avatar avatar--placeholder">
      {% firstof request.user.first_name|slice:":1"|upper request.user.username|slice:":1"|upper %}
    </div>
  {% endif %}
  <div>
    <div><b>Логин:</b> {{ username }}</div>
    <div class="badges"><b>Роли:</b>
      {% for r in roles %}<span>{{ r }}</span>{% empty %}<span>нет</span>{% endfor %}
    </div>
  </div>
</div>

<div class="card" style="margin-bottom:16px">
  <a class="btn btn-secondary" href="{% url 'post_login_router' %}">← На главную</a>
</div>

<div class="card">
  <h1>Профиль</h1>
  <p class="note">Логин и роли редактируются только администратором.</p>

  <div class="row" style="display:flex;align-items:center;gap:16px;margin:12px 0 20px">
    {% if p_form.instance.avatar %}
      <img id="avatarPreview" src="{{ p_form.instance.avatar.url }}" class="avatar-lg" alt="avatar">
    {% else %}
      <div id="avatarPreviewFallback" class="avatar-lg">
        {% firstof request.user.first_name|slice:":1"|upper request.user.username|slice:":1"|upper %}
      </div>
    {% endif %}
    <button type="button" class="btn btn-secondary" id="pickAvatar">✏️ Изменить аватар</button>
  </div>

  <form id="profileForm" method="post" enctype="multipart/form-data" class="grid-2">
    {% csrf_token %}

    <!-- спрятанный input файла (рендерится из формы) -->
    {{ p_form.avatar }}

    <div class="card">
      <h3>Данные пользователя</h3>
      <div class="field"><label>Имя</label>{{ u_form.first_name }}</div>
      <div class="field"><label>Фамилия</label>{{ u_form.last_name }}</div>
      <div class="field"><label>E-mail</label>{{ u_form.email }}</div>
    </div>

    <div class="card">
      <h3>Контакты и аватар</h3>
      <div class="field"><label>Телефон</label>{{ p_form.phone }}</div>
      <div class="field"><label>WhatsApp</label>{{ p_form.whatsapp }}</div>
      <div class="field"><label>Telegram</label>{{ p_form.telegram }}</div>
      <div class="field"><label>VK</label>{{ p_form.vk }}</div>
      <div class="field"><label>Дата рождения</label>{{ p_form.birth_date }}</div>
    </div>

    <div style="grid-column:1/-1;display:flex;gap:10px">
      <button class="btn btn-primary" type="submit">Сохранить</button>
      <a class="btn btn-link" href="{% url 'post_login_router' %}">Отмена</a>
    </div>
  </form>
</div>

<script>
  (function(){
    const btn = document.getElementById('pickAvatar');
    const file = document.getElementById('id_avatar');
    const form = document.getElementById('profileForm');
    const img  = document.getElementById('avatarPreview');
    const fallback = document.getElementById('avatarPreviewFallback');

    if (btn && file) {
      btn.addEventListener('click', () => file.click());
      file.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        if (img) { img.src = url; img.onload = () => URL.revokeObjectURL(url); }
        else {
          const im = document.createElement('img');
          im.className = 'avatar-lg'; im.id = 'avatarPreview'; im.src = url;
          im.onload = () => URL.revokeObjectURL(url);
          if (fallback) fallback.replaceWith(im);
        }
        form.submit();
      });
    }
  })();
</script>

{% endblock %}
