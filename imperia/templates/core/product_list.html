{% extends "base.html" %}
{% load access %}
{% block title %}–¢–æ–≤–∞—Ä—ã ‚Äî Imperia{% endblock %}

{% block content %}
  <h1 class="text-3xl font-semibold mb-4">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>

{# –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ‚Äî —á/–± —Å—Ç–∏–ª—å #}
<div class="space-y-3">

  {# –ü–û–ò–°–ö #}
  {% if request.user|in_groups:"director" or request.user|in_groups:"operator" or request.user|in_groups:"warehouse" or request.user|in_groups:"manager" %}
    <form id="searchForm" method="get"
          class="rounded-2xl bg-white border border-gray-200 shadow-sm p-3 md:p-4">
      <div class="flex flex-col md:flex-row md:items-center gap-2">
        <div class="flex-1 relative">
          <input id="searchInput" name="q" type="search"
                 placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É (3+ —Å–∏–º–≤–æ–ª–∞)‚Ä¶"
                 value="{{ q|default:'' }}"
                 class="w-full rounded-xl border border-gray-300 bg-white pl-10 pr-3 py-2 outline-none focus:ring-2 focus:ring-gray-500" />
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
        </div>

        <div class="flex items-center gap-2">
          <input type="hidden" name="supplier" value="{{ supplier|default:'' }}">
          <input type="hidden" name="sort"     value="{{ sort|default:'' }}">
          <input type="hidden" name="order"    value="{{ order|default:'asc' }}">
          <input type="hidden" name="per_page" value="{{ per_page|default:24 }}">

          <button id="searchBtn" type="submit"
                  class="rounded-xl px-4 py-2 bg-black text-white hover:bg-gray-900 disabled:opacity-50">
            –ò—Å–∫–∞—Ç—å
          </button>

          {% if q or supplier or sort %}
            <a href="{{ request.path }}"
               class="rounded-xl px-3 py-2 border border-gray-300 bg-white hover:bg-gray-50"
               title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã">–°–±—Ä–æ—Å</a>
          {% endif %}
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, —à—Ç—Ä–∏—Ö–∫–æ–¥—É, –∞—Ä—Ç–∏–∫—É–ª—É –∏ –±—Ä–µ–Ω–¥—É.</p>
    </form>
  {% endif %}

  {# –§–ò–õ–¨–¢–† + –°–û–†–¢–∏—Ä–æ–≤–∫–∞ #}
  {% if request.user|in_groups:"director" or request.user|in_groups:"operator" or request.user|in_groups:"warehouse" %}
    <form id="fsForm" method="get"
          class="rounded-2xl bg-white border border-gray-200 shadow-sm p-3 md:p-4">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-2">

        <label class="lg:col-span-2">
          <span class="block text-xs font-medium text-gray-600 mb-1">–ü–æ—Å—Ç–∞–≤—â–∏–∫</span>
          <select name="supplier"
                  class="w-full rounded-xl border border-gray-300 px-3 py-2 bg-white focus:ring-2 focus:ring-gray-500">
            <option value="" {% if not supplier %}selected{% endif %}>–í—Å–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏</option>
            {% for s in suppliers %}
              {% if s.code %}
                <option value="{{ s.code }}" {% if supplier == s.code %}selected{% endif %}>
                  {{ s.code }}{% if s.name %} ‚Äî {{ s.name }}{% endif %}
                </option>
              {% else %}
                <option value="{{ s }}" {% if supplier == s %}selected{% endif %}>{{ s }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </label>

        <label>
          <span class="block text-xs font-medium text-gray-600 mb-1">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
          <select name="sort"
                  class="w-full rounded-xl border border-gray-300 px-3 py-2 bg-white focus:ring-2 focus:ring-gray-500">
            <option value=""           {% if not sort %}selected{% endif %}>–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
            <option value="price"      {% if sort == 'price' %}selected{% endif %}>–ü–æ —Ü–µ–Ω–µ (–º–∏–Ω)</option>
          </select>
        </label>

        <div class="flex flex-col">
          <span class="block text-xs font-medium text-gray-600 mb-1">–ü–æ—Ä—è–¥–æ–∫</span>
          <div class="flex items-center gap-2">
            <input type="hidden" name="order" id="orderInput" value="{{ order|default:'asc' }}">
            <button id="orderToggle" type="button"
                    class="flex-1 rounded-xl border border-gray-300 px-3 py-2 bg-white hover:bg-gray-50"
                    title="–°–º–µ–Ω–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
              {% if order == 'desc' %}‚ñº –î–æ—Ä–æ–∂–µ ‚Üí –î–µ—à–µ–≤–ª–µ{% else %}‚ñ≤ –î–µ—à–µ–≤–ª–µ ‚Üí –î–æ—Ä–æ–∂–µ{% endif %}
            </button>
            <button type="submit"
                    class="rounded-xl px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50">
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>

      </div>

      <input type="hidden" name="q"        value="{{ q|default:'' }}">
      <input type="hidden" name="per_page" value="{{ per_page|default:24 }}">
      <p class="text-xs text-gray-500 mt-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ —Ü–µ–Ω—ã, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª.</p>
    </form>
  {% endif %}
</div>



  {# –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ #}
  <div class="mt-6 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    {% for p in page_obj.object_list %}
      <div class="rounded-2xl bg-white shadow hover:shadow-md transition overflow-hidden cursor-pointer js-product-card"
           data-id="{{ p.id }}">
        <div class="aspect-[4/3] bg-gray-100">
          {% with p.images.all|first as img %}
            {% if img %}
              <img src="{{ img.url }}" alt="{{ p.name|default:'product image' }}"
                   class="w-full h-full object-contain" loading="lazy">
            {% else %}
              <div class="w-full h-full flex items-center justify-center text-gray-400">–Ω–µ—Ç —Ñ–æ—Ç–æ</div>
            {% endif %}
          {% endwith %}
        </div>
        <div class="p-4">
          <div class="text-sm text-gray-500">
            {{ p.brand }}{% if p.brand and p.vendor_code %} ¬∑ {% endif %}{{ p.vendor_code }}
          </div>
          <div class="mt-1 font-medium line-clamp-2">{{ p.name }}</div>
          <div class="mt-2 text-sm text-gray-600">
            –®—Ç—Ä–∏—Ö–∫–æ–¥: <span class="font-mono">{{ p.barcode|default:"‚Äî" }}</span>
          </div>

          {% if request.user|in_groups:"director" or request.user|in_groups:"operator" or request.user|in_groups:"warehouse" %}
            <div class="mt-1 text-sm text-gray-600">–ü–æ—Å—Ç–∞–≤—â–∏–∫: {{ p.supplier.code }}</div>
          {% endif %}

          <div class="mt-2">
            {% if request.user|in_groups:"operator" or request.user|in_groups:"director" %}
              {% if p.min_price %}
                <span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 text-sm px-2 py-1">
                  {{ p.min_price }} ‚ÇΩ
                </span>
              {% else %}
                <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-600 text-sm px-2 py-1">
                  —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                </span>
              {% endif %}
            {% else %}
              <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-600 text-sm px-2 py-1">
                —Ü–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="md:col-span-3 text-gray-600">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    {% endfor %}
  </div>

  {# –ü–∞–≥–∏–Ω–∞—Ü–∏—è ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º q/supplier/sort/order/per_page #}
  {% if page_obj.paginator.num_pages > 1 %}
    <div class="mt-6 flex items-center justify-center gap-2">
      {% if page_obj.has_previous %}
        <a class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50"
           href="?{% if q %}q={{ q|urlencode }}&{% endif %}
                  {% if supplier %}supplier={{ supplier|urlencode }}&{% endif %}
                  sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
      {% else %}
        <span class="px-3 py-2 rounded-xl border bg-gray-100 text-gray-400 cursor-not-allowed">–ù–∞–∑–∞–¥</span>
      {% endif %}
      <span class="px-3 py-2 text-sm text-gray-600">–°—Ç—Ä. {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50"
           href="?{% if q %}q={{ q|urlencode }}&{% endif %}
                  {% if supplier %}supplier={{ supplier|urlencode }}&{% endif %}
                  sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">–í–ø–µ—Ä—ë–¥</a>
      {% else %}
        <span class="px-3 py-2 rounded-xl border bg-gray-100 text-gray-400 cursor-not-allowed">–í–ø–µ—Ä—ë–¥</span>
      {% endif %}
    </div>
  {% endif %}

  {# ===== MODAL ===== #}
  <div id="productModal" class="fixed inset-0 z-50 hidden">
    <!-- overlay -->
    <div class="absolute inset-0 bg-black/50"></div>

    <!-- dialog -->
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-[min(900px,95vw)] max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-xl border border-gray-200 relative">
        <!-- header -->
        <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b px-5 py-3 flex items-center justify-between">
          <h3 id="mTitle" class="text-xl font-semibold line-clamp-1">–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞</h3>
          <button id="mClose" class="w-9 h-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <!-- body -->
        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div id="mImageWrap" class="aspect-[4/3] bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
              <div id="mSpinner" class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            </div>
            <div id="mThumbs" class="mt-3 flex gap-2 overflow-x-auto"></div>
          </div>

          <div class="space-y-2">
            <div class="text-sm text-gray-500" id="mBrand"></div>
            <div class="text-lg font-medium" id="mName"></div>
            <div class="text-sm text-gray-600">–®—Ç—Ä–∏—Ö–∫–æ–¥: <span class="font-mono" id="mBarcode"></span></div>
            <div class="text-sm text-gray-600">–ü–æ—Å—Ç–∞–≤—â–∏–∫: <span id="mSupplier"></span></div>

            {% if request.user|in_groups:"operator" or request.user|in_groups:"director" %}
              <div id="mPrice" class="mt-2 hidden">
                <span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 text-sm px-2 py-1">
                  <span id="mMinPrice"></span>
                </span>
              </div>
            {% endif %}

            <div class="mt-3">
              <div class="text-sm text-gray-900 font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
              <div class="text-sm text-gray-700" id="mDesc"></div>
              <div class="text-sm text-gray-700 mt-1" id="mDescExt"></div>
            </div>

            <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
              <div class="bg-gray-50 rounded-lg p-2 border">
                <div class="text-gray-500">–°—Ç—Ä–∞–Ω–∞</div>
                <div id="mCountry" class="font-medium">‚Äî</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2 border">
                <div class="text-gray-500">–í–µ—Å, –∫–≥</div>
                <div id="mWeight" class="font-medium">‚Äî</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2 border">
                <div class="text-gray-500">–û–±—ä—ë–º, –º¬≥</div>
                <div id="mVol" class="font-medium">‚Äî</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2 border col-span-3">
                <div class="text-gray-500">–ì–∞–±–∞—Ä–∏—Ç—ã, —Å–º</div>
                <div id="mPkg" class="font-medium">‚Äî</div>
              </div>
            </div>

            <div class="mt-3">
              <details class="group">
                <summary class="cursor-pointer select-none text-sm font-medium text-gray-900">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</summary>
                <div id="mCerts" class="mt-2 space-y-1"></div>
              </details>
            </div>

            {% if request.user|in_groups:"operator" or request.user|in_groups:"director" %}
              <div class="mt-3">
                <details>
                  <summary class="cursor-pointer select-none text-sm font-medium text-gray-900">–í—Å–µ —Ü–µ–Ω—ã</summary>
                  <div id="mPricesAll" class="mt-2 text-sm text-gray-700"></div>
                </details>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- footer -->
        <div class="px-5 pb-5">
          <button id="mClose2" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
// –ü–æ–∏—Å–∫ ‚Äî –∞–∫—Ç–∏–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ 3+ —Å–∏–º–≤–æ–ª–∞—Ö
  (function(){
    const form  = document.getElementById('searchForm');
    const input = document.getElementById('searchInput');
    const btn   = document.getElementById('searchBtn');
    if (!form || !input || !btn) return;

    const toggleBtn = () => { btn.disabled = (input.value.trim().length < 3); };
    toggleBtn();
    input.addEventListener('input', toggleBtn);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim().length < 3) e.preventDefault();
    });
    form.addEventListener('submit', (e) => {
      if (input.value.trim().length < 3) e.preventDefault();
    });
  })();

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ—Ä—è–¥–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (‚ñ≤ / ‚ñº)
  (function(){
    const btn = document.getElementById('orderToggle');
    const input = document.getElementById('orderInput');
    if (!btn || !input) return;

    btn.addEventListener('click', () => {
      const next = (input.value === 'desc') ? 'asc' : 'desc';
      input.value = next;
      btn.textContent = (next === 'desc') ? '‚ñº –î–æ—Ä–æ–∂–µ ‚Üí –î–µ—à–µ–≤–ª–µ' : '‚ñ≤ –î–µ—à–µ–≤–ª–µ ‚Üí –î–æ—Ä–æ–∂–µ';
    });
  })();

  // –ú–æ–¥–∞–ª–∫–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π —Ç–æ–≤–∞—Ä–∞
  (function(){
    const modal = document.getElementById('productModal');
    if (!modal) return;

    const overlay  = modal.querySelector('.absolute.inset-0');
    const closeBtn = document.getElementById('mClose');
    const closeBtn2= document.getElementById('mClose2');

    const title   = document.getElementById('mTitle');
    const brandEl = document.getElementById('mBrand');
    const nameEl  = document.getElementById('mName');
    const barcode = document.getElementById('mBarcode');
    const supplier= document.getElementById('mSupplier');
    const desc    = document.getElementById('mDesc');
    const descExt = document.getElementById('mDescExt');

    const minPriceWrap = document.getElementById('mPrice') || null;
    const minPrice = document.getElementById('mMinPrice') || null;
    const pricesAll = document.getElementById('mPricesAll') || null;

    const weight  = document.getElementById('mWeight');
    const volume  = document.getElementById('mVol');
    const pkg     = document.getElementById('mPkg');
    const country = document.getElementById('mCountry');

    const imgWrap = document.getElementById('mImageWrap');
    const thumbs  = document.getElementById('mThumbs');
    const certs   = document.getElementById('mCerts');

    function openModal(){ modal.classList.remove('hidden'); document.body.style.overflow='hidden'; }
    function closeModal(){ modal.classList.add('hidden'); document.body.style.overflow=''; }

    overlay.addEventListener('click', closeModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);
    closeBtn2 && closeBtn2.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    document.querySelectorAll('.js-product-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const id = card.dataset.id;
        if(!id) return;

        // —Å–±—Ä–æ—Å
        title.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞';
        brandEl.textContent = '';
        nameEl.textContent = '';
        barcode.textContent = '';
        supplier.textContent = '';
        desc.textContent = '';
        descExt.textContent = '';
        if (minPriceWrap) { minPriceWrap.classList.add('hidden'); }
        if (minPrice)     { minPrice.textContent = ''; }
        weight.textContent  = '‚Äî';
        volume.textContent  = '‚Äî';
        pkg.textContent     = '‚Äî';
        country.textContent = '‚Äî';
        imgWrap.innerHTML = '<div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        thumbs.innerHTML = '';
        certs.innerHTML = '';
        if (pricesAll) pricesAll.innerHTML = '';

        openModal();

        fetch(`/products/${id}/json/`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
          .then(r=>r.ok ? r.json() : Promise.reject(r.status))
          .then(d=>{
            title.textContent = d.name || '–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞';
            brandEl.textContent = [d.brand, d.vendor_code].filter(Boolean).join(' ¬∑ ');
            nameEl.textContent = d.name || '';
            barcode.textContent = d.barcode || '‚Äî';
            supplier.textContent = d.supplier || '‚Äî';
            desc.textContent = d.description || '';
            descExt.textContent = d.description_ext || '';

            if (minPriceWrap && minPrice && d.min_price){
              minPriceWrap.classList.remove('hidden');
              minPrice.textContent = d.min_price + ' ‚ÇΩ';
            }

            country.textContent = d.country || '‚Äî';
            weight.textContent  = d.weight_kg || '‚Äî';
            volume.textContent  = d.volume_m3 || '‚Äî';
            const H = d.pkg && d.pkg.h_cm, W = d.pkg && d.pkg.w_cm, D = d.pkg && d.pkg.d_cm;
            if (H || W || D) pkg.textContent = [H, W, D].filter(Boolean).join(' √ó ');

            imgWrap.innerHTML = '';
            if (Array.isArray(d.images) && d.images.length){
              const main = document.createElement('img');
              main.src = d.images[0]; main.className='w-full h-full object-contain';
              imgWrap.appendChild(main);
              d.images.forEach((u)=>{
                const t = document.createElement('img');
                t.src = u; t.className='w-16 h-16 object-contain bg-gray-100 rounded-md border cursor-pointer';
                t.addEventListener('click', ()=>{ main.src = u; });
                thumbs.appendChild(t);
              });
            } else {
              const ph = document.createElement('div');
              ph.className='w-full h-full flex items-center justify-center text-gray-400';
              ph.textContent='–Ω–µ—Ç —Ñ–æ—Ç–æ';
              imgWrap.appendChild(ph);
            }

            if (Array.isArray(d.certificates) && d.certificates.length){
              d.certificates.forEach(c=>{
                const a = document.createElement('a');
                a.href = c.url; a.target = '_blank'; a.rel='noopener';
                a.className='block text-blue-600 hover:underline';
                a.textContent = [c.name, c.issued_by, c.active_to].filter(Boolean).join(' ¬∑ ') || c.url;
                certs.appendChild(a);
              });
            } else {
              certs.innerHTML = '<div class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }

            if (pricesAll){
              if (Array.isArray(d.prices) && d.prices.length){
                const tbl = document.createElement('div');
                d.prices.forEach(p=>{
                  const row = document.createElement('div');
                  row.className='flex justify-between gap-3';
                  row.innerHTML = `<span class="text-gray-500">${p.type}</span><span class="font-medium">${p.value} ${p.currency}</span>`;
                  tbl.appendChild(row);
                });
                pricesAll.appendChild(tbl);
              } else {
                pricesAll.innerHTML = '<div class="text-sm text-gray-500">–ù–µ—Ç —Ü–µ–Ω</div>';
              }
            }
          })
          .catch(()=>{ title.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; });
      });
    });
  })();
</script>
{% endblock %}
