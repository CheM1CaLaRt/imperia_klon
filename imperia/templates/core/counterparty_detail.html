{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ obj.name }} ‚Äî IndigoFlow{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ obj.name }}</h1>
      <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>
    {% if can_edit_client %}
      <div style="display:flex;gap:8px">
        <a href="{% url 'core:counterparty_update' obj.pk %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'core:counterparty_delete' obj.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid grid-2">
  {# –†–µ–∫–≤–∏–∑–∏—Ç—ã #}
  <div class="card">
    <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div style="display:grid;gap:12px">
      <div><span style="color:var(--muted);font-size:13px">–ò–ù–ù:</span> <span style="font-weight:600">{{ obj.inn }}</span></div>
      {% if obj.kpp %}<div><span style="color:var(--muted);font-size:13px">–ö–ü–ü:</span> <span style="font-weight:600">{{ obj.kpp }}</span></div>{% endif %}
      {% if obj.ogrn %}<div><span style="color:var(--muted);font-size:13px">–û–ì–†–ù:</span> <span style="font-weight:600">{{ obj.ogrn }}</span></div>{% endif %}
      {% if obj.full_name %}<div><span style="color:var(--muted);font-size:13px">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span> <div style="margin-top:4px">{{ obj.full_name }}</div></div>{% endif %}
      {% if obj.address %}<div><span style="color:var(--muted);font-size:13px">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.address }}</div></div>{% endif %}
      {% if obj.actual_address %}<div><span style="color:var(--muted);font-size:13px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.actual_address }}</div></div>{% endif %}
      {% if obj.website %}
        <div>
          <span style="color:var(--muted);font-size:13px">–°–∞–π—Ç:</span>
          <a href="{{ obj.website }}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-weight:600">{{ obj.website }}</a>
        </div>
      {% endif %}
      <div><span style="color:var(--muted);font-size:13px">–°—Ç—Ä–∞–Ω–∞:</span> <span style="font-weight:600">{{ obj.registration_country }}</span></div>
      <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at|date:"d.m.Y H:i" }}</div>
    </div>
  </div>

  {# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ #}
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:700;margin:0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      {% if can_edit_client %}
        <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" style="margin:0">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
        </form>
      {% endif %}
    </div>

    {% if obj.finance %}
      <div style="display:grid;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div style="color:var(--muted);font-size:14px;padding:24px;text-align:center">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
    {% endif %}
  </div>
</div>

{# –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ #}
{% if obj.address or obj.actual_address %}
<div style="margin-top:16px">
  {% if obj.address and obj.actual_address %}
    {# –û–±–µ –∫–∞—Ä—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ #}
    <div class="grid grid-2" style="gap:16px">
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
            –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
        </div>
        <div id="map-legal" style="width:100%;height:420px"></div>
      </div>
      
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
            –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
        </div>
        <div id="map-actual" style="width:100%;height:420px"></div>
      </div>
    </div>
  {% elif obj.address %}
    {# –¢–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
          –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
      </div>
      <div id="map-legal" style="width:100%;height:420px"></div>
    </div>
  {% elif obj.actual_address %}
    {# –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
          –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
      </div>
      <div id="map-actual" style="width:100%;height:420px"></div>
    </div>
  {% endif %}
</div>
{% endif %}

{# –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
  <div class="grid grid-3">
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–∞–Ω–∫</div>
      <div style="font-weight:600">{{ obj.bank_name|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–ò–ö</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_bik|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_account|default:"‚Äî" }}</div>
    </div>
  </div>
</div>

{# –ö–æ–Ω—Ç–∞–∫—Ç—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div style="display:grid;gap:12px">
      {% for c in obj.contacts.all %}
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">{{ c.full_name }}</div>
              <div style="color:var(--muted);font-size:14px;margin-bottom:8px">{{ c.position }}</div>
              <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:14px">
                {% if c.email %}<span>‚úâÔ∏è <a href="mailto:{{ c.email }}" style="color:var(--primary);text-decoration:none">{{ c.email }}</a></span>{% endif %}
                {% if c.phone %}<span>‚òéÔ∏è <a href="tel:{{ c.phone }}" style="color:var(--text);text-decoration:none">{{ c.phone }}</a></span>{% endif %}
                {% if c.mobile %}<span>üì± <a href="tel:{{ c.mobile }}" style="color:var(--text);text-decoration:none">{{ c.mobile }}</a></span>{% endif %}
              </div>
              {% if c.note %}<div style="margin-top:8px;color:var(--muted);font-size:13px">{{ c.note }}</div>{% endif %}
            </div>
            {% if can_edit_contact %}
              <div style="display:flex;gap:8px">
                <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  {% endif %}
</div>

{# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="btn btn-secondary">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div style="display:grid;gap:12px">
        {% for m in managers %}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600;font-size:16px">{{ m.get_full_name|default:m.username }}</div>
              <div style="color:var(--muted);font-size:14px">@{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}</div>
            </div>
            {% if can_edit_client %}
              <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:24px;text-align:center;color:var(--muted)">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
    {% endif %}
  {% endwith %}
</div>

{# –î–æ–∫—É–º–µ–Ω—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  {% if obj.documents.all %}
    <div style="display:grid;gap:8px">
      {% for d in obj.documents.all %}
        <a href="{{ d.file.url }}" target="_blank" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);transition:background 0.2s"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <span style="font-weight:600">{{ d.title|default:d.file.name }}</span>
          <span style="font-size:12px;color:var(--muted)">{{ d.created_at|date:"d.m.Y" }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
  {% endif %}
</div>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç API 3.0 #}
{% if obj.address or obj.actual_address %}
<script src="https://api-maps.yandex.ru/v3/?apikey=692ebf62729afc22637e1678&lang=ru_RU"></script>
<script type="text/javascript">
  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç
  var mapsData = [];
  {% if obj.address %}
  mapsData.push({
    address: '{{ obj.address|escapejs }}',
    containerId: 'map-legal',
    title: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å',
    isLegal: true
  });
  {% endif %}
  {% if obj.actual_address %}
  mapsData.push({
    address: '{{ obj.actual_address|escapejs }}',
    containerId: 'map-actual',
    title: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å',
    isLegal: false
  });
  {% endif %}

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ API 3.0
  ymaps3.ready.then(function() {
    mapsData.forEach(function(mapData) {
      initMap(mapData);
    });
  });

  // –§—É–Ω–∫—Ü–∏—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ HTTP API
  function geocodeAddress(searchAddr, apiKey) {
    return fetch('https://geocode-maps.yandex.ru/1.x/?apikey=' + apiKey + '&format=json&geocode=' + encodeURIComponent(searchAddr))
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data && data.response && data.response.GeoObjectCollection && 
            data.response.GeoObjectCollection.featureMember && 
            data.response.GeoObjectCollection.featureMember.length > 0) {
          var pos = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(' ');
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞] –¥–ª—è API 3.0
          return [parseFloat(pos[0]), parseFloat(pos[1])];
        }
        return null;
      })
      .catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞:', err);
        return null;
      });
  }
  
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è API 3.0
  function initMap(mapData) {
    var address = mapData.address;
    var containerId = mapData.containerId;
    var title = mapData.title;
    var isLegal = mapData.isLegal;
    var apiKey = '692ebf62729afc22637e1678';
    
    var YMap = ymaps3.YMap;
    var YMapDefaultSchemeLayer = ymaps3.YMapDefaultSchemeLayer;
    var YMapMarker = ymaps3.YMapMarker;
    
    // –°–æ–∑–¥–∞—ë–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    function createSearchVariants(addr) {
      var variants = [];
      var cleanAddr = addr.trim();
      var withoutIndex = cleanAddr.replace(/^\d{6},\s*/, '');
      
      var city = '';
      var street = '';
      var house = '';
      var building = '';
      var parts = withoutIndex.split(',').map(function(p) { return p.trim(); });
      
      for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        if (part.match(/^–ì\.–ú–û–°–ö–í–ê$/i) || part.match(/–ú–û–°–ö–í–ê/i)) {
          city = '–ú–æ—Å–∫–≤–∞';
        } else if (part.match(/^–ì\.–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì$/i) || part.match(/–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì/i) || part.match(/–ü–ï–¢–ï–†–ë–£–†–ì/i)) {
          city = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';
        } else if (part.match(/^–£–õ\./i)) {
          street = part.replace(/^–£–õ\.\s*/i, '').toLowerCase().replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        } else if (part.match(/^–ü–†-–ö–¢/i)) {
          var prospectName = part.replace(/^–ü–†-–ö–¢\s*/i, '');
          street = '–ø—Ä–æ—Å–ø–µ–∫—Ç ' + prospectName.toLowerCase().replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        } else if (part.match(/^–î\./i)) {
          house = part.replace(/^–î\.\s*/i, '');
        } else if (part.match(/^–ö\./i)) {
          building = part.replace(/^–ö\.\s*/i, '');
        }
      }
      
      if (city && street && house) {
        variants.push(city + ', ' + street + ', –¥. ' + house + (building ? ', –∫–æ—Ä–ø. ' + building : ''));
        variants.push(city + ', ' + street + ', ' + house);
      }
      
      var simple = withoutIndex
        .replace(/–ì\.–ú–û–°–ö–í–ê/gi, '–ú–æ—Å–∫–≤–∞')
        .replace(/–ì\.–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì/gi, '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')
        .replace(/–ü–†-–ö–¢/gi, '–ø—Ä–æ—Å–ø–µ–∫—Ç')
        .replace(/–£–õ\./gi, '—É–ª–∏—Ü–∞')
        .replace(/–î\./gi, '–¥.')
        .replace(/–ö\./gi, '–∫–æ—Ä–ø.');
      variants.push(simple);
      variants.push(withoutIndex);
      
      return variants.filter(function(v, i, self) {
        return self.indexOf(v) === i && v.length > 5;
      });
    }
    
    // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É API 3.0
    var container = document.getElementById(containerId);
    var map = new YMap(container, {
      location: {
        center: [37.617635, 55.755814], // –ú–æ—Å–∫–≤–∞ [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞]
        zoom: 10
      }
    });
    
    map.addChild(new YMapDefaultSchemeLayer());
    
    var searchVariants = createSearchVariants(address);
    console.log('–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞:', title, searchVariants);
    
    // –ü—Ä–æ–±—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞
    function tryGeocode(variantIndex) {
      if (variantIndex >= searchVariants.length) {
        console.warn('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è:', title);
        return;
      }
      
      var searchAddr = searchVariants[variantIndex];
      console.log('–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤–∞—Ä–∏–∞–Ω—Ç ' + (variantIndex + 1) + ':', searchAddr);
      
      geocodeAddress(searchAddr, apiKey).then(function(coordinates) {
        if (coordinates && coordinates.length === 2) {
          console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω! –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', coordinates);
          
          map.setLocation({
            center: coordinates,
            zoom: 15
          });
          
          var marker = new YMapMarker({
            coordinates: coordinates,
            title: title,
            color: isLegal ? '#3b82f6' : '#10b981'
          });
          
          map.addChild(marker);
        } else {
          tryGeocode(variantIndex + 1);
        }
      });
    }
    
    tryGeocode(0);
  }
</script>

<style>
@media (max-width:940px){
  .grid-2[style*="gap:16px"]{grid-template-columns:1fr}
  #map-legal,#map-actual{height:350px !important}
}
@media (max-width:640px){
  #map-legal,#map-actual{height:300px !important}
}
</style>
{% endif %}

{% endblock %}
