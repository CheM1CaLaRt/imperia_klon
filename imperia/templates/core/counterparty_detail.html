{% extends "base.html" %}
{% load humanize %}

{% block title %}–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç ‚Äî {{ obj.name }}{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-2">{{ obj.name }}</h1>

{# –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è operator/director #}
{% if can_edit_client %}
<div class="mb-4 flex gap-2">
  <a href="{% url 'core:counterparty_update' obj.pk %}" class="rounded-xl border px-3 py-1">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
  <a href="{% url 'core:counterparty_delete' obj.pk %}" class="rounded-xl border px-3 py-1 text-red-600">–£–¥–∞–ª–∏—Ç—å</a>
</div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- –†–µ–∫–≤–∏–∑–∏—Ç—ã -->
  <div class="rounded-xl border p-4">
    <h2 class="font-semibold mb-2">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div class="space-y-1 text-sm">
      <div><span class="text-gray-500">–ò–ù–ù:</span> {{ obj.inn }}</div>
      {% if obj.kpp %}<div><span class="text-gray-500">–ö–ü–ü:</span> {{ obj.kpp }}</div>{% endif %}
      {% if obj.ogrn %}<div><span class="text-gray-500">–û–ì–†–ù:</span> {{ obj.ogrn }}</div>{% endif %}
      {% if obj.full_name %}<div><span class="text-gray-500">–ü–æ–ª–Ω–æ–µ –∏–º—è:</span> {{ obj.full_name }}</div>{% endif %}
      {% if obj.address %}<div><span class="text-gray-500">–ê–¥—Ä–µ—Å:</span> {{ obj.address }}</div>{% endif %}
      {% if obj.website %}
      <div>
        <span class="text-gray-500">–°–∞–π—Ç:</span>
        <a href="{{ obj.website }}" class="text-blue-600" target="_blank" rel="noopener">{{ obj.website }}</a>
      </div>
      {% endif %}
      <div><span class="text-gray-500">–°—Ç—Ä–∞–Ω–∞:</span> {{ obj.registration_country }}</div>
      <div class="text-xs text-gray-500 mt-2">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at }}</div>
    </div>
  </div>

  <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
  <div class="rounded-xl border p-4">
    <h2 class="font-semibold mb-2">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>

    {% if can_edit_client %}
    <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" class="mb-3">
      {% csrf_token %}
      <button class="rounded-xl border px-3 py-1">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
    </form>
    {% endif %}

    {% if obj.finance %}
      <div class="space-y-1 text-sm">
        <div>
          <span class="text-gray-500">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥):</span>
          {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
        </div>
        <div>
          <span class="text-gray-500">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥):</span>
          {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
        </div>
      </div>
    {% else %}
      <p class="text-sm text-gray-500">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç.</p>
    {% endif %}
  </div>
</div>

<!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
<div class="rounded-xl border p-4 mt-4">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-semibold">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="rounded-xl border px-3 py-1">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div class="space-y-2 text-sm">
      {% for c in obj.contacts.all %}
        <div class="border rounded-lg p-2">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">{{ c.full_name }}</div>
              <div class="text-gray-600">{{ c.position }}</div>
            </div>
            {% if can_edit_contact %}
            <div class="flex gap-2">
              <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="text-blue-600 text-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="text-red-600 text-sm">–£–¥–∞–ª–∏—Ç—å</a>
            </div>
            {% endif %}
          </div>
          <div class="mt-1">
            {% if c.email %}<span class="mr-3">‚úâÔ∏è {{ c.email }}</span>{% endif %}
            {% if c.phone %}<span class="mr-3">‚òéÔ∏è {{ c.phone }}</span>{% endif %}
            {% if c.mobile %}<span>üì± {{ c.mobile }}</span>{% endif %}
          </div>
          {% if c.note %}<div class="text-gray-500 mt-1">{{ c.note }}</div>{% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-sm text-gray-500">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
  {% endif %}
</div>

<!-- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã (–≤–∏–∑—É–∞–ª—å–Ω–æ –∫–∞–∫ –∫–æ–Ω—Ç–∞–∫—Ç—ã) -->
<div class="rounded-xl border p-4 mt-4">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-semibold">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="rounded-xl border px-3 py-1">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div class="space-y-2 text-sm">
        {% for m in managers %}
          <div class="border rounded-lg p-2">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">{{ m.get_full_name|default:m.username }}</div>
                <div class="text-gray-600">
                  @{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}
                </div>
              </div>
              {% if can_edit_client %}
              <div>
                <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}">
                  {% csrf_token %}
                  <button type="submit" class="text-red-600 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
              </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-gray-500">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã.</p>
    {% endif %}
  {% endwith %}
</div>
{% endblock %}
