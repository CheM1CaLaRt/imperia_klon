{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ obj.name }} ‚Äî IndigoFlow{% endblock %}

{% block extra_head %}
  {# Leaflet CSS #}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  {# Yandex Maps API - –∑–∞–≥—Ä—É–∂–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ #}
  <script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º Yandex Maps API –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    (function() {
      var script = document.createElement('script');
      script.src = 'https://api-maps.yandex.ru/2.1/?apikey=&lang=ru_RU';
      script.type = 'text/javascript';
      script.async = true;
      script.onerror = function() {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Yandex Maps API, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback');
      };
      document.head.appendChild(script);
    })();
  </script>
  <style>
    #address-map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-top: 20px;
    }
    .map-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--muted);
      font-size: 14px;
    }
    .map-error {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #dc2626;
      font-size: 14px;
      background: #fee2e2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }
  </style>
{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ obj.name }}</h1>
      <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>
    {% if can_edit_client %}
      <div style="display:flex;gap:8px">
        <a href="{% url 'core:counterparty_update' obj.pk %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'core:counterparty_delete' obj.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid grid-2">
  {# –†–µ–∫–≤–∏–∑–∏—Ç—ã #}
  <div class="card">
    <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div style="display:grid;gap:12px">
      <div><span style="color:var(--muted);font-size:13px">–ò–ù–ù:</span> <span style="font-weight:600">{{ obj.inn }}</span></div>
      {% if obj.kpp %}<div><span style="color:var(--muted);font-size:13px">–ö–ü–ü:</span> <span style="font-weight:600">{{ obj.kpp }}</span></div>{% endif %}
      {% if obj.ogrn %}<div><span style="color:var(--muted);font-size:13px">–û–ì–†–ù:</span> <span style="font-weight:600">{{ obj.ogrn }}</span></div>{% endif %}
      {% if obj.full_name %}<div><span style="color:var(--muted);font-size:13px">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span> <div style="margin-top:4px">{{ obj.full_name }}</div></div>{% endif %}
      {% if obj.address %}
      <div>
        <span style="color:var(--muted);font-size:13px">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span>
        <div style="margin-top:4px">{{ obj.address }}</div>
        <a href="#" 
           class="btn btn-secondary yandex-map-link" 
           data-address="{{ obj.address|escapejs }}"
           style="margin-top:8px;font-size:13px;padding:6px 12px;display:inline-flex;align-items:center;gap:6px;text-decoration:none">
          <span>üó∫Ô∏è</span>
          <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
        </a>
      </div>
      {% endif %}
      {# –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ #}
      {% with addresses=obj.addresses.all %}
        {% if addresses %}
          <div>
            <span style="color:var(--muted);font-size:13px;font-weight:600;display:block;margin-bottom:12px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞–¥—Ä–µ—Å–∞ / –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
            <div style="display:flex;flex-direction:column;gap:12px">
              {% for addr in addresses %}
                <div style="padding:16px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;position:relative">
                  {% if addr.is_default %}
                    <div style="position:absolute;top:12px;right:12px;background:#3b82f6;color:white;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase">
                      –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    </div>
                    <div style="padding-right:100px;margin-bottom:8px">
                      <div style="font-weight:500;font-size:14px;color:#1f2937;line-height:1.5">{{ addr.address }}</div>
                    </div>
                  {% else %}
                    <div style="margin-bottom:8px">
                      <div style="font-weight:500;font-size:14px;color:#1f2937;line-height:1.5">{{ addr.address }}</div>
                    </div>
                  {% endif %}
                  <a href="#" 
                     class="btn btn-secondary yandex-map-link" 
                     data-address="{{ addr.address|escapejs }}"
                     style="font-size:13px;padding:6px 12px;display:inline-flex;align-items:center;gap:6px;text-decoration:none;background:#3b82f6;color:white;border:none;border-radius:8px;transition:all 0.2s"
                     onmouseover="this.style.background='#2563eb'"
                     onmouseout="this.style.background='#3b82f6'">
                    <span>üó∫Ô∏è</span>
                    <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                  </a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% elif obj.actual_address %}
          {# Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö #}
          <div>
            <span style="color:var(--muted);font-size:13px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span>
            <div style="margin-top:4px">{{ obj.actual_address }}</div>
            <a href="#" 
               class="btn btn-secondary yandex-map-link" 
               data-address="{{ obj.actual_address|escapejs }}"
               style="margin-top:8px;font-size:13px;padding:6px 12px;display:inline-flex;align-items:center;gap:6px;text-decoration:none">
              <span>üó∫Ô∏è</span>
              <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
            </a>
          </div>
        {% endif %}
      {% endwith %}
      {% if obj.website %}
        <div>
          <span style="color:var(--muted);font-size:13px">–°–∞–π—Ç:</span>
          <a href="{{ obj.website }}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-weight:600">{{ obj.website }}</a>
        </div>
      {% endif %}
      <div><span style="color:var(--muted);font-size:13px">–°—Ç—Ä–∞–Ω–∞:</span> <span style="font-weight:600">{{ obj.registration_country }}</span></div>
      <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at|date:"d.m.Y H:i" }}</div>
    </div>
  </div>

  {# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ #}
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:700;margin:0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      {% if can_edit_client %}
        <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" style="margin:0">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
        </form>
      {% endif %}
    </div>

    {% if obj.finance %}
      <div style="display:grid;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div style="color:var(--muted);font-size:14px;padding:24px;text-align:center">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
    {% endif %}
  </div>
</div>

{# –ö–∞—Ä—Ç–∞ –∞–¥—Ä–µ—Å–æ–≤ #}
{% if obj.address or obj.addresses.all or obj.actual_address %}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ö–∞—Ä—Ç–∞ –∞–¥—Ä–µ—Å–æ–≤</h2>
  <div id="address-map" class="map-loading">
    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</span>
  </div>
</div>
{% endif %}

{# –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
  <div class="grid grid-3">
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–∞–Ω–∫</div>
      <div style="font-weight:600">{{ obj.bank_name|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–ò–ö</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_bik|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_account|default:"‚Äî" }}</div>
    </div>
  </div>
</div>

{# –ö–æ–Ω—Ç–∞–∫—Ç—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div style="display:grid;gap:12px">
      {% for c in obj.contacts.all %}
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">{{ c.full_name }}</div>
              <div style="color:var(--muted);font-size:14px;margin-bottom:8px">{{ c.position }}</div>
              <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:14px">
                {% if c.email %}<span>‚úâÔ∏è <a href="mailto:{{ c.email }}" style="color:var(--primary);text-decoration:none">{{ c.email }}</a></span>{% endif %}
                {% if c.phone %}<span>‚òéÔ∏è <a href="tel:{{ c.phone }}" style="color:var(--text);text-decoration:none">{{ c.phone }}</a></span>{% endif %}
                {% if c.mobile %}<span>üì± <a href="tel:{{ c.mobile }}" style="color:var(--text);text-decoration:none">{{ c.mobile }}</a></span>{% endif %}
              </div>
              {% if c.note %}<div style="margin-top:8px;color:var(--muted);font-size:13px">{{ c.note }}</div>{% endif %}
            </div>
            {% if can_edit_contact %}
              <div style="display:flex;gap:8px">
                <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  {% endif %}
</div>

{# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="btn btn-secondary">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div style="display:grid;gap:12px">
        {% for m in managers %}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600;font-size:16px">{{ m.get_full_name|default:m.username }}</div>
              <div style="color:var(--muted);font-size:14px">@{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}</div>
            </div>
            {% if can_edit_client %}
              <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:24px;text-align:center;color:var(--muted)">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
    {% endif %}
  {% endwith %}
</div>

{# –î–æ–∫—É–º–µ–Ω—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  {% if obj.documents.all %}
    <div style="display:grid;gap:8px">
      {% for d in obj.documents.all %}
        <a href="{{ d.file.url }}" target="_blank" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);transition:background 0.2s"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <span style="font-weight:600">{{ d.title|default:d.file.name }}</span>
          <span style="font-size:12px;color:var(--muted)">{{ d.created_at|date:"d.m.Y" }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
  {% endif %}
</div>

{# Leaflet JS #}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ "–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ"
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.yandex-map-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var address = this.getAttribute('data-address');
      var url = 'https://yandex.ru/maps/?text=' + encodeURIComponent(address);
      window.open(url, '_blank', 'noopener,noreferrer');
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∞–¥—Ä–µ—Å–æ–≤
  const mapContainer = document.getElementById('address-map');
  if (mapContainer) {
    initAddressMap();
  }
});

// –§—É–Ω–∫—Ü–∏—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Yandex Maps Geocoder API
async function geocodeAddress(address, country = '–†–æ—Å—Å–∏—è') {
  if (!address || address.trim() === '') {
    console.warn('–ü—É—Å—Ç–æ–π –∞–¥—Ä–µ—Å –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è');
    return null;
  }

  const cleanAddress = address.trim();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ Yandex Maps API
  if (typeof ymaps === 'undefined') {
    console.error('Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    // Fallback –Ω–∞ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç
    return await geocodeAddressFallback(cleanAddress, country);
  }

  return new Promise((resolve) => {
    // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Yandex Maps API
    ymaps.ready(function() {
      const geocoder = ymaps.geocode(cleanAddress, {
        results: 1
      });
      
      geocoder.then(
        function(res) {
          const firstGeoObject = res.geoObjects.get(0);
          
          if (firstGeoObject) {
            const coords = firstGeoObject.geometry.getCoordinates();
            const displayName = firstGeoObject.getAddressLine();
            
            console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Yandex:', cleanAddress, '‚Üí', displayName);
            
            // Yandex Maps –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞], Leaflet –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
            resolve({
              lat: coords[1], // –®–∏—Ä–æ—Ç–∞
              lon: coords[0], // –î–æ–ª–≥–æ—Ç–∞
              display_name: displayName || cleanAddress
            });
          } else {
            console.warn('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Yandex:', cleanAddress);
            // –ü—Ä–æ–±—É–µ–º —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å "–ü—Ä."
            if (cleanAddress.match(/^[–ü–ø]—Ä\./)) {
              const addressWithCity = `${cleanAddress}, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥`;
              console.log('–ü—Ä–æ–±—É–µ–º —Å –≥–æ—Ä–æ–¥–æ–º:', addressWithCity);
              
              const geocoder2 = ymaps.geocode(addressWithCity, { results: 1 });
              geocoder2.then(
                function(res2) {
                  const firstGeoObject2 = res2.geoObjects.get(0);
                  if (firstGeoObject2) {
                    const coords2 = firstGeoObject2.geometry.getCoordinates();
                    const displayName2 = firstGeoObject2.getAddressLine();
                    console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω —Å –≥–æ—Ä–æ–¥–æ–º:', addressWithCity, '‚Üí', displayName2);
                    // Yandex Maps –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞], Leaflet –∏—Å–ø–æ–ª—å–∑—É–µ—Ç [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
                    resolve({
                      lat: coords2[1], // –®–∏—Ä–æ—Ç–∞
                      lon: coords2[0], // –î–æ–ª–≥–æ—Ç–∞
                      display_name: displayName2 || addressWithCity
                    });
                  } else {
                    // Fallback –Ω–∞ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç
                    geocodeAddressFallback(cleanAddress, country).then(resolve);
                  }
                },
                function(err) {
                  console.warn('–û—à–∏–±–∫–∞ Yandex Geocoder:', err);
                  geocodeAddressFallback(cleanAddress, country).then(resolve);
                }
              );
            } else {
              // Fallback –Ω–∞ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç
              geocodeAddressFallback(cleanAddress, country).then(resolve);
            }
          }
        },
        function(err) {
          console.warn('–û—à–∏–±–∫–∞ Yandex Geocoder:', err);
          // Fallback –Ω–∞ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç
          geocodeAddressFallback(cleanAddress, country).then(resolve);
        }
      );
    });
  });
}

// Fallback —Ñ—É–Ω–∫—Ü–∏—è —á–µ—Ä–µ–∑ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç (Nominatim)
async function geocodeAddressFallback(address, country = '–†–æ—Å—Å–∏—è') {
  try {
    const url = `{% url 'core:geocode_address' %}?address=${encodeURIComponent(address)}&country=${encodeURIComponent(country)}`;
    
    console.log('–ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Django-—ç–Ω–¥–ø–æ–∏–Ω—Ç (fallback):', address);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
      credentials: 'same-origin'
    });
    
    if (!response.ok) {
      console.warn(`HTTP ${response.status} –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:`, address);
      return null;
    }
    
    const data = await response.json();
    
    if (data.success && data.lat && data.lon) {
      console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Nominatim:', address, '‚Üí', data.display_name);
      return {
        lat: parseFloat(data.lat),
        lon: parseFloat(data.lon),
        display_name: data.display_name
      };
    } else {
      console.warn('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Nominatim:', address, data.error || '');
      return null;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–¥—Ä–µ—Å–∞:', address, error);
    return null;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
async function initAddressMap() {
  const mapContainer = document.getElementById('address-map');
  if (!mapContainer) return;

  // –°–æ–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–∞
  const addresses = [];
  
  // –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
  {% if obj.address %}
  addresses.push({
    address: '{{ obj.address|escapejs }}',
    type: 'legal',
    label: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å'
  });
  {% endif %}
  
  // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞–¥—Ä–µ—Å–∞
  {% with addresses=obj.addresses.all %}
    {% if addresses %}
      {% for addr in addresses %}
      addresses.push({
        address: '{{ addr.address|escapejs }}',
        type: 'actual',
        label: '{{ addr.is_default|yesno:"–ê–¥—Ä–µ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å" }}'
      });
      {% endfor %}
    {% elif obj.actual_address %}
      addresses.push({
        address: '{{ obj.actual_address|escapejs }}',
        type: 'actual',
        label: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å'
      });
    {% endif %}
  {% endwith %}

  console.log('–°–æ–±—Ä–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞:', addresses);

  if (addresses.length === 0) {
    mapContainer.className = 'map-error';
    mapContainer.innerHTML = '<span>–ê–¥—Ä–µ—Å–∞ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>';
    return;
  }

  // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ø—É—Å—Ç—ã–µ –∞–¥—Ä–µ—Å–∞
  const uniqueAddresses = [];
  const seenAddresses = new Set();
  
  for (const addr of addresses) {
    if (!addr.address || typeof addr.address !== 'string') {
      console.warn('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å:', addr);
      continue;
    }
    
    const normalized = addr.address.trim().toLowerCase();
    if (normalized === '') {
      console.warn('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç–æ–π –∞–¥—Ä–µ—Å');
      continue;
    }
    
    if (!seenAddresses.has(normalized)) {
      seenAddresses.add(normalized);
      uniqueAddresses.push({
        ...addr,
        address: addr.address.trim() // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
      });
    }
  }

  console.log('–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', uniqueAddresses);

  // –ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º –≤—Å–µ –∞–¥—Ä–µ—Å–∞
  mapContainer.className = 'map-loading';
  mapContainer.innerHTML = '<span>–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ...</span>';

  console.log('–ù–∞—á–∏–Ω–∞–µ–º –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤:', uniqueAddresses);

  const geocodedAddresses = [];
  const failedAddresses = [];
  
  // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
  const country = '{{ obj.registration_country|default:"–†–æ—Å—Å–∏—è"|escapejs }}' || '–†–æ—Å—Å–∏—è';
  
  for (let i = 0; i < uniqueAddresses.length; i++) {
    const addr = uniqueAddresses[i];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
    if (uniqueAddresses.length > 1) {
      mapContainer.innerHTML = `<span>–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ... (${i + 1}/${uniqueAddresses.length})</span>`;
    }
    
    console.log(`–ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å ${i + 1}/${uniqueAddresses.length}:`, addr.address);
    const coords = await geocodeAddress(addr.address, country);
    
    if (coords) {
      geocodedAddresses.push({
        ...addr,
        lat: coords.lat,
        lon: coords.lon,
        display_name: coords.display_name
      });
      console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω:', addr.address, coords);
    } else {
      failedAddresses.push(addr.address);
      console.warn('‚úó –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω:', addr.address);
    }
    
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ (–∏–∑–±–µ–≥–∞–µ–º rate limiting Nominatim)
    // Nominatim —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É
    if (i < uniqueAddresses.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 1100));
    }
  }

  if (geocodedAddresses.length === 0) {
    mapContainer.className = 'map-error';
    let errorMsg = '<div style="text-align:center;padding:20px;"><div style="font-weight:600;margin-bottom:8px;">–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</div>';
    if (failedAddresses.length > 0) {
      errorMsg += '<div style="font-size:12px;color:#6b7280;margin-top:8px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ –Ω–∞–π—Ç–∏:<br>';
      failedAddresses.forEach(addr => {
        errorMsg += `‚Ä¢ ${addr}<br>`;
      });
      errorMsg += '</div>';
    }
    errorMsg += '</div>';
    mapContainer.innerHTML = errorMsg;
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞. –ü—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è –∞–¥—Ä–µ—Å–∞:', failedAddresses);
    return;
  }

  if (failedAddresses.length > 0) {
    console.warn('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:', failedAddresses);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
  const map = L.map('address-map').setView(
    [geocodedAddresses[0].lat, geocodedAddresses[0].lon],
    geocodedAddresses.length > 1 ? 12 : 15
  );

  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
  }).addTo(map);

  // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏
  const markers = [];
  const colors = {
    legal: '#dc2626',    // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ
    actual: '#3b82f6'    // –°–∏–Ω–∏–π –¥–ª—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ
  };

  geocodedAddresses.forEach((addr, index) => {
    const color = colors[addr.type] || '#6b7280';
    const icon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="
        background-color: ${color};
        width: 24px;
        height: 24px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      "></div>`,
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });

    const marker = L.marker([addr.lat, addr.lon], { icon: icon }).addTo(map);
    
    marker.bindPopup(`
      <div style="font-weight: 600; margin-bottom: 4px; color: ${color};">${addr.label}</div>
      <div style="font-size: 13px; color: #6b7280;">${addr.address}</div>
    `);

    markers.push(marker);
  });

  // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–∫, –ø–æ–¥–≥–æ–Ω—è–µ–º –∑—É–º —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
  if (markers.length > 1) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }

  // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
  mapContainer.className = '';
}
</script>

{% endblock %}
