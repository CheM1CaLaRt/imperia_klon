{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ obj.name }} ‚Äî IndigoFlow{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ obj.name }}</h1>
      <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>
    {% if can_edit_client %}
      <div style="display:flex;gap:8px">
        <a href="{% url 'core:counterparty_update' obj.pk %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'core:counterparty_delete' obj.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid grid-2">
  {# –†–µ–∫–≤–∏–∑–∏—Ç—ã #}
  <div class="card">
    <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div style="display:grid;gap:12px">
      <div><span style="color:var(--muted);font-size:13px">–ò–ù–ù:</span> <span style="font-weight:600">{{ obj.inn }}</span></div>
      {% if obj.kpp %}<div><span style="color:var(--muted);font-size:13px">–ö–ü–ü:</span> <span style="font-weight:600">{{ obj.kpp }}</span></div>{% endif %}
      {% if obj.ogrn %}<div><span style="color:var(--muted);font-size:13px">–û–ì–†–ù:</span> <span style="font-weight:600">{{ obj.ogrn }}</span></div>{% endif %}
      {% if obj.full_name %}<div><span style="color:var(--muted);font-size:13px">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span> <div style="margin-top:4px">{{ obj.full_name }}</div></div>{% endif %}
      {% if obj.address %}<div><span style="color:var(--muted);font-size:13px">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.address }}</div></div>{% endif %}
      {% if obj.actual_address %}<div><span style="color:var(--muted);font-size:13px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.actual_address }}</div></div>{% endif %}
      {% if obj.website %}
        <div>
          <span style="color:var(--muted);font-size:13px">–°–∞–π—Ç:</span>
          <a href="{{ obj.website }}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-weight:600">{{ obj.website }}</a>
        </div>
      {% endif %}
      <div><span style="color:var(--muted);font-size:13px">–°—Ç—Ä–∞–Ω–∞:</span> <span style="font-weight:600">{{ obj.registration_country }}</span></div>
      <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at|date:"d.m.Y H:i" }}</div>
    </div>
  </div>

  {# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ #}
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:700;margin:0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      {% if can_edit_client %}
        <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" style="margin:0">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
        </form>
      {% endif %}
    </div>

    {% if obj.finance %}
      <div style="display:grid;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div style="color:var(--muted);font-size:14px;padding:24px;text-align:center">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
    {% endif %}
  </div>
</div>

{# –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ #}
{% if obj.address or obj.actual_address %}
<div style="margin-top:16px">
  {% if obj.address and obj.actual_address %}
    {# –û–±–µ –∫–∞—Ä—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ #}
    <div class="grid grid-2" style="gap:16px">
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
            –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
        </div>
        <div id="map-legal" style="width:100%;height:420px"></div>
      </div>
      
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
            –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
        </div>
        <div id="map-actual" style="width:100%;height:420px"></div>
      </div>
    </div>
  {% elif obj.address %}
    {# –¢–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
          –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
      </div>
      <div id="map-legal" style="width:100%;height:420px"></div>
    </div>
  {% elif obj.actual_address %}
    {# –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
          –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
      </div>
      <div id="map-actual" style="width:100%;height:420px"></div>
    </div>
  {% endif %}
</div>
{% endif %}

{# –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
  <div class="grid grid-3">
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–∞–Ω–∫</div>
      <div style="font-weight:600">{{ obj.bank_name|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–ò–ö</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_bik|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_account|default:"‚Äî" }}</div>
    </div>
  </div>
</div>

{# –ö–æ–Ω—Ç–∞–∫—Ç—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div style="display:grid;gap:12px">
      {% for c in obj.contacts.all %}
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">{{ c.full_name }}</div>
              <div style="color:var(--muted);font-size:14px;margin-bottom:8px">{{ c.position }}</div>
              <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:14px">
                {% if c.email %}<span>‚úâÔ∏è <a href="mailto:{{ c.email }}" style="color:var(--primary);text-decoration:none">{{ c.email }}</a></span>{% endif %}
                {% if c.phone %}<span>‚òéÔ∏è <a href="tel:{{ c.phone }}" style="color:var(--text);text-decoration:none">{{ c.phone }}</a></span>{% endif %}
                {% if c.mobile %}<span>üì± <a href="tel:{{ c.mobile }}" style="color:var(--text);text-decoration:none">{{ c.mobile }}</a></span>{% endif %}
              </div>
              {% if c.note %}<div style="margin-top:8px;color:var(--muted);font-size:13px">{{ c.note }}</div>{% endif %}
            </div>
            {% if can_edit_contact %}
              <div style="display:flex;gap:8px">
                <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  {% endif %}
</div>

{# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="btn btn-secondary">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div style="display:grid;gap:12px">
        {% for m in managers %}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600;font-size:16px">{{ m.get_full_name|default:m.username }}</div>
              <div style="color:var(--muted);font-size:14px">@{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}</div>
            </div>
            {% if can_edit_client %}
              <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:24px;text-align:center;color:var(--muted)">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
    {% endif %}
  {% endwith %}
</div>

{# –î–æ–∫—É–º–µ–Ω—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  {% if obj.documents.all %}
    <div style="display:grid;gap:8px">
      {% for d in obj.documents.all %}
        <a href="{{ d.file.url }}" target="_blank" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);transition:background 0.2s"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <span style="font-weight:600">{{ d.title|default:d.file.name }}</span>
          <span style="font-size:12px;color:var(--muted)">{{ d.created_at|date:"d.m.Y" }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
  {% endif %}
</div>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç #}
{% if obj.address or obj.actual_address %}
<script>
(function() {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç
  window.yandexMapsData = window.yandexMapsData || [];
  {% if obj.address %}
  window.yandexMapsData.push({
    address: '{{ obj.address|escapejs }}',
    containerId: 'map-legal',
    title: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å'
  });
  {% endif %}
  {% if obj.actual_address %}
  window.yandexMapsData.push({
    address: '{{ obj.actual_address|escapejs }}',
    containerId: 'map-actual',
    title: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å'
  });
  {% endif %}
})();
</script>
<script src="https://api-maps.yandex.ru/2.1/?apikey=61d952c3-f131-4b50-89c4-7035053deeaf&lang=ru_RU" type="text/javascript" onerror="console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç');"></script>
<script>
(function() {
  'use strict';
  
  function showError(containerId, address, errorText) {
    var container = document.getElementById(containerId);
    if (!container) return;
    var shortAddr = address.length > 60 ? address.substring(0, 60) + '...' : address;
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;text-align:center;padding:32px;background:#f6f7f8"><div><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="font-size:14px;margin-bottom:4px;color:#ef4444">' + errorText + '</div><div style="font-size:12px;opacity:0.8;margin-top:8px">' + shortAddr + '</div></div></div>';
  }

  function showLoading(containerId) {
    var container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;background:#f6f7f8"><div style="text-align:center"><div style="font-size:32px;margin-bottom:8px">üìç</div><div style="font-size:14px">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div></div></div>';
  }

  function initMap(mapData) {
    var address = mapData.address;
    var containerId = mapData.containerId;
    var title = mapData.title;
    
    if (!address || !containerId) {
      console.warn('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã');
      return;
    }
    
    var container = document.getElementById(containerId);
    if (!container) {
      console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω:', containerId);
      return;
    }

    showLoading(containerId);

    try {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞–¥—Ä–µ—Å –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –ï–ì–†–Æ–õ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≥–µ–æ–∫–æ–¥–µ—Ä–∞
      // –ü—Ä–∏–º–µ—Ä: "105066, –ì.–ú–û–°–ö–í–ê, –£–õ. –ù–ò–ñ–ù–Ø–Ø –ö–†–ê–°–ù–û–°–ï–õ–¨–°–ö–ê–Ø, –î. 40/12" 
      // -> "–ú–æ—Å–∫–≤–∞, –ù–∏–∂–Ω—è—è –ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è —É–ª–∏—Ü–∞, 40/12"
      
      var cleanAddr = address.trim();
      var searchVariants = [];
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞
      var parts = cleanAddr.split(',').map(function(p) { return p.trim(); });
      
      // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
      var normalized = '';
      var city = '';
      var street = '';
      var house = '';
      
      for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å
        if (/^\d{6}$/.test(part)) continue;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ—Ä–æ–¥
        if (part.match(/^–ì\.–ú–û–°–ö–í–ê$/i)) {
          city = '–ú–æ—Å–∫–≤–∞';
          continue;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É–ª–∏—Ü—É
        if (part.match(/^–£–õ\./i)) {
          street = part.replace(/^–£–õ\.\s*/i, '');
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
          street = street.replace(/([–ê-–Ø–Å])([–ê-–Ø–Å]+)/g, function(m, first, rest) {
            return first + rest.toLowerCase();
          }) + ' —É–ª–∏—Ü–∞';
          continue;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º
        if (part.match(/^–î\./i)) {
          house = part.replace(/^–î\.\s*/i, '');
          continue;
        }
      }
      
      // –°–æ–±–∏—Ä–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
      if (city && street && house) {
        normalized = city + ', ' + street + ', ' + house;
        searchVariants.push(normalized);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
      var variant1 = cleanAddr.replace(/–ì\.–ú–û–°–ö–í–ê/gi, '–ú–æ—Å–∫–≤–∞');
      searchVariants.push(variant1);
      
      var variant2 = cleanAddr.replace(/^\d{6},\s*/, '');
      if (variant2 !== cleanAddr) {
        var variant2Fixed = variant2.replace(/–ì\.–ú–û–°–ö–í–ê/gi, '–ú–æ—Å–∫–≤–∞');
        searchVariants.push(variant2Fixed);
      }
      
      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
      searchVariants = searchVariants.filter(function(item, index, self) {
        return self.indexOf(item) === index && item.length > 5;
      });
      
      console.log('–ò—Å—Ö–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å:', address);
      console.log('–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞:', searchVariants);

      if (typeof ymaps === 'undefined') {
        showError(containerId, address, '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
      }

      // –ü—Ä–æ–±—É–µ–º –≥–µ–æ–∫–æ–¥–∏–Ω–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∞–¥—Ä–µ—Å–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏
      function tryNextVariant(index) {
        if (index >= searchVariants.length) {
          showError(containerId, address, '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ');
          return;
        }
        
        var searchAddr = searchVariants[index];
        console.log('–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤–∞—Ä–∏–∞–Ω—Ç ' + (index + 1) + ':', searchAddr);
        
        // –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ —Å —Å–∞–π—Ç–∞)
        var geocoder = ymaps.geocode(searchAddr);
        
        geocoder.then(function(res) {
          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
            if (!res || !res.geoObjects || res.geoObjects.getLength() === 0) {
              console.warn('–í–∞—Ä–∏–∞–Ω—Ç ' + (index + 1) + ' –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π...');
              tryNextVariant(index + 1);
              return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
            var firstGeoObject = res.geoObjects.get(0);
            if (!firstGeoObject) {
              tryNextVariant(index + 1);
              return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
            var coordinates = firstGeoObject.geometry.getCoordinates();
            
            if (!coordinates || !Array.isArray(coordinates) || coordinates.length !== 2) {
              tryNextVariant(index + 1);
              return;
            }

            console.log('–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω! –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', coordinates);

            // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É
            var map = new ymaps.Map(containerId, {
              center: coordinates,
              zoom: 15,
              controls: ['zoomControl', 'fullscreenControl']
            });

            var isLegal = title.indexOf('–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π') !== -1;
            
            // –°–æ–∑–¥–∞—ë–º –º–µ—Ç–∫—É (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ —Å —Å–∞–π—Ç–∞)
            var placemark = new ymaps.Placemark(
              coordinates,
              {
                hintContent: address,
                balloonContent: '<strong>' + title + '</strong><br/>' + address
              },
              {
                preset: isLegal ? 'islands#blueCircleDotIcon' : 'islands#greenCircleDotIcon',
                iconColor: isLegal ? '#3b82f6' : '#10b981'
              }
            );

            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
            map.geoObjects.add(placemark);
            
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
            map.behaviors.disable('scrollZoom');
            
          } catch(e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã:', e);
            tryNextVariant(index + 1);
          }
        }, function(err) {
          console.warn('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ ' + (index + 1) + ':', err);
          tryNextVariant(index + 1);
        });
      }
      
      // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
      tryNextVariant(0);
    } catch(e) {
      console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', e);
      showError(containerId, address, '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  }

  function startInit() {
    if (!window.yandexMapsData || !Array.isArray(window.yandexMapsData)) {
      console.warn('–î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      return;
    }

    var maxAttempts = 50;
    var attempt = 0;

    function checkAndInit() {
      attempt++;
      if (typeof ymaps !== 'undefined' && typeof ymaps.ready === 'function') {
        ymaps.ready(function() {
          try {
            for (var i = 0; i < window.yandexMapsData.length; i++) {
              initMap(window.yandexMapsData[i]);
            }
          } catch(e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç:', e);
          }
        });
      } else if (attempt < maxAttempts) {
        setTimeout(checkAndInit, 200);
      } else {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç');
        if (window.yandexMapsData) {
          for (var j = 0; j < window.yandexMapsData.length; j++) {
            showError(window.yandexMapsData[j].containerId, window.yandexMapsData[j].address, '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
          }
        }
      }
    }

    checkAndInit();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startInit);
  } else {
    startInit();
  }
})();
</script>

<style>
@media (max-width:940px){
  .grid-2[style*="gap:16px"]{grid-template-columns:1fr}
  #map-legal,#map-actual{height:350px !important}
}
@media (max-width:640px){
  #map-legal,#map-actual{height:300px !important}
}
</style>
{% endif %}

{% endblock %}
