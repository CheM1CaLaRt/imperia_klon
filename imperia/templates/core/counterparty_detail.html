{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ obj.name }} ‚Äî IndigoFlow{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ obj.name }}</h1>
      <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>
    {% if can_edit_client %}
      <div style="display:flex;gap:8px">
        <a href="{% url 'core:counterparty_update' obj.pk %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'core:counterparty_delete' obj.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid grid-2">
  {# –†–µ–∫–≤–∏–∑–∏—Ç—ã #}
  <div class="card">
    <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div style="display:grid;gap:12px">
      <div><span style="color:var(--muted);font-size:13px">–ò–ù–ù:</span> <span style="font-weight:600">{{ obj.inn }}</span></div>
      {% if obj.kpp %}<div><span style="color:var(--muted);font-size:13px">–ö–ü–ü:</span> <span style="font-weight:600">{{ obj.kpp }}</span></div>{% endif %}
      {% if obj.ogrn %}<div><span style="color:var(--muted);font-size:13px">–û–ì–†–ù:</span> <span style="font-weight:600">{{ obj.ogrn }}</span></div>{% endif %}
      {% if obj.full_name %}<div><span style="color:var(--muted);font-size:13px">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span> <div style="margin-top:4px">{{ obj.full_name }}</div></div>{% endif %}
      {% if obj.address %}<div><span style="color:var(--muted);font-size:13px">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.address }}</div></div>{% endif %}
      {% if obj.actual_address %}<div><span style="color:var(--muted);font-size:13px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.actual_address }}</div></div>{% endif %}
      {% if obj.website %}
        <div>
          <span style="color:var(--muted);font-size:13px">–°–∞–π—Ç:</span>
          <a href="{{ obj.website }}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-weight:600">{{ obj.website }}</a>
        </div>
      {% endif %}
      <div><span style="color:var(--muted);font-size:13px">–°—Ç—Ä–∞–Ω–∞:</span> <span style="font-weight:600">{{ obj.registration_country }}</span></div>
      <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at|date:"d.m.Y H:i" }}</div>
    </div>
  </div>

  {# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ #}
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:700;margin:0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      {% if can_edit_client %}
        <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" style="margin:0">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
        </form>
      {% endif %}
    </div>

    {% if obj.finance %}
      <div style="display:grid;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div style="color:var(--muted);font-size:14px;padding:24px;text-align:center">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
    {% endif %}
  </div>
</div>

{# –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ #}
{% if obj.address or obj.actual_address %}
<div style="margin-top:16px">
  {% if obj.address and obj.actual_address %}
    {# –û–±–µ –∫–∞—Ä—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ #}
    <div class="grid grid-2" style="gap:16px">
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
            –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
        </div>
        <div id="map-legal" style="width:100%;height:420px"></div>
      </div>
      
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
            –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
        </div>
        <div id="map-actual" style="width:100%;height:420px"></div>
      </div>
    </div>
  {% elif obj.address %}
    {# –¢–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
          –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
      </div>
      <div id="map-legal" style="width:100%;height:420px"></div>
    </div>
  {% elif obj.actual_address %}
    {# –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
          –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
      </div>
      <div id="map-actual" style="width:100%;height:420px"></div>
    </div>
  {% endif %}
</div>
{% endif %}

{# –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
  <div class="grid grid-3">
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–∞–Ω–∫</div>
      <div style="font-weight:600">{{ obj.bank_name|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–ò–ö</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_bik|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_account|default:"‚Äî" }}</div>
    </div>
  </div>
</div>

{# –ö–æ–Ω—Ç–∞–∫—Ç—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div style="display:grid;gap:12px">
      {% for c in obj.contacts.all %}
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">{{ c.full_name }}</div>
              <div style="color:var(--muted);font-size:14px;margin-bottom:8px">{{ c.position }}</div>
              <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:14px">
                {% if c.email %}<span>‚úâÔ∏è <a href="mailto:{{ c.email }}" style="color:var(--primary);text-decoration:none">{{ c.email }}</a></span>{% endif %}
                {% if c.phone %}<span>‚òéÔ∏è <a href="tel:{{ c.phone }}" style="color:var(--text);text-decoration:none">{{ c.phone }}</a></span>{% endif %}
                {% if c.mobile %}<span>üì± <a href="tel:{{ c.mobile }}" style="color:var(--text);text-decoration:none">{{ c.mobile }}</a></span>{% endif %}
              </div>
              {% if c.note %}<div style="margin-top:8px;color:var(--muted);font-size:13px">{{ c.note }}</div>{% endif %}
            </div>
            {% if can_edit_contact %}
              <div style="display:flex;gap:8px">
                <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  {% endif %}
</div>

{# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="btn btn-secondary">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div style="display:grid;gap:12px">
        {% for m in managers %}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600;font-size:16px">{{ m.get_full_name|default:m.username }}</div>
              <div style="color:var(--muted);font-size:14px">@{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}</div>
            </div>
            {% if can_edit_client %}
              <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:24px;text-align:center;color:var(--muted)">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
    {% endif %}
  {% endwith %}
</div>

{# –î–æ–∫—É–º–µ–Ω—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  {% if obj.documents.all %}
    <div style="display:grid;gap:8px">
      {% for d in obj.documents.all %}
        <a href="{{ d.file.url }}" target="_blank" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);transition:background 0.2s"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <span style="font-weight:600">{{ d.title|default:d.file.name }}</span>
          <span style="font-size:12px;color:var(--muted)">{{ d.created_at|date:"d.m.Y" }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
  {% endif %}
</div>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç #}
{% if obj.address or obj.actual_address %}
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
(function() {
  if (typeof ymaps === 'undefined') {
    console.warn('–Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    return;
  }

  ymaps.ready(function() {
    // –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
    function initMap(address, mapContainerId, title) {
      if (!address || !mapContainerId) return;
      
      const mapContainer = document.getElementById(mapContainerId);
      if (!mapContainer) return;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div style="font-size:32px;margin-bottom:8px">üìç</div><div style="font-size:14px">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div></div></div>';

      ymaps.geocode(address, {
        results: 1
      }).then(function(res) {
        const firstGeoObject = res.geoObjects.get(0);
        
        if (!firstGeoObject) {
          mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);text-align:center;padding:32px"><div><div style="font-size:32px;margin-bottom:8px">üìç</div><div style="font-size:14px;margin-bottom:4px">–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ</div><div style="font-size:12px;opacity:0.8">' + (address.length > 60 ? address.substring(0, 60) + '...' : address) + '</div></div></div>';
          return;
        }

        const coords = firstGeoObject.geometry.getCoordinates();
        const bounds = firstGeoObject.properties.get('boundedBy');

        const map = new ymaps.Map(mapContainerId, {
          center: coords,
          zoom: 15,
          controls: ['zoomControl', 'fullscreenControl']
        });

        const shortAddress = address.split(',').slice(0, 2).join(',');
        const metaText = firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData.text') || address;
        
        const placemark = new ymaps.Placemark(coords, {
          balloonContentHeader: '<strong style="font-size:16px;display:block;margin-bottom:8px">' + title + '</strong>',
          balloonContentBody: '<div style="color:#666;line-height:1.6;margin-bottom:8px">' + address + '</div>',
          hintContent: shortAddress
        }, {
          preset: title.includes('–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π') ? 'islands#blueCircleDotIcon' : 'islands#greenCircleDotIcon',
          iconColor: title.includes('–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π') ? '#3b82f6' : '#10b981',
          draggable: false
        });

        map.geoObjects.add(placemark);

        if (bounds) {
          map.setBounds(bounds, {
            checkZoomRange: true,
            duration: 300
          });
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
        map.behaviors.disable('scrollZoom');
      }).catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –¥–ª—è ' + mapContainerId + ':', err);
        mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);text-align:center;padding:32px"><div><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="font-size:14px">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</div></div></div>';
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç
    {% if obj.address %}
      initMap('{{ obj.address|escapejs }}', 'map-legal', '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å');
    {% endif %}

    {% if obj.actual_address %}
      initMap('{{ obj.actual_address|escapejs }}', 'map-actual', '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å');
    {% endif %}
  });
})();
</script>

<style>
@media (max-width:940px){
  .grid-2[style*="gap:16px"]{grid-template-columns:1fr}
  #map-legal,#map-actual{height:350px !important}
}
@media (max-width:640px){
  #map-legal,#map-actual{height:300px !important}
}
</style>
{% endif %}

{% endblock %}
