{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ obj.name }} ‚Äî IndigoFlow{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ obj.name }}</h1>
      <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>
    {% if can_edit_client %}
      <div style="display:flex;gap:8px">
        <a href="{% url 'core:counterparty_update' obj.pk %}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'core:counterparty_delete' obj.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid grid-2">
  {# –†–µ–∫–≤–∏–∑–∏—Ç—ã #}
  <div class="card">
    <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
    <div style="display:grid;gap:12px">
      <div><span style="color:var(--muted);font-size:13px">–ò–ù–ù:</span> <span style="font-weight:600">{{ obj.inn }}</span></div>
      {% if obj.kpp %}<div><span style="color:var(--muted);font-size:13px">–ö–ü–ü:</span> <span style="font-weight:600">{{ obj.kpp }}</span></div>{% endif %}
      {% if obj.ogrn %}<div><span style="color:var(--muted);font-size:13px">–û–ì–†–ù:</span> <span style="font-weight:600">{{ obj.ogrn }}</span></div>{% endif %}
      {% if obj.full_name %}<div><span style="color:var(--muted);font-size:13px">–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span> <div style="margin-top:4px">{{ obj.full_name }}</div></div>{% endif %}
      {% if obj.address %}<div><span style="color:var(--muted);font-size:13px">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.address }}</div></div>{% endif %}
      {% if obj.actual_address %}<div><span style="color:var(--muted);font-size:13px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:</span> <div style="margin-top:4px">{{ obj.actual_address }}</div></div>{% endif %}
      {% if obj.website %}
        <div>
          <span style="color:var(--muted);font-size:13px">–°–∞–π—Ç:</span>
          <a href="{{ obj.website }}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-weight:600">{{ obj.website }}</a>
        </div>
      {% endif %}
      <div><span style="color:var(--muted);font-size:13px">–°—Ç—Ä–∞–Ω–∞:</span> <span style="font-weight:600">{{ obj.registration_country }}</span></div>
      <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ obj.updated_at|date:"d.m.Y H:i" }}</div>
    </div>
  </div>

  {# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ #}
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:700;margin:0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      {% if can_edit_client %}
        <form method="post" action="{% url 'core:counterparty_refresh_finance' obj.pk %}" style="margin:0">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –ï–ì–†–Æ–õ</button>
        </form>
      {% endif %}
    </div>

    {% if obj.finance %}
      <div style="display:grid;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–í—ã—Ä—É—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.revenue_last %}{{ obj.finance.revenue_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</div>
          <div style="font-size:20px;font-weight:700;color:var(--primary)">
            {% if obj.finance.profit_last is not None %}{{ obj.finance.profit_last|floatformat:0|intcomma }} ‚ÇΩ{% else %}‚Äî{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div style="color:var(--muted);font-size:14px;padding:24px;text-align:center">–§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
    {% endif %}
  </div>
</div>

{# –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ #}
{% if obj.address or obj.actual_address %}
<div style="margin-top:16px">
  {% if obj.address and obj.actual_address %}
    {# –û–±–µ –∫–∞—Ä—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ #}
    <div class="grid grid-2" style="gap:16px">
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
            –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
        </div>
        <div id="map-legal" style="width:100%;height:420px"></div>
      </div>
      
      <div class="card" style="overflow:hidden;padding:0">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
          <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
            –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          </h2>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
        </div>
        <div id="map-actual" style="width:100%;height:420px"></div>
      </div>
    </div>
  {% elif obj.address %}
    {# –¢–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
          –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.address }}</div>
      </div>
      <div id="map-legal" style="width:100%;height:420px"></div>
    </div>
  {% elif obj.actual_address %}
    {# –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π #}
    <div class="card" style="overflow:hidden;padding:0">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px">
          <span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>
          –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        </h2>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">{{ obj.actual_address }}</div>
      </div>
      <div id="map-actual" style="width:100%;height:420px"></div>
    </div>
  {% endif %}
</div>
{% endif %}

{# –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
  <div class="grid grid-3">
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–∞–Ω–∫</div>
      <div style="font-weight:600">{{ obj.bank_name|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–ë–ò–ö</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_bik|default:"‚Äî" }}</div>
    </div>
    <div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</div>
      <div style="font-weight:600;font-family:ui-monospace">{{ obj.bank_account|default:"‚Äî" }}</div>
    </div>
  </div>
</div>

{# –ö–æ–Ω—Ç–∞–∫—Ç—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ª–∏—Ü–∞</h2>
    {% if can_add_contact %}
      <a href="{% url 'core:contact_add' obj.pk %}" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</a>
    {% endif %}
  </div>

  {% if obj.contacts.all %}
    <div style="display:grid;gap:12px">
      {% for c in obj.contacts.all %}
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">{{ c.full_name }}</div>
              <div style="color:var(--muted);font-size:14px;margin-bottom:8px">{{ c.position }}</div>
              <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:14px">
                {% if c.email %}<span>‚úâÔ∏è <a href="mailto:{{ c.email }}" style="color:var(--primary);text-decoration:none">{{ c.email }}</a></span>{% endif %}
                {% if c.phone %}<span>‚òéÔ∏è <a href="tel:{{ c.phone }}" style="color:var(--text);text-decoration:none">{{ c.phone }}</a></span>{% endif %}
                {% if c.mobile %}<span>üì± <a href="tel:{{ c.mobile }}" style="color:var(--text);text-decoration:none">{{ c.mobile }}</a></span>{% endif %}
              </div>
              {% if c.note %}<div style="margin-top:8px;color:var(--muted);font-size:13px">{{ c.note }}</div>{% endif %}
            </div>
            {% if can_edit_contact %}
              <div style="display:flex;gap:8px">
                <a href="{% url 'core:contact_edit' pk=obj.pk contact_id=c.pk %}" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'core:contact_delete' pk=obj.pk contact_id=c.pk %}" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  {% endif %}
</div>

{# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>
    {% if can_edit_client %}
      <a href="{% url 'core:counterparty_update' obj.pk %}#managers" class="btn btn-secondary">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
    {% endif %}
  </div>

  {% with managers=obj.managers.all %}
    {% if managers %}
      <div style="display:grid;gap:12px">
        {% for m in managers %}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600;font-size:16px">{{ m.get_full_name|default:m.username }}</div>
              <div style="color:var(--muted);font-size:14px">@{{ m.username }}{% if m.email %} ‚Ä¢ {{ m.email }}{% endif %}</div>
            </div>
            {% if can_edit_client %}
              <form method="post" action="{% url 'core:counterparty_manager_remove' obj.pk m.pk %}" style="margin:0">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:13px;padding:6px 12px">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:24px;text-align:center;color:var(--muted)">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
    {% endif %}
  {% endwith %}
</div>

{# –î–æ–∫—É–º–µ–Ω—Ç—ã #}
<div class="card">
  <h2 style="font-size:18px;font-weight:700;margin:0 0 16px 0;padding-bottom:12px;border-bottom:1px solid var(--border)">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  {% if obj.documents.all %}
    <div style="display:grid;gap:8px">
      {% for d in obj.documents.all %}
        <a href="{{ d.file.url }}" target="_blank" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);transition:background 0.2s"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <span style="font-weight:600">{{ d.title|default:d.file.name }}</span>
          <span style="font-size:12px;color:var(--muted)">{{ d.created_at|date:"d.m.Y" }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:24px;text-align:center;color:var(--muted)">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
  {% endif %}
</div>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç #}
{% if obj.address or obj.actual_address %}
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script type="text/javascript">
  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç
  var mapsData = [];
  {% if obj.address %}
  mapsData.push({
    address: '{{ obj.address|escapejs }}',
    containerId: 'map-legal',
    title: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å',
    isLegal: true
  });
  {% endif %}
  {% if obj.actual_address %}
  mapsData.push({
    address: '{{ obj.actual_address|escapejs }}',
    containerId: 'map-actual',
    title: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å',
    isLegal: false
  });
  {% endif %}

  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ API)
  ymaps.ready(function() {
    mapsData.forEach(function(mapData) {
      initMap(mapData);
    });
  });

  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç—ã
  function initMap(mapData) {
    var address = mapData.address;
    var containerId = mapData.containerId;
    var title = mapData.title;
    var isLegal = mapData.isLegal;
    
    // –°–æ–∑–¥–∞—ë–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    function createSearchVariants(addr) {
      var variants = [];
      var cleanAddr = addr.trim();
      
      // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å
      var withoutIndex = cleanAddr.replace(/^\d{6},\s*/, '');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ—Ä–æ–¥
      var city = '';
      var street = '';
      var house = '';
      var building = '';
      
      var parts = withoutIndex.split(',').map(function(p) { return p.trim(); });
      
      for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ—Ä–æ–¥
        if (part.match(/^–ì\.–ú–û–°–ö–í–ê$/i) || part.match(/–ú–û–°–ö–í–ê/i)) {
          city = '–ú–æ—Å–∫–≤–∞';
        } else if (part.match(/^–ì\.–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì$/i) || part.match(/–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì/i) || part.match(/–ü–ï–¢–ï–†–ë–£–†–ì/i)) {
          city = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';
        }
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É–ª–∏—Ü—É/–ø—Ä–æ—Å–ø–µ–∫—Ç
        else if (part.match(/^–£–õ\./i)) {
          street = part.replace(/^–£–õ\.\s*/i, '').toLowerCase()
            .replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        } else if (part.match(/^–ü–†-–ö–¢/i)) {
          var prospectName = part.replace(/^–ü–†-–ö–¢\s*/i, '');
          street = '–ø—Ä–æ—Å–ø–µ–∫—Ç ' + prospectName.toLowerCase()
            .replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        }
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º
        else if (part.match(/^–î\./i)) {
          house = part.replace(/^–î\.\s*/i, '');
        }
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–ø—É—Å
        else if (part.match(/^–ö\./i)) {
          building = part.replace(/^–ö\.\s*/i, '');
        }
      }
      
      // –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
      if (city && street && house) {
        var fullAddr = city + ', ' + street;
        if (building && building.length > 0) {
          fullAddr += ', –¥. ' + house + ', –∫–æ—Ä–ø. ' + building;
        } else {
          fullAddr += ', –¥. ' + house;
        }
        variants.push(fullAddr);
        
        // –í–∞—Ä–∏–∞–Ω—Ç 1.1: –ë–µ–∑ "–¥."
        variants.push(city + ', ' + street + ', ' + house + (building ? ' ' + building : ''));
        
        // –í–∞—Ä–∏–∞–Ω—Ç 1.2: –¢–æ–ª—å–∫–æ —É–ª–∏—Ü–∞ –∏ –¥–æ–º
        var streetOnly = street.replace(/^–ø—Ä–æ—Å–ø–µ–∫—Ç\s+/i, '–ø—Ä–æ—Å–ø–µ–∫—Ç ').replace(/^—É–ª–∏—Ü–∞\s+/i, '—É–ª–∏—Ü–∞ ');
        variants.push(city + ', ' + streetOnly + ', ' + house);
      }
      
      // –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
      var simple = withoutIndex
        .replace(/–ì\.–ú–û–°–ö–í–ê/gi, '–ú–æ—Å–∫–≤–∞')
        .replace(/–ì\.–°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì/gi, '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')
        .replace(/–ü–†-–ö–¢/gi, '–ø—Ä–æ—Å–ø–µ–∫—Ç')
        .replace(/–£–õ\./gi, '—É–ª–∏—Ü–∞')
        .replace(/–î\./gi, '–¥.')
        .replace(/–ö\./gi, '–∫–æ—Ä–ø.');
      variants.push(simple);
      
      // –í–∞—Ä–∏–∞–Ω—Ç 3: –¢–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º
      if (city && street && house) {
        variants.push(city + ', ' + street + ', ' + house);
      }
      
      // –í–∞—Ä–∏–∞–Ω—Ç 4: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞
      variants.push(withoutIndex);
      
      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
      return variants.filter(function(v, i, self) {
        return self.indexOf(v) === i && v.length > 5;
      });
    }

    // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –ú–æ—Å–∫–≤–µ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –ø–æ—Å–ª–µ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞)
    var myMap = new ymaps.Map(containerId, {
      center: [55.76, 37.64],
      zoom: 10,
      controls: [
        'zoomControl',
        'fullscreenControl',
        'typeSelector',
        new ymaps.control.SearchControl({
          options: {
            size: 'large',
            provider: 'yandex#search'
          }
        })
      ]
    });

    // –ü–æ–ª—É—á–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    var searchVariants = createSearchVariants(address);
    console.log('–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞:', searchVariants);

    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ –≥–µ–æ–∫–æ–¥–∏–Ω–≥, –ø—Ä–æ–±—É—è —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    function tryGeocode(variantIndex) {
      if (variantIndex >= searchVariants.length) {
        console.warn('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        // –ö–∞—Ä—Ç–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
        return;
      }
      
      var searchAddr = searchVariants[variantIndex];
      console.log('–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤–∞—Ä–∏–∞–Ω—Ç ' + (variantIndex + 1) + ':', searchAddr);
      
      ymaps.geocode(searchAddr).then(function(res) {
        var firstGeoObject = res.geoObjects.get(0);
        
        if (firstGeoObject) {
          // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
          var coordinates = firstGeoObject.geometry.getCoordinates();
          console.log('‚úì –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω! –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', coordinates);
          
          // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
          myMap.setCenter(coordinates);
          myMap.setZoom(15);

          // –°–æ–∑–¥–∞—ë–º –º–µ—Ç–∫—É
          var myPlacemark = new ymaps.Placemark(coordinates, {
            hintContent: title,
            balloonContent: '<div style="padding:8px"><strong style="display:block;margin-bottom:4px">' + title + '</strong><div style="font-size:13px;color:#666">' + address + '</div></div>'
          }, {
            preset: isLegal ? 'islands#blueCircleDotIcon' : 'islands#greenCircleDotIcon',
            iconColor: isLegal ? '#3b82f6' : '#10b981'
          });

          // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
          myMap.geoObjects.add(myPlacemark);
          
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω —Å—Ä–∞–∑—É
          myPlacemark.balloon.open();
        } else {
          // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
          console.warn('–í–∞—Ä–∏–∞–Ω—Ç ' + (variantIndex + 1) + ' –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π...');
          tryGeocode(variantIndex + 1);
        }
      }, function(err) {
        console.warn('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤–∞—Ä–∏–∞–Ω—Ç ' + (variantIndex + 1) + ':', err);
        // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        tryGeocode(variantIndex + 1);
      });
    }
    
    // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    tryGeocode(0);
  }
</script>

<style>
@media (max-width:940px){
  .grid-2[style*="gap:16px"]{grid-template-columns:1fr}
  #map-legal,#map-actual{height:350px !important}
}
@media (max-width:640px){
  #map-legal,#map-actual{height:300px !important}
}
</style>
{% endif %}

{% endblock %}
