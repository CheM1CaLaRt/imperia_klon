{% extends "base.html" %}
{% block title %}–ü—Ä–∏—ë–º–∫–∞/–†–∞–∑–º–µ—â–µ–Ω–∏–µ ‚Äî {{ warehouse.code }}{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">–ü—Ä–∏—ë–º–∫–∞/–†–∞–∑–º–µ—â–µ–Ω–∏–µ</h1>
      <p class="card-subtitle">–°–∫–ª–∞–¥: {{ warehouse.code }} ‚Äî {{ warehouse.name }}</p>
    </div>
    <a class="btn btn-secondary" href="{% url 'warehouse_detail' warehouse.pk %}">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–∫–ª–∞–¥—É</a>
  </div>
</div>

<div class="grid grid-2">
  {# –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Ñ–æ—Ä–º–∞ #}
  <div class="card">
    <form method="post" style="display:grid;gap:16px">
      {% csrf_token %}

      <div class="field">
        <label class="field label">–Ø—á–µ–π–∫–∞</label>
        <input type="text" name="bin" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, A1" style="width:100%">
        <div style="margin-top:6px;font-size:13px;color:var(--muted)">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º</div>
      </div>

      <div class="field">
        <label class="field label">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
        <div style="position:relative">
          <input
            type="search"
            name="barcode"
            autocomplete="off"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥"
            style="width:100%;font-family:ui-monospace;font-size:15px"
            hx-get="{% url 'product_by_barcode' %}"
            hx-target="#putaway-preview"
            hx-trigger="input delay:250ms, search from:input"
            hx-indicator="#putaway-indicator">
          <div id="putaway-indicator" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:13px">–ü–æ–∏—Å–∫...</div>
        </div>
      </div>

      <div class="field">
        <label class="field label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input id="qty-input" type="number" step="any" name="qty" style="width:100%" required>
      </div>

      <div style="padding:12px 16px;background:var(--bg);border-radius:12px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" name="create_bin" checked style="width:18px;height:18px;cursor:pointer">
          <span style="font-size:14px">–°–æ–∑–¥–∞–≤–∞—Ç—å —è—á–µ–π–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç</span>
        </label>
      </div>

      <div style="display:flex;gap:12px;padding-top:12px;border-top:1px solid var(--border)">
        <button class="btn btn-primary" type="submit" style="flex:1">–î–æ–±–∞–≤–∏—Ç—å</button>
        <a class="btn btn-secondary" href="{% url 'warehouse_detail' warehouse.pk %}">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>

  {# –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –ø—Ä–µ–≤—å—é —Ç–æ–≤–∞—Ä–∞ #}
  <div class="card" id="putaway-preview" style="min-height:200px">
    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);text-align:center;padding:32px">
      <div>
        <div style="font-size:48px;margin-bottom:12px">üîç</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:4px">–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥</div>
        <div style="font-size:13px">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</div>
      </div>
    </div>
  </div>
</div>

{# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä HTMX + –∞–≤—Ç–æ—Ñ–æ–∫—É—Å qty –ø—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ + –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–≤—å—é #}
<script>
  (function () {
    const indicator = document.getElementById('putaway-indicator');
    const preview   = document.getElementById('putaway-preview');
    const bc        = document.querySelector('input[name="barcode"]');
    const qty       = document.getElementById('qty-input');
    const placeholderHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);text-align:center;padding:32px"><div><div style="font-size:48px;margin-bottom:12px">üîç</div><div style="font-size:15px;font-weight:600;margin-bottom:4px">–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥</div><div style="font-size:13px">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</div></div></div>';

    document.addEventListener('htmx:beforeRequest', (e) => {
      if (e.detail.elt?.name === 'barcode') {
        if (indicator) indicator.style.display = 'block';
      }
    });
    
    document.addEventListener('htmx:afterOnLoad', (e) => {
      if (e.detail.elt?.name === 'barcode') {
        if (indicator) indicator.style.display = 'none';
        const found = preview.querySelector('[data-product-found="1"]');
        if (found && qty) {
          setTimeout(() => qty.focus(), 100);
        }
      }
    });

    function maybeClearPreview() {
      if (bc && preview && bc.value.trim() === '') {
        preview.innerHTML = placeholderHTML;
        if (qty) qty.value = '';
      }
    }
    bc?.addEventListener('input', maybeClearPreview);
    bc?.addEventListener('search', maybeClearPreview);
  })();
</script>

{# Lightbox –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ #}
<dialog id="img-zoom-modal" style="border-radius:18px;padding:0;max-width:840px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);border:1px solid var(--border)">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:14px;color:var(--muted)">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
      <button type="button" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="padding:20px;background:var(--card);display:flex;align-items:center;justify-content:center">
      <img id="img-zoom-target" src="" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" style="max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px">
    </div>
  </form>
</dialog>

<script>
  (function () {
    const dlg = document.getElementById('img-zoom-modal');
    const img = document.getElementById('img-zoom-target');
    window.__zoomPreview = function (src) {
      if (!src) return;
      img.src = src;
      dlg.showModal();
    };
    dlg?.addEventListener('click', (e) => {
      const r = dlg.getBoundingClientRect();
      const inside = r.top <= e.clientY && e.clientY <= r.bottom && r.left <= e.clientX && e.clientX <= r.right;
      if (!inside) dlg.close();
    });
    dlg?.addEventListener('close', () => { img.src = ''; });
  })();
</script>

<style>
@media (max-width:940px){
  .grid-2{grid-template-columns:1fr}
  #putaway-preview{min-height:auto}
}
</style>
{% endblock %}
