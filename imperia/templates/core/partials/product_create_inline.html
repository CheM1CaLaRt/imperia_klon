{# Новый товар (inline) #}
{% load access %}
<div>
  {% if form.non_field_errors %}
    <div class="mb-4 rounded-lg bg-red-50 text-red-800 border border-red-200 px-4 py-3 text-sm">
      {{ form.non_field_errors|join:", " }}
    </div>
  {% endif %}

  <form
    id="createProductForm"
    method="post"
    action="/ajax/product-create-inline/"
    class="space-y-4"
  >
    {% csrf_token %}

    <div>
      <label class="block text-sm text-gray-600 mb-1">Штрихкод</label>
      {{ form.barcode }}
      {% if form.barcode.errors %}<div class="text-xs text-red-600 mt-1">{{ form.barcode.errors|join:", " }}</div>{% endif %}
    </div>

    <div>
      <label class="block text-sm text-gray-600 mb-1">Название</label>
      {{ form.name }}
      {% if form.name.errors %}<div class="text-xs text-red-600 mt-1">{{ form.name.errors|join:", " }}</div>{% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div>
    <label class="block text-sm text-gray-600 mb-1">Бренд</label>
    {{ form.brand }}
  </div>
  <div>
    <label class="block text-sm text-gray-600 mb-1">Поставщик</label>
    {{ form.vendor }}
  </div>
</div>

{% if request.user|in_groups:"operator" or request.user|in_groups:"director" %}
  <div>
    <label class="block text-sm text-gray-600 mb-1">Цена (contracts), ₽</label>
    <input type="text" name="price_contracts" class="input w-full" value="{{ form.price_contracts.value|default:'' }}">
  </div>
{% endif %}


    <div>
      <label class="block text-sm text-gray-600 mb-1">URL изображения</label>
      {{ form.image_url }}
    </div>

    <div>
      <label class="block text-sm text-gray-600 mb-1">Описание</label>
      {{ form.description }}
    </div>

    {# --- расширенные поля, как в "Изменить" --- #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Страна</label>
        {{ form.country }}
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Вес, кг</label>
        {{ form.weight_kg }}
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Объём, м³</label>
        {{ form.volume_m3 }}
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Высота, см</label>
        {{ form.pkg_h_cm }}
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Ширина, см</label>
        {{ form.pkg_w_cm }}
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Глубина, см</label>
        {{ form.pkg_d_cm }}
      </div>
    </div>

    <div>
      <label class="block text-sm text-gray-600 mb-1">Расширенное описание</label>
      {{ form.description_ext }}
    </div>

    <div>
      <label class="block text-sm text-gray-600 mb-1">Артикул поставщика</label>
      {{ form.vendor_code }}
    </div>

    <div class="flex gap-3 pt-4 border-t border-gray-200">
      <button type="submit" class="px-5 py-2.5 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors text-sm">
        Сохранить
      </button>
      <button type="button" id="cancelCreateProduct" class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors text-sm">
        Отмена
      </button>
    </div>
  </form>
</div>

<script>
(function() {
  function initCreateProductForm() {
    const form = document.getElementById('createProductForm');
    
    if (!form) return;
    
    // Удаляем старые обработчики, если есть
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Функция для закрытия модального окна
    function closeModal() {
      // Используем глобальную функцию, если она доступна
      if (window.closeCreateProductModal) {
        console.log('Используем глобальную функцию закрытия');
        window.closeCreateProductModal();
        return;
      }
      
      // Иначе используем локальную логику
      const modal = document.getElementById('createProductModal');
      if (modal) {
        console.log('Закрытие модального окна через кнопку Отмена');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        // Очищаем содержимое формы
        const contentDiv = document.getElementById('createProductContent');
        if (contentDiv) {
          contentDiv.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">Загрузка формы...</div>';
        }
      }
    }
    
    // Находим кнопку "Отмена" в новой форме и добавляем обработчик
    const newCancelBtn = newForm.querySelector('#cancelCreateProduct');
    if (newCancelBtn) {
      // Удаляем старые обработчики, если есть
      const newCancelBtnClone = newCancelBtn.cloneNode(true);
      newCancelBtn.parentNode.replaceChild(newCancelBtnClone, newCancelBtn);
      
      newCancelBtnClone.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Кнопка Отмена нажата');
        closeModal();
        return false;
      });
    } else {
      console.error('Кнопка cancelCreateProduct не найдена в форме');
    }
    
    newForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(newForm);
      const submitBtn = newForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Сохранение...';
      
      fetch(newForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json().then(data => ({ type: 'json', data }));
        } else {
          return response.text().then(html => ({ type: 'html', html }));
        }
      })
      .then(result => {
        console.log('Результат:', result);
        if (result.type === 'json' && result.data && result.data.success) {
          // Успешно создан, закрываем модальное окно и перезагружаем страницу
          const modal = document.getElementById('createProductModal');
          if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.style.overflow = '';
          }
          window.location.reload();
        } else {
          // Есть ошибки или HTML форма, показываем обновленную форму
          const contentDiv = document.getElementById('createProductContent');
          if (contentDiv) {
            contentDiv.innerHTML = result.html || result;
            // Переинициализируем обработчики
            setTimeout(initCreateProductForm, 100);
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            console.error('Не найден элемент createProductContent');
          }
        }
      })
      .catch(error => {
        console.error('Ошибка:', error);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        alert('Произошла ошибка при создании товара: ' + error.message);
      });
    });
  }
  
  // Инициализируем при загрузке
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCreateProductForm);
  } else {
    initCreateProductForm();
  }
  
  // Экспортируем функцию для повторной инициализации
  window.initCreateProductForm = initCreateProductForm;
})();
</script>
