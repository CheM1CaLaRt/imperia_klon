{% extends "base.html" %}
{% load humanize %}
{% load access %}

{% block title %}{{ warehouse.code }} — {{ warehouse.name }}{% endblock %}

{% block content %}
<div class="flex gap-5" style="float: right">
    <a class="btn" href="{% url 'put_away' warehouse.pk %}">Приёмка/Размещение</a>
    <a class="btn" href="{% url 'move_between_bins' warehouse.pk %}">Перемещение</a>
    {% if request.user|in_groups:"director" %}
      <a class="btn btn-danger"
         href="{% url 'warehouse_delete' warehouse.pk %}"
         onclick="return confirm('Удалить склад и все связанные данные?')">
        Удалить склад
      </a>
    {% endif %}
</div>
<br>
<div>
    <h1 class="text-2xl font-semibold">{{ warehouse.code }} — {{ warehouse.name }}</h1>
    {% if warehouse.address %}
      <div class="text-sm text-gray-500">{{ warehouse.address }}</div>
    {% endif %}
</div>
<br> <br>




{# ---------- Фильтры ---------- #}
<form method="get" class="flex flex-wrap items-end gap-4 mb-6">
  <div class="flex-1 min-w-[220px]">
    <label class="block text-sm text-gray-500 mb-1">Поиск (штрихкод/название)</label>
    <input
      type="text"
      name="q"
      value="{{ request.GET.q|default_if_none:'' }}"
      class="input w-full"
      placeholder="Начните вводить…">
  </div>

  <div>
    <label class="block text-sm text-gray-500 mb-1">Ячейка</label>
    <select name="bin" class="select">
      <option value="">— все ячейки —</option>
      {% for b in bins %}
        <option value="{{ b.code }}" {% if request.GET.bin == b.code %}selected{% endif %}>
          {{ b.code }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex gap-2">
    <button class="btn" type="submit">Применить</button>
    <a class="btn btn-light" href="{% url 'warehouse_detail' warehouse.pk %}">Сбросить</a>
  </div>
</form>



{# ---------- Ячейки ---------- #}


<h2 class="text-xl font-semibold mb-2">Ячейки</h2>
    {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
      <a class="btn" href="{% url 'bin_create' warehouse.pk %}">+ Ячейка</a>
    {% endif %}

{% if request.GET.bin %}
  <div class="mb-3 text-sm">
    Фильтр по ячейке:
    <span class="inline-flex items-center gap-2 rounded-lg bg-blue-50 px-2 py-1 text-blue-700">
      <span class="font-mono">{{ request.GET.bin }}</span>
      <a class="hover:underline"
         href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}{% if request.GET.order %}order={{ request.GET.order }}&{% endif %}">
        сбросить
      </a>
    </span>
  </div>
{% endif %}

<div class="flex flex-wrap gap-2 mb-6">
  {% for b in bins %}
    <div
      class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-2
             {% if request.GET.bin and request.GET.bin == b.code %} bg-blue-50 ring-1 ring-blue-200 {% else %} hover:bg-gray-50 {% endif %}">

      {# левая кликабельная часть — фильтр по ячейке #}
      <a
        href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}bin={{ b.code }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}"
        class="min-w-0"
        title="Показать только ячейку {{ b.code }}"
      >
        <div class="leading-tight">
          <div class="font-mono font-medium truncate max-w-[160px]">{{ b.code }}</div>
          {% if b.description %}
            <div class="text-[11px] text-gray-500 truncate max-w-[160px]">{{ b.description }}</div>
          {% endif %}
        </div>
      </a>

      <span class="h-4 w-px bg-gray-200"></span>

      {# действия — всегда видны #}
      {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
        <div class="flex items-center gap-1">
          <a
            href="{% url 'bin_edit' warehouse.pk b.pk %}"
            class="btn btn-xs"
            title="Изменить ячейку"
            onclick="event.stopPropagation();"
          >Изм.</a>

          {# УДАЛЕНИЕ: все данные на форме, обработчик — общий (см. <script> ниже) #}
          <form method="post"
                action="{% url 'bin_delete' warehouse.pk b.pk %}"
                class="bin-delete-form"
                data-bin-code="{{ b.code }}"
                data-has-items="{% if b.qty_sum or b.product_count or b.items_count %}1{% else %}0{% endif %}"
                data-qty="{{ b.qty_sum|default_if_none:'' }}"
                data-positions="{{ b.product_count|default_if_none:'' }}">
            {% csrf_token %}
            <button class="btn btn-xs btn-danger" type="submit" title="Удалить">×</button>
          </form>
        </div>
      {% endif %}
    </div>
  {% empty %}
    <p>Нет ячеек</p>
  {% endfor %}
</div>

{# ---- Модалка "удаление недоступно" ---- #}
<dialog id="bin-block-modal" class="rounded-2xl p-0 w-[min(520px,92vw)] shadow-2xl backdrop:bg-black/30">
  <form method="dialog" class="m-0">
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="text-lg font-semibold">Удаление ячейки недоступно</h2>
      <button class="rounded-xl px-3 py-1 text-sm hover:bg-gray-100">Закрыть</button>
    </div>
    <div class="p-4 text-sm">
      <p class="mb-2">
        Нельзя удалить ячейку <span id="bin-block-code" class="font-mono"></span> — в ней есть товар.
      </p>
      <p id="bin-block-stats" class="mb-3 text-gray-600"></p>
      <ul class="list-disc pl-5 text-gray-600">
        <li>Переместите остатки в другую ячейку;</li>
        <li>или обнулите остатки через операции приёмки/перемещения.</li>
      </ul>
    </div>
  </form>
</dialog>

<script>
  // Перехват submit у форм удаления ячеек (надёжнее, чем ловить click у кнопки)
  document.addEventListener('submit', function(e) {
    const form = e.target.closest('.bin-delete-form');
    if (!form) return;

    const hasItems = form.dataset.hasItems === '1';
    const code = form.dataset.binCode || '';
    const qty = form.dataset.qty || '';
    const pos = form.dataset.positions || '';

    // Если есть товар — не отправляем форму, показываем модалку с причиной
    if (hasItems) {
      e.preventDefault();
      const codeEl = document.getElementById('bin-block-code');
      const statsEl = document.getElementById('bin-block-stats');
      if (codeEl) codeEl.textContent = code;
      const parts = [];
      if (pos) parts.push(`Позиции: ${pos}`);
      if (qty) parts.push(`Количество: ${qty}`);
      if (statsEl) statsEl.textContent = parts.join(' • ');
      document.getElementById('bin-block-modal')?.showModal();
      return;
    }

    // Если пустая — спрашиваем подтверждение
    if (!confirm('Удалить ячейку ' + code + '?')) {
      e.preventDefault();
    }
  });

  // Закрытие модалки по клику по фону
  (function(){
    const dlg = document.getElementById('bin-block-modal');
    dlg?.addEventListener('click', (e) => {
      const r = dlg.getBoundingClientRect();
      const inside = r.top <= e.clientY && e.clientY <= r.bottom &&
                     r.left <= e.clientX && e.clientX <= r.right;
      if (!inside) dlg.close();
    });
  })();
</script>




{# ---------- Остатки ---------- #}
<h2 class="text-xl font-semibold mb-2">Остатки</h2>
<div class="rounded-xl border overflow-hidden">
  <table class="min-w-full">
    <thead>
      <tr class="text-left bg-gray-100">
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=bin&order={% if request.GET.sort == 'bin' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Ячейка
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=barcode&order={% if request.GET.sort == 'barcode' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Штрихкод
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=name&order={% if request.GET.sort == 'name' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Товар
          </a>
        </th>
        <th class="p-2 w-24 text-right">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=qty&order={% if request.GET.sort == 'qty' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Кол-во
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=updated&order={% if request.GET.sort == 'updated' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Обновлено
          </a>
        </th>
        <th class="p-2 w-28">Действия</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-gray-200">
      {% for row in inventory %}
        {% if not request.GET.bin or row.bin and row.bin.code == request.GET.bin %}
          {% if not request.GET.q or request.GET.q|lower in row.product.name|lower or request.GET.q|lower in row.product.barcode|lower %}
            <tr class="hover:bg-gray-50">
              <td class="p-2">{% if row.bin %}{{ row.bin.code }}{% else %}—{% endif %}</td>

              {# клик по штрихкоду тоже открывает карточку #}
              <td class="p-2 font-mono">
                <a href="#"
                   hx-get="{% url 'product_card' row.product.id %}"
                   hx-target="#product-modal-body"
                   hx-swap="innerHTML"
                   onclick="event.preventDefault();">
                  {{ row.product.barcode }}
                </a>
              </td>

              <td class="p-2">
                <a href="#"
                   class="hover:underline"
                   hx-get="{% url 'product_card' row.product.id %}"
                   hx-target="#product-modal-body"
                   hx-swap="innerHTML"
                   onclick="event.preventDefault();">
                  {{ row.product.name }}
                </a>
              </td>

              <td class="p-2 text-right">{{ row.quantity|floatformat:0 }}</td>
              <td class="p-2 text-xs text-gray-500">{{ row.updated_at|date:"d.m.Y H:i" }}</td>
              <td class="p-2">
                {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
                  <a class="btn btn-xs"
                     href="{% url 'inventory_edit' warehouse.pk row.pk %}">
                    Изменить
                  </a>
                {% else %}—{% endif %}
              </td>
            </tr>
          {% endif %}
        {% endif %}
      {% empty %}
        <tr>
          <td colspan="6" class="p-3 text-gray-500">Остатки не заведены</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# ---------- Модалка карточки товара ---------- #}
<dialog id="product-modal" class="rounded-2xl p-0 w-[min(700px,92vw)] shadow-2xl backdrop:bg-black/30">
  <form method="dialog" class="m-0">
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="text-lg font-semibold">Товар</h2>
      <button class="rounded-xl px-3 py-1 text-sm hover:bg-gray-100">Закрыть</button>
    </div>
    <div id="product-modal-body" class="p-4">
      <div class="text-gray-500">Загрузка…</div>
    </div>
  </form>
</dialog>

<script>
  // 1) Убедимся, что HTMX есть (если нет — подгружаем)
  if (!window.htmx) {
    var s = document.createElement('script');
    s.src = 'https://unpkg.com/htmx.org@1.9.12';
    document.head.appendChild(s);
  }

  // 2) Открываем диалог после любого успешного HTMX-запроса в #product-modal-body
  document.addEventListener('htmx:afterOnLoad', function (e) {
    if (e.detail && e.detail.target && e.detail.target.id === 'product-modal-body') {
      const dlg = document.getElementById('product-modal');
      dlg && dlg.showModal();
    }
  });

  // 3) Закрытие по клику вне окна и по Esc
  (function () {
    const dlg = document.getElementById('product-modal');
    dlg?.addEventListener('click', function (e) {
      const r = dlg.getBoundingClientRect();
      const inside = r.top <= e.clientY && e.clientY <= r.bottom &&
                     r.left <= e.clientX && e.clientX <= r.right;
      if (!inside) dlg.close();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && dlg?.open) dlg.close();
    });
  })();
</script>
{% endblock %}
