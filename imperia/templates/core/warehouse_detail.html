{% extends "base.html" %}
{% load humanize %}
{% load access %}

{% block title %}{{ warehouse.code }} ‚Äî {{ warehouse.name }}{% endblock %}

{% block content %}

{# –®–∞–ø–∫–∞ —Å–∫–ª–∞–¥–∞ #}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ warehouse.code }} ‚Äî {{ warehouse.name }}</h1>
      {% if warehouse.address %}
        <p class="card-subtitle">{{ warehouse.address }}</p>
      {% endif %}
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn btn-primary" href="{% url 'put_away' warehouse.pk %}">–ü—Ä–∏—ë–º–∫–∞/–†–∞–∑–º–µ—â–µ–Ω–∏–µ</a>
      <a class="btn btn-secondary" href="{% url 'move_between_bins' warehouse.pk %}">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</a>
      {% if request.user|in_groups:"director" %}
        <a class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca"
           href="{% url 'warehouse_delete' warehouse.pk %}"
           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥ –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')">
          –£–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥
        </a>
      {% endif %}
    </div>
  </div>
</div>

{# –§–∏–ª—å—Ç—Ä—ã #}
<div class="card">
  <form method="get" style="display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:end;flex-wrap:wrap">
    <div class="field" style="margin:0">
      <label class="field label">–ü–æ–∏—Å–∫ (—à—Ç—Ä–∏—Ö–∫–æ–¥/–Ω–∞–∑–≤–∞–Ω–∏–µ)</label>
      <input
        type="text"
        name="q"
        value="{{ request.GET.q|default_if_none:'' }}"
        placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..."
        style="width:100%">
    </div>
    <div class="field" style="margin:0;min-width:180px">
      <label class="field label">–Ø—á–µ–π–∫–∞</label>
      <select name="bin" style="width:100%">
        <option value="">‚Äî –≤—Å–µ —è—á–µ–π–∫–∏ ‚Äî</option>
        {% for b in bins %}
          <option value="{{ b.code }}" {% if request.GET.bin == b.code %}selected{% endif %}>
            {{ b.code }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div style="display:flex;gap:8px">
      <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a class="btn btn-secondary" href="{% url 'warehouse_detail' warehouse.pk %}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </form>
</div>

{# –Ø—á–µ–π–∫–∏ #}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px">
    <h2 style="font-size:18px;font-weight:700;margin:0">–Ø—á–µ–π–∫–∏</h2>
    {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
      <a class="btn btn-secondary" href="{% url 'bin_create' warehouse.pk %}">+ –Ø—á–µ–π–∫–∞</a>
    {% endif %}
  </div>

  {% if request.GET.bin %}
    <div style="margin-bottom:16px;padding:12px 16px;background:var(--bg);border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:13px;color:var(--muted)">–§–∏–ª—å—Ç—Ä –ø–æ —è—á–µ–π–∫–µ:</span>
        <span style="font-family:ui-monospace;font-weight:600;font-size:14px;padding:4px 10px;background:var(--primary);color:#fff;border-radius:8px">{{ request.GET.bin }}</span>
      </div>
      <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}{% if request.GET.order %}order={{ request.GET.order }}&{% endif %}"
         style="font-size:13px;color:var(--primary);text-decoration:none;font-weight:600">
        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
      </a>
    </div>
  {% endif %}

  {% if bins %}
    <div style="display:flex;flex-wrap:wrap;gap:10px">
      {% for b in bins %}
        <div style="display:flex;align-items:center;gap:8px;padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:var(--card);transition:all 0.2s;flex:0 1 auto;min-width:0"
             {% if not b.is_active %}style="opacity:0.7;border-style:dashed"{% endif %}
             onmouseover="if(this.onmouseover) this.style.borderColor='var(--primary)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
             onmouseout="if(this.onmouseout) this.style.borderColor=''; this.style.boxShadow=''">
          <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}bin={{ b.code }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}"
             style="flex:1;min-width:0;text-decoration:none;color:inherit">
            <div style="font-family:ui-monospace;font-weight:600;font-size:15px;margin-bottom:4px;color:var(--text)">
              {{ b.code }}
              {% if not b.is_active %}
                <span style="display:inline-block;margin-left:6px;padding:2px 6px;border-radius:4px;background:var(--bg);color:var(--muted);font-size:11px;font-weight:normal">–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
              {% endif %}
            </div>
            {% if b.description %}
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px">{{ b.description|truncatewords:8 }}</div>
            {% endif %}
            {% if b.product_count or b.qty_sum %}
              <div style="font-size:12px;color:var(--muted)">
                {% if b.product_count %}–ü–æ–∑–∏—Ü–∏–∏: <strong style="color:var(--text)">{{ b.product_count }}</strong>{% endif %}
                {% if b.product_count and b.qty_sum %} ‚Ä¢ {% endif %}
                {% if b.qty_sum %}–ö–æ–ª-–≤–æ: <strong style="color:var(--text)">{{ b.qty_sum|floatformat:0 }}</strong>{% endif %}
              </div>
            {% endif %}
          </a>
          {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
            <div style="display:flex;align-items:center;gap:4px;padding-left:8px;border-left:1px solid var(--border)">
              <a href="{% url 'bin_edit' warehouse.pk b.pk %}"
                 class="btn btn-secondary"
                 style="font-size:12px;padding:4px 8px"
                 onclick="event.stopPropagation();">–ò–∑–º.</a>
              <form method="post"
                    action="{% url 'bin_delete' warehouse.pk b.pk %}"
                    class="bin-delete-form"
                    data-bin-code="{{ b.code }}"
                    data-has-items="{% if b.qty_sum or b.product_count or b.items_count %}1{% else %}0{% endif %}"
                    data-qty="{{ b.qty_sum|default_if_none:'' }}"
                    data-positions="{{ b.product_count|default_if_none:'' }}"
                    style="margin:0;display:inline"
                    onclick="event.stopPropagation();">
                {% csrf_token %}
                <button type="submit" class="btn" style="background:#fee2e2;color:#7f1d1d;border-color:#fecaca;font-size:16px;padding:4px 8px;line-height:1" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
              </form>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding:32px;text-align:center;color:var(--muted)">
      <div style="font-size:32px;margin-bottom:8px">üì¶</div>
      <div>–Ø—á–µ–µ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
    </div>
  {% endif %}
</div>

{# –ú–æ–¥–∞–ª–∫–∞ "—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ" #}
<dialog id="bin-block-modal" style="border-radius:18px;padding:0;max-width:520px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);border:1px solid var(--border)">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <h2 style="font-size:18px;font-weight:700;margin:0">–£–¥–∞–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</h2>
      <button type="button" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="padding:20px;font-size:14px">
      <p style="margin-bottom:12px">
        –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —è—á–µ–π–∫—É <span id="bin-block-code" style="font-family:ui-monospace;font-weight:600"></span> ‚Äî –≤ –Ω–µ–π –µ—Å—Ç—å —Ç–æ–≤–∞—Ä.
      </p>
      <p id="bin-block-stats" style="margin-bottom:16px;color:var(--muted)"></p>
      <ul style="margin:0;padding-left:20px;color:var(--muted)">
        <li>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –æ—Å—Ç–∞—Ç–∫–∏ –≤ –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É;</li>
        <li>–∏–ª–∏ –æ–±–Ω—É–ª–∏—Ç–µ –æ—Å—Ç–∞—Ç–∫–∏ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏—ë–º–∫–∏/–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è.</li>
      </ul>
    </div>
  </form>
</dialog>

<script>
  document.addEventListener('submit', function(e) {
    const form = e.target.closest('.bin-delete-form');
    if (!form) return;

    const hasItems = form.dataset.hasItems === '1';
    const code = form.dataset.binCode || '';
    const qty = form.dataset.qty || '';
    const pos = form.dataset.positions || '';

    if (hasItems) {
      e.preventDefault();
      const codeEl = document.getElementById('bin-block-code');
      const statsEl = document.getElementById('bin-block-stats');
      if (codeEl) codeEl.textContent = code;
      const parts = [];
      if (pos) parts.push(`–ü–æ–∑–∏—Ü–∏–∏: ${pos}`);
      if (qty) parts.push(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}`);
      if (statsEl) statsEl.textContent = parts.join(' ‚Ä¢ ');
      document.getElementById('bin-block-modal')?.showModal();
      return;
    }

    if (!confirm('–£–¥–∞–ª–∏—Ç—å —è—á–µ–π–∫—É ' + code + '?')) {
      e.preventDefault();
    }
  });

  (function(){
    const dlg = document.getElementById('bin-block-modal');
    dlg?.addEventListener('click', (e) => {
      const r = dlg.getBoundingClientRect();
      const inside = r.top <= e.clientY && e.clientY <= r.bottom &&
                     r.left <= e.clientX && e.clientX <= r.right;
      if (!inside) dlg.close();
    });
  })();
</script>

{# –û—Å—Ç–∞—Ç–∫–∏ #}
<div class="card" style="overflow:hidden;padding:0">
  <div style="padding:16px 20px;border-bottom:1px solid var(--border)">
    <h2 style="font-size:18px;font-weight:700;margin:0">–û—Å—Ç–∞—Ç–∫–∏</h2>
  </div>
  {% if inventory %}
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:var(--bg);border-bottom:2px solid var(--border)">
            <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">
              <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=bin&order={% if request.GET.sort == 'bin' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}"
                 style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:4px">
                –Ø—á–µ–π–∫–∞
                <span style="font-size:10px">‚Üï</span>
              </a>
            </th>
            <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">
              <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=barcode&order={% if request.GET.sort == 'barcode' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}"
                 style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:4px">
                –®—Ç—Ä–∏—Ö–∫–æ–¥
                <span style="font-size:10px">‚Üï</span>
              </a>
            </th>
            <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">
              <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=name&order={% if request.GET.sort == 'name' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}"
                 style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:4px">
                –¢–æ–≤–∞—Ä
                <span style="font-size:10px">‚Üï</span>
              </a>
            </th>
            <th style="padding:12px;text-align:right;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">
              <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=qty&order={% if request.GET.sort == 'qty' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}"
                 style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:4px;justify-content:flex-end">
                –ö–æ–ª-–≤–æ
                <span style="font-size:10px">‚Üï</span>
              </a>
            </th>
            <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">
              <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=updated&order={% if request.GET.sort == 'updated' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}"
                 style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:4px">
                –û–±–Ω–æ–≤–ª–µ–Ω–æ
                <span style="font-size:10px">‚Üï</span>
              </a>
            </th>
            <th style="padding:12px;text-align:left;font-weight:600;font-size:13px;color:var(--muted);text-transform:uppercase;white-space:nowrap">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for row in inventory %}
            {% if not request.GET.bin or row.bin and row.bin.code == request.GET.bin %}
              {% if not request.GET.q or request.GET.q|lower in row.product.name|lower or request.GET.q|lower in row.product.barcode|lower %}
                <tr style="border-bottom:1px solid var(--border);transition:background 0.2s"
                    onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                  <td style="padding:12px;font-size:14px;font-family:ui-monospace;font-weight:600" data-label="–Ø—á–µ–π–∫–∞">
                    {% if row.bin %}{{ row.bin.code }}{% else %}‚Äî{% endif %}
                  </td>
                  <td style="padding:12px" data-label="–®—Ç—Ä–∏—Ö–∫–æ–¥">
                    <a href="#"
                       hx-get="{% url 'product_card' row.product.id %}"
                       hx-target="#product-modal-body"
                       hx-swap="innerHTML"
                       onclick="event.preventDefault();"
                       style="font-family:ui-monospace;font-size:13px;font-weight:600;color:var(--primary);text-decoration:none">
                      {{ row.product.barcode }}
                    </a>
                  </td>
                  <td style="padding:12px" data-label="–¢–æ–≤–∞—Ä">
                    <a href="#"
                       hx-get="{% url 'product_card' row.product.id %}"
                       hx-target="#product-modal-body"
                       hx-swap="innerHTML"
                       onclick="event.preventDefault();"
                       style="color:var(--text);text-decoration:none;font-size:14px">
                      {{ row.product.name|truncatewords:10 }}
                    </a>
                  </td>
                  <td style="padding:12px;text-align:right;font-size:15px;font-weight:600;color:var(--primary)" data-label="–ö–æ–ª-–≤–æ">
                    {{ row.quantity|floatformat:0 }}
                  </td>
                  <td style="padding:12px;font-size:13px;color:var(--muted)" data-label="–û–±–Ω–æ–≤–ª–µ–Ω–æ">
                    {{ row.updated_at|date:"d.m.Y H:i" }}
                  </td>
                  <td style="padding:12px" data-label="–î–µ–π—Å—Ç–≤–∏—è">
                    {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
                      <a class="btn btn-secondary"
                         href="{% url 'inventory_edit' warehouse.pk row.pk %}"
                         style="font-size:13px;padding:6px 12px">
                        –ò–∑–º–µ–Ω–∏—Ç—å
                      </a>
                    {% else %}
                      <span style="color:var(--muted)">‚Äî</span>
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endif %}
          {% empty %}
            <tr>
              <td colspan="6" style="padding:48px 24px;text-align:center;color:var(--muted)">
                <div style="font-size:32px;margin-bottom:8px">üì¶</div>
                <div>–û—Å—Ç–∞—Ç–∫–∏ –Ω–µ –∑–∞–≤–µ–¥–µ–Ω—ã</div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div style="padding:48px 24px;text-align:center;color:var(--muted)">
      <div style="font-size:32px;margin-bottom:8px">üì¶</div>
      <div>–û—Å—Ç–∞—Ç–∫–∏ –Ω–µ –∑–∞–≤–µ–¥–µ–Ω—ã</div>
    </div>
  {% endif %}
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ #}
<dialog id="product-modal" style="border-radius:18px;padding:0;max-width:700px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,0.3);border:1px solid var(--border)">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <h2 style="font-size:18px;font-weight:700;margin:0">–¢–æ–≤–∞—Ä</h2>
      <button type="button" id="product-modal-close" class="btn btn-secondary" style="font-size:13px;padding:6px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="product-modal-body" style="padding:20px">
      <div style="color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </form>
</dialog>

<script>
  if (!window.htmx) {
    var s = document.createElement('script');
    s.src = 'https://unpkg.com/htmx.org@1.9.12';
    document.head.appendChild(s);
  }

  document.addEventListener('htmx:afterOnLoad', function (e) {
    if (e.detail && e.detail.target && e.detail.target.id === 'product-modal-body') {
      const dlg = document.getElementById('product-modal');
      dlg && dlg.showModal();
    }
  });

  (function () {
    const dlg = document.getElementById('product-modal');
    const closeBtn = document.getElementById('product-modal-close');
    
    if (!dlg) return;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dlg.close();
      });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –¥–∏–∞–ª–æ–≥–∞
    dlg.addEventListener('click', function (e) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ backdrop (–≤–Ω–µ —Å–∞–º–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞)
      const rect = dlg.getBoundingClientRect();
      const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.bottom &&
                          rect.left <= e.clientX && e.clientX <= rect.right);
      if (!isInDialog) {
        dlg.close();
      }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && dlg && dlg.open) {
        dlg.close();
      }
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
    const modalBody = document.getElementById('product-modal-body');
    if (modalBody) {
      modalBody.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
    
    const modalHeader = dlg.querySelector('div[style*="border-bottom"]');
    if (modalHeader) {
      modalHeader.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
  })();
</script>

<style>
@media (max-width:940px){
  .card form[style*="grid-template-columns"]{grid-template-columns:1fr !important}
  .card form .field{min-width:auto !important}
  .card-header{flex-wrap:wrap}
}
@media (max-width:640px){
  .card-header{flex-direction:column;align-items:stretch;gap:12px}
  .card-header .btn{width:100%}
  table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  table thead{display:none}
  table tbody{display:block}
  table tbody tr{display:block;margin-bottom:12px;border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,0.05)}
  table tbody td{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--bg);text-align:right !important}
  table tbody td:before{content:attr(data-label);font-weight:600;color:var(--muted);margin-right:auto;text-align:left}
  table tbody td:last-child{border-bottom:0}
  table tbody td a{word-break:break-word}
}
</style>
{% endblock %}
