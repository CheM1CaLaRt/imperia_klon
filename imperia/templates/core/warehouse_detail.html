{% extends "base.html" %}
{% load humanize %}
{% load access %}

{% block title %}{{ warehouse.code }} — {{ warehouse.name }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-5">
  <div>
    <h1 class="text-2xl font-semibold">{{ warehouse.code }} — {{ warehouse.name }}</h1>
    {% if warehouse.address %}
      <div class="text-sm text-gray-500">{{ warehouse.address }}</div>
    {% endif %}
  </div>

  <div class="flex gap-2">
    <a class="btn" href="{% url 'put_away' warehouse.pk %}">Приёмка/Размещение</a>
    <a class="btn" href="{% url 'move_between_bins' warehouse.pk %}">Перемещение</a>

    {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
      <a class="btn" href="{% url 'bin_create' warehouse.pk %}">+ Ячейка</a>
    {% endif %}

    {% if request.user|in_groups:"director" %}
      <a class="btn btn-danger"
         href="{% url 'warehouse_delete' warehouse.pk %}"
         onclick="return confirm('Удалить склад и все связанные данные?')">
        Удалить склад
      </a>
    {% endif %}
  </div>
</div>

{# ---------- Фильтры ---------- #}
<form method="get" class="flex flex-wrap items-end gap-4 mb-6">
  <div class="flex-1 min-w-[220px]">
    <label class="block text-sm text-gray-500 mb-1">Поиск (штрихкод/название)</label>
    <input
      type="text"
      name="q"
      value="{{ request.GET.q|default_if_none:'' }}"
      class="input w-full"
      placeholder="Начните вводить…">
  </div>

  <div>
    <label class="block text-sm text-gray-500 mb-1">Ячейка</label>
    <select name="bin" class="select">
      <option value="">— все ячейки —</option>
      {% for b in bins %}
        <option value="{{ b.code }}" {% if request.GET.bin == b.code %}selected{% endif %}>
          {{ b.code }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex gap-2">
    <button class="btn" type="submit">Применить</button>
    <a class="btn btn-light" href="{% url 'warehouse_detail' warehouse.pk %}">Сбросить</a>
  </div>
</form>

{# ---------- Ячейки ---------- #}
<h2 class="text-xl font-semibold mb-2">Ячейки</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
  {% for b in bins %}
    <div class="rounded-xl border p-3{% if request.GET.bin and request.GET.bin == b.code %} bg-gray-50 ring-1 ring-gray-200{% endif %}">
      <div class="flex items-center justify-between gap-2">
        <div>
          <div class="font-mono font-medium">{{ b.code }}</div>
          {% if b.description %}
            <div class="text-xs text-gray-500">{{ b.description }}</div>
          {% endif %}
        </div>
        <div class="flex items-center gap-1">
          <a class="btn btn-xs"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}bin={{ b.code }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
            Фильтр
          </a>
          {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
            <a class="btn btn-xs" href="{% url 'bin_edit' warehouse.pk b.pk %}">Изм.</a>
            <form method="post" action="{% url 'bin_delete' warehouse.pk b.pk %}"
                  onsubmit="return confirm('Удалить ячейку {{ b.code }}?')">
              {% csrf_token %}
              <button class="btn btn-xs btn-danger" type="submit" title="Удалить">×</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  {% empty %}
    <p>Нет ячеек</p>
  {% endfor %}
</div>

{# ---------- Остатки ---------- #}
<h2 class="text-xl font-semibold mb-2">Остатки</h2>
<div class="rounded-xl border overflow-hidden">
  <table class="min-w-full">
    <thead>
      <tr class="text-left bg-gray-100">
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=bin&order={% if request.GET.sort == 'bin' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Ячейка
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=barcode&order={% if request.GET.sort == 'barcode' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Штрихкод
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=name&order={% if request.GET.sort == 'name' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Товар
          </a>
        </th>
        <th class="p-2 w-24 text-right">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=qty&order={% if request.GET.sort == 'qty' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Кол-во
          </a>
        </th>
        <th class="p-2">
          <a class="link"
             href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.bin %}bin={{ request.GET.bin }}&{% endif %}sort=updated&order={% if request.GET.sort == 'updated' and request.GET.order != 'desc' %}desc{% else %}asc{% endif %}">
            Обновлено
          </a>
        </th>
        <th class="p-2 w-28">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for row in inventory %}
        {# фильтр по выбранной ячейке, без скобок в if #}
        {% if not request.GET.bin or row.bin and row.bin.code == request.GET.bin %}
          {# текстовый поиск #}
          {% if not request.GET.q or request.GET.q|lower in row.product.name|lower or request.GET.q|lower in row.product.barcode|lower %}
            <tr class="border-t hover:bg-gray-50">
              <td class="p-2">{% if row.bin %}{{ row.bin.code }}{% else %}—{% endif %}</td>
              <td class="p-2 font-mono">{{ row.product.barcode }}</td>
              <td class="p-2">{{ row.product.name }}</td>
              <td class="p-2 text-right">{{ row.quantity|floatformat:0 }}</td>
              <td class="p-2 text-xs text-gray-500">{{ row.updated_at|date:"d.m.Y H:i" }}</td>
              <td class="p-2">
                {% if request.user|in_groups:"warehouse" or request.user|in_groups:"director" %}
                  <a class="btn btn-xs" href="{% url 'inventory_edit' warehouse.pk row.pk %}">Изменить</a>
                {% else %}—{% endif %}
              </td>
            </tr>
          {% endif %}
        {% endif %}
      {% empty %}
        <tr>
          <td colspan="6" class="p-3 text-gray-500">Остатки не заведены</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
