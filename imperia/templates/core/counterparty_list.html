{% extends "base.html" %}
{% load static %}
{% block title %}Клиенты{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-4">Клиенты</h1>

{# ===== Роль-ориентированная мини-навигация (красивые пилюли) ===== #}
{% with u=request.user n=request.resolver_match.url_name %}
  <div class="mb-5 flex flex-wrap items-center gap-2">
    {% if is_manager %}
      <div class="inline-flex items-center gap-px rounded-full bg-gray-100 p-1 shadow-inner">
        <a href="{% url 'core:counterparty_request_create' %}"
           class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm transition
                  {% if n == 'counterparty_request_create' %} bg-black text-white shadow {% else %} bg-white text-gray-800 hover:bg-gray-50 {% endif %}">
          <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 5a1 1 0 011 1v5h5a1 1 0 010 2h-5v5a1 1 0 01-2 0v-5H6a1 1 0 010-2h5V6a1 1 0 011-1z"/>
          </svg>
          <span>Новая заявка (контрагент)</span>
        </a>

        <a href="{% url 'core:manager_counterparty_requests' %}"
           class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm transition
                  {% if n == 'manager_counterparty_requests' %} bg-black text-white shadow {% else %} bg-white text-gray-800 hover:bg-gray-50 {% endif %}">
          <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M5 6h14a1 1 0 010 2H5a1 1 0 110-2zm0 5h14a1 1 0 010 2H5a1 1 0 110-2zm0 5h9a1 1 0 010 2H5a1 1 0 110-2z"/>
          </svg>
          <span>Мои заявки</span>
        </a>
      </div>
    {% endif %}

    {% if is_operator or is_director %}
      <a href="{% url 'core:counterparty_review_queue' %}"
         class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1.5 text-sm text-gray-800 border transition hover:bg-gray-50
                {% if n == 'counterparty_review_queue' %} !bg-black !text-white border-black shadow {% endif %}">
        <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M9 12l2 2 4-4a1 1 0 011.41 1.41l-4.7 4.7a1 1 0 01-1.41 0L7.6 13.4A1 1 0 019 12z"/>
          <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 2a8 8 0 110 16 8 8 0 010-16z"/>
        </svg>
        <span>Подтверждение контрагентов</span>
        {% if pending_count %}
          <span class="ml-1 inline-flex h-5 min-w-[1.25rem] items-center justify-center rounded-full bg-yellow-500 px-1.5 text-[11px] font-medium text-white">
            {{ pending_count }}
          </span>
        {% endif %}
      </a>
    {% endif %}
  </div>
{% endwith %}

{# ===== Поисковая панель + кнопка добавления ===== #}
<div class="flex items-center justify-between mb-4 gap-3">
  <form method="get" class="flex-1 flex gap-2">
    <input type="search" name="q" value="{{ q }}" placeholder="Поиск по названию или ИНН"
           class="rounded-xl border px-3 py-2 w-full outline-none focus:ring-2 focus:ring-blue-500">
    <button class="rounded-xl border px-4 hover:bg-gray-50">Найти</button>
    {% if q %}
      <a href="{% url 'core:counterparty_list' %}" class="rounded-xl border px-3 py-2 hover:bg-gray-50">Сброс</a>
    {% endif %}
  </form>

  {% if is_operator or is_director %}
    <a href="{% url 'core:counterparty_create' %}"
       class="inline-flex items-center gap-2 rounded-xl bg-black text-white px-4 py-2 shadow hover:opacity-90">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 4a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V5a1 1 0 011-1z"/>
      </svg>
      Добавить клиента
    </a>
  {% endif %}
</div>

{# ===== Список клиентов ===== #}
{% if objects %}
  <div class="rounded-xl border divide-y bg-white">
    {% for obj in objects %}
      <a href="{% url 'core:counterparty_detail' obj.pk %}"
         class="flex items-center justify-between px-4 py-3 hover:bg-gray-50">
        <div>
          <div class="font-medium">{{ obj.name }}</div>
          <div class="text-sm text-gray-600">
            ИНН: {{ obj.inn }}{% if obj.kpp %} • КПП: {{ obj.kpp }}{% endif %}
          </div>
        </div>
        {% if obj.managers.all %}
          <div class="hidden md:flex gap-1">
            {% for m in obj.managers.all %}
              <span class="inline-block rounded-full bg-gray-100 px-2 py-0.5 text-xs">
                {{ m.get_full_name|default:m.username }}
              </span>
            {% endfor %}
          </div>
        {% endif %}
      </a>
    {% endfor %}
  </div>
{% else %}
  <p class="text-sm text-gray-500">Ничего не найдено.</p>
{% endif %}
{% endblock %}
