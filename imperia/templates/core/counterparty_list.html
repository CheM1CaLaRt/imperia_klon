{% extends "base.html" %}
{% block wrap_mod %}wrap--xl{% endblock %}
{% load static %}
{% block title %}–ö–ª–∏–µ–Ω—Ç—ã ‚Äî IndigoFlow{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">–ö–ª–∏–µ–Ω—Ç—ã</h1>
      <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏</p>
    </div>
    {% if is_operator or is_director %}
      <a href="{% url 'core:counterparty_create' %}" class="btn btn-primary">
        + –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
      </a>
    {% endif %}
  </div>
</div>

{# –†–æ–ª—å-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏-–Ω–∞–≤–∏–≥–∞—Ü–∏—è #}
{% with n=request.resolver_match.url_name %}
  {% if is_manager or is_operator or is_director %}
    <div class="card" style="padding:16px 20px">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        {% if is_manager %}
          <a href="{% url 'core:counterparty_request_create' %}"
             class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-weight:600 transition
                    {% if n == 'counterparty_request_create' %} bg-black text-white shadow {% else %} bg-white border border-gray-300 text-gray-800 hover:bg-gray-50 {% endif %}"
             style="text-decoration:none;border:1px solid var(--border);background:var(--card);color:var(--text)">
            <span>+</span>
            <span>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç)</span>
          </a>
          <a href="{% url 'core:manager_counterparty_requests' %}"
             class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-weight:600 transition
                    {% if n == 'manager_counterparty_requests' %} bg-black text-white shadow {% else %} bg-white border border-gray-300 text-gray-800 hover:bg-gray-50 {% endif %}"
             style="text-decoration:none;border:1px solid var(--border);background:var(--card);color:var(--text)">
            <span>üìã</span>
            <span>–ú–æ–∏ –∑–∞—è–≤–∫–∏</span>
          </a>
        {% endif %}

        {% if is_operator or is_director %}
          <a href="{% url 'core:counterparty_review_queue' %}"
             class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-weight:600 transition
                    {% if n == 'counterparty_review_queue' %} !bg-black !text-white border-black shadow {% else %} bg-white border border-gray-300 text-gray-800 hover:bg-gray-50 {% endif %}"
             style="text-decoration:none;border:1px solid var(--border);background:var(--card);color:var(--text)">
            <span>‚úì</span>
            <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</span>
            {% if pending_count %}
              <span style="display:inline-flex;height:20px;min-width:20px;align-items:center;justify-content:center;border-radius:999px;background:#f59e0b;padding:0 6px;font-size:11px;font-weight:600;color:#fff">{{ pending_count }}</span>
            {% endif %}
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endwith %}

{# –ü–æ–∏—Å–∫ #}
<div class="card">
  <form method="get" style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">
    <div style="flex:1;min-width:200px">
      <label class="field label" style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">–ü–æ–∏—Å–∫</label>
      <input type="search" name="q" value="{{ q }}" placeholder="–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –ò–ù–ù"
             style="width:100%;padding:12px 14px;background:#fff;border:1px solid var(--border);border-radius:12px;font-size:15px">
    </div>
    <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
    {% if q %}
      <a href="{% url 'core:counterparty_list' %}" class="btn btn-secondary">–°–±—Ä–æ—Å</a>
    {% endif %}
  </form>
</div>

{# –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ #}
{% if objects %}
  <div class="card" style="padding:0;overflow:hidden">
    <div style="display:grid;gap:0">
      {% for obj in objects %}
        <a href="{% url 'core:counterparty_detail' obj.pk %}"
           style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);text-decoration:none;color:inherit;transition:background 0.2s;gap:16px"
           onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;font-size:16px;margin-bottom:4px;color:var(--text)">{{ obj.name }}</div>
            <div style="font-size:14px;color:var(--muted)">
              –ò–ù–ù: {{ obj.inn }}{% if obj.kpp %} ‚Ä¢ –ö–ü–ü: {{ obj.kpp }}{% endif %}
            </div>
          </div>
          {% if obj.managers.all %}
            <div style="display:none;flex-wrap:wrap;gap:6px;flex-shrink:0">
              {% for m in obj.managers.all %}
                <span style="display:inline-block;border-radius:999px;background:var(--bg);padding:4px 10px;font-size:12px;color:var(--text)">{{ m.get_full_name|default:m.username }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </div>
{% else %}
  <div class="card">
    <div style="padding:48px 24px;text-align:center;color:var(--muted)">
      <div style="font-size:48px;margin-bottom:12px">üë•</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:4px;color:var(--text)">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
      <div style="font-size:14px">{% if q %}–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å{% else %}–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞{% endif %}</div>
    </div>
  </div>
{% endif %}

<style>
@media (min-width:768px){
  .card a div[style*="display:none"]{display:flex !important}
}
@media (max-width:640px){
  .card-header{flex-direction:column;align-items:stretch;gap:12px}
  .card-header .btn{width:100%}
  .card a{flex-direction:column;align-items:flex-start}
}
</style>
{% endblock %}
