{# templates/core/counterparty_form.html #}
{% extends "base.html" %}

{% block title %}{% if edit_mode %}Изменить контрагента{% else %}Новый контрагент{% endif %}{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-4">
  {% if edit_mode %}Изменить контрагента{% else %}Новый контрагент{% endif %}
</h1>

<form method="post" enctype="multipart/form-data" class="space-y-5">
  {% csrf_token %}

  <div class="grid grid-cols-1 gap-4">

    {# ИНН + кнопка ЕГРЮЛ #}
    <div>
      {{ form.inn.label_tag }}
      {{ form.inn }}
      {% if form.inn.errors %}<div class="text-red-600 text-sm">{{ form.inn.errors }}</div>{% endif %}
      <div class="mt-2">
        <button type="button" id="btn-egrul" class="rounded-xl border px-3 py-2">Найти в ЕГРЮЛ</button>
      </div>
    </div>

    {# Краткое и полное наименование #}
    <div>
      {{ form.name.label_tag }}
      {{ form.name }}
      {% if form.name.errors %}<div class="text-red-600 text-sm">{{ form.name.errors }}</div>{% endif %}
    </div>

    <div>
      {{ form.full_name.label_tag }}
      {{ form.full_name }}
      {% if form.full_name.errors %}<div class="text-red-600 text-sm">{{ form.full_name.errors }}</div>{% endif %}
    </div>

    {# КПП / ОГРН / Страна #}
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        {{ form.kpp.label_tag }}
        {{ form.kpp }}
        {% if form.kpp.errors %}<div class="text-red-600 text-sm">{{ form.kpp.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.ogrn.label_tag }}
        {{ form.ogrn }}
        {% if form.ogrn.errors %}<div class="text-red-600 text-sm">{{ form.ogrn.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.registration_country.label_tag }}
        {{ form.registration_country }}
        {% if form.registration_country.errors %}<div class="text-red-600 text-sm">{{ form.registration_country.errors }}</div>{% endif %}
      </div>
    </div>

    {# Юр. адрес #}
    <div>
      {{ form.address.label_tag }}
      {{ form.address }}
      {% if form.address.errors %}<div class="text-red-600 text-sm">{{ form.address.errors }}</div>{% endif %}
    </div>

    {# Фактический/доставки #}
    <div>
      {{ form.actual_address.label_tag }}
      {{ form.actual_address }}
      {% if form.actual_address.errors %}<div class="text-red-600 text-sm">{{ form.actual_address.errors }}</div>{% endif %}
    </div>

    {# Банк: наименование / БИК / счёт #}
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        {{ form.bank_name.label_tag }}
        {{ form.bank_name }}
        {% if form.bank_name.errors %}<div class="text-red-600 text-sm">{{ form.bank_name.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.bank_bik.label_tag }}
        {{ form.bank_bik }}
        {% if form.bank_bik.errors %}<div class="text-red-600 text-sm">{{ form.bank_bik.errors }}</div>{% endif %}
      </div>
      <div>
        {{ form.bank_account.label_tag }}
        {{ form.bank_account }}
        {% if form.bank_account.errors %}<div class="text-red-600 text-sm">{{ form.bank_account.errors }}</div>{% endif %}
      </div>
    </div>

    {# Сайт #}
    <div>
      {{ form.website.label_tag }}
      {{ form.website }}
      {% if form.website.errors %}<div class="text-red-600 text-sm">{{ form.website.errors }}</div>{% endif %}
    </div>

    {# Менеджеры #}
    <div>
      <label class="block text-sm text-gray-600 mb-1">Закреплённые менеджеры</label>
      {{ form.managers }}
      {% if form.managers.errors %}<div class="text-red-600 text-sm">{{ form.managers.errors }}</div>{% endif %}
      <p class="text-xs text-gray-500 mt-1">Можно выбрать несколько.</p>
    </div>
  </div>

  {# Сканы документов #}
  {% if doc_formset %}
  <div class="rounded-xl border p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Сканы документов</h2>
      <button type="button" id="add-doc" class="rounded-xl border px-3 py-1">Добавить файл</button>
    </div>

    {{ doc_formset.management_form }}

    <div id="doc-forms" class="space-y-3">
      {% for f in doc_formset.forms %}
        {{ f.id }} {# скрытое поле для существующих #}
        <div class="border rounded-lg p-3">
          <div class="grid md:grid-cols-3 gap-4 items-start">
            <div>
              {{ f.title.label_tag }}
              {{ f.title }}
              {% if f.title.errors %}<div class="text-red-600 text-sm">{{ f.title.errors }}</div>{% endif %}
            </div>
            <div>
              {{ f.file.label_tag }}
              {{ f.file }}
              {% if f.file.errors %}<div class="text-red-600 text-sm">{{ f.file.errors }}</div>{% endif %}
              {% if f.instance.pk and f.instance.file %}
                <div class="mt-1 text-sm">
                  <a href="{{ f.instance.file.url }}" target="_blank" class="text-blue-600 underline">Просмотреть текущий файл</a>
                </div>
              {% endif %}
            </div>
            <div class="pt-6">
              {% if f.DELETE %}
                <label class="inline-flex items-center gap-2 text-red-600">
                  {{ f.DELETE }} удалить
                </label>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Пустой блок для JS-добавления новой строки #}
    <template id="doc-empty">
      <div class="border rounded-lg p-3">
        <div class="grid md:grid-cols-3 gap-4 items-start">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Название</label>
            REPLACE_TITLE
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Файл</label>
            REPLACE_FILE
          </div>
        </div>
      </div>
    </template>
  </div>
  {% endif %}
{# перед кнопками #}
{% if form.non_field_errors %}
  <div class="rounded-md bg-red-50 text-red-700 px-3 py-2 text-sm mb-2">
    {{ form.non_field_errors }}
  </div>
{% endif %}
{% if doc_formset %}
  {% if doc_formset.non_form_errors %}
    <div class="rounded-md bg-red-50 text-red-700 px-3 py-2 text-sm mb-2">
      {{ doc_formset.non_form_errors }}
    </div>
  {% endif %}
{% endif %}
  <div class="flex gap-2">
    <button type="submit" class="rounded-xl bg-black text-white px-4 py-2">Сохранить</button>
    <a href="javascript:history.back()" class="rounded-xl border px-4 py-2">Отмена</a>
  </div>
</form>
<script>
  // ==========================
  // 1) Автозаполнение из ЕГРЮЛ
  // ==========================
  (function () {
    const btn = document.getElementById('btn-egrul');
    if (!btn) return;

    const lookupUrl = "{% url 'core:counterparty_lookup_inn' %}"; // /counterparties/lookup/

    btn.addEventListener('click', async function () {
      const innInput = document.getElementById('id_inn');
      const inn = (innInput?.value || '').trim();

      if (!/^\d{10}(\d{2})?$/.test(inn)) {
        alert('Введите корректный ИНН: 10 (юр.лицо) или 12 (ИП) цифр.');
        innInput?.focus();
        return;
      }

      btn.disabled = true;

      try {
        const resp = await fetch(`${lookupUrl}?inn=${encodeURIComponent(inn)}`, { method: 'GET' });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          alert(data.error || 'Не удалось получить данные ЕГРЮЛ');
          return;
        }

        const d = data.data || {};

        // Заполняем известные поля из payload
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el && (val ?? '') !== '') el.value = val;
        };

        setVal('id_name', d.name);
        setVal('id_full_name', d.full_name);
        setVal('id_kpp', d.kpp);
        setVal('id_ogrn', d.ogrn);
        setVal('id_registration_country', d.registration_country || 'РОССИЯ');
        setVal('id_address', d.address);
        setVal('id_website', d.website);

        // Новые поля обычно не приходят из ЕГРЮЛ — оставляем как есть:
        // setVal('id_actual_address', d.actual_address);
        // setVal('id_bank_name', d.bank_name);
        // setVal('id_bank_bik', d.bank_bik);
        // setVal('id_bank_account', d.bank_account);
      } catch (e) {
        console.error(e);
        alert('Ошибка запроса к ЕГРЮЛ.');
      } finally {
        btn.disabled = false;
      }
    });
  })();


  // ==========================================
  // 2) Подсказки адресов (OSM Nominatim, бесплатно)
  //    для поля "Фактический адрес / адрес доставки"
  // ==========================================
  (function () {
    const input = document.getElementById('id_actual_address');
    if (!input) return;

    // создаём контейнер подсказок, если его нет
    const boxId = 'addr-suggest-box';
    let box = document.getElementById(boxId);
    if (!box) {
      box = document.createElement('div');
      box.id = boxId;
      box.className = 'hidden absolute z-50 mt-1 w-full rounded-lg border bg-white shadow';
      // обёртка-родитель для нормального позиционирования
      const wrapper = document.createElement('div');
      wrapper.className = 'relative';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      wrapper.appendChild(box);
    }

    const endpoint = "{% url 'core:address_suggest_osm' %}"; // /api/suggest/address/osm
    let timer = null;
    let lastQuery = '';

    function hideBox() {
      box.classList.add('hidden');
      box.innerHTML = '';
    }
    function showBox() {
      box.classList.remove('hidden');
    }
    function esc(s) {
      return (s || '').replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
    }
    function render(items) {
      if (!items || !items.length) {
        hideBox();
        return;
      }
      box.innerHTML = items.map(it => `
        <button type="button"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 focus:bg-gray-100"
                data-value="${esc(it.value)}">
          ${esc(it.value)}
        </button>
      `).join('');
      showBox();
    }

    async function fetchSuggest(q) {
      try {
        const resp = await fetch(`${endpoint}?q=${encodeURIComponent(q)}`, {
          headers: {"X-Requested-With": "XMLHttpRequest"}
        });
        const data = await resp.json();
        render((data && data.suggestions) || []);
      } catch (e) {
        console.error(e);
        hideBox();
      }
    }

    function debounce(fn, ms) {
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), ms);
      };
    }

    const onType = debounce(() => {
      const q = (input.value || '').trim();
      if (!q) { hideBox(); return; }
      if (q === lastQuery) return;
      lastQuery = q;
      fetchSuggest(q);
    }, 300);

    input.addEventListener('input', onType);
    input.addEventListener('focus', () => { if (box.innerHTML.trim()) showBox(); });
    // небольшая задержка, чтобы успеть кликнуть по пункту
    input.addEventListener('blur', () => setTimeout(hideBox, 150));

    box.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-value]');
      if (!btn) return;
      input.value = btn.getAttribute('data-value') || '';
      hideBox();
    });

    // ESC — скрыть подсказки
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { hideBox(); }
    });
  })();


  // ==========================================
  // 3) Добавление новой строки документа (Formset)
  // ==========================================
  (function () {
    const addBtn = document.getElementById('add-doc');
    if (!addBtn) return;

    // Если doc_formset не передан в шаблон — защищаемся от пустого селектора
    const totalInput = document.querySelector('input[name="{{ doc_formset.prefix|default_if_none:"__doc__" }}-TOTAL_FORMS"]') ||
                       document.querySelector('input[name$="-TOTAL_FORMS"]');
    const container  = document.getElementById('doc-forms');
    const tmplEl     = document.getElementById('doc-empty');

    if (!totalInput || !container || !tmplEl) return;

    const tmpl = tmplEl.innerHTML;

    addBtn.addEventListener('click', function () {
      const idx = parseInt(totalInput.value || '0', 10);
      const prefix = totalInput.name.replace(/-TOTAL_FORMS$/, ''); // вычисляем актуальный prefix
      const titleHtml = `<input type="text" name="${prefix}-${idx}-title" class="input">`;
      const fileHtml  = `<input type="file" name="${prefix}-${idx}-file" class="input">`;

      let html = tmpl.replace('REPLACE_TITLE', titleHtml)
                     .replace('REPLACE_FILE', fileHtml);

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      container.appendChild(wrapper.firstElementChild);

      totalInput.value = idx + 1;
    });
  })();
</script>

{% endblock %}
