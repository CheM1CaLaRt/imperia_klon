{# templates/core/counterparty_form.html #}
{% extends "base.html" %}

{% block title %}{% if edit_mode %}Изменить контрагента{% else %}Новый контрагент{% endif %} — IndigoFlow{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{% if edit_mode %}Изменить контрагента{% else %}Новый контрагент{% endif %}</h1>
      <p class="card-subtitle">{% if edit_mode %}Редактирование информации о контрагенте{% else %}Создание нового контрагента в системе{% endif %}</p>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="space-y-5" style="padding-top:20px">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="padding:12px 16px;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;color:#7f1d1d;font-size:14px">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="grid grid-cols-1 gap-5">

      {# ИНН + автоматический поиск в ЕГРЮЛ по Enter #}
      <div class="field">
        {{ form.inn.label_tag }}
        <div style="position:relative">
          {{ form.inn }}
          <div id="egrul-loading" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:14px">
            Поиск...
          </div>
        </div>
        {% if form.inn.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.inn.errors }}</div>{% endif %}
        <div style="margin-top:6px;font-size:13px;color:var(--muted)">
          Введите ИНН и нажмите Enter для автоматического поиска в ЕГРЮЛ
        </div>
        <button type="button" id="btn-egrul" style="display:none">Найти в ЕГРЮЛ</button>
      </div>

      {# Краткое и полное наименование #}
      <div class="field">
        {{ form.name.label_tag }}
        {{ form.name }}
        {% if form.name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.name.errors }}</div>{% endif %}
      </div>

      <div class="field">
        {{ form.full_name.label_tag }}
        {{ form.full_name }}
        {% if form.full_name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.full_name.errors }}</div>{% endif %}
      </div>

      {# КПП / ОГРН / Страна #}
      <div class="grid grid-3">
        <div class="field">
          {{ form.kpp.label_tag }}
          {{ form.kpp }}
          {% if form.kpp.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.kpp.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.ogrn.label_tag }}
          {{ form.ogrn }}
          {% if form.ogrn.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.ogrn.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.registration_country.label_tag }}
          {{ form.registration_country }}
          {% if form.registration_country.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.registration_country.errors }}</div>{% endif %}
        </div>
      </div>

      {# Юр. адрес #}
      <div class="field">
        {{ form.address.label_tag }}
        {{ form.address }}
        {% if form.address.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.address.errors }}</div>{% endif %}
      </div>

      {# Фактический/доставки #}
      <div class="field">
        {{ form.actual_address.label_tag }}
        {{ form.actual_address }}
        {% if form.actual_address.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.actual_address.errors }}</div>{% endif %}
      </div>

      {# Банк: наименование / БИК / счёт #}
      <div class="grid grid-3">
        <div class="field">
          {{ form.bank_name.label_tag }}
          {{ form.bank_name }}
          {% if form.bank_name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_name.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.bank_bik.label_tag }}
          {{ form.bank_bik }}
          {% if form.bank_bik.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_bik.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.bank_account.label_tag }}
          {{ form.bank_account }}
          {% if form.bank_account.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_account.errors }}</div>{% endif %}
        </div>
      </div>

      {# Сайт #}
      <div class="field">
        {{ form.website.label_tag }}
        {{ form.website }}
        {% if form.website.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.website.errors }}</div>{% endif %}
      </div>

      {# Менеджеры #}
      <div class="field">
        <label class="field label">Закреплённые менеджеры</label>
        {{ form.managers }}
        {% if form.managers.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.managers.errors }}</div>{% endif %}
        <p style="font-size:13px;color:var(--muted);margin-top:4px">Можно выбрать несколько.</p>
      </div>
    </div>

    {# Сканы документов #}
    {% if doc_formset %}
    <div class="card" style="margin-top:24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
        <h2 style="font-size:18px;font-weight:700;margin:0">Сканы документов</h2>
        <button type="button" id="add-doc" class="btn btn-secondary">+ Добавить файл</button>
      </div>

      {{ doc_formset.management_form }}

      <div id="doc-forms" style="display:grid;gap:12px">
        {% for f in doc_formset.forms %}
          {{ f.id }}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
            <div class="grid grid-3" style="gap:16px">
              <div class="field">
                {{ f.title.label_tag }}
                {{ f.title }}
                {% if f.title.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ f.title.errors }}</div>{% endif %}
              </div>
              <div class="field">
                {{ f.file.label_tag }}
                {{ f.file }}
                {% if f.file.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ f.file.errors }}</div>{% endif %}
                {% if f.instance.pk and f.instance.file %}
                  <div style="margin-top:8px">
                    <a href="{{ f.instance.file.url }}" target="_blank" style="color:var(--primary);text-decoration:none;font-size:13px">Просмотреть текущий файл</a>
                  </div>
                {% endif %}
              </div>
              <div style="display:flex;align-items:end;padding-bottom:8px">
                {% if f.DELETE %}
                  <label style="display:flex;align-items:center;gap:8px;color:#7f1d1d;font-size:14px;cursor:pointer">
                    {{ f.DELETE }}
                    <span>Удалить</span>
                  </label>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {# Пустой блок для JS-добавления новой строки #}
      <template id="doc-empty">
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div class="grid grid-3" style="gap:16px">
            <div class="field">
              <label class="field label">Название</label>
              REPLACE_TITLE
            </div>
            <div class="field">
              <label class="field label">Файл</label>
              REPLACE_FILE
            </div>
            <div></div>
          </div>
        </div>
      </template>
    </div>
    {% endif %}

    {% if doc_formset %}
      {% if doc_formset.non_form_errors %}
        <div style="padding:12px 16px;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;color:#7f1d1d;font-size:14px;margin-top:20px">
          {{ doc_formset.non_form_errors }}
        </div>
      {% endif %}
    {% endif %}

    <div style="display:flex;gap:12px;padding-top:20px;border-top:1px solid var(--border);margin-top:24px">
      <button type="submit" class="btn btn-primary">Сохранить</button>
      <a href="javascript:history.back()" class="btn btn-secondary">Отмена</a>
    </div>
  </form>
</div>

<script>
  // ==========================
  // 1) Автозаполнение из ЕГРЮЛ по Enter
  // ==========================
  (function () {
    const innInput = document.getElementById('id_inn');
    const btn = document.getElementById('btn-egrul');
    const loadingEl = document.getElementById('egrul-loading');
    
    if (!innInput) return;

    const lookupUrl = "{% url 'core:counterparty_lookup_inn' %}";

    async function performLookup() {
      const inn = (innInput.value || '').trim();

      if (!/^\d{10}(\d{2})?$/.test(inn)) {
        alert('Введите корректный ИНН: 10 (юр.лицо) или 12 (ИП) цифр.');
        innInput.focus();
        return;
      }

      if (loadingEl) loadingEl.style.display = 'block';
      if (btn) btn.disabled = true;
      innInput.disabled = true;

      try {
        const resp = await fetch(`${lookupUrl}?inn=${encodeURIComponent(inn)}`, { method: 'GET' });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          alert(data.error || 'Не удалось получить данные ЕГРЮЛ');
          return;
        }

        const d = data.data || {};

        // Заполняем известные поля из payload
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el && (val ?? '') !== '') el.value = val;
        };

        setVal('id_name', d.name);
        setVal('id_full_name', d.full_name);
        setVal('id_kpp', d.kpp);
        setVal('id_ogrn', d.ogrn);
        setVal('id_registration_country', d.registration_country || 'РОССИЯ');
        setVal('id_address', d.address);
        setVal('id_website', d.website);

        // Показываем уведомление об успехе
        if (loadingEl) {
          loadingEl.style.color = '#10b981';
          loadingEl.textContent = '✓ Данные загружены';
          setTimeout(() => {
            loadingEl.style.display = 'none';
            loadingEl.style.color = '';
            loadingEl.textContent = 'Поиск...';
          }, 2000);
        }
      } catch (e) {
        console.error(e);
        alert('Ошибка запроса к ЕГРЮЛ.');
        if (loadingEl) loadingEl.style.display = 'none';
      } finally {
        if (btn) btn.disabled = false;
        innInput.disabled = false;
      }
    }

    // Обработка Enter в поле ИНН
    innInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        performLookup();
      }
    });

    // Кнопка как fallback (скрыта, но можно использовать программно)
    if (btn) {
      btn.addEventListener('click', performLookup);
    }
  })();


  // ==========================================
  // 2) Подсказки адресов (OSM Nominatim)
  // ==========================================
  (function () {
    const input = document.getElementById('id_actual_address');
    if (!input) return;

    const boxId = 'addr-suggest-box';
    let box = document.getElementById(boxId);
    if (!box) {
      box = document.createElement('div');
      box.id = boxId;
      box.style.cssText = 'display:none;position:absolute;z-index:50;margin-top:4px;width:100%;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);max-height:300px;overflow-y:auto';
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      wrapper.appendChild(box);
    }

    const endpoint = "{% url 'core:address_suggest_osm' %}";
    let timer = null;
    let lastQuery = '';

    function hideBox() { box.style.display = 'none'; box.innerHTML = ''; }
    function showBox() { box.style.display = 'block'; }
    function esc(s) {
      return (s || '').replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
    }
    function render(items) {
      if (!items || !items.length) { hideBox(); return; }
      box.innerHTML = items.map(it => `
        <button type="button"
                style="width:100%;text-align:left;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.2s"
                onmouseover="this.style.background='var(--bg)'"
                onmouseout="this.style.background='transparent'"
                data-value="${esc(it.value)}">
          ${esc(it.value)}
        </button>
      `).join('');
      showBox();
    }

    async function fetchSuggest(q) {
      try {
        const resp = await fetch(`${endpoint}?q=${encodeURIComponent(q)}`, {
          headers: {"X-Requested-With": "XMLHttpRequest"}
        });
        const data = await resp.json();
        render((data && data.suggestions) || []);
      } catch (e) {
        console.error(e);
        hideBox();
      }
    }

    function debounce(fn, ms) {
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), ms);
      };
    }

    const onType = debounce(() => {
      const q = (input.value || '').trim();
      if (!q) { hideBox(); return; }
      if (q === lastQuery) return;
      lastQuery = q;
      fetchSuggest(q);
    }, 300);

    input.addEventListener('input', onType);
    input.addEventListener('focus', () => { if (box.innerHTML.trim()) showBox(); });
    input.addEventListener('blur', () => setTimeout(hideBox, 150));

    box.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-value]');
      if (!btn) return;
      input.value = btn.getAttribute('data-value') || '';
      hideBox();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideBox();
    });
  })();


  // ==========================================
  // 3) Добавление новой строки документа (Formset)
  // ==========================================
  (function () {
    const addBtn = document.getElementById('add-doc');
    if (!addBtn) return;

    const totalInput = document.querySelector('input[name="{{ doc_formset.prefix|default_if_none:"__doc__" }}-TOTAL_FORMS"]') ||
                       document.querySelector('input[name$="-TOTAL_FORMS"]');
    const container  = document.getElementById('doc-forms');
    const tmplEl     = document.getElementById('doc-empty');

    if (!totalInput || !container || !tmplEl) return;

    const tmpl = tmplEl.innerHTML;

    addBtn.addEventListener('click', function () {
      const idx = parseInt(totalInput.value || '0', 10);
      const prefix = totalInput.name.replace(/-TOTAL_FORMS$/, '');
      const titleHtml = `<input type="text" name="${prefix}-${idx}-title" class="field input">`;
      const fileHtml  = `<input type="file" name="${prefix}-${idx}-file" class="field input">`;

      let html = tmpl.replace('REPLACE_TITLE', titleHtml)
                     .replace('REPLACE_FILE', fileHtml);

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      container.appendChild(wrapper.firstElementChild);

      totalInput.value = idx + 1;
    });
  })();
</script>
{% endblock %}
