{# templates/core/counterparty_form.html #}
{% extends "base.html" %}

{% block title %}{% if edit_mode %}–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞{% else %}–ù–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç{% endif %} ‚Äî IndigoFlow{% endblock %}

{% block content %}
<style>
  .yandex-map-btn {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    box-shadow: none !important;
  }
  .yandex-map-btn:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }
  .yandex-map-btn:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
  }
  .yandex-map-btn:invalid {
    box-shadow: none !important;
  }
</style>
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{% if edit_mode %}–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞{% else %}–ù–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç{% endif %}</h1>
      <p class="card-subtitle">{% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ{% else %}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ{% endif %}</p>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="space-y-5" style="padding-top:20px">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="padding:12px 16px;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;color:#7f1d1d;font-size:14px">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="grid grid-cols-1 gap-5">

      {# –ò–ù–ù + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤ –ï–ì–†–Æ–õ –ø–æ Enter #}
      <div class="field">
        {{ form.inn.label_tag }}
        <div style="position:relative">
          {{ form.inn }}
          <div id="egrul-loading" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:14px">
            –ü–æ–∏—Å–∫...
          </div>
        </div>
        {% if form.inn.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.inn.errors }}</div>{% endif %}
        <div style="margin-top:6px;font-size:13px;color:var(--muted)">
          –í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –ï–ì–†–Æ–õ
        </div>
        <button type="button" id="btn-egrul" style="display:none">–ù–∞–π—Ç–∏ –≤ –ï–ì–†–Æ–õ</button>
      </div>

      {# –ö—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ #}
      <div class="field">
        {{ form.name.label_tag }}
        {{ form.name }}
        {% if form.name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.name.errors }}</div>{% endif %}
      </div>

      <div class="field">
        {{ form.full_name.label_tag }}
        {{ form.full_name }}
        {% if form.full_name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.full_name.errors }}</div>{% endif %}
      </div>

      {# –ö–ü–ü / –û–ì–†–ù / –°—Ç—Ä–∞–Ω–∞ #}
      <div class="grid grid-3">
        <div class="field">
          {{ form.kpp.label_tag }}
          {{ form.kpp }}
          {% if form.kpp.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.kpp.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.ogrn.label_tag }}
          {{ form.ogrn }}
          {% if form.ogrn.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.ogrn.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.registration_country.label_tag }}
          {{ form.registration_country }}
          {% if form.registration_country.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.registration_country.errors }}</div>{% endif %}
        </div>
      </div>

      {# –Æ—Ä. –∞–¥—Ä–µ—Å #}
      <div class="field">
        {{ form.address.label_tag }}
        {{ form.address }}
        {% if form.address.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.address.errors }}</div>{% endif %}
        <button type="button" 
                class="yandex-map-btn" 
                data-address-field="id_address"
                style="margin-top:8px;background:var(--primary);color:white;border:none;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;text-decoration:none;transition:opacity 0.2s,background 0.2s;outline:none"
                tabindex="0">
          <span>üó∫Ô∏è</span>
          <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
        </button>
      </div>

      {# –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ #}
      {% if address_formset %}
      <div class="field">
        <label class="field-label" style="font-weight:600;margin-bottom:16px;display:block;font-size:15px;color:#1f2937">
          –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞–¥—Ä–µ—Å–∞ / –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        </label>
        <div id="address-formset-container" style="display:flex;flex-direction:column;gap:16px">
          {{ address_formset.management_form }}
          {% for addr_form in address_formset %}
            <div class="address-form-row" style="padding:20px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;position:relative;transition:all 0.2s">
              {% if addr_form.DELETE %}
                <div style="position:absolute;top:16px;right:16px;display:flex;align-items:center;gap:6px">
                  {{ addr_form.DELETE }}
                  <label for="{{ addr_form.DELETE.id_for_label }}" style="cursor:pointer;color:#dc2626;font-size:13px;font-weight:500;user-select:none">–£–¥–∞–ª–∏—Ç—å</label>
                </div>
              {% endif %}
              {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ #}
              {% for hidden in addr_form.hidden_fields %}
                {{ hidden }}
              {% endfor %}
              <div style="display:flex;flex-direction:column;gap:12px;padding-right:100px">
                <div>
                  {{ addr_form.address }}
                  {% if addr_form.address.errors %}
                    <div style="color:#dc2626;font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px">
                      <span>‚ö†</span>
                      <span>{{ addr_form.address.errors }}</span>
                    </div>
                  {% endif %}
                </div>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding-top:4px">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;color:#374151;user-select:none">
                    {{ addr_form.is_default }}
                    <span style="font-weight:500">–ê–¥—Ä–µ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                  </label>
                  <button type="button" 
                          class="yandex-map-btn" 
                          data-address-field="{{ addr_form.address.id_for_label }}"
                          style="background:#3b82f6;color:white;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:6px;text-decoration:none;transition:all 0.2s;outline:none;box-shadow:0 1px 2px rgba(0,0,0,0.05)"
                          tabindex="0"
                          onmouseover="this.style.background='#2563eb';this.style.transform='translateY(-1px)';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                          onmouseout="this.style.background='#3b82f6';this.style.transform='';this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
                    <span style="font-size:14px">üó∫Ô∏è</span>
                    <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                  </button>
                </div>
              </div>
              {% if addr_form.non_field_errors %}
                <div style="color:#dc2626;font-size:12px;margin-top:8px;padding:8px;background:#fef2f2;border-radius:6px;border-left:3px solid #dc2626">
                  {{ addr_form.non_field_errors }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        {% if address_formset.non_form_errors %}
          <div style="color:#dc2626;font-size:13px;margin-top:12px;padding:12px;background:#fef2f2;border-radius:8px;border-left:3px solid #dc2626">
            {{ address_formset.non_form_errors }}
          </div>
        {% endif %}
        <button type="button" id="add-address-btn" style="margin-top:16px;background:#3b82f6;color:white;border:none;border-radius:10px;padding:10px 20px;font-size:14px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;box-shadow:0 2px 4px rgba(59,130,246,0.2)"
                onmouseover="this.style.background='#2563eb';this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 6px rgba(59,130,246,0.3)'"
                onmouseout="this.style.background='#3b82f6';this.style.transform='';this.style.boxShadow='0 2px 4px rgba(59,130,246,0.2)'">
          <span style="font-size:18px;font-weight:bold">+</span>
          <span>–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</span>
        </button>
      </div>
      {% endif %}

      {# –ë–∞–Ω–∫: –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –ë–ò–ö / —Å—á—ë—Ç / –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç #}
      <div class="grid grid-2" style="gap:16px">
        <div class="field">
          {{ form.bank_name.label_tag }}
          {{ form.bank_name }}
          {% if form.bank_name.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_name.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.bank_bik.label_tag }}
          {{ form.bank_bik }}
          {% if form.bank_bik.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_bik.errors }}</div>{% endif %}
        </div>
      </div>
      <div class="grid grid-2" style="gap:16px">
        <div class="field">
          {{ form.bank_account.label_tag }}
          {{ form.bank_account }}
          {% if form.bank_account.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_account.errors }}</div>{% endif %}
        </div>
        <div class="field">
          {{ form.bank_corr_account.label_tag }}
          {{ form.bank_corr_account }}
          {% if form.bank_corr_account.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.bank_corr_account.errors }}</div>{% endif %}
        </div>
      </div>

      {# –°–∞–π—Ç #}
      <div class="field">
        {{ form.website.label_tag }}
        {{ form.website }}
        {% if form.website.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.website.errors }}</div>{% endif %}
      </div>

      {# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã #}
      <div class="field">
        <label class="field label">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</label>
        {{ form.managers }}
        {% if form.managers.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ form.managers.errors }}</div>{% endif %}
        <p style="font-size:13px;color:var(--muted);margin-top:4px">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</p>
      </div>
    </div>

    {# –°–∫–∞–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ #}
    {% if doc_formset %}
    <div class="card" style="margin-top:24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
        <h2 style="font-size:18px;font-weight:700;margin:0">–°–∫–∞–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
        <button type="button" id="add-doc" class="btn btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
      </div>

      {{ doc_formset.management_form }}

      <div id="doc-forms" style="display:grid;gap:12px">
        {% for f in doc_formset.forms %}
          {{ f.id }}
          <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
            <div class="grid grid-3" style="gap:16px">
              <div class="field">
                {{ f.title.label_tag }}
                {{ f.title }}
                {% if f.title.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ f.title.errors }}</div>{% endif %}
              </div>
              <div class="field">
                {{ f.file.label_tag }}
                {{ f.file }}
                {% if f.file.errors %}<div style="color:#ef4444;font-size:13px;margin-top:4px">{{ f.file.errors }}</div>{% endif %}
                {% if f.instance.pk and f.instance.file %}
                  <div style="margin-top:8px">
                    <a href="{{ f.instance.file.url }}" target="_blank" style="color:var(--primary);text-decoration:none;font-size:13px">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª</a>
                  </div>
                {% endif %}
              </div>
              <div style="display:flex;align-items:end;padding-bottom:8px">
                {% if f.DELETE %}
                  <label style="display:flex;align-items:center;gap:8px;color:#7f1d1d;font-size:14px;cursor:pointer">
                    {{ f.DELETE }}
                    <span>–£–¥–∞–ª–∏—Ç—å</span>
                  </label>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {# –ü—É—Å—Ç–æ–π –±–ª–æ–∫ –¥–ª—è JS-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ #}
      <template id="doc-empty">
        <div style="padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg)">
          <div class="grid grid-3" style="gap:16px">
            <div class="field">
              <label class="field label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              REPLACE_TITLE
            </div>
            <div class="field">
              <label class="field label">–§–∞–π–ª</label>
              REPLACE_FILE
            </div>
            <div></div>
          </div>
        </div>
      </template>
    </div>
    {% endif %}

    {% if doc_formset %}
      {% if doc_formset.non_form_errors %}
        <div style="padding:12px 16px;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;color:#7f1d1d;font-size:14px;margin-top:20px">
          {{ doc_formset.non_form_errors }}
        </div>
      {% endif %}
    {% endif %}

    <div style="display:flex;gap:12px;padding-top:20px;border-top:1px solid var(--border);margin-top:24px">
      <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <a href="javascript:history.back()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>
</div>

<script>
  // ==========================
  // 1) –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –ï–ì–†–Æ–õ –ø–æ Enter
  // ==========================
  (function () {
    const innInput = document.getElementById('id_inn');
    const btn = document.getElementById('btn-egrul');
    const loadingEl = document.getElementById('egrul-loading');
    
    if (!innInput) return;

    const lookupUrl = "{% url 'core:counterparty_lookup_inn' %}";

    async function performLookup() {
      const inn = (innInput.value || '').trim();

      if (!/^\d{10}(\d{2})?$/.test(inn)) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò–ù–ù: 10 (—é—Ä.–ª–∏—Ü–æ) –∏–ª–∏ 12 (–ò–ü) —Ü–∏—Ñ—Ä.');
        innInput.focus();
        return;
      }

      if (loadingEl) loadingEl.style.display = 'block';
      if (btn) btn.disabled = true;
      innInput.disabled = true;

      try {
        const resp = await fetch(`${lookupUrl}?inn=${encodeURIComponent(inn)}`, { method: 'GET' });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          alert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ï–ì–†–Æ–õ');
          return;
        }

        const d = data.data || {};

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è –∏–∑ payload
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el && (val ?? '') !== '') el.value = val;
        };

        setVal('id_name', d.name);
        setVal('id_full_name', d.full_name);
        setVal('id_kpp', d.kpp);
        setVal('id_ogrn', d.ogrn);
        setVal('id_registration_country', d.registration_country || '–†–û–°–°–ò–Ø');
        setVal('id_address', d.address);
        setVal('id_website', d.website);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—Ç –ø–æ—Å–ª–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        setTimeout(function() {
          document.querySelectorAll('.yandex-map-btn').forEach(function(btn) {
            var fieldId = btn.getAttribute('data-address-field');
            var addressField = document.getElementById(fieldId);
            if (addressField) {
              var hasValue = (addressField.value || '').trim().length > 0;
              if (hasValue) {
                btn.style.background = 'var(--primary)';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
              }
            }
          });
        }, 100);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        if (loadingEl) {
          loadingEl.style.color = '#10b981';
          loadingEl.textContent = '‚úì –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
          setTimeout(() => {
            loadingEl.style.display = 'none';
            loadingEl.style.color = '';
            loadingEl.textContent = '–ü–æ–∏—Å–∫...';
          }, 2000);
        }
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ï–ì–†–Æ–õ.');
        if (loadingEl) loadingEl.style.display = 'none';
      } finally {
        if (btn) btn.disabled = false;
        innInput.disabled = false;
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –ò–ù–ù
    innInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        performLookup();
      }
    });

    // –ö–Ω–æ–ø–∫–∞ –∫–∞–∫ fallback (—Å–∫—Ä—ã—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ)
    if (btn) {
      btn.addEventListener('click', performLookup);
    }
  })();


  // ==========================================
  // 2) –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤ (OSM Nominatim)
  // ==========================================
  (function () {
    const input = document.getElementById('id_actual_address');
    if (!input) return;

    const boxId = 'addr-suggest-box';
    let box = document.getElementById(boxId);
    if (!box) {
      box = document.createElement('div');
      box.id = boxId;
      box.style.cssText = 'display:none;position:absolute;z-index:50;margin-top:4px;width:100%;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);max-height:300px;overflow-y:auto';
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      wrapper.appendChild(box);
    }

    const endpoint = "{% url 'core:address_suggest_osm' %}";
    let timer = null;
    let lastQuery = '';

    function hideBox() { box.style.display = 'none'; box.innerHTML = ''; }
    function showBox() { box.style.display = 'block'; }
    function esc(s) {
      return (s || '').replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
    }
    function render(items) {
      if (!items || !items.length) { hideBox(); return; }
      box.innerHTML = items.map(it => `
        <button type="button"
                style="width:100%;text-align:left;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.2s"
                onmouseover="this.style.background='var(--bg)'"
                onmouseout="this.style.background='transparent'"
                data-value="${esc(it.value)}">
          ${esc(it.value)}
        </button>
      `).join('');
      showBox();
    }

    async function fetchSuggest(q) {
      try {
        const resp = await fetch(`${endpoint}?q=${encodeURIComponent(q)}`, {
          headers: {"X-Requested-With": "XMLHttpRequest"}
        });
        const data = await resp.json();
        render((data && data.suggestions) || []);
      } catch (e) {
        console.error(e);
        hideBox();
      }
    }

    function debounce(fn, ms) {
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), ms);
      };
    }

    const onType = debounce(() => {
      const q = (input.value || '').trim();
      if (!q) { hideBox(); return; }
      if (q === lastQuery) return;
      lastQuery = q;
      fetchSuggest(q);
    }, 300);

    input.addEventListener('input', onType);
    input.addEventListener('focus', () => { if (box.innerHTML.trim()) showBox(); });
    input.addEventListener('blur', () => setTimeout(hideBox, 150));

    box.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-value]');
      if (!btn) return;
      input.value = btn.getAttribute('data-value') || '';
      hideBox();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideBox();
    });
  })();


  // ==========================================
  // 3) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (Formset)
  // ==========================================
  (function () {
    const addBtn = document.getElementById('add-doc');
    if (!addBtn) return;

    const totalInput = document.querySelector('input[name="{{ doc_formset.prefix|default_if_none:"__doc__" }}-TOTAL_FORMS"]') ||
                       document.querySelector('input[name$="-TOTAL_FORMS"]');
    const container  = document.getElementById('doc-forms');
    const tmplEl     = document.getElementById('doc-empty');

    if (!totalInput || !container || !tmplEl) return;

    const tmpl = tmplEl.innerHTML;

    addBtn.addEventListener('click', function () {
      const idx = parseInt(totalInput.value || '0', 10);
      const prefix = totalInput.name.replace(/-TOTAL_FORMS$/, '');
      const titleHtml = `<input type="text" name="${prefix}-${idx}-title" class="field input">`;
      const fileHtml  = `<input type="file" name="${prefix}-${idx}-file" class="field input">`;

      let html = tmpl.replace('REPLACE_TITLE', titleHtml)
                     .replace('REPLACE_FILE', fileHtml);

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      container.appendChild(wrapper.firstElementChild);

      totalInput.value = idx + 1;
    });
  })();


  // ==========================================
  // 4) –ö–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ" –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤
  // ==========================================
  (function () {
    function updateButtonStyle(btn, hasValue) {
      if (hasValue) {
        btn.style.background = 'var(--primary)';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.style.pointerEvents = 'auto';
      } else {
        btn.style.background = 'var(--muted)';
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        btn.style.pointerEvents = 'auto';
      }
    }

    function setupMapButton(btn) {
      var fieldId = btn.getAttribute('data-address-field');
      var addressField = document.getElementById(fieldId);
      
      if (!addressField) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      updateButtonStyle(btn, (addressField.value || '').trim().length > 0);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
      addressField.addEventListener('input', function() {
        updateButtonStyle(btn, (this.value || '').trim().length > 0);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ –ï–ì–†–Æ–õ)
      addressField.addEventListener('change', function() {
        updateButtonStyle(btn, (this.value || '').trim().length > 0);
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
      btn.addEventListener('mouseenter', function() {
        if ((addressField.value || '').trim().length > 0) {
          this.style.opacity = '0.9';
          this.style.transform = 'scale(1.02)';
        }
      });
      
      btn.addEventListener('mouseleave', function() {
        this.style.opacity = '';
        this.style.transform = '';
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        var address = (addressField.value || '').trim();
        
        if (!address) {
          alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å –≤ –ø–æ–ª–µ');
          addressField.focus();
          return false;
        }
        
        var url = 'https://yandex.ru/maps/?text=' + encodeURIComponent(address);
        window.open(url, '_blank', 'noopener,noreferrer');
        return false;
      });
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º submit —Ñ–æ—Ä–º—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –∫–Ω–æ–ø–∫–µ
      btn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          e.stopPropagation();
          this.click();
        }
      });
    }

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.yandex-map-btn').forEach(setupMapButton);
      });
    } else {
      document.querySelectorAll('.yandex-map-btn').forEach(setupMapButton);
    }
  })();


  // ==========================================
  // 4) –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è formset
  // ==========================================
  (function () {
    const endpoint = "{% url 'core:address_suggest_osm' %}";
    
    function initAddressAutocomplete(input) {
      if (!input || input.dataset.autocompleteInitialized) return;
      input.dataset.autocompleteInitialized = 'true';
      
      const boxId = 'addr-suggest-box-' + input.id;
      let box = document.getElementById(boxId);
      let wrapper = input.parentElement;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–±–µ—Ä—Ç–∫–∞
      if (!wrapper || wrapper.tagName !== 'DIV' || !wrapper.style.position) {
        // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
      }
      
      if (!box) {
        box = document.createElement('div');
        box.id = boxId;
        box.style.cssText = 'display:none;position:absolute;z-index:9999;margin-top:4px;width:100%;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);max-height:300px;overflow-y:auto';
        wrapper.appendChild(box);
      }

      let timer = null;
      let lastQuery = '';
      let currentController = null; // –î–ª—è –æ—Ç–º–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
      let isRequesting = false; // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      let hideTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –±–æ–∫—Å–∞

      function hideBox() { 
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
        box.style.display = 'none'; 
        box.innerHTML = ''; 
      }
      
      function showBox() { 
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
        box.style.display = 'block'; 
      }
      
      function esc(s) {
        return (s || '').replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;');
      }
      
      function render(items) {
        if (!items || !items.length) { 
          hideBox(); 
          return; 
        }
        box.innerHTML = items.map(it => `
          <button type="button"
                  style="width:100%;text-align:left;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.2s"
                  onmouseover="this.style.background='var(--bg)'"
                  onmouseout="this.style.background='transparent'"
                  data-value="${esc(it.value)}">
            ${esc(it.value)}
          </button>
        `).join('');
        showBox();
      }

      async function fetchSuggest(q) {
        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
        if (currentController) {
          currentController.abort();
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π AbortController –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        currentController = new AbortController();
        const signal = currentController.signal;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        isRequesting = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        box.innerHTML = '<div style="padding:12px 16px;text-align:center;color:var(--muted);font-size:14px">–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤...</div>';
        showBox();
        
        try {
          const resp = await fetch(`${endpoint}?q=${encodeURIComponent(q)}`, {
            headers: {"X-Requested-With": "XMLHttpRequest"},
            signal: signal
          });
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω
          if (signal.aborted) {
            return;
          }
          
          if (!resp.ok) {
            hideBox();
            return;
          }
          
          const data = await resp.json();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω
          if (signal.aborted) {
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤—Å–µ –µ—â–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (q –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
          if (q === lastQuery) {
            render((data && data.suggestions) || []);
          }
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞
          if (e.name === 'AbortError') {
            return;
          }
          hideBox();
        } finally {
          isRequesting = false;
          currentController = null;
        }
      }

      function debounce(fn, ms) {
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), ms);
        };
      }

      const onType = debounce(() => {
        const q = (input.value || '').trim();
        
        if (!q) { 
          lastQuery = '';
          hideBox(); 
          return; 
        }
        
        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        if (q === lastQuery) {
          return;
        }
        
        lastQuery = q;
        
        if (q.length >= 3) {
          fetchSuggest(q);
        } else {
          hideBox();
        }
      }, 400); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º debounce –¥–æ 400ms –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã

      input.addEventListener('input', onType);
      
      input.addEventListener('focus', () => { 
        const q = (input.value || '').trim();
        if (q && q.length >= 3 && q !== lastQuery) {
          lastQuery = q;
          fetchSuggest(q);
        } else if (box.innerHTML.trim() && !isRequesting) {
          showBox();
        }
      });
      
      input.addEventListener('blur', () => {
        // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ, —á—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –ø–æ–¥—Å–∫–∞–∑–∫–µ —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å
        hideTimeout = setTimeout(() => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ–∫—É—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—à–µ–ª (–Ω–µ –ø–µ—Ä–µ—à–µ–ª –Ω–∞ –±–æ–∫—Å)
          if (document.activeElement !== input && !box.contains(document.activeElement)) {
            hideBox();
          }
        }, 200);
      });
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –±–æ–∫—Å
      box.addEventListener('mouseenter', () => {
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      });
      
      box.addEventListener('mouseleave', () => {
        // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞, —Å–∫—Ä—ã–≤–∞–µ–º –±–æ–∫—Å
        if (document.activeElement !== input) {
          hideTimeout = setTimeout(hideBox, 150);
        }
      });

      box.addEventListener('mousedown', (e) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º mousedown –≤–º–µ—Å—Ç–æ click, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å blur
        e.preventDefault();
        const btn = e.target.closest('button[data-value]');
        if (!btn) return;
        const value = btn.getAttribute('data-value') || '';
        input.value = value;
        lastQuery = value; // –û–±–Ω–æ–≤–ª—è–µ–º lastQuery, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        hideBox();
        input.focus(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideBox();
      });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π –∞–¥—Ä–µ—Å–æ–≤
    function initAllAddressAutocompletes() {
      // –ò—â–µ–º –≤—Å–µ –ø–æ–ª—è –∞–¥—Ä–µ—Å–æ–≤ –≤ formset - –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
      const selectors = [
        '#address-formset-container input[id$="-address"]',
        '#address-formset-container input[name$="-address"]',
        '#address-formset-container input[type="text"][placeholder*="–∞–¥—Ä–µ—Å"]',
        '.address-form-row input[type="text"]'
      ];
      
      let addressInputs = [];
      for (const selector of selectors) {
        addressInputs = document.querySelectorAll(selector);
        if (addressInputs.length > 0) break;
      }
      
      addressInputs.forEach(input => {
        if (input && !input.disabled && input.type === 'text') {
          initAddressAutocomplete(input);
        }
      });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
    function initWhenReady() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initAllAddressAutocompletes, 200);
        });
      } else {
        setTimeout(initAllAddressAutocompletes, 200);
      }
    }
    
    initWhenReady();
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ MutationObserver
    const container = document.getElementById('address-formset-container');
    if (container) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === 1) { // Element node
                const addressInputs = node.querySelectorAll && node.querySelectorAll('input[id$="-address"], input[name$="-address"], input[type="text"][placeholder*="–∞–¥—Ä–µ—Å"]');
                if (addressInputs && addressInputs.length > 0) {
                  addressInputs.forEach(input => {
                    if (input && !input.disabled && !input.dataset.autocompleteInitialized) {
                      setTimeout(() => initAddressAutocomplete(input), 100);
                    }
                  });
                }
              }
            });
          }
        });
      });
      
      observer.observe(container, {
        childList: true,
        subtree: true
      });
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ formset
    window.initAddressAutocomplete = initAddressAutocomplete;
    window.initAllAddressAutocompletes = initAllAddressAutocompletes;
  })();

  // ==========================================
  // 5) Formset –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏
  // ==========================================
  (function () {
    const addBtn = document.getElementById('add-address-btn');
    if (!addBtn) return;

    const totalInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const container = document.getElementById('address-formset-container');
    if (!totalInput || !container) return;

    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ—Ñ–∏–∫—Å formset
    const prefix = totalInput.name.replace(/-TOTAL_FORMS$/, '');
    
    // –ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω –∏–∑ –ø–µ—Ä–≤–æ–π —Ñ–æ—Ä–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const firstRow = container.querySelector('.address-form-row');
    if (!firstRow) return;

    addBtn.addEventListener('click', function () {
      const idx = parseInt(totalInput.value || '0', 10);
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
      const newRow = document.createElement('div');
      newRow.className = 'address-form-row';
      newRow.style.cssText = 'padding:20px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;position:relative;transition:all 0.2s';
      
      newRow.innerHTML = `
        <div style="position:absolute;top:16px;right:16px;display:flex;align-items:center;gap:6px">
          <input type="checkbox" name="${prefix}-${idx}-DELETE" id="id_${prefix}-${idx}-DELETE">
          <label for="id_${prefix}-${idx}-DELETE" style="cursor:pointer;color:#dc2626;font-size:13px;font-weight:500;user-select:none">–£–¥–∞–ª–∏—Ç—å</label>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;padding-right:100px">
          <div>
            <input type="text" name="${prefix}-${idx}-address" id="id_${prefix}-${idx}-address" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" style="width:100%;padding:10px 14px;font-size:14px">
          </div>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding-top:4px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;color:#374151;user-select:none">
              <input type="checkbox" name="${prefix}-${idx}-is_default" id="id_${prefix}-${idx}-is_default" class="checkbox" style="width:18px;height:18px;cursor:pointer">
              <span style="font-weight:500">–ê–¥—Ä–µ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
            </label>
            <button type="button" 
                    class="yandex-map-btn" 
                    data-address-field="id_${prefix}-${idx}-address"
                    style="background:#3b82f6;color:white;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:6px;text-decoration:none;transition:all 0.2s;outline:none;box-shadow:0 1px 2px rgba(0,0,0,0.05)"
                    tabindex="0">
              <span style="font-size:14px">üó∫Ô∏è</span>
              <span>–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(newRow);
      totalInput.value = idx + 1;
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞
      setTimeout(() => {
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞
        let newAddressInput = newRow.querySelector('input[id$="-address"]') ||
                             newRow.querySelector('input[name$="-address"]') ||
                             newRow.querySelector('input[type="text"][placeholder*="–∞–¥—Ä–µ—Å"]') ||
                             newRow.querySelector('input[type="text"]');
        
        if (newAddressInput && window.initAddressAutocomplete) {
          window.initAddressAutocomplete(newAddressInput);
        } else {
          // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ª—è
          if (window.initAllAddressAutocompletes) {
            setTimeout(() => window.initAllAddressAutocompletes(), 300);
          }
        }
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–∞—Ä—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
      const newMapBtn = newRow.querySelector('.yandex-map-btn');
      if (newMapBtn && typeof setupMapButton === 'function') {
        setupMapButton(newMapBtn);
      }
      }, 300);
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ —É–¥–∞–ª–µ–Ω–∏—è
      const deleteCheckbox = newRow.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.addEventListener('change', function() {
          if (this.checked) {
            newRow.style.opacity = '0.5';
            newRow.style.background = '#f3f4f6';
            newRow.querySelector('input[name$="-address"]').disabled = true;
            newRow.querySelector('input[name$="-is_default"]').disabled = true;
            const mapBtn = newRow.querySelector('.yandex-map-btn');
            if (mapBtn) {
              mapBtn.style.opacity = '0.5';
              mapBtn.style.pointerEvents = 'none';
            }
          } else {
            newRow.style.opacity = '1';
            newRow.style.background = '#f9fafb';
            newRow.querySelector('input[name$="-address"]').disabled = false;
            newRow.querySelector('input[name$="-is_default"]').disabled = false;
            const mapBtn = newRow.querySelector('.yandex-map-btn');
            if (mapBtn) {
              mapBtn.style.opacity = '1';
              mapBtn.style.pointerEvents = 'auto';
            }
          }
        });
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–∞—Ä—Ç—ã
      const mapBtn = newRow.querySelector('.yandex-map-btn');
      if (mapBtn) {
        mapBtn.addEventListener('mouseenter', function() {
          if (!deleteCheckbox || !deleteCheckbox.checked) {
            this.style.background = '#2563eb';
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          }
        });
        mapBtn.addEventListener('mouseleave', function() {
          if (!deleteCheckbox || !deleteCheckbox.checked) {
            this.style.background = '#3b82f6';
            this.style.transform = '';
            this.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
          }
        });
      }
    });

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ —É–¥–∞–ª–µ–Ω–∏—è
    container.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const row = this.closest('.address-form-row');
        if (row) {
          if (this.checked) {
            row.style.opacity = '0.5';
            row.style.background = '#f3f4f6';
            row.querySelector('input[name$="-address"]').disabled = true;
            row.querySelector('input[name$="-is_default"]').disabled = true;
            const mapBtn = row.querySelector('.yandex-map-btn');
            if (mapBtn) {
              mapBtn.style.opacity = '0.5';
              mapBtn.style.pointerEvents = 'none';
            }
          } else {
            row.style.opacity = '1';
            row.style.background = '#f9fafb';
            row.querySelector('input[name$="-address"]').disabled = false;
            row.querySelector('input[name$="-is_default"]').disabled = false;
            const mapBtn = row.querySelector('.yandex-map-btn');
            if (mapBtn) {
              mapBtn.style.opacity = '1';
              mapBtn.style.pointerEvents = 'auto';
            }
          }
        }
      });
    });
  })();
</script>

<script>
// –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
(function() {
  const bankNameInput = document.querySelector('input[name="bank_name"]');
  const bankBikInput = document.querySelector('input[name="bank_bik"]');
  
  if (!bankNameInput || !bankBikInput) return;
  
  let autocompleteList = null;
  let searchTimeout = null;
  let selectedBank = null;
  
  function createAutocompleteList() {
    if (autocompleteList) {
      autocompleteList.remove();
    }
    
    const list = document.createElement('div');
    list.className = 'bank-autocomplete-list';
    list.id = 'bank-autocomplete-list';
    list.style.cssText = 'position:absolute;z-index:1000;background:white;border:1px solid var(--border);border-radius:8px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.15);margin-top:4px;width:100%;';
    
    const wrapper = bankNameInput.closest('.field') || bankNameInput.parentElement;
    if (wrapper) {
      wrapper.style.position = 'relative';
      wrapper.appendChild(list);
    }
    
    autocompleteList = list;
    return list;
  }
  
  function hideAutocomplete() {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
  }
  
  function selectBank(bank) {
    selectedBank = bank;
    bankNameInput.value = bank.name;
    bankBikInput.value = bank.bik;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    const bankCorrAccountInput = document.querySelector('input[name="bank_corr_account"]');
    if (bankCorrAccountInput && bank.ks) {
      bankCorrAccountInput.value = bank.ks;
    }
    
    hideAutocomplete();
  }
  
  async function searchBanks(query) {
    if (query.length < 3) {
      hideAutocomplete();
      return;
    }
    
    try {
      const response = await fetch(`{% url 'core:bank_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (!data.ok || !data.banks || data.banks.length === 0) {
        hideAutocomplete();
        return;
      }
      
      if (!autocompleteList) {
        createAutocompleteList();
      }
      
      autocompleteList.innerHTML = '';
      
      data.banks.forEach(bank => {
        const item = document.createElement('div');
        item.style.cssText = 'padding:10px 14px;cursor:pointer;border-bottom:1px solid #eee;transition:background-color 0.15s;';
        const ksInfo = bank.ks ? ` / –ö/–°: ${bank.ks}` : '';
        item.innerHTML = `
          <div style="font-weight:500;font-size:14px">${bank.name}</div>
          <div style="font-size:12px;color:var(--muted);font-family:monospace;margin-top:2px">–ë–ò–ö: ${bank.bik}${ksInfo}</div>
        `;
        item.onmouseover = () => item.style.backgroundColor = '#f5f5f5';
        item.onmouseout = () => item.style.backgroundColor = '';
        item.onclick = () => selectBank(bank);
        autocompleteList.appendChild(item);
      });
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤:', error);
      hideAutocomplete();
    }
  }
  
  bankNameInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ë–ò–ö
    if (selectedBank && query !== selectedBank.name) {
      selectedBank = null;
      bankBikInput.value = '';
    }
    
    if (query.length >= 3) {
      searchTimeout = setTimeout(() => searchBanks(query), 300);
    } else {
      hideAutocomplete();
    }
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Å–ø–∏—Å–∫–∞
  document.addEventListener('click', function(e) {
    if (autocompleteList && !autocompleteList.contains(e.target) && e.target !== bankNameInput) {
      hideAutocomplete();
    }
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && autocompleteList) {
      hideAutocomplete();
    }
  });
})();
</script>
{% endblock %}
