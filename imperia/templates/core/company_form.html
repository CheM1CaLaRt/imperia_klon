{% extends "base.html" %}

{% block title %}{{ title }} — IndigoFlow{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">{{ title }}</h1>
      <p class="card-subtitle">
        {% if action == "edit" %}
          Редактирование данных компании
        {% else %}
          Заполните форму для создания новой компании
        {% endif %}
      </p>
    </div>
    <a href="{% url 'core:company_list' %}" class="btn btn-secondary">← Назад к списку</a>
  </div>

  <form method="post" style="padding:24px;display:grid;gap:24px">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
      <div style="padding:14px 18px;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;color:#7f1d1d;font-size:14px">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Основная информация -->
    <div style="display:grid;gap:20px;padding:20px;background:var(--bg);border-radius:16px;border:1px solid var(--border)">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--text)">Основная информация</h2>
      
      <div class="field">
        <label class="field label">{{ form.name.label }} <span style="color:#ef4444">*</span></label>
        {{ form.name }}
        {% if form.name.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.name.errors }}</div>
        {% endif %}
      </div>

      <div class="field">
        <label class="field label">{{ form.full_name.label }} <span style="color:#ef4444">*</span></label>
        {{ form.full_name }}
        {% if form.full_name.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.full_name.errors }}</div>
        {% endif %}
      </div>

      <div class="grid grid-2" style="gap:20px">
        <div class="field">
          <label class="field label">{{ form.inn.label }} <span style="color:#ef4444">*</span></label>
          <div style="position:relative">
            {{ form.inn }}
            <div id="egrul-loading" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:14px">
              Поиск...
            </div>
          </div>
          {% if form.inn.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.inn.errors }}</div>
          {% endif %}
          <div style="margin-top:6px;font-size:13px;color:var(--muted)">
            Введите ИНН и нажмите Enter для автоматического поиска в ЕГРЮЛ
          </div>
        </div>
        
        <div class="field">
          <label class="field label">{{ form.kpp.label }}</label>
          {{ form.kpp }}
          {% if form.kpp.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.kpp.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="field">
        <label class="field label">{{ form.ogrn.label }}</label>
        {{ form.ogrn }}
        {% if form.ogrn.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.ogrn.errors }}</div>
        {% endif %}
      </div>

      <div class="field">
        <label class="field label">{{ form.address.label }} <span style="color:#ef4444">*</span></label>
        {{ form.address }}
        {% if form.address.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.address.errors }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Адреса компании -->
    {% if address_formset %}
    <div style="display:grid;gap:20px;padding:20px;background:var(--bg);border-radius:16px;border:1px solid var(--border)">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--text)">Дополнительные адреса</h2>
      <p style="margin:0;font-size:13px;color:var(--muted)">Вы можете добавить несколько адресов каждого типа: фактический адрес, адрес доставки, почтовый адрес</p>
      
      <div id="address-formset-container" style="display:flex;flex-direction:column;gap:16px">
        {{ address_formset.management_form }}
        {% for addr_form in address_formset %}
          <div class="address-form-row" style="padding:20px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;position:relative;transition:all 0.2s">
            {% if addr_form.DELETE %}
              <div style="position:absolute;top:16px;right:16px;display:flex;align-items:center;gap:6px">
                {{ addr_form.DELETE }}
                <label for="{{ addr_form.DELETE.id_for_label }}" style="cursor:pointer;color:#dc2626;font-size:13px;font-weight:500;user-select:none">Удалить</label>
              </div>
            {% else %}
              {# Для новых форм кнопка удаления будет скрыта через JavaScript #}
              <div style="position:absolute;top:16px;right:16px;display:none">
                <span style="color:#dc2626;font-size:13px;font-weight:500">Новый адрес</span>
              </div>
            {% endif %}
            {% for hidden in addr_form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
            <div style="display:flex;flex-direction:column;gap:12px;padding-right:100px">
              <div class="grid grid-2" style="gap:12px">
                <div class="field">
                  <label class="field label">{{ addr_form.address_type.label }}</label>
                  {{ addr_form.address_type }}
                  {% if addr_form.address_type.errors %}
                    <div style="color:#ef4444;font-size:13px;margin-top:4px">{{ addr_form.address_type.errors }}</div>
                  {% endif %}
                </div>
                <div class="field" style="display:flex;align-items:center;gap:8px;padding-top:24px">
                  {{ addr_form.is_default }}
                  <label for="{{ addr_form.is_default.id_for_label }}" style="cursor:pointer;font-size:14px;font-weight:500">
                    {{ addr_form.is_default.label }}
                  </label>
                </div>
              </div>
              <div class="field">
                <label class="field label">{{ addr_form.address.label }}</label>
                {{ addr_form.address }}
                {% if addr_form.address.errors %}
                  <div style="color:#ef4444;font-size:13px;margin-top:4px">{{ addr_form.address.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <button type="button" id="add-address-btn" class="btn" style="background:var(--card);border-color:var(--border);color:var(--text);width:100%;justify-content:center">
        + Добавить адрес
      </button>
    </div>
    {% endif %}

    <!-- Контактная информация -->
    <div style="display:grid;gap:20px;padding:20px;background:var(--bg);border-radius:16px;border:1px solid var(--border)">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--text)">Контактная информация</h2>
      
      <div class="grid grid-2" style="gap:20px">
        <div class="field">
          <label class="field label">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% if form.phone.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.phone.errors }}</div>
          {% endif %}
        </div>
        
        <div class="field">
          <label class="field label">{{ form.email.label }}</label>
          {{ form.email }}
          {% if form.email.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.email.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Банковские реквизиты -->
    <div style="display:grid;gap:20px;padding:20px;background:var(--bg);border-radius:16px;border:1px solid var(--border)">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--text)">Банковские реквизиты</h2>
      
      <div class="field">
        <label class="field label">{{ form.bank_name.label }}</label>
        {{ form.bank_name }}
        {% if form.bank_name.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.bank_name.errors }}</div>
        {% endif %}
      </div>

      <div class="grid grid-2" style="gap:20px">
        <div class="field">
          <label class="field label">{{ form.bank_bik.label }}</label>
          {{ form.bank_bik }}
          {% if form.bank_bik.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.bank_bik.errors }}</div>
          {% endif %}
        </div>
        
        <div class="field">
          <label class="field label">{{ form.bank_account.label }}</label>
          {{ form.bank_account }}
          {% if form.bank_account.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.bank_account.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="field">
        <label class="field label">{{ form.bank_corr_account.label }}</label>
        {{ form.bank_corr_account }}
        {% if form.bank_corr_account.errors %}
          <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.bank_corr_account.errors }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Руководство -->
    <div style="display:grid;gap:20px;padding:20px;background:var(--bg);border-radius:16px;border:1px solid var(--border)">
      <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--text)">Руководство</h2>
      
      <div class="grid grid-2" style="gap:20px">
        <div class="field">
          <label class="field label">{{ form.director_name.label }}</label>
          {{ form.director_name }}
          {% if form.director_name.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.director_name.errors }}</div>
          {% endif %}
        </div>
        
        <div class="field">
          <label class="field label">{{ form.director_position.label }}</label>
          {{ form.director_position }}
          {% if form.director_position.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.director_position.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-2" style="gap:20px">
        <div class="field">
          <label class="field label">{{ form.accountant_name.label }}</label>
          {{ form.accountant_name }}
          {% if form.accountant_name.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.accountant_name.errors }}</div>
          {% endif %}
        </div>
        
        <div class="field">
          <label class="field label">{{ form.accountant_position.label }}</label>
          {{ form.accountant_position }}
          {% if form.accountant_position.errors %}
            <div style="color:#ef4444;font-size:13px;margin-top:6px">{{ form.accountant_position.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Статус -->
    <div class="field" style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px">
      {{ form.is_active }}
      <label for="{{ form.is_active.id_for_label }}" style="cursor:pointer;font-size:14px;font-weight:500">
        {{ form.is_active.label }}
      </label>
      {% if form.is_active.help_text %}
        <span style="font-size:12px;color:var(--muted);margin-left:auto">{{ form.is_active.help_text }}</span>
      {% endif %}
    </div>

    <!-- Кнопки действий -->
    <div style="display:flex;gap:12px;padding-top:16px;border-top:1px solid var(--border);flex-wrap:wrap">
      <button type="submit" class="btn btn-primary" style="flex:1;min-width:140px">
        {% if action == "edit" %}Сохранить изменения{% else %}Создать компанию{% endif %}
      </button>
      <a href="{% url 'core:company_list' %}" class="btn" style="background:var(--card);border-color:var(--border);color:var(--text)">Отмена</a>
    </div>
  </form>
</div>

<style>
@media (max-width:640px){
  .grid-2{grid-template-columns:1fr}
  .card-header{flex-direction:column;align-items:stretch;gap:12px}
  .card-header .btn{width:100%;justify-content:center}
}
.bank-autocomplete-list {
  position: absolute;
  z-index: 1000;
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  margin-top: 4px;
  width: 100%;
}
.bank-autocomplete-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  transition: background-color 0.15s;
}
.bank-autocomplete-item:hover {
  background-color: #f5f5f5;
}
.bank-autocomplete-item:last-child {
  border-bottom: none;
}
.bank-autocomplete-item__name {
  font-weight: 500;
  font-size: 14px;
}
.bank-autocomplete-item__bik {
  font-size: 12px;
  color: var(--muted);
  font-family: monospace;
  margin-top: 2px;
}
.bank-input-wrapper {
  position: relative;
}
</style>

<script>
(function() {
  const bankNameInput = document.querySelector('input[name="bank_name"]');
  const bankBikInput = document.querySelector('input[name="bank_bik"]');
  
  if (!bankNameInput || !bankBikInput) return;
  
  let autocompleteList = null;
  let searchTimeout = null;
  let selectedBank = null;
  
  function createAutocompleteList() {
    if (autocompleteList) {
      autocompleteList.remove();
    }
    
    const list = document.createElement('div');
    list.className = 'bank-autocomplete-list';
    list.id = 'bank-autocomplete-list';
    
    const wrapper = bankNameInput.closest('.field') || bankNameInput.parentElement;
    wrapper.style.position = 'relative';
    wrapper.appendChild(list);
    
    autocompleteList = list;
    return list;
  }
  
  function hideAutocomplete() {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
  }
  
  function selectBank(bank) {
    selectedBank = bank;
    bankNameInput.value = bank.name;
    bankBikInput.value = bank.bik;
    
    // Заполняем корреспондентский счет, если он есть
    const bankCorrAccountInput = document.querySelector('input[name="bank_corr_account"]');
    if (bankCorrAccountInput && bank.ks) {
      bankCorrAccountInput.value = bank.ks;
    }
    
    hideAutocomplete();
  }
  
  async function searchBanks(query) {
    if (query.length < 3) {
      hideAutocomplete();
      return;
    }
    
    try {
      const response = await fetch(`{% url 'core:bank_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (!data.ok || !data.banks || data.banks.length === 0) {
        hideAutocomplete();
        return;
      }
      
      if (!autocompleteList) {
        createAutocompleteList();
      }
      
      autocompleteList.innerHTML = '';
      
      data.banks.forEach(bank => {
        const item = document.createElement('div');
        item.className = 'bank-autocomplete-item';
        const ksInfo = bank.ks ? ` / К/С: ${bank.ks}` : '';
        item.innerHTML = `
          <div class="bank-autocomplete-item__name">${bank.name}</div>
          <div class="bank-autocomplete-item__bik">БИК: ${bank.bik}${ksInfo}</div>
        `;
        item.onclick = () => selectBank(bank);
        autocompleteList.appendChild(item);
      });
      
    } catch (error) {
      console.error('Ошибка поиска банков:', error);
      hideAutocomplete();
    }
  }
  
  bankNameInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Если значение изменилось после выбора банка, сбрасываем БИК
    if (selectedBank && query !== selectedBank.name) {
      selectedBank = null;
      bankBikInput.value = '';
    }
    
    if (query.length >= 3) {
      searchTimeout = setTimeout(() => searchBanks(query), 300);
    } else {
      hideAutocomplete();
    }
  });
  
  // Закрытие при клике вне списка
  document.addEventListener('click', function(e) {
    if (autocompleteList && !autocompleteList.contains(e.target) && e.target !== bankNameInput) {
      hideAutocomplete();
    }
  });
  
  // Закрытие по Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && autocompleteList) {
      hideAutocomplete();
    }
  });
})();
</script>

<script>
// Автозаполнение по ИНН из ЕГРЮЛ
(function() {
  const innInput = document.getElementById('id_inn');
  const loadingEl = document.getElementById('egrul-loading');
  
  if (!innInput) return;
  
  const lookupUrl = "{% url 'core:company_lookup_inn' %}";
  
  async function performLookup() {
    const inn = (innInput.value || '').trim();
    
    if (!/^\d{10}(\d{2})?$/.test(inn)) {
      alert('Введите корректный ИНН: 10 (юр.лицо) или 12 (ИП) цифр.');
      innInput.focus();
      return;
    }
    
    if (loadingEl) loadingEl.style.display = 'block';
    innInput.disabled = true;
    
    try {
      const resp = await fetch(`${lookupUrl}?inn=${encodeURIComponent(inn)}`, { method: 'GET' });
      const data = await resp.json();
      
      if (!resp.ok || !data.ok) {
        alert(data.error || 'Не удалось получить данные ЕГРЮЛ');
        return;
      }
      
      const d = data.data || {};
      
      // Заполняем известные поля из payload
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && (val ?? '') !== '') el.value = val;
      };
      
      setVal('id_name', d.name);
      setVal('id_full_name', d.full_name);
      setVal('id_kpp', d.kpp);
      setVal('id_ogrn', d.ogrn);
      setVal('id_address', d.address);
      
      // Показываем уведомление об успехе
      if (loadingEl) {
        loadingEl.style.color = '#10b981';
        loadingEl.textContent = '✓ Данные загружены';
        setTimeout(() => {
          loadingEl.style.display = 'none';
          loadingEl.style.color = 'var(--primary)';
          loadingEl.textContent = 'Поиск...';
        }, 2000);
      }
      
    } catch (err) {
      console.error('Ошибка запроса ЕГРЮЛ:', err);
      alert('Ошибка при получении данных из ЕГРЮЛ');
      if (loadingEl) loadingEl.style.display = 'none';
    } finally {
      innInput.disabled = false;
    }
  }
  
  // Обработка Enter в поле ИНН
  innInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      performLookup();
    }
  });
})();
</script>

<script>
// Управление формсетом адресов
(function() {
  const container = document.getElementById('address-formset-container');
  const addBtn = document.getElementById('add-address-btn');
  
  if (!container || !addBtn) return;
  
  const totalFormsInput = container.querySelector('input[name$="-TOTAL_FORMS"]');
  if (!totalFormsInput) return;
  
  const prefix = totalFormsInput.name.replace(/-TOTAL_FORMS$/, '');
  
  addBtn.addEventListener('click', function() {
    const currentCount = parseInt(totalFormsInput.value) || 0;
    const newIndex = currentCount;
    
    // Находим последнюю форму как шаблон
    const lastForm = container.querySelector('.address-form-row:last-of-type');
    if (!lastForm) return;
    
    // Клонируем последнюю форму
    const newForm = lastForm.cloneNode(true);
    
    // Обновляем индексы в именах полей
    const inputs = newForm.querySelectorAll('input, select, label');
    inputs.forEach(el => {
      if (el.name) {
        el.name = el.name.replace(/-(\d+)-/, `-${newIndex}-`);
      }
      if (el.id) {
        el.id = el.id.replace(/-(\d+)-/, `-${newIndex}-`);
      }
      if (el.htmlFor) {
        el.htmlFor = el.htmlFor.replace(/-(\d+)-/, `-${newIndex}-`);
      }
    });
    
    // Очищаем значения
    newForm.querySelectorAll('input[type="text"], select').forEach(input => {
      if (input.name && !input.name.includes('address_type')) {
        input.value = '';
      } else if (input.name && input.name.includes('address_type')) {
        input.value = 'actual'; // Значение по умолчанию
      }
    });
    
    // Сбрасываем чекбоксы
    newForm.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
    });
    
    // Убираем скрытые поля ID и DELETE для новой формы
    const hiddenId = newForm.querySelector('input[name$="-id"]');
    if (hiddenId) {
      hiddenId.value = '';
    }
    
    // Показываем кнопку удаления для новой формы
    const deleteContainer = newForm.querySelector('div[style*="position:absolute"]');
    if (deleteContainer) {
      deleteContainer.style.display = 'none'; // Скрываем для новых форм
    }
    
    // Вставляем новую форму перед кнопкой добавления
    const addBtnParent = addBtn.parentElement;
    addBtnParent.insertBefore(newForm, addBtn);
    
    // Увеличиваем счетчик
    totalFormsInput.value = newIndex + 1;
  });
  
  // Обработка удаления форм
  container.addEventListener('change', function(e) {
    if (e.target.type === 'checkbox' && e.target.name && e.target.name.includes('-DELETE')) {
      const formRow = e.target.closest('.address-form-row');
      if (formRow && e.target.checked) {
        formRow.style.opacity = '0.5';
        formRow.style.pointerEvents = 'none';
      } else if (formRow) {
        formRow.style.opacity = '1';
        formRow.style.pointerEvents = 'auto';
      }
    }
  });
})();
</script>
{% endblock %}

