<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>УПД — Заявка #{{ obj.number }}{% if shipment %} (Отгрузка #{{ shipment.shipment_number|default:shipment.pk }}){% endif %}</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#000;background:#fff}
    .wrap{max-width:210mm;margin:0 auto;padding:10mm}
    @media print{
      .noprint{display:none}
      .wrap{padding:5mm}
      body{background:#fff}
    }
    h1{font-size:16px;font-weight:700;margin-bottom:15px;text-align:center;text-transform:uppercase}
    .header{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
    .header-box{border:1px solid #000;padding:10px}
    .header-box h3{font-size:11px;font-weight:600;margin-bottom:8px;text-transform:uppercase;border-bottom:1px solid #000;padding-bottom:3px}
    .header-box p{margin:3px 0;font-size:11px;line-height:1.3}
    .doc-info{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
    .doc-info-item{border:1px solid #000;padding:8px;text-align:center}
    .doc-info-item strong{display:block;font-size:10px;margin-bottom:3px}
    .doc-info-item span{font-size:11px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:11px}
    th,td{padding:6px 4px;border:1px solid #000;text-align:left}
    th{background:#f0f0f0;font-weight:600;text-align:center;font-size:10px}
    .right{text-align:right}
    .center{text-align:center}
    .footer{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    .signature-block{border:1px solid #000;padding:10px;min-height:80px}
    .signature-block h4{font-size:11px;font-weight:600;margin-bottom:8px;text-transform:uppercase}
    .signature-block p{margin:5px 0;font-size:10px}
    .total-row{font-weight:700;font-size:12px}
    .muted{color:#666}
    .note-box{margin-top:15px;padding:10px;border:1px solid #000;font-size:11px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="noprint" style="margin-bottom:15px">
      <button onclick="window.print()" style="padding:8px 16px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px">Печать</button>
      <button onclick="window.close()" style="padding:8px 16px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-left:10px;font-size:12px">Закрыть</button>
    </div>

    <h1>Универсальный передаточный документ</h1>
    
    <div class="doc-info">
      <div class="doc-info-item">
        <strong>Номер</strong>
        <span>{% if shipment %}{{ shipment.shipment_number|default:shipment.pk }}{% else %}{{ obj.number|default:obj.pk }}{% endif %}</span>
      </div>
      <div class="doc-info-item">
        <strong>Дата</strong>
        <span>{% if shipment %}{{ shipment.shipped_at|date:"d.m.Y" }}{% else %}{{ obj.created_at|date:"d.m.Y" }}{% endif %}</span>
      </div>
      <div class="doc-info-item">
        <strong>Заявка</strong>
        <span>#{{ obj.number|default:obj.pk }}</span>
      </div>
      <div class="doc-info-item">
        <strong>Статус</strong>
        <span>{% if shipment %}Отгрузка{% else %}Заявка{% endif %}</span>
      </div>
    </div>

    <div class="header">
      <div class="header-box">
        <h3>Продавец</h3>
        <p><strong>ООО "Ваша компания"</strong></p>
        <p>ИНН: <span id="seller_inn">________________</span></p>
        <p>КПП: <span id="seller_kpp">________________</span></p>
        <p>Адрес: <span id="seller_address">________________</span></p>
        <p>Телефон: <span id="seller_phone">________________</span></p>
      </div>
      
      <div class="header-box">
        <h3>Покупатель</h3>
        {% if obj.counterparty %}
          <p><strong>{{ obj.counterparty.name }}</strong></p>
          {% if obj.counterparty.inn %}
            <p>ИНН: {{ obj.counterparty.inn }}</p>
          {% endif %}
          {% if obj.counterparty.kpp %}
            <p>КПП: {{ obj.counterparty.kpp }}</p>
          {% endif %}
          {% if obj.counterparty.address %}
            <p>Адрес: {{ obj.counterparty.address }}</p>
          {% endif %}
        {% else %}
          <p class="muted">Не указан</p>
        {% endif %}
      </div>
    </div>

    {% if obj.delivery_address or obj.delivery_contact %}
    <div class="header" style="margin-top:10px">
      <div class="header-box">
        <h3>Адрес доставки</h3>
        {% if obj.delivery_address %}
          <p>{{ obj.delivery_address.address }}</p>
        {% elif obj.counterparty and obj.counterparty.actual_address %}
          <p>{{ obj.counterparty.actual_address }}</p>
        {% else %}
          <p class="muted">Не указан</p>
        {% endif %}
      </div>
      
      <div class="header-box">
        <h3>Контактное лицо</h3>
        {% if obj.delivery_contact %}
          <p><strong>{{ obj.delivery_contact.full_name }}</strong></p>
          {% if obj.delivery_contact.position %}
            <p>Должность: {{ obj.delivery_contact.position }}</p>
          {% endif %}
          {% if obj.delivery_contact.phone %}
            <p>Телефон: {{ obj.delivery_contact.phone }}</p>
          {% endif %}
          {% if obj.delivery_contact.email %}
            <p>Email: {{ obj.delivery_contact.email }}</p>
          {% endif %}
        {% else %}
          <p class="muted">Не указано</p>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <h3 style="margin-top:15px;margin-bottom:8px;font-size:13px;font-weight:600">Товары</h3>
    <table>
      <thead>
        <tr>
          <th style="width:4%">№</th>
          <th style="width:40%">Наименование</th>
          <th style="width:8%" class="center">Ед.</th>
          <th style="width:12%" class="right">Количество</th>
          <th style="width:18%" class="right">Цена</th>
          <th style="width:18%" class="right">Сумма</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr>
            <td class="center">{{ forloop.counter }}</td>
            <td>{{ item.title }}</td>
            <td class="center">{{ item.unit }}</td>
            <td class="right">{{ item.quantity }}</td>
            <td class="right">{{ item.price|floatformat:2 }} ₽</td>
            <td class="right">{{ item.total|floatformat:2 }} ₽</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="center muted">Товары не указаны</td>
          </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="5" class="right"><strong>Итого:</strong></td>
          <td class="right">{{ total_amount|floatformat:2 }} ₽</td>
        </tr>
      </tbody>
    </table>

    {% if shipment and shipment.comment %}
    <div class="note-box">
      <strong>Примечание к отгрузке:</strong> {{ shipment.comment }}
    </div>
    {% endif %}

    <div class="footer">
      <div class="signature-block">
        <h4>Отпустил</h4>
        <p style="margin-top:30px">____________________</p>
        <p class="muted" style="font-size:9px">Подпись, ФИО</p>
      </div>
      <div class="signature-block">
        <h4>Получил</h4>
        <p style="margin-top:30px">____________________</p>
        <p class="muted" style="font-size:9px">Подпись, ФИО</p>
      </div>
    </div>
  </div>
  <script>window.addEventListener('load',()=>{ if(!window.opener) setTimeout(()=>window.print(),500); });</script>
</body>
</html>

