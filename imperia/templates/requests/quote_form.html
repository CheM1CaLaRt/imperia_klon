{% extends "base.html" %}
{% load access %}
{% load static %}
{% block title %}{% if quote %}Редактирование КП{% else %}Создание КП{% endif %} — Заявка #{{ request.number }}{% endblock %}

{% block content %}
<div class="wrap">
  <header style="margin-bottom: 32px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <div>
        <h1 style="margin: 0; font-size: 32px; font-weight: 700; color: var(--text);">
          {% if quote %}Редактирование коммерческого предложения{% else %}Создание коммерческого предложения{% endif %}
        </h1>
        <div style="margin-top: 12px; display: flex; align-items: center; gap: 20px; font-size: 14px; color: var(--muted);">
          <span>Заявка <strong style="color: var(--text);">#{{ request.number }}</strong></span>
          <span style="padding: 0 8px;">•</span>
          <span>{{ request.title }}</span>
          {% if request.counterparty %}
            <span style="padding: 0 8px;">•</span>
            <span>Контрагент: <strong style="color: var(--text);">{{ request.counterparty.name }}</strong></span>
          {% endif %}
        </div>
      </div>
      <a href="{% url 'core:request_detail' request.pk %}" class="btn" style="background: var(--bg); border: 1px solid var(--border); padding: 10px 20px;">
        ← Назад к заявке
      </a>
    </div>
  </header>

  <form method="post" id="quoteForm" style="max-width: 1400px;">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="card" style="padding: 28px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 12px; background: white;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: var(--text);">Товары и цены</h2>
        <div style="display: flex; gap: 8px;">
          <button type="button" id="createProductBtn" class="btn btn-primary" style="padding: 10px 20px; font-size: 14px; border-radius: 8px; font-weight: 500;">
            + Создать товар
          </button>
          <button type="button" id="addRowBtn" class="btn" style="padding: 10px 20px; font-size: 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-weight: 500;">
            + Добавить строку
          </button>
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table id="quoteTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border); background: var(--bg);">
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 50px;">№</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Штрихкод</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Артикул</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); min-width: 250px;">Наименование</th>
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 130px;">Количество</th>
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 150px;">Цена за единицу</th>
              {% if is_operator|default:False or is_director|default:False %}
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Наценка %</th>
              {% endif %}
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 150px;">Итого</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 200px;">Примечание</th>
              <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--muted); width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="quoteItemsBody">
            {% for form in formset %}
              <tr class="quote-item-row" data-form-row data-row-index="{{ forloop.counter0 }}" style="border-bottom: 1px solid var(--border);">
                <td style="padding: 16px 12px; font-size: 14px; color: var(--muted); vertical-align: top; padding-top: 20px;">{{ forloop.counter }}</td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.request_item_id }}
                  {{ form.product_id }}
                  {{ form.barcode }}
                  {% if form.barcode.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.barcode.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.article }}
                  {% if form.article.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.article.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  <div style="position: relative;">
                    <div class="product-search-wrapper" style="position: relative;">
                      {{ form.title }}
                      <button type="button" class="btn-create-product" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: none;" title="Создать новый товар">
                        + Новый
                      </button>
                    </div>
                    {% if form.title.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.title.errors }}</div>{% endif %}
                  </div>
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.quantity }}
                  {% if form.quantity.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.quantity.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  <div style="position: relative;">
                    {{ form.price }}
                    <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; pointer-events: none;">₽</span>
                  </div>
                  {% if form.price.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.price.errors }}</div>{% endif %}
                </td>
                {% if is_operator|default:False or is_director|default:False %}
                <td style="padding: 16px 12px; vertical-align: top;">
                  <div style="display: flex; align-items: center; gap: 4px;">
                    {{ form.markup_percent }}
                    <span style="color: var(--muted); font-size: 14px;">%</span>
                  </div>
                  {% if form.markup_percent.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.markup_percent.errors }}</div>{% endif %}
                </td>
                {% endif %}
                <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
                  <span class="item-total" style="font-size: 16px; font-weight: 600; color: var(--text);">0.00</span> <span style="color: var(--muted);">₽</span>
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.note }}
                  {% if form.note.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.note.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; text-align: center; vertical-align: top; padding-top: 20px;">
                  <button type="button" class="btn-remove-row" data-remove style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 4px 8px; opacity: 0.6; transition: opacity 0.2s; border-radius: 4px;" title="Удалить строку" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    ×
                  </button>
                </td>
              </tr>
              {% if form.non_field_errors %}
                <tr>
                  <td colspan="{% if is_operator|default:False or is_director|default:False %}10{% else %}9{% endif %}" style="padding: 8px 12px; color: #ef4444; font-size: 13px;">
                    {{ form.non_field_errors }}
                  </td>
                </tr>
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="{% if is_operator|default:False or is_director|default:False %}10{% else %}9{% endif %}" style="padding: 48px; text-align: center; color: var(--muted);">
                  <div style="font-size: 16px; margin-bottom: 8px;">Нет товаров для добавления в КП</div>
                  <button type="button" id="addFirstRowBtn" class="btn btn-primary" style="margin-top: 12px; padding: 10px 20px; border-radius: 8px;">
                    + Добавить строку
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr style="border-top: 2px solid var(--border); background: var(--bg);">
              <td colspan="{% if is_operator|default:False or is_director|default:False %}6{% else %}5{% endif %}" style="padding: 24px 12px; text-align: right; font-size: 18px; font-weight: 600; color: var(--text);">
                Итого:
              </td>
              <td colspan="{% if is_operator|default:False or is_director|default:False %}4{% else %}4{% endif %}" style="padding: 24px 12px; text-align: right; font-size: 24px; font-weight: 700; color: var(--primary);">
                <span id="grandTotal">0.00</span> <span style="font-size: 18px; font-weight: 600;">₽</span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
      <button name="action" value="save" type="submit" class="btn btn-primary" style="flex: 1; min-width: 140px; padding: 12px 24px; border-radius: 8px; font-weight: 500;">Сохранить КП</button>
      <button name="action" value="submit_for_approval" type="submit" class="btn" style="flex: 1; min-width: 140px; background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500;">Отправить на согласование</button>
      <a href="{% url 'core:request_detail' request.pk %}" class="btn" style="background: var(--bg); border-color: var(--border); color: var(--text); min-width: 140px; padding: 12px 24px; border-radius: 8px; font-weight: 500;">Отмена</a>
    </div>
  </form>
</div>

<!-- Модальное окно создания товара -->
<div id="createProductModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
  <div style="background: white; border-radius: 16px; padding: 0; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); border-radius: 16px 16px 0 0;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Создание нового товара</h3>
      <button type="button" id="closeCreateProductModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">×</button>
    </div>
    <div id="createProductContent" style="padding: 24px;"></div>
  </div>
</div>

<style>
.autocomplete-list {
  position: fixed;
  z-index: 10001;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  margin-top: 2px;
}

.autocomplete-list div {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.autocomplete-list div:hover {
  background-color: #f5f5f5;
}

.autocomplete-list div:last-child {
  border-bottom: none;
}

body.modal-open {
  overflow: hidden;
}

.quote-item-row:hover {
  background-color: #fafafa;
}

.input:focus {
  outline: 2px solid var(--primary);
  outline-offset: -2px;
  border-color: var(--primary);
}

@media (max-width: 768px) {
  .quote-item-row td {
    padding: 12px 8px !important;
  }
  
  .card {
    padding: 20px !important;
  }
}
</style>

<script>
(function() {
  'use strict';
  
  let form = null;
  let quoteItemsBody = null;
  let totalFormsInput = null;
  let createProductBtn = null;
  let addRowBtn = null;
  let addFirstRowBtn = null;
  let autocompleteTimeout = null;
  let currentAutocompleteRow = null;
  let autocompleteList = null;
  let articleSearchTimeout = null;
  
  const isOperatorOrDirector = {% if is_operator|default:False or is_director|default:False %}true{% else %}false{% endif %};
  
  // Преобразуем products_data в JavaScript объект
  const productsDataMap = {};
  {% if products_data %}
    {% for pid, data in products_data.items %}
    productsDataMap[{{ pid }}] = { purchase_price: {% if data.purchase_price %}{{ data.purchase_price|floatformat:2 }}{% else %}null{% endif %} };
    {% endfor %}
  {% endif %}
  
  // Функция для форматирования чисел
  function formatNumber(num) {
    return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }
  
  // Расчет итога по строке
  function calculateTotal(row) {
    const quantityInput = row.querySelector('input[name*="-quantity"]');
    const priceInput = row.querySelector('input[name*="-price"]');
    const totalSpan = row.querySelector('.item-total');
    
    if (!quantityInput || !priceInput || !totalSpan) return;
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    totalSpan.textContent = formatNumber(total);
    
    calculateGrandTotal();
  }
  
  // Расчет цены на основе наценки (для операторов и директоров)
  function calculatePriceFromMarkup(row) {
    if (!isOperatorOrDirector) return;
    
    const markupInput = row.querySelector('input[name*="-markup_percent"]');
    const priceInput = row.querySelector('input[name*="-price"]');
    const productIdInput = row.querySelector('input[name*="-product_id"]');
    
    if (!markupInput || !priceInput || !productIdInput) return;
    
    const markup = parseFloat(markupInput.value);
    if (isNaN(markup) || markup === 0) return;
    
    const productId = parseInt(productIdInput.value);
    if (!productId) return;
    
    const purchasePrice = productsDataMap[productId]?.purchase_price;
    if (!purchasePrice || purchasePrice <= 0) return;
    
    // Рассчитываем цену: цена = закупочная_цена * (1 + наценка / 100)
    const newPrice = purchasePrice * (1 + markup / 100);
    priceInput.value = newPrice.toFixed(2);
    calculateTotal(row);
  }
  
  // Расчет общего итога
  function calculateGrandTotal() {
    if (!quoteItemsBody) return;
    let grandTotal = 0;
    const rows = quoteItemsBody.querySelectorAll('[data-form-row]');
    rows.forEach(row => {
      const quantityInput = row.querySelector('input[name*="-quantity"]');
      const priceInput = row.querySelector('input[name*="-price"]');
      
      if (quantityInput && priceInput) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        grandTotal += quantity * price;
      }
    });
    
    const grandTotalSpan = document.getElementById('grandTotal');
    if (grandTotalSpan) {
      grandTotalSpan.textContent = formatNumber(grandTotal);
    }
  }
  
  // Создание списка автодополнения
  function createAutocompleteList(row) {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
    
    const nameInput = row.querySelector('[name$="-title"]');
    if (!nameInput) return null;
    
    const list = document.createElement('div');
    list.className = 'autocomplete-list';
    document.body.appendChild(list);
    autocompleteList = list;
    return list;
  }
  
  function hideAutocomplete() {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
    currentAutocompleteRow = null;
  }
  
  function updateAutocompletePosition() {
    if (!autocompleteList || !currentAutocompleteRow) return;
    
    const nameInput = currentAutocompleteRow.querySelector('[name$="-title"]');
    if (!nameInput) {
      hideAutocomplete();
      return;
    }
    
    const inputRect = nameInput.getBoundingClientRect();
    autocompleteList.style.top = inputRect.bottom + 'px';
    autocompleteList.style.left = inputRect.left + 'px';
    autocompleteList.style.width = inputRect.width + 'px';
  }
  
  async function selectProduct(row, product) {
    hideAutocomplete();
    
    const set = (sel, v) => {
      const el = row.querySelector(sel);
      if (el) el.value = v || '';
    };
    
    set('[name$="-title"]', product.name);
    set('[name$="-barcode"]', product.barcode || '');
    if (product.sku) set('[name$="-article"]', product.sku);
    set('[name$="-product_id"]', product.id || '');
    
    const qtyEl = row.querySelector('[name$="-quantity"]');
    if (qtyEl && !qtyEl.value) qtyEl.value = 1;
    
    row.removeAttribute('data-notfound');
    calculateTotal(row);
  }
  
  // Обработка ввода в поля (будет прикреплен в init)
  function setupInputHandlers() {
    document.addEventListener('input', async function(e) {
      const el = e.target;
      if (!el || !el.closest('#quoteItemsBody')) return;
    
    const row = el.closest('[data-form-row]');
    if (!row) return;
    
    // Поиск по названию
    if (el.name && el.name.endsWith('-title')) {
      row.removeAttribute('data-notfound');
      const query = el.value.trim();
      
      if (autocompleteTimeout) {
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = null;
      }
      
      if (query.length < 3) {
        hideAutocomplete();
        return;
      }
      
      if (currentAutocompleteRow && currentAutocompleteRow !== row) {
        hideAutocomplete();
      }
      
      autocompleteTimeout = setTimeout(async function() {
        try {
          const url = `{% url 'core:stock_lookup_by_name' %}?name=${encodeURIComponent(query)}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            hideAutocomplete();
            return;
          }
          const data = await resp.json();
          if (!data.ok || !data.products || data.products.length === 0) {
            const createBtn = row.querySelector('.btn-create-product');
            if (createBtn) createBtn.style.display = 'block';
            hideAutocomplete();
            return;
          }
          
          currentAutocompleteRow = row;
          const list = createAutocompleteList(row);
          if (!list) return;
          
          list.innerHTML = '';
          data.products.forEach(product => {
            const item = document.createElement('div');
            item.style.cssText = 'padding:10px 14px;cursor:pointer;border-bottom:1px solid #eee;';
            item.textContent = product.name;
            item.onmouseover = () => item.style.backgroundColor = '#f5f5f5';
            item.onmouseout = () => item.style.backgroundColor = '';
            item.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              selectProduct(row, product);
            };
            list.appendChild(item);
          });
          
          updateAutocompletePosition();
          
          if (data.products.length === 1) {
            selectProduct(row, data.products[0]);
          }
        } catch (err) {
          console.error('Ошибка при поиске:', err);
          hideAutocomplete();
        }
      }, 300);
      return;
    }
    
    // Поиск по штрихкоду
    if (el.name && el.name.endsWith('-barcode')) {
      row.removeAttribute('data-notfound');
      const bc = el.value.trim();
      
      if (bc.length < 6) return;
      
      try {
        const resp = await fetch(`{% url 'core:stock_lookup_by_barcode' %}?barcode=${encodeURIComponent(bc)}`);
        if (!resp.ok) {
          row.setAttribute('data-notfound', '1');
          return;
        }
        const data = await resp.json();
        if (!data.ok) {
          row.setAttribute('data-notfound', '1');
          return;
        }
        
        const set = (sel, v) => {
          const el = row.querySelector(sel);
          if (el) el.value = v || '';
        };
        set('[name$="-title"]', data.name);
        if (data.sku) set('[name$="-article"]', data.sku);
        set('[name$="-product_id"]', data.id || '');
        const qtyEl = row.querySelector('[name$="-quantity"]');
        if (qtyEl && !qtyEl.value) qtyEl.value = 1;
        row.removeAttribute('data-notfound');
        calculateTotal(row);
      } catch (_) {
        row.setAttribute('data-notfound', '1');
      }
      return;
    }
    
    // Поиск по артикулу
    if (el.name && el.name.endsWith('-article')) {
      row.removeAttribute('data-notfound');
      const article = el.value.trim();
      
      if (articleSearchTimeout) {
        clearTimeout(articleSearchTimeout);
        articleSearchTimeout = null;
      }
      
      if (article.length < 2) return;
      
      articleSearchTimeout = setTimeout(async () => {
        try {
          const resp = await fetch(`{% url 'core:stock_lookup_by_sku' %}?sku=${encodeURIComponent(article)}`);
          if (!resp.ok) {
            row.setAttribute('data-notfound', '1');
            return;
          }
          const data = await resp.json();
          if (!data.ok) {
            row.setAttribute('data-notfound', '1');
            return;
          }
          
          const set = (sel, v) => {
            const el = row.querySelector(sel);
            if (el) el.value = v || '';
          };
          set('[name$="-title"]', data.name);
          set('[name$="-barcode"]', data.barcode || '');
          if (data.sku) set('[name$="-article"]', data.sku);
          set('[name$="-product_id"]', data.id || '');
          const qtyEl = row.querySelector('[name$="-quantity"]');
          if (qtyEl && !qtyEl.value) qtyEl.value = 1;
          row.removeAttribute('data-notfound');
          calculateTotal(row);
        } catch (err) {
          console.error('Ошибка поиска по артикулу:', err);
          row.setAttribute('data-notfound', '1');
        }
      }, 500);
      return;
    }
    
    // Расчет при изменении количества или цены
    if (el.name && (el.name.endsWith('-quantity') || el.name.endsWith('-price'))) {
      calculateTotal(row);
    }
    
    // Расчет цены на основе наценки
    if (isOperatorOrDirector && el.name && el.name.endsWith('-markup_percent')) {
      calculatePriceFromMarkup(row);
    }
  });
  
  function init() {
    console.log('Начало инициализации формы КП...');
    
    form = document.getElementById('quoteForm');
    if (!form) {
      console.error('Форма quoteForm не найдена');
      return;
    }
    
    quoteItemsBody = document.getElementById('quoteItemsBody');
    if (!quoteItemsBody) {
      console.error('quoteItemsBody не найден');
      return;
    }
    
    totalFormsInput = form.querySelector('input[name$="-TOTAL_FORMS"]');
    createProductBtn = document.getElementById('createProductBtn');
    addRowBtn = document.getElementById('addRowBtn');
    addFirstRowBtn = document.getElementById('addFirstRowBtn');
    
    console.log('Элементы найдены:', {
      form: !!form,
      quoteItemsBody: !!quoteItemsBody,
      totalFormsInput: !!totalFormsInput,
      createProductBtn: !!createProductBtn,
      addRowBtn: !!addRowBtn,
      addFirstRowBtn: !!addFirstRowBtn
    });
    
    // Управление формсетом товаров
    function renumberForms() {
      if (!quoteItemsBody || !totalFormsInput) return;
      const rows = quoteItemsBody.querySelectorAll('[data-form-row]');
      rows.forEach((row, idx) => {
        row.querySelectorAll('input, select, textarea').forEach(el => {
          if (el.name) {
            el.name = el.name.replace(/quote_items-(\d+)-/g, `quote_items-${idx}-`);
          }
          if (el.id) {
            el.id = el.id.replace(/id_quote_items-(\d+)-/g, `id_quote_items-${idx}-`);
          }
        });
        const numberCell = row.querySelector('td:first-child');
        if (numberCell) numberCell.textContent = idx + 1;
        row.setAttribute('data-row-index', idx);
      });
      totalFormsInput.value = rows.length;
    }
    
    function cloneLastRow() {
      if (!quoteItemsBody) {
        console.error('quoteItemsBody не найден в cloneLastRow');
        return;
      }
    const rows = quoteItemsBody.querySelectorAll('[data-form-row]');
    if (rows.length === 0) {
      // Создаем первую строку
      const tbody = quoteItemsBody;
      const templateRow = document.createElement('tr');
      templateRow.className = 'quote-item-row';
      templateRow.setAttribute('data-form-row', '');
      templateRow.setAttribute('data-row-index', '0');
      
      const emptyRow = tbody.querySelector('tr td[colspan]');
      if (emptyRow) {
        tbody.innerHTML = '';
      }
      
      const rowIndex = 0;
      templateRow.innerHTML = `
        <td style="padding: 16px 12px; font-size: 14px; color: var(--muted); vertical-align: top; padding-top: 20px;">1</td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="hidden" name="quote_items-${rowIndex}-request_item_id" value="">
          <input type="hidden" name="quote_items-${rowIndex}-product_id" value="">
          <input type="text" name="quote_items-${rowIndex}-barcode" class="input quote-barcode" placeholder="Штрихкод" autocomplete="off" inputmode="numeric">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="text" name="quote_items-${rowIndex}-article" class="input quote-article" placeholder="Артикул" autocomplete="off">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <div style="position: relative;">
            <div class="product-search-wrapper" style="position: relative;">
              <input type="text" name="quote_items-${rowIndex}-title" class="input quote-product-name" placeholder="Наименование товара" autocomplete="off">
              <button type="button" class="btn-create-product" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: none;" title="Создать новый товар">+ Новый</button>
            </div>
          </div>
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="number" name="quote_items-${rowIndex}-quantity" class="input" step="0.001" min="0" placeholder="Количество">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <div style="position: relative;">
            <input type="number" name="quote_items-${rowIndex}-price" class="input" step="0.01" min="0" placeholder="Цена за единицу" required>
            <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; pointer-events: none;">₽</span>
          </div>
        </td>
        {% if is_operator|default:False or is_director|default:False %}
        <td style="padding: 16px 12px; vertical-align: top;">
          <div style="display: flex; align-items: center; gap: 4px;">
            <input type="number" name="quote_items-${rowIndex}-markup_percent" class="input" step="0.1" placeholder="Наценка %">
            <span style="color: var(--muted); font-size: 14px;">%</span>
          </div>
        </td>
        {% endif %}
        <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
          <span class="item-total" style="font-size: 16px; font-weight: 600; color: var(--text);">0.00</span> <span style="color: var(--muted);">₽</span>
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="text" name="quote_items-${rowIndex}-note" class="input" placeholder="Примечание">
        </td>
        <td style="padding: 16px 12px; text-align: center; vertical-align: top; padding-top: 20px;">
          <button type="button" class="btn-remove-row" data-remove style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 4px 8px; opacity: 0.6; transition: opacity 0.2s; border-radius: 4px;" title="Удалить строку" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">×</button>
        </td>
      `;
      
      tbody.appendChild(templateRow);
      
      if (totalFormsInput) {
        totalFormsInput.value = '1';
      }
      
      const barcodeInput = templateRow.querySelector('input[name*="-barcode"]');
      if (barcodeInput) {
        setTimeout(() => barcodeInput.focus(), 100);
      }
      
      return;
    }
    
    const lastRow = rows[rows.length - 1];
    const clone = lastRow.cloneNode(true);
    
    clone.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.type === 'checkbox') el.checked = false;
      else if (el.type === 'hidden' && el.name.includes('product_id')) el.value = '';
      else if (el.type === 'hidden' && el.name.includes('request_item_id')) el.value = '';
      else if (el.type !== 'hidden') el.value = '';
      el.classList.remove('field-error');
    });
    
    clone.querySelectorAll('.errorlist').forEach(el => el.remove());
    clone.removeAttribute('data-notfound');
    
    const totalSpan = clone.querySelector('.item-total');
    if (totalSpan) totalSpan.textContent = '0.00';
    
    lastRow.parentNode.insertBefore(clone, lastRow.nextSibling);
    renumberForms();
    
    const barcodeInput = clone.querySelector('input[name*="-barcode"]');
    if (barcodeInput) {
      setTimeout(() => barcodeInput.focus(), 100);
    }
  }
  
  // Модальное окно создания товара
  function openCreateProductModal(productName, row) {
    const modal = document.getElementById('createProductModal');
    const content = document.getElementById('createProductContent');
    
    if (!modal || !content) return;
    
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">Загрузка формы...</div>';
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    fetch('/ajax/product-create-inline/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      content.innerHTML = html;
      const nameInput = content.querySelector('input[name="name"]');
      if (nameInput && productName) {
        nameInput.value = productName;
      }
      if (window.initCreateProductForm) {
        window.initCreateProductForm();
      }
    })
    .catch(error => {
      console.error('Ошибка загрузки формы:', error);
      content.innerHTML = '<div style="color: #ef4444; padding: 20px;">Ошибка загрузки формы создания товара</div>';
    });
  }
  
  function closeCreateProductModal() {
    const modal = document.getElementById('createProductModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
  }
  
    // Кнопка добавления строки
    if (addRowBtn) {
      addRowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cloneLastRow();
      });
    }
    
    if (addFirstRowBtn) {
      addFirstRowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cloneLastRow();
      });
    }
    
    // Удаление строки
    quoteItemsBody.addEventListener('click', function(e) {
      const btn = e.target.closest('[data-remove]');
      if (!btn) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const row = btn.closest('[data-form-row]');
      if (!row) return;
      
      if (confirm('Удалить эту позицию?')) {
        const rows = quoteItemsBody.querySelectorAll('[data-form-row]');
        if (rows.length <= 1) {
          // Если последняя строка, очищаем её
          row.querySelectorAll('input, select, textarea').forEach(el => {
            if (el.type !== 'hidden' && !el.name.includes('DELETE')) {
              el.value = '';
            }
          });
        } else {
          row.remove();
          renumberForms();
        }
        
        calculateGrandTotal();
      }
    });
  
    // Кнопка создания товара
    if (createProductBtn) {
      createProductBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openCreateProductModal('', null);
      });
    }
    
    // Кнопка создания товара из строки
    quoteItemsBody.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn-create-product');
      if (!btn) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const row = btn.closest('[data-form-row]');
      if (!row) return;
      
      const titleInput = row.querySelector('[name$="-title"]');
      const titleValue = titleInput ? titleInput.value.trim() : '';
      openCreateProductModal(titleValue, row);
    });
    
    // Закрытие модального окна
    const closeBtn = document.getElementById('closeCreateProductModal');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeCreateProductModal);
    }
    
    const modal = document.getElementById('createProductModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeCreateProductModal();
        }
      });
    }
    
    // Первоначальный расчет
    const existingRows = quoteItemsBody.querySelectorAll('[data-form-row]');
    existingRows.forEach(row => {
      calculateTotal(row);
    });
    calculateGrandTotal();
    
    // Скрытие автодополнения при клике вне
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete-list') && !e.target.closest('[name$="-title"]')) {
        hideAutocomplete();
      }
    });
  }
  
  // Инициализация при загрузке DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM уже загружен
    init();
  }
})();
</script>

{% endblock %}
