{% extends "base.html" %}
{% load access %}
{% load static %}
{% block title %}{% if quote %}Редактирование КП{% else %}Создание КП{% endif %} — Заявка #{{ request.number }}{% endblock %}

{% block content %}
<div class="wrap">
  <header style="margin-bottom: 32px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <div>
        <h1 style="margin: 0; font-size: 32px; font-weight: 700; color: var(--text);">
          {% if quote %}Редактирование коммерческого предложения{% else %}Создание коммерческого предложения{% endif %}
        </h1>
        <div style="margin-top: 12px; display: flex; align-items: center; gap: 20px; font-size: 14px; color: var(--muted);">
          <span>Заявка <strong style="color: var(--text);">#{{ request.number }}</strong></span>
          <span style="padding: 0 8px;">•</span>
          <span>{{ request.title }}</span>
          {% if request.counterparty %}
            <span style="padding: 0 8px;">•</span>
            <span>Контрагент: <strong style="color: var(--text);">{{ request.counterparty.name }}</strong></span>
          {% endif %}
        </div>
      </div>
      <a href="{% url 'core:request_detail' request.pk %}" class="btn" style="background: var(--bg); border: 1px solid var(--border); padding: 10px 20px;">
        ← Назад к заявке
      </a>
    </div>
  </header>

  <form method="post" id="quoteForm" style="max-width: 1400px;">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="card" style="padding: 28px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: var(--text);">Товары и цены</h2>
        <div style="display: flex; gap: 8px;">
          <button type="button" id="createProductBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
            + Создать товар
          </button>
          <button type="button" id="addRowBtn" class="btn" style="padding: 8px 16px; font-size: 14px; background: var(--bg); border: 1px solid var(--border);">
            + Добавить строку
          </button>
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table id="quoteTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border); background: var(--bg);">
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 50px;">№</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Штрихкод</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Артикул</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); min-width: 250px;">Наименование</th>
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 130px;">Количество</th>
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 150px;">Цена за единицу</th>
              {% if is_operator or is_director %}
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 120px;">Наценка</th>
              {% endif %}
              <th style="padding: 14px 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--muted); width: 150px;">Итого</th>
              <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--muted); width: 200px;">Примечание</th>
              <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--muted); width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="quoteItemsBody">
            {% for form in formset %}
              <tr class="quote-item-row" data-row-index="{{ forloop.counter0 }}" style="border-bottom: 1px solid var(--border);">
                <td style="padding: 16px 12px; font-size: 14px; color: var(--muted); vertical-align: top; padding-top: 20px;">{{ forloop.counter }}</td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.request_item_id }}
                  {{ form.product_id }}
                  {{ form.barcode }}
                  {% if form.barcode.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.barcode.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.article }}
                  {% if form.article.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.article.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  <div style="position: relative;">
                    <div class="product-search-wrapper" style="position: relative;">
                      {{ form.title }}
                      <div class="product-autocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 300px; overflow-y: auto; margin-top: 4px;"></div>
                      <button type="button" class="btn-create-product" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: none;" title="Создать новый товар">
                        + Новый
                      </button>
                    </div>
                    {% if form.title.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.title.errors }}</div>{% endif %}
                  </div>
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.quantity }}
                  {% if form.quantity.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.quantity.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  <div style="position: relative;">
                    {{ form.price }}
                    <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; pointer-events: none;">₽</span>
                  </div>
                  {% if form.price.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.price.errors }}</div>{% endif %}
                </td>
                {% if is_operator or is_director %}
                <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
                  <span class="markup-percent" data-purchase-price="">—</span>
                </td>
                {% endif %}
                <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
                  <span class="item-total" style="font-size: 16px; font-weight: 600; color: var(--text);">0.00</span> <span style="color: var(--muted);">₽</span>
                </td>
                <td style="padding: 16px 12px; vertical-align: top;">
                  {{ form.note }}
                  {% if form.note.errors %}<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.note.errors }}</div>{% endif %}
                </td>
                <td style="padding: 16px 12px; text-align: center; vertical-align: top; padding-top: 20px;">
                  <button type="button" class="btn-remove-row" data-remove-row style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 4px 8px; opacity: 0.6; transition: opacity 0.2s;" title="Удалить строку">
                    ×
                  </button>
                </td>
              </tr>
              {% if form.non_field_errors %}
                <tr>
                  <td colspan="{% if is_operator or is_director %}10{% else %}9{% endif %}" style="padding: 8px 12px; color: #ef4444; font-size: 13px;">
                    {{ form.non_field_errors }}
                  </td>
                </tr>
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="{% if is_operator or is_director %}10{% else %}9{% endif %}" style="padding: 48px; text-align: center; color: var(--muted);">
                  <div style="font-size: 16px; margin-bottom: 8px;">Нет товаров для добавления в КП</div>
                  <button type="button" id="addFirstRowBtn" class="btn btn-primary" style="margin-top: 12px;">
                    + Добавить строку
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr style="border-top: 2px solid var(--border); background: var(--bg);">
              <td colspan="{% if is_operator or is_director %}6{% else %}5{% endif %}" style="padding: 24px 12px; text-align: right; font-size: 18px; font-weight: 600; color: var(--text);">
                Итого:
              </td>
              <td colspan="{% if is_operator or is_director %}4{% else %}4{% endif %}" style="padding: 24px 12px; text-align: right; font-size: 24px; font-weight: 700; color: var(--primary);">
                <span id="grandTotal">0.00</span> <span style="font-size: 18px; font-weight: 600;">₽</span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
      <button name="action" value="save" type="submit" class="btn btn-primary" style="flex: 1; min-width: 140px;">Сохранить КП</button>
      <button name="action" value="submit_for_approval" type="submit" class="btn" style="flex: 1; min-width: 140px; background: var(--success); color: white; border: none;">Отправить на согласование</button>
      <a href="{% url 'core:request_detail' request.pk %}" class="btn" style="background: var(--bg); border-color: var(--border); color: var(--text); min-width: 140px;">Отмена</a>
    </div>
  </form>
</div>

<!-- Модальное окно создания товара -->
<div id="createProductModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; padding: 0; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Создание нового товара</h3>
      <button type="button" id="closeCreateProductModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">×</button>
    </div>
    <div id="createProductContent" style="padding: 24px;"></div>
  </div>
</div>

<style>
  .product-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 300px;
    overflow-y: auto;
    margin-top: 4px;
  }
  
  .product-autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s;
  }
  
  .product-autocomplete-item:hover {
    background-color: #f5f5f5;
  }
  
  .product-autocomplete-item:last-child {
    border-bottom: none;
  }
  
  .product-autocomplete-item-name {
    font-weight: 500;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .product-autocomplete-item-meta {
    font-size: 12px;
    color: var(--muted);
  }
  
  .markup-percent {
    font-weight: 600;
    font-size: 14px;
  }
  
  .markup-percent.positive {
    color: #10b981;
  }
  
  .markup-percent.negative {
    color: #ef4444;
  }
  
  .btn-remove-row:hover {
    opacity: 1 !important;
  }
  
  @media (max-width: 768px) {
    .quote-item-row td {
      padding: 12px 8px !important;
    }
    
    .card {
      padding: 20px !important;
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  const form = document.getElementById('quoteForm');
  if (!form) {
    console.error('Форма quoteForm не найдена');
    return;
  }
  
  const quoteItemsBody = document.getElementById('quoteItemsBody');
  const totalFormsInput = form.querySelector('input[name$="-TOTAL_FORMS"]');
  const createProductBtn = document.getElementById('createProductBtn');
  const addRowBtn = document.getElementById('addRowBtn');
  const addFirstRowBtn = document.getElementById('addFirstRowBtn');
  
  let autocompleteTimeout = null;
  let currentAutocompleteRow = null;
  let autocompleteList = null;
  
  const isOperatorOrDirector = {% if is_operator or is_director %}true{% else %}false{% endif %};
  
  // Преобразуем products_data в JavaScript объект
  const productsDataMap = {};
  {% if products_data %}
    {% for pid, data in products_data.items %}
    productsDataMap[{{ pid }}] = { purchase_price: {% if data.purchase_price %}{{ data.purchase_price|floatformat:2 }}{% else %}null{% endif %} };
    {% endfor %}
  {% endif %}
  
  // Функция для форматирования чисел
  function formatNumber(num) {
    return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }
  
  // Расчет итога по строке
  function calculateTotal(row) {
    const quantityInput = row.querySelector('input[name*="-quantity"]');
    const priceInput = row.querySelector('input[name*="-price"]');
    const totalSpan = row.querySelector('.item-total');
    
    if (!quantityInput || !priceInput || !totalSpan) return;
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    totalSpan.textContent = formatNumber(total);
    
    // Расчет наценки
    if (isOperatorOrDirector) {
      calculateMarkup(row);
    }
    
    calculateGrandTotal();
  }
  
  // Расчет наценки
  function calculateMarkup(row) {
    const priceInput = row.querySelector('input[name*="-price"]');
    const markupSpan = row.querySelector('.markup-percent');
    if (!markupSpan || !priceInput) return;
    
    const purchasePrice = parseFloat(markupSpan.getAttribute('data-purchase-price') || 0);
    const price = parseFloat(priceInput.value) || 0;
    
    if (purchasePrice > 0 && price > 0) {
      const markup = ((price - purchasePrice) / purchasePrice) * 100;
      markupSpan.textContent = markup.toFixed(1) + '%';
      markupSpan.className = 'markup-percent ' + (markup >= 0 ? 'positive' : 'negative');
    } else {
      markupSpan.textContent = '—';
      markupSpan.className = 'markup-percent';
    }
  }
  
  // Расчет общего итога
  function calculateGrandTotal() {
    let grandTotal = 0;
    const rows = quoteItemsBody.querySelectorAll('.quote-item-row');
    rows.forEach(row => {
      const quantityInput = row.querySelector('input[name*="-quantity"]');
      const priceInput = row.querySelector('input[name*="-price"]');
      
      if (quantityInput && priceInput) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        grandTotal += quantity * price;
      }
    });
    
    const grandTotalSpan = document.getElementById('grandTotal');
    if (grandTotalSpan) {
      grandTotalSpan.textContent = formatNumber(grandTotal);
    }
  }
  
  // Создание списка автодополнения
  function createAutocompleteList(row) {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
    
    const wrapper = row.querySelector('.product-search-wrapper');
    if (!wrapper) return null;
    
    const list = document.createElement('div');
    list.className = 'product-autocomplete';
    wrapper.appendChild(list);
    autocompleteList = list;
    return list;
  }
  
  // Скрытие автодополнения
  function hideAutocomplete() {
    if (autocompleteList) {
      autocompleteList.remove();
      autocompleteList = null;
    }
    currentAutocompleteRow = null;
  }
  
  // Выбор товара из автодополнения
  function selectProduct(row, product) {
    const set = (sel, v) => {
      const el = row.querySelector(sel);
      if (el) el.value = v || '';
    };
    
    set('input[name*="-title"]', product.name || '');
    set('input[name*="-barcode"]', product.barcode || '');
    if (product.sku) set('input[name*="-article"]', product.sku);
    set('input[name*="-product_id"]', product.id || '');
    
    const quantityInput = row.querySelector('input[name*="-quantity"]');
    if (quantityInput && !quantityInput.value) quantityInput.value = 1;
    
    // Устанавливаем цену закупки для расчета наценки
    const markupSpan = row.querySelector('.markup-percent');
    if (markupSpan && product.id) {
      const productId = product.id;
      const purchasePrice = productsDataMap[productId]?.purchase_price || product.purchase_price || '';
      if (purchasePrice) {
        markupSpan.setAttribute('data-purchase-price', purchasePrice);
        calculateMarkup(row);
      }
    }
    
    // Скрываем кнопку создания
    const createBtn = row.querySelector('.btn-create-product');
    if (createBtn) {
      createBtn.style.display = product.id ? 'none' : 'block';
    }
    
    row.removeAttribute('data-notfound');
    hideAutocomplete();
    calculateTotal(row);
  }
  
  // Поиск товаров по названию
  async function searchProducts(query, row) {
    if (query.length < 3) {
      hideAutocomplete();
      return;
    }
    
    try {
      const url = `{% url 'core:stock_lookup_by_name' %}?name=${encodeURIComponent(query)}`;
      const resp = await fetch(url);
      if (!resp.ok) {
        hideAutocomplete();
        return;
      }
      
      const data = await resp.json();
      if (!data.ok || !data.products || data.products.length === 0) {
        const createBtn = row.querySelector('.btn-create-product');
        if (createBtn) createBtn.style.display = 'block';
        hideAutocomplete();
        return;
      }
    
      currentAutocompleteRow = row;
      const list = createAutocompleteList(row);
      if (!list) return;
      
      list.innerHTML = '';
      data.products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-autocomplete-item';
        item.innerHTML = `
          <div class="product-autocomplete-item-name">${product.name || ''}</div>
          <div class="product-autocomplete-item-meta">
            ${product.sku ? 'Артикул: ' + product.sku : ''} 
            ${product.barcode ? ' • ШК: ' + product.barcode : ''}
            ${product.has_stock ? ' • В наличии' : ' • Нет на складе'}
          </div>
        `;
        item.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          selectProduct(row, product);
        };
        list.appendChild(item);
      });
      
      list.style.display = 'block';
      
      // Если только один результат - автоматически выбираем его
      if (data.products.length === 1) {
        selectProduct(row, data.products[0]);
      }
    } catch (err) {
      console.error('Ошибка при поиске:', err);
      hideAutocomplete();
    }
  }
  
  // Инициализация обработчиков строки
  function initRowHandlers(row) {
    if (row.dataset.handlersInitialized === 'true') return;
    row.dataset.handlersInitialized = 'true';
    
    const titleInput = row.querySelector('input[name*="-title"]');
    const barcodeInput = row.querySelector('input[name*="-barcode"]');
    const articleInput = row.querySelector('input[name*="-article"]');
    const quantityInput = row.querySelector('input[name*="-quantity"]');
    const priceInput = row.querySelector('input[name*="-price"]');
    const createBtn = row.querySelector('.btn-create-product');
    
    // Поиск по названию
    if (titleInput) {
      titleInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (autocompleteTimeout) {
          clearTimeout(autocompleteTimeout);
        }
        
        if (currentAutocompleteRow && currentAutocompleteRow !== row) {
          hideAutocomplete();
        }
        
        autocompleteTimeout = setTimeout(() => {
          searchProducts(query, row);
        }, 300);
      });
      
      titleInput.addEventListener('blur', function() {
        setTimeout(hideAutocomplete, 200);
      });
    }
    
    // Поиск по штрихкоду
    if (barcodeInput) {
      let barcodeTimeout = null;
      barcodeInput.addEventListener('input', async function() {
        const bc = this.value.trim();
        row.removeAttribute('data-notfound');
        
        if (barcodeTimeout) {
          clearTimeout(barcodeTimeout);
        }
        
        if (bc.length < 6) return;
        
        barcodeTimeout = setTimeout(async () => {
          try {
            const resp = await fetch(`{% url 'core:stock_lookup_by_barcode' %}?barcode=${encodeURIComponent(bc)}`);
            if (!resp.ok) {
              row.setAttribute('data-notfound', '1');
              return;
            }
            const data = await resp.json();
            if (!data.ok) {
              row.setAttribute('data-notfound', '1');
              return;
            }
            
            selectProduct(row, data);
          } catch (_) {
            row.setAttribute('data-notfound', '1');
          }
        }, 500);
      });
    }
    
    // Поиск по артикулу
    if (articleInput) {
      let articleTimeout = null;
      articleInput.addEventListener('input', async function() {
        const article = this.value.trim();
        row.removeAttribute('data-notfound');
        
        if (articleTimeout) {
          clearTimeout(articleTimeout);
        }
        
        if (article.length < 2) return;
        
        articleTimeout = setTimeout(async () => {
          try {
            const resp = await fetch(`{% url 'core:stock_lookup_by_sku' %}?sku=${encodeURIComponent(article)}`);
            if (!resp.ok) {
              row.setAttribute('data-notfound', '1');
              return;
            }
            const data = await resp.json();
            if (!data.ok) {
              row.setAttribute('data-notfound', '1');
              return;
            }
            
            selectProduct(row, data);
          } catch (err) {
            console.error('Ошибка поиска по артикулу:', err);
            row.setAttribute('data-notfound', '1');
          }
        }, 500);
      });
    }
    
    // Расчет при изменении количества или цены
    if (quantityInput) {
      quantityInput.addEventListener('input', () => {
        calculateTotal(row);
      });
    }
    
    if (priceInput) {
      priceInput.addEventListener('input', () => {
        calculateTotal(row);
      });
    }
    
    // Создание нового товара
    if (createBtn) {
      createBtn.addEventListener('click', function() {
        const titleValue = titleInput?.value.trim() || '';
        openCreateProductModal(titleValue, row);
      });
    }
    
    // Инициализация наценки
    if (isOperatorOrDirector) {
      const productIdInput = row.querySelector('input[name*="-product_id"]');
      const markupSpan = row.querySelector('.markup-percent');
      if (productIdInput && markupSpan && productIdInput.value) {
        const productId = parseInt(productIdInput.value);
        if (productsDataMap[productId]) {
          markupSpan.setAttribute('data-purchase-price', productsDataMap[productId].purchase_price || '');
          calculateMarkup(row);
        }
      }
    }
    
    // Первоначальный расчет
    calculateTotal(row);
  }
  
  // Инициализация всех существующих строк
  const existingRows = quoteItemsBody.querySelectorAll('.quote-item-row');
  existingRows.forEach(row => {
    initRowHandlers(row);
  });
  
  // Расчет общего итога
  calculateGrandTotal();
  
  // Функция для обновления имен полей в строке
  function updateRowFieldNames(row, index) {
    const prefix = 'quote_items';
    row.querySelectorAll('input, textarea').forEach(el => {
      if (el.name) {
        el.name = el.name.replace(new RegExp(`${prefix}-(\\d+)-`), `${prefix}-${index}-`);
      }
      if (el.id) {
        el.id = el.id.replace(new RegExp(`id_${prefix}-(\\d+)-`), `id_${prefix}-${index}-`);
      }
    });
  }
  
  // Функция для добавления новой строки
  function addNewRow() {
    const existingRows = quoteItemsBody.querySelectorAll('.quote-item-row');
    const lastRow = existingRows[existingRows.length - 1];
    
    if (!lastRow) {
      // Создаем первую строку
      const tbody = quoteItemsBody;
      const templateRow = document.createElement('tr');
      templateRow.className = 'quote-item-row';
      templateRow.setAttribute('data-row-index', '0');
      const rowIndex = 0;
      
      templateRow.innerHTML = `
        <td style="padding: 16px 12px; font-size: 14px; color: var(--muted); vertical-align: top; padding-top: 20px;">1</td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="hidden" name="quote_items-${rowIndex}-request_item_id" value="">
          <input type="hidden" name="quote_items-${rowIndex}-product_id" value="">
          <input type="text" name="quote_items-${rowIndex}-barcode" class="input quote-barcode" placeholder="Штрихкод" autocomplete="off" inputmode="numeric">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="text" name="quote_items-${rowIndex}-article" class="input quote-article" placeholder="Артикул" autocomplete="off">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <div style="position: relative;">
            <div class="product-search-wrapper" style="position: relative;">
              <input type="text" name="quote_items-${rowIndex}-title" class="input quote-product-name" placeholder="Наименование товара" autocomplete="off">
              <div class="product-autocomplete" style="display: none;"></div>
              <button type="button" class="btn-create-product" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: none;" title="Создать новый товар">+ Новый</button>
            </div>
          </div>
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="number" name="quote_items-${rowIndex}-quantity" class="input" step="0.001" min="0" placeholder="Количество">
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <div style="position: relative;">
            <input type="number" name="quote_items-${rowIndex}-price" class="input" step="0.01" min="0" placeholder="Цена за единицу" required>
            <span style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; pointer-events: none;">₽</span>
          </div>
        </td>
        {% if is_operator or is_director %}
        <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
          <span class="markup-percent" data-purchase-price="">—</span>
        </td>
        {% endif %}
        <td style="padding: 16px 12px; text-align: right; vertical-align: top; padding-top: 20px;">
          <span class="item-total" style="font-size: 16px; font-weight: 600; color: var(--text);">0.00</span> <span style="color: var(--muted);">₽</span>
        </td>
        <td style="padding: 16px 12px; vertical-align: top;">
          <input type="text" name="quote_items-${rowIndex}-note" class="input" placeholder="Примечание">
        </td>
        <td style="padding: 16px 12px; text-align: center; vertical-align: top; padding-top: 20px;">
          <button type="button" class="btn-remove-row" data-remove-row style="background: transparent; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 4px 8px; opacity: 0.6; transition: opacity 0.2s;" title="Удалить строку">×</button>
        </td>
      `;
      
      // Очищаем tbody если там только пустая строка
      const emptyRow = tbody.querySelector('tr td[colspan]');
      if (emptyRow) {
        tbody.innerHTML = '';
      }
      
      tbody.appendChild(templateRow);
      
      if (totalFormsInput) {
        totalFormsInput.value = '1';
      }
      
      initRowHandlers(templateRow);
      
      const barcodeInput = templateRow.querySelector('input[name*="-barcode"]');
      if (barcodeInput) {
        setTimeout(() => barcodeInput.focus(), 100);
      }
      
      return;
    }
    
    // Клонируем последнюю строку
    const newRow = lastRow.cloneNode(true);
    
    // Очищаем значения
    newRow.querySelectorAll('input, textarea').forEach(el => {
      if (el.type === 'hidden' && el.name.includes('request_item_id')) {
        el.value = '';
      } else if (el.type === 'hidden' && el.name.includes('product_id')) {
        el.value = '';
      } else if (el.type !== 'hidden') {
        el.value = '';
      }
      el.classList.remove('field-error');
    });
    
    newRow.querySelectorAll('.errorlist').forEach(el => el.remove());
    
    // Сбрасываем итог и наценку
    const totalSpan = newRow.querySelector('.item-total');
    if (totalSpan) totalSpan.textContent = '0.00';
    const markupSpan = newRow.querySelector('.markup-percent');
    if (markupSpan) {
      markupSpan.textContent = '—';
      markupSpan.setAttribute('data-purchase-price', '');
      markupSpan.className = 'markup-percent';
    }
    
    // Обновляем номер строки
    const rowNumber = existingRows.length + 1;
    const numberCell = newRow.querySelector('td:first-child');
    if (numberCell) numberCell.textContent = rowNumber;
    
    // Обновляем data-row-index
    const newIndex = existingRows.length;
    newRow.setAttribute('data-row-index', newIndex);
    newRow.removeAttribute('data-handlers-initialized');
    
    // Добавляем строку
    quoteItemsBody.appendChild(newRow);
    
    // Обновляем TOTAL_FORMS
    if (totalFormsInput) {
      const currentTotal = parseInt(totalFormsInput.value || '0', 10);
      totalFormsInput.value = currentTotal + 1;
    }
    
    // Обновляем имена полей
    updateRowFieldNames(newRow, newIndex);
    
    // Инициализируем обработчики
    initRowHandlers(newRow);
    
    // Фокусируемся на поле штрихкода
    const barcodeInput = newRow.querySelector('input[name*="-barcode"]');
    if (barcodeInput) {
      setTimeout(() => barcodeInput.focus(), 100);
    }
  }
  
  // Модальное окно создания товара
  function openCreateProductModal(productName, row) {
    const modal = document.getElementById('createProductModal');
    const content = document.getElementById('createProductContent');
    
    if (!modal || !content) {
      console.error('Модальное окно не найдено');
      return;
    }
    
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">Загрузка формы...</div>';
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    fetch('/ajax/product-create-inline/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      content.innerHTML = html;
      const nameInput = content.querySelector('input[name="name"]');
      if (nameInput && productName) {
        nameInput.value = productName;
      }
      if (window.initCreateProductForm) {
        window.initCreateProductForm();
      }
    })
    .catch(error => {
      console.error('Ошибка загрузки формы:', error);
      content.innerHTML = '<div style="color: #ef4444; padding: 20px;">Ошибка загрузки формы создания товара</div>';
    });
  }
  
  function closeCreateProductModal() {
    const modal = document.getElementById('createProductModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  }
  
  // Обработчики кнопок
  if (createProductBtn) {
    createProductBtn.addEventListener('click', function(e) {
      e.preventDefault();
      openCreateProductModal('', null);
    });
  }
  
  if (addRowBtn) {
    addRowBtn.addEventListener('click', function(e) {
      e.preventDefault();
      addNewRow();
    });
  }
  
  if (addFirstRowBtn) {
    addFirstRowBtn.addEventListener('click', function(e) {
      e.preventDefault();
      addNewRow();
    });
  }
  
  // Удаление строки (делегирование событий)
  quoteItemsBody.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-remove-row]');
    if (!btn) return;
    
    const row = btn.closest('.quote-item-row');
    if (!row) return;
    
    if (confirm('Удалить эту позицию?')) {
      const rows = quoteItemsBody.querySelectorAll('.quote-item-row');
      if (rows.length <= 1) {
        // Если последняя строка, очищаем её
        row.querySelectorAll('input, textarea').forEach(el => {
          if (el.type !== 'hidden' && !el.name.includes('DELETE')) {
            el.value = '';
          }
        });
      } else {
        row.remove();
        
        // Обновляем номера строк
        const remainingRows = quoteItemsBody.querySelectorAll('.quote-item-row');
        remainingRows.forEach((r, idx) => {
          const numberCell = r.querySelector('td:first-child');
          if (numberCell) numberCell.textContent = idx + 1;
          r.setAttribute('data-row-index', idx);
          updateRowFieldNames(r, idx);
        });
        
        // Обновляем TOTAL_FORMS
        if (totalFormsInput) {
          totalFormsInput.value = remainingRows.length;
        }
      }
      
      calculateGrandTotal();
    }
  });
  
  // Закрытие модального окна
  const closeBtn = document.getElementById('closeCreateProductModal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeCreateProductModal);
  }
  
  const modal = document.getElementById('createProductModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeCreateProductModal();
      }
    });
  }
  
  window.closeCreateProductModal = closeCreateProductModal;
})();
</script>

{% endblock %}
