{% extends "base.html" %}
{% load access %}
{% block title %}Заявки{% endblock %}
{% block content %}
<h1 class="rq-title">Заявки</h1>

<div class="mb-3 flex flex-wrap gap-6">
  <a href="{% url 'core:request_list' %}" class="btn {% if not status %}btn-primary{% endif %}">Все</a>
  <a href="?status=submitted" class="btn {% if status == 'submitted' %}btn-primary{% endif %}">На согласовании</a>
  <a href="?status=quote" class="btn {% if status == 'quote' %}btn-primary{% endif %}">КП</a>
  <a href="?status=approved" class="btn {% if status == 'approved' %}btn-primary{% endif %}">Согласованы</a>
  <a href="?status=rejected" class="btn {% if status == 'rejected' %}btn-primary{% endif %}">Не согласованы</a>
  <a href="?status=to_pick" class="btn {% if status == 'to_pick' %}btn-primary{% endif %}">В сборку</a>
  <a href="?status=in_progress" class="btn {% if status == 'in_progress' %}btn-primary{% endif %}">Собираются</a>
  <a href="?status=ready_to_ship" class="btn {% if status == 'ready_to_ship' %}btn-primary{% endif %}">Готовы к отгрузке</a>
  <a href="?status={{ statuses.DELIVERED }}" class="btn {% if status == statuses.DELIVERED %}btn-primary{% endif %}">Доставлены</a>
  <a href="?status=done" class="btn {% if status == 'done' %}btn-primary{% endif %}">Завершены</a>

  {% if request.user|in_groups:"manager,operator,director" %}
    <a href="{% url 'core:request_create' %}" class="btn">Новая заявка</a>
  {% endif %}
</div>

<div class="rq-list">
  {% for r in requests %}
    <a class="rq-item" href="{% url 'core:request_detail' r.pk %}">
      <div class="rq-item__top">
        <div class="rq-item__title">#{{ r.number }} — {{ r.title }}</div>
        <div class="rq-item__chips">
          {# бейдж статуса #}
          <span class="rq-chip rq-chip--{{ r.status }}">{{ r.get_status_display }}</span>

          {# бейдж оплаты #}
          {% if r.is_paid %}
          <span class="rq-chip rq-chip--paid" title="Оплачено">
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm1 5v2.05c1.84.26 3 1.31 3 2.78 0 1.76-1.7 2.67-3.88 3.18l-.12.03V17h-2v-1.86c-1.67-.25-3-1.1-3-2.64h2c0 .7.77 1.14 2 1.33 1.48-.31 2-.8 2-1.36 0-.57-.6-1.03-2-1.33-2.04-.44-4-1.13-4-3.15 0-1.5 1.3-2.56 3-2.9V5h2Z" />
            </svg>
            Оплачено
          </span>
          {% endif %}
        </div>
      </div>

      <div class="rq-item__meta">
        Инициатор: {{ r.initiator }}
        {% if r.counterparty %} · Контрагент: {{ r.counterparty.name }}{% endif %}
        · {{ r.created_at|date:"d.m.Y H:i" }}
      </div>
    </a>
  {% empty %}
    <div class="rq-empty">Заявок нет</div>
  {% endfor %}
</div>

<style>
.rq-list {
  display: grid;
  gap: 8px;
}

.rq-item {
  display: block;
  padding: 12px 14px;
  border: 1px solid #e6e6ea;
  border-radius: 12px;
  background: #fff;
  transition: background 0.2s ease;
}

.rq-item:hover {
  background: #fafafa;
}

.rq-item__top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.rq-item__title {
  font-weight: 600;
}

.rq-item__meta {
  color: #777;
  margin-top: 4px;
  font-size: 14px;
}

.rq-item__chips {
  display: flex;
  gap: 6px;
  align-items: center;
}

/* Базовый чип */
.rq-chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:3px 10px; border-radius:999px; font-size:12px; font-weight:500;
  border:1px solid var(--border,#e5e7eb); background:#fff; color:#111827;
}

/* Статусы — мягкие фоны */
.rq-chip--submitted     { background:#eef2ff; border-color:#c7d2fe; color:#1f2937; } /* На согласовании */
.rq-chip--quote         { background:#fef3c7; border-color:#fde68a; color:#78350f; } /* КП */
.rq-chip--approved      { background:#e0f2fe; border-color:#bae6fd; color:#075985; } /* Согласована */
.rq-chip--to_pick       { background:#f5f3ff; border-color:#ddd6fe; color:#3730a3; } /* В сборку */
.rq-chip--in_progress   { background:#ecfeff; border-color:#a5f3fc; color:#155e75; } /* Собирается */
.rq-chip--ready_to_ship { background:#f0fdf4; border-color:#bbf7d0; color:#166534; } /* Готова к отгрузке */
.rq-chip--delivered     { background:#fff7ed; border-color:#fed7aa; color:#9a3412; } /* Доставлена */
.rq-chip--canceled      { background:#fee2e2; border-color:#fecaca; color:#7f1d1d; } /* Отменена */

/* Завершена — акцентный тёмный бейдж */
.rq-chip--done { background:#111; border-color:#111; color:#fff; }

/* Бейдж оплаты (как раньше) */
.rq-chip--paid{
  border:1px solid #0ea5e9; background:#e0f2fe; color:#075985;
}
.rq-chip--paid svg{ fill:currentColor; display:block; }
.rq-chip--rejected     { background:#ffe4e6; border-color:#fecdd3; color:#7f1d1d; } /* Не согласована */
}
</style>
{% endblock %}
