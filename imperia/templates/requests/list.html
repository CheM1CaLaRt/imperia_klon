{% extends "base.html" %}
{% load access %}
{% block title %}–ó–∞—è–≤–∫–∏ ‚Äî IndigoFlow{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">–ó–∞—è–≤–∫–∏</h1>
      <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏</p>
    </div>
    {% if request.user|in_groups:"manager,operator,director" %}
      <a href="{% url 'core:request_create' %}" class="btn btn-primary">+ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</a>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="filter-wrapper">
    <div class="filter-header">
      <div class="filter-header__icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 4C3 3.44772 3.44772 3 4 3H20C20.5523 3 21 3.44772 21 4V6.58579C21 6.851 20.8946 7.10536 20.7071 7.29289L14.2929 13.7071C14.1054 13.8946 14 14.149 14 14.4142V17L10 21V14.4142C10 14.149 9.89464 13.8946 9.70711 13.7071L3.29289 7.29289C3.10536 7.10536 3 6.851 3 6.58579V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3 class="filter-header__title">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É</h3>
    </div>
    <form method="get" action="{% url 'core:request_list' %}" class="filter-form" id="statusFilterForm">
      <div class="filter-controls">
        <div class="filter-select-wrapper">
          <label for="statusFilter" class="filter-select-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</label>
          <select id="statusFilter" name="status" class="filter-select">
            <option value="">–í—Å–µ –∑–∞—è–≤–∫–∏</option>
            {% if is_warehouse_only %}
              {# –ö–ª–∞–¥–æ–≤—â–∏–∫ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –µ–≥–æ —Ä–∞–±–æ—Ç–æ–π #}
              <option value="to_pick" {% if status == 'to_pick' %}selected{% endif %}>–í —Å–±–æ—Ä–∫—É</option>
              <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>–°–æ–±–∏—Ä–∞—é—Ç—Å—è</option>
              <option value="ready_to_ship" {% if status == 'ready_to_ship' %}selected{% endif %}>–ö –æ—Ç–≥—Ä—É–∑–∫–µ</option>
              <option value="in_delivery" {% if status == 'in_delivery' %}selected{% endif %}>–í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
            {% else %}
              {# –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π #}
              <option value="draft" {% if status == 'draft' %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</option>
              <option value="submitted" {% if status == 'submitted' %}selected{% endif %}>–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
              <option value="quote" {% if status == 'quote' %}selected{% endif %}>–ö–ü</option>
              <option value="approved" {% if status == 'approved' %}selected{% endif %}>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã</option>
              <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã</option>
              <option value="to_pick" {% if status == 'to_pick' %}selected{% endif %}>–í —Å–±–æ—Ä–∫—É</option>
              <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>–°–æ–±–∏—Ä–∞—é—Ç—Å—è</option>
              <option value="ready_to_ship" {% if status == 'ready_to_ship' %}selected{% endif %}>–ö –æ—Ç–≥—Ä—É–∑–∫–µ</option>
              <option value="in_delivery" {% if status == 'in_delivery' %}selected{% endif %}>–í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
              <option value="partially_shipped" {% if status == 'partially_shipped' %}selected{% endif %}>–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω—ã</option>
              <option value="{{ statuses.DELIVERED }}" {% if status == statuses.DELIVERED %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω—ã</option>
              <option value="done" {% if status == 'done' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω—ã</option>
            {% endif %}
          </select>
        </div>
        <button type="submit" class="filter-apply-btn">
          <span class="filter-apply-btn__icon">‚úì</span>
          <span class="filter-apply-btn__text">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
        </button>
        {% if status %}
          <a href="{% url 'core:request_list' %}" class="filter-clear-btn" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä">
            <span class="filter-clear-btn__icon">‚úï</span>
            <span class="filter-clear-btn__text">–°–±—Ä–æ—Å–∏—Ç—å</span>
          </a>
        {% endif %}
      </div>
      {% if status %}
        <div class="filter-active-badge">
          <span class="filter-active-badge__text">–ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: 
            {% if status == 'draft' %}–ß–µ—Ä–Ω–æ–≤–∏–∫–∏
            {% elif status == 'submitted' %}–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏
            {% elif status == 'quote' %}–ö–ü
            {% elif status == 'approved' %}–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã
            {% elif status == 'rejected' %}–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã
            {% elif status == 'to_pick' %}–í —Å–±–æ—Ä–∫—É
            {% elif status == 'in_progress' %}–°–æ–±–∏—Ä–∞—é—Ç—Å—è
            {% elif status == 'ready_to_ship' %}–ö –æ—Ç–≥—Ä—É–∑–∫–µ
            {% elif status == 'in_delivery' %}–í –¥–æ—Å—Ç–∞–≤–∫–µ
            {% elif status == 'partially_shipped' %}–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω—ã
            {% elif status == statuses.DELIVERED %}–î–æ—Å—Ç–∞–≤–ª–µ–Ω—ã
            {% elif status == 'done' %}–ó–∞–≤–µ—Ä—à–µ–Ω—ã
            {% else %}{{ status }}{% endif %}
          </span>
        </div>
      {% endif %}
    </form>
  </div>
</div>

<section class="rq-list" aria-live="polite">
  {% for r in requests %}
    <a class="rq-item" href="{% url 'core:request_detail' r.pk %}">
      <div class="rq-item__row">
        <div class="rq-item__main">
          <div class="rq-item__title">#{{ r.number }} ‚Äî {{ r.title }}</div>
          <div class="rq-item__meta">
            –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: {{ r.initiator }}
            {% if r.counterparty %} ¬∑ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {{ r.counterparty.name }}{% endif %}
            ¬∑ {{ r.created_at|date:"d.m.Y H:i" }}
          </div>
        </div>
        <div class="rq-item__badges">
          {% if r.status == 'canceled' %}
            <span class="rq-chip rq-chip--done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          {% else %}
            <span class="rq-chip rq-chip--{{ r.status }}">{{ r.get_status_display }}</span>
          {% endif %}
          {% if r.is_paid %}
            <span class="rq-chip rq-chip--flag">–û–ø–ª–∞—á–µ–Ω–æ</span>
          {% endif %}
          {% if r.status == 'canceled' %}
            <span class="rq-chip rq-chip--flag">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
          {% endif %}
        </div>
      </div>
    </a>
  {% empty %}
    <div class="card">
      <div class="rq-empty">
        <div style="font-size:48px;margin-bottom:12px">üìã</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:4px">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>
        <div style="color:var(--muted);font-size:14px">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</div>
      </div>
    </div>
  {% endfor %}
</section>

<style>
/* –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä */
.filter-wrapper{
  padding:20px;
  background:#fff;
  border-radius:var(--radius);
}
.filter-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:16px;
  padding-bottom:16px;
  border-bottom:1px solid var(--border);
}
.filter-header__icon{
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(107,114,128,0.08);
  border-radius:10px;
  color:var(--text);
  border:1px solid rgba(0,0,0,0.06);
}
.filter-header__title{
  font-size:16px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.01em;
}

.filter-form{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.filter-controls{
  display:flex;
  gap:12px;
  align-items:flex-end;
  flex-wrap:wrap;
}
.filter-select-wrapper{
  flex:1;
  min-width:200px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.filter-select-label{
  font-size:13px;
  font-weight:600;
  color:var(--muted);
}
.filter-select{
  width:100%;
  padding:12px 16px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--text);
  font-weight:500;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  background-size:12px;
  padding-right:40px;
}
.filter-select:hover{
  border-color:rgba(0,0,0,0.2);
  background-color:#fafafa;
}
.filter-select:focus{
  outline:none;
  border-color:rgba(10,132,255,0.4);
  box-shadow:0 0 0 4px rgba(10,132,255,0.1);
  background-color:#fff;
}

.filter-apply-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 24px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--text);
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
  white-space:nowrap;
}
.filter-apply-btn:hover{
  background:#f8f9fa;
  border-color:rgba(0,0,0,0.18);
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
.filter-apply-btn:active{
  transform:translateY(0);
}
.filter-apply-btn__icon{
  font-size:16px;
  line-height:1;
}
.filter-apply-btn__text{
  letter-spacing:-0.01em;
}

.filter-clear-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:12px 20px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--muted);
  font-weight:600;
  font-size:14px;
  text-decoration:none;
  transition:all 0.2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
  white-space:nowrap;
}
.filter-clear-btn:hover{
  background:#fee2e2;
  border-color:rgba(239,68,68,0.3);
  color:#dc2626;
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(239,68,68,0.15);
}
.filter-clear-btn:active{
  transform:translateY(0);
}
.filter-clear-btn__icon{
  font-size:14px;
  line-height:1;
}

.filter-active-badge{
  padding:10px 14px;
  background:rgba(10,132,255,0.08);
  border:1px solid rgba(10,132,255,0.2);
  border-radius:10px;
  display:flex;
  align-items:center;
  gap:8px;
}
.filter-active-badge__text{
  font-size:13px;
  font-weight:600;
  color:#075985;
}

.rq-list{display:grid;gap:12px}
.rq-item{display:block;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px 20px;text-decoration:none;color:inherit;transition:all 0.2s;box-shadow:var(--shadow)}
.rq-item:hover{background:#fff;border-color:var(--primary);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.rq-item__row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
.rq-item__main{flex:1;min-width:0}
.rq-item__title{font-weight:700;font-size:16px;margin-bottom:6px;color:var(--text)}
.rq-item__meta{color:var(--muted);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rq-item__badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text);white-space:nowrap}
.rq-chip--done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-chip--flag{background:var(--card);border:1px dashed var(--border);color:var(--text)}
.rq-chip--draft{background:#f3f4f6;border-color:#d1d5db;color:#374151}
.rq-chip--submitted{background:#eef2ff;border-color:#c7d2fe;color:#1f2937}
.rq-chip--quote{background:#fef3c7;border-color:#fde68a;color:#78350f}
.rq-chip--approved{background:#e0f2fe;border-color:#bae6fd;color:#075985}
.rq-chip--to_pick{background:#f5f3ff;border-color:#ddd6fe;color:#3730a3}
.rq-chip--in_progress{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
.rq-chip--ready_to_ship{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
.rq-chip--in_delivery{background:#e0e7ff;border-color:#c7d2fe;color:#3730a3}
.rq-chip--partially_shipped{background:#fef3c7;border-color:#fde68a;color:#92400e}
.rq-chip--delivered{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
.rq-chip--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:12px;padding:48px 24px;text-align:center;color:var(--muted)}

@media (max-width:940px){
  .filter-wrapper{padding:16px}
  .filter-controls{flex-direction:column;align-items:stretch}
  .filter-select-wrapper{min-width:100%}
  .filter-apply-btn,.filter-clear-btn{width:100%;justify-content:center}
  .rq-item{padding:14px 16px}
  .rq-item__row{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-item__meta{white-space:normal}
  .card-header{flex-wrap:wrap;gap:12px}
  .card-header .btn{font-size:14px;padding:8px 14px}
}
@media (max-width:640px){
  .filter-wrapper{padding:14px}
  .filter-header{padding-bottom:12px;margin-bottom:12px}
  .filter-header__icon{width:32px;height:32px}
  .filter-header__title{font-size:15px}
  .filter-select{padding:14px 16px;font-size:15px;padding-right:44px}
  .filter-apply-btn,.filter-clear-btn{padding:14px 20px;font-size:15px}
  .rq-item{padding:12px 14px}
  .rq-item__title{font-size:15px;line-height:1.4}
  .rq-item__meta{font-size:12px;line-height:1.5}
  .rq-item__badges{width:100%}
  .rq-chip{font-size:11px;padding:3px 8px}
  .card-header{flex-direction:column;align-items:stretch}
  .card-header .btn{width:100%;justify-content:center}
}
</style>

<script>
(function(){
  const filterForm = document.getElementById('statusFilterForm');
  const statusSelect = document.getElementById('statusFilter');
  const applyBtn = document.querySelector('.filter-apply-btn');
  
  if (!filterForm || !statusSelect || !applyBtn) return;
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
  let initialValue = statusSelect.value;
  
  statusSelect.addEventListener('change', function() {
    const hasChanged = this.value !== initialValue;
    if (hasChanged) {
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      applyBtn.style.background = '#0A84FF';
      applyBtn.style.color = '#fff';
      applyBtn.style.borderColor = '#0A84FF';
      applyBtn.style.boxShadow = '0 2px 8px rgba(10,132,255,0.25)';
    } else {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –≤–∏–¥
      applyBtn.style.background = '';
      applyBtn.style.color = '';
      applyBtn.style.borderColor = '';
      applyBtn.style.boxShadow = '';
    }
  });
  
  // –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã –æ–±–Ω–æ–≤–ª—è–µ–º initialValue
  filterForm.addEventListener('submit', function() {
    initialValue = statusSelect.value;
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    applyBtn.disabled = true;
    applyBtn.style.opacity = '0.6';
    applyBtn.style.cursor = 'wait';
    applyBtn.querySelector('.filter-apply-btn__text').textContent = '–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è...';
  });
})();
</script>
{% endblock %}
