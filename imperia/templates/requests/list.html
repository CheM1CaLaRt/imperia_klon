{% extends "base.html" %}
{% load access %}
{% block title %}–ó–∞—è–≤–∫–∏ ‚Äî IndigoFlow{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div>
      <h1 class="card-title">–ó–∞—è–≤–∫–∏</h1>
      <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏</p>
    </div>
    {% if request.user|in_groups:"manager,operator,director" %}
      <a href="{% url 'core:request_create' %}" class="btn btn-primary">+ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</a>
    {% endif %}
  </div>
</div>

<div class="card">
  <nav class="rq-filters" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
    <a href="{% url 'core:request_list' %}" class="rq-seg {% if not status %}is-active{% endif %}">–í—Å–µ</a>
    <a href="?status=submitted" class="rq-seg {% if status == 'submitted' %}is-active{% endif %}">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</a>
    <a href="?status=quote" class="rq-seg {% if status == 'quote' %}is-active{% endif %}">–ö–ü</a>
    <a href="?status=approved" class="rq-seg {% if status == 'approved' %}is-active{% endif %}">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã</a>
    <a href="?status=rejected" class="rq-seg {% if status == 'rejected' %}is-active{% endif %}">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã</a>
    <a href="?status=to_pick" class="rq-seg {% if status == 'to_pick' %}is-active{% endif %}">–í —Å–±–æ—Ä–∫—É</a>
    <a href="?status=in_progress" class="rq-seg {% if status == 'in_progress' %}is-active{% endif %}">–°–æ–±–∏—Ä–∞—é—Ç—Å—è</a>
    <a href="?status=ready_to_ship" class="rq-seg {% if status == 'ready_to_ship' %}is-active{% endif %}">–ö –æ—Ç–≥—Ä—É–∑–∫–µ</a>
    <a href="?status={{ statuses.DELIVERED }}" class="rq-seg {% if status == statuses.DELIVERED %}is-active{% endif %}">–î–æ—Å—Ç–∞–≤–ª–µ–Ω—ã</a>
    <a href="?status=done" class="rq-seg {% if status == 'done' %}is-active{% endif %}">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</a>
  </nav>
</div>

<section class="rq-list" aria-live="polite">
  {% for r in requests %}
    <a class="rq-item" href="{% url 'core:request_detail' r.pk %}">
      <div class="rq-item__row">
        <div class="rq-item__main">
          <div class="rq-item__title">#{{ r.number }} ‚Äî {{ r.title }}</div>
          <div class="rq-item__meta">
            –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: {{ r.initiator }}
            {% if r.counterparty %} ¬∑ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {{ r.counterparty.name }}{% endif %}
            ¬∑ {{ r.created_at|date:"d.m.Y H:i" }}
          </div>
        </div>
        <div class="rq-item__badges">
          {% if r.status == 'canceled' %}
            <span class="rq-chip rq-chip--done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          {% else %}
            <span class="rq-chip rq-chip--{{ r.status }}">{{ r.get_status_display }}</span>
          {% endif %}
          {% if r.is_paid %}
            <span class="rq-chip rq-chip--flag">–û–ø–ª–∞—á–µ–Ω–æ</span>
          {% endif %}
          {% if r.status == 'canceled' %}
            <span class="rq-chip rq-chip--flag">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
          {% endif %}
        </div>
      </div>
    </a>
  {% empty %}
    <div class="card">
      <div class="rq-empty">
        <div style="font-size:48px;margin-bottom:12px">üìã</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:4px">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>
        <div style="color:var(--muted);font-size:14px">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</div>
      </div>
    </div>
  {% endfor %}
</section>

<style>
.rq-filters{position:sticky;top:72px;z-index:10;background:var(--card);padding:16px 0;display:flex;flex-wrap:wrap;gap:8px;margin:-20px -20px 20px -20px;padding-left:20px;padding-right:20px;border-bottom:1px solid var(--border)}
.rq-seg{white-space:nowrap;padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);font-weight:600;text-decoration:none;font-size:14px;transition:all 0.2s}
.rq-seg:hover{background:var(--bg);border-color:var(--primary)}
.rq-seg.is-active{background:var(--primary);color:#fff;border-color:var(--primary)}

.rq-list{display:grid;gap:12px}
.rq-item{display:block;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px 20px;text-decoration:none;color:inherit;transition:all 0.2s;box-shadow:var(--shadow)}
.rq-item:hover{background:#fff;border-color:var(--primary);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.rq-item__row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
.rq-item__main{flex:1;min-width:0}
.rq-item__title{font-weight:700;font-size:16px;margin-bottom:6px;color:var(--text)}
.rq-item__meta{color:var(--muted);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rq-item__badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text);white-space:nowrap}
.rq-chip--done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-chip--flag{background:var(--card);border:1px dashed var(--border);color:var(--text)}
.rq-chip--submitted{background:#eef2ff;border-color:#c7d2fe;color:#1f2937}
.rq-chip--quote{background:#fef3c7;border-color:#fde68a;color:#78350f}
.rq-chip--approved{background:#e0f2fe;border-color:#bae6fd;color:#075985}
.rq-chip--to_pick{background:#f5f3ff;border-color:#ddd6fe;color:#3730a3}
.rq-chip--in_progress{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
.rq-chip--ready_to_ship{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
.rq-chip--delivered{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
.rq-chip--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:12px;padding:48px 24px;text-align:center;color:var(--muted)}

@media (max-width:940px){
  .rq-filters{position:static;margin:-16px -16px 16px -16px;padding-left:16px;padding-right:16px}
  .rq-item{padding:14px 16px}
  .rq-item__row{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-item__meta{white-space:normal}
}
@media (max-width:640px){
  .rq-filters{overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;padding-bottom:8px}
  .rq-filters::-webkit-scrollbar{display:none}
  .rq-seg{font-size:13px;padding:6px 12px}
  .rq-item__title{font-size:15px}
  .rq-item__meta{font-size:13px}
}
</style>
{% endblock %}
