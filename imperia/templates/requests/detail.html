{% extends "base.html" %}
{% load access %}
{% load static access %}
{% block title %}–ó–∞—è–≤–∫–∞ #{{ obj.number }}{% endblock %}

{% block content %}
<div class="rq-container">

  <!-- ===== –®–∞–ø–∫–∞ ===== -->
  <header class="rq-header">
    <div>
      <h1 class="rq-title">–ó–∞—è–≤–∫–∞ <span class="rq-mono">#{{ obj.number }}</span> ‚Äî {{ obj.title }}</h1>
      <div class="rq-meta">
        {% if obj.status == 'canceled' %}
          <span class="rq-chip rq-chip--done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          <span class="rq-chip rq-chip--flag-danger">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
        {% else %}
          <span class="rq-chip rq-chip--{{ obj.status }}">{{ obj.get_status_display }}</span>
        {% endif %}
        {% if obj.is_paid %}
          <span class="rq-chip rq-chip--paid" title="–û–ø–ª–∞—á–µ–Ω–æ">–û–ø–ª–∞—á–µ–Ω–æ</span>
        {% endif %}
        <span>–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: <b>{{ obj.initiator }}</b></span>
        {% if obj.counterparty %}<span>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: <b>{{ obj.counterparty.name }}</b></span>{% endif %}
        <span>–°–æ–∑–¥–∞–Ω–∞: {{ obj.created_at|date:"d.m.Y H:i" }}</span>
      </div>
    </div>
  </header>

  <!-- ===== –ü—Ä–æ–≥—Ä–µ—Å—Å-—ç—Ç–∞–ø—ã ===== -->
  {% with s=obj.status %}
  <div class="card" style="padding:24px;margin-bottom:20px;background:linear-gradient(to bottom, #f8fafc 0%, #fff 100%);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
    <h2 style="margin:0 0 20px 0;font-size:18px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px">
      <span style="display:inline-flex;width:32px;height:32px;align-items:center;justify-content:center;background:var(--primary);color:#fff;border-radius:8px;font-size:16px">üìã</span>
      –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏
    </h2>
    <div class="modern-steps-container">
      <div class="modern-steps-track">
        <!-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∞ -->
        <div class="modern-step {% if s != 'draft' %}is-completed{% endif %} {% if s == 'draft' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s != 'draft' %}‚úì{% else %}1{% endif %}
            </div>
            {% if s != 'draft' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–°–æ–∑–¥–∞–Ω–∞</div>
            {% if status_dates.draft %}
              <div class="modern-step__date">{{ status_dates.draft.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.draft.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ -->
        <div class="modern-step {% if s in 'submitted quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}is-completed{% endif %} {% if s == 'submitted' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'submitted quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}‚úì{% else %}2{% endif %}
            </div>
            {% if s in 'submitted quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
            {% if status_dates.submitted %}
              <div class="modern-step__date">{{ status_dates.submitted.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.submitted.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 3: –ö–ü -->
        <div class="modern-step {% if s in 'quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}is-completed{% endif %} {% if s == 'quote' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}‚úì{% else %}3{% endif %}
            </div>
            {% if s in 'quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ö–ü</div>
            {% if status_dates.quote %}
              <div class="modern-step__date">{{ status_dates.quote.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.quote.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 4: –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ -->
        <div class="modern-step {% if s in 'pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}is-completed{% endif %} {% if s == 'pending_approval' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}‚úì{% else %}4{% endif %}
            </div>
            {% if s in 'pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</div>
            {% if status_dates.pending_approval %}
              <div class="modern-step__date">{{ status_dates.pending_approval.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.pending_approval.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 5: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ -->
        <div class="modern-step {% if s in 'approved to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}is-completed{% endif %} {% if s == 'approved' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}‚úì{% else %}5{% endif %}
            </div>
            {% if s in 'approved to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</div>
            {% if status_dates.approved %}
              <div class="modern-step__date">{{ status_dates.approved.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.approved.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å) -->
        {% if s == 'rejected' %}
        <div class="modern-step modern-step--error is-active">
          <div class="modern-step__icon">
            <div class="modern-step__circle">‚úó</div>
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</div>
            {% if status_dates.rejected %}
              <div class="modern-step__date">{{ status_dates.rejected.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.rejected.author }}</div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- –®–∞–≥ 6: –ù–∞ —Å–±–æ—Ä–∫—É -->
        <div class="modern-step {% if s in 'to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}is-completed{% endif %} {% if s == 'to_pick' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}‚úì{% else %}6{% endif %}
            </div>
            {% if s in 'to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ù–∞ —Å–±–æ—Ä–∫—É</div>
            {% if status_dates.to_pick %}
              <div class="modern-step__date">{{ status_dates.to_pick.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.to_pick.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 7: –°–æ–±–∏—Ä–∞–µ—Ç—Å—è -->
        <div class="modern-step {% if s in 'in_progress ready_to_ship partially_shipped shipped done canceled' %}is-completed{% endif %} {% if s == 'in_progress' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'in_progress ready_to_ship partially_shipped shipped done canceled' %}‚úì{% else %}7{% endif %}
            </div>
            {% if s in 'in_progress ready_to_ship partially_shipped shipped done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–°–æ–±–∏—Ä–∞–µ—Ç—Å—è</div>
            {% if status_dates.in_progress %}
              <div class="modern-step__date">{{ status_dates.in_progress.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.in_progress.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 8: –ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ -->
        <div class="modern-step {% if s in 'ready_to_ship partially_shipped shipped done canceled' %}is-completed{% endif %} {% if s == 'ready_to_ship' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'ready_to_ship partially_shipped shipped done canceled' %}‚úì{% else %}8{% endif %}
            </div>
            {% if s in 'ready_to_ship partially_shipped shipped done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</div>
            {% if status_dates.ready_to_ship %}
              <div class="modern-step__date">{{ status_dates.ready_to_ship.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.ready_to_ship.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 9: –û—Ç–≥—Ä—É–∂–µ–Ω–∞ -->
        <div class="modern-step {% if s in 'partially_shipped shipped done canceled' %}is-completed{% endif %} {% if s in 'partially_shipped shipped' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'partially_shipped shipped done canceled' %}‚úì{% else %}9{% endif %}
            </div>
            {% if s in 'partially_shipped shipped done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–û—Ç–≥—Ä—É–∂–µ–Ω–∞</div>
            {% if status_dates.shipped or status_dates.partially_shipped %}
              <div class="modern-step__date">
                {% if status_dates.shipped %}{{ status_dates.shipped.date|date:"d.m.Y H:i" }}
                {% elif status_dates.partially_shipped %}{{ status_dates.partially_shipped.date|date:"d.m.Y H:i" }}{% endif %}
              </div>
              <div class="modern-step__author">
                {% if status_dates.shipped %}{{ status_dates.shipped.author }}
                {% elif status_dates.partially_shipped %}{{ status_dates.partially_shipped.author }}{% endif %}
              </div>
            {% endif %}
            {% if s == 'partially_shipped' %}
              <div class="modern-step__badge" style="background:#fef3c7;color:#78350f;font-size:11px;padding:2px 8px;border-radius:4px;margin-top:4px">–ß–∞—Å—Ç–∏—á–Ω–æ</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 10: –î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ -->
        <div class="modern-step {% if s in 'delivered done canceled' %}is-completed{% endif %} {% if s == 'delivered' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'delivered done canceled' %}‚úì{% else %}10{% endif %}
            </div>
            {% if s in 'delivered done canceled' %}<div class="modern-step__connector"></div>{% endif %}
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞</div>
            {% if status_dates.delivered %}
              <div class="modern-step__date">{{ status_dates.delivered.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.delivered.author }}</div>
            {% endif %}
          </div>
        </div>

        <!-- –®–∞–≥ 11: –ó–∞–≤–µ—Ä—à–µ–Ω–∞ -->
        <div class="modern-step {% if s in 'done canceled' %}is-completed{% endif %} {% if s == 'done' %}is-active{% endif %}">
          <div class="modern-step__icon">
            <div class="modern-step__circle">
              {% if s in 'done canceled' %}‚úì{% else %}11{% endif %}
            </div>
          </div>
          <div class="modern-step__content">
            <div class="modern-step__title">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</div>
            {% if status_dates.done %}
              <div class="modern-step__date">{{ status_dates.done.date|date:"d.m.Y H:i" }}</div>
              <div class="modern-step__author">{{ status_dates.done.author }}</div>
            {% endif %}
            {% if obj.status == 'done' and not obj.is_paid %}
              <div class="modern-step__badge" style="background:#fee2e2;color:#7f1d1d;font-size:11px;padding:2px 8px;border-radius:4px;margin-top:4px">–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞</div>
            {% elif obj.status == 'done' and obj.is_paid %}
              <div class="modern-step__badge" style="background:#dcfce7;color:#166534;font-size:11px;padding:2px 8px;border-radius:4px;margin-top:4px">–û–ø–ª–∞—á–µ–Ω–∞</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endwith %}

  <!-- ===== –ú–∞–∫–µ—Ç: 2 –∫–æ–ª–æ–Ω–∫–∏ ===== -->
  <div class="rq-grid">

    <!-- ===== –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ===== -->
    <div class="rq-main">

      <!-- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>

          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            {% if can_edit_quote %}
              {% if active_quote %}
                <a href="{% url 'core:request_quote_edit' obj.pk active_quote.pk %}" class="btn btn-primary">
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% else %}
                <a href="{% url 'core:request_quote_create' obj.pk %}" class="btn btn-primary">
                  –°–æ–∑–¥–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% endif %}
            {% endif %}
            
            {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
            <form class="rq-upload" method="post" enctype="multipart/form-data"
                  action="{% url 'core:request_upload_quote' obj.pk %}"
                  style="display: inline-block;">
              {% csrf_token %}
              <input id="quoteFile" type="file" name="file" class="rq-upload__input"
                     accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.odt,.ods,.rtf,.png,.jpg,.jpeg"
                     onchange="this.form.submit()">
              <label for="quoteFile" class="rq-upload__label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</label>
            </form>
            {% endif %}
          </div>
        </div>

        {% if active_quote and quote_items %}
          <div style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 16px; font-weight: 600;">–¢–æ–≤–∞—Ä—ã –≤ –ö–ü</h3>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);">
                –ò—Ç–æ–≥–æ: {{ quote_total|floatformat:2 }} ‚ÇΩ
              </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for item in quote_items %}
                  <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                    <td style="padding: 10px 8px;">{{ item.title }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2 }} ‚ÇΩ</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600;">{{ item.total|floatformat:2 }} ‚ÇΩ</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% if obj.quotes.all %}
          <ul class="rq-history" style="padding:12px 14px;">
            {% for q in obj.quotes.all %}
              <li class="rq-file">
                <div class="rq-file__meta">
                  <span class="rq-mono">{{ q.created_at|date:"d.m.Y H:i" }}</span>
                  ‚Äî {{ q.original_name }}
                  <span class="muted">, –∑–∞–≥—Ä—É–∑–∏–ª: {{ q.uploaded_by }}</span>
                </div>
                <div class="rq-file__actions">
                  <button class="btn btn-ghost open-preview"
                          data-url="{% url 'core:request_quote_preview' obj.pk q.pk %}"
                          data-name="{{ q.original_name }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                  <a class="btn" href="{{ q.file.url }}" download>–°–∫–∞—á–∞—Ç—å</a>
                  {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
                  <form method="post" action="{% url 'core:request_quote_delete' obj.pk q.pk %}"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ¬´{{ q.original_name }}¬ª?');">
                    {% csrf_token %}
                    <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">–§–∞–π–ª—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</div>
        {% endif %}
      </section>

      <!-- –û—Ç–≥—Ä—É–∑–∫–∏ -->
      {% if obj.status in 'ready_to_ship partially_shipped shipped' %}
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–û—Ç–≥—Ä—É–∑–∫–∏</h2>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            {% if can_create_shipment %}
              <a href="{% url 'core:request_shipment_create' obj.pk %}" class="btn btn-primary">
                –°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É
              </a>
            {% endif %}
            {% if obj.delivery_address or obj.delivery_contact %}
              <a href="{% url 'core:request_route_sheet' obj.pk %}" target="_blank" class="btn btn-ghost">
                üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
              </a>
              <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
                üìÑ –£–ü–î
              </a>
            {% endif %}
          </div>
        </div>

        {% if shipments %}
          {% for shipment in shipments %}
            <div style="padding: 16px; border-bottom: 1px solid var(--border); {% if not forloop.last %}margin-bottom: 16px;{% endif %}">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                    –û—Ç–≥—Ä—É–∑–∫–∞ #{{ shipment.shipment_number|default:shipment.pk }}
                  </h3>
                  <div style="margin-top: 4px; font-size: 13px; color: var(--muted);">
                    {{ shipment.shipped_at|date:"d.m.Y H:i" }} ¬∑ {{ shipment.shipped_by }}
                    {% if shipment.is_partial %}
                      <span style="color: #f59e0b;">(–ß–∞—Å—Ç–∏—á–Ω–∞—è)</span>
                    {% endif %}
                  </div>
                </div>
                <div style="font-size: 16px; font-weight: 700; color: var(--primary);">
                  –ò—Ç–æ–≥–æ: {{ shipment.get_total|floatformat:2 }} ‚ÇΩ
                </div>
              </div>
              
              {% if shipment.comment %}
                <div style="padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 12px; font-size: 13px; color: var(--muted);">
                  {{ shipment.comment }}
                </div>
              {% endif %}
              
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="border-bottom: 1px solid var(--border);">
                    <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                    <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in shipment.items.all %}
                    <tr style="border-bottom: 1px solid var(--border);">
                      <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                      <td style="padding: 10px 8px;">{{ item.title }}</td>
                      <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                      <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2|default:"‚Äî" }} {% if item.price %}‚ÇΩ{% endif %}</td>
                      <td style="padding: 10px 8px; text-align: right; font-weight: 600;">
                        {% if item.price %}
                          {% widthratio item.quantity 1 item.price as item_total %}
                          {{ item_total|floatformat:2 }} ‚ÇΩ
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <a href="{% url 'core:request_upd_shipment' obj.pk shipment.pk %}" target="_blank" class="btn btn-ghost" style="font-size: 13px;">
                  üìÑ –£–ü–î –¥–ª—è —ç—Ç–æ–π –æ—Ç–≥—Ä—É–∑–∫–∏
                </a>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="rq-empty">–û—Ç–≥—Ä—É–∑–æ–∫ –Ω–µ—Ç</div>
        {% endif %}
      </section>
      {% endif %}
      
      <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã (–µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫, –Ω–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏) -->
      {% if obj.status not in 'ready_to_ship partially_shipped shipped' and obj.delivery_address %}
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        </div>
        <div style="padding: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          <a href="{% url 'core:request_route_sheet' obj.pk %}" target="_blank" class="btn btn-ghost">
            üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
          </a>
          {% if active_quote %}
            <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
              üìÑ –£–ü–î
            </a>
          {% endif %}
        </div>
      </section>
      {% endif %}

      <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <section class="rq-card">
        <div class="rq-card__head"><h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2></div>
        <div class="rq-card__body">
          {% if obj.comment_internal %}
            {{ obj.comment_internal|linebreaksbr }}
          {% else %}
            <span class="muted">‚Äî</span>
          {% endif %}
        </div>
      </section>

      <!-- –ü–æ–∑–∏—Ü–∏–∏ -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ü–æ–∑–∏—Ü–∏–∏</h2>
          {% if can_add_items %}
            <form method="post" action="{% url 'core:request_add_item' obj.pk %}" class="rq-additem">
              {% csrf_token %}
              <div class="rq-additem__field">{{ item_form.title }}</div>
              <div class="rq-additem__qty">{{ item_form.quantity }}</div>
              <div class="rq-additem__note">{{ item_form.note }}</div>
              <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
          {% endif %}
        </div>

        {% if obj.items.all %}
          <div class="rq-table">
            <div class="rq-trow rq-trow--head">
              <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
              <div class="ta-right">–ö–æ–ª-–≤–æ</div>
              <div>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>
            </div>
            {% for it in obj.items.all %}
              <div class="rq-trow">
                <div>{% if it.title %}{{ it.title }}{% else %}{{ it.product.name }}{% endif %}</div>
                <div class="ta-right">{{ it.quantity }}</div>
                <div class="muted">{{ it.note }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="rq-empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
        {% endif %}
      </section>

      <!-- –°–µ–∫—Ü–∏—è ¬´–°–±–æ—Ä–∫–∞ —Å–æ —Å–∫–ª–∞–¥–∞¬ª (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ approved) -->
      {% if show_pick_section %}
        {% include "core/_pick_section.html" with req=obj formset=pick_formset csrf_token=csrf_token %}
      {% endif %}

      {# –°–ø–∏—Å–æ–∫ –∫ —Å–±–æ—Ä–∫–µ –¥–ª—è —Å–∫–ª–∞–¥–∞ #}
      {% if latest_pick and pick_items %}
        <div class="mt-6 border border-gray-200 rounded-xl">
          <div class="px-4 py-3 border-b bg-white flex items-center justify-between">
            <div class="font-semibold">–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})
<!--            {# detail.html ‚Äî –≤ –±–ª–æ–∫–µ "–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ...)" —Å–ø—Ä–∞–≤–∞ –¥–æ–±–∞–≤–∏–º #}-->
            <a href="{% url 'core:pick_print' obj.pk %}" class="btn btn-ghost" target="_blank">–ü–µ—á–∞—Ç—å</a>
            </div>
            <div class="text-sm text-gray-500">–°–æ–∑–¥–∞–ª: {{ latest_pick.created_by }} ¬∑ {{ latest_pick.created_at|date:"d.m.Y H:i" }}</div>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-gray-500 border-b">
                <tr class="text-left">
                  <th class="py-2 pr-3">–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
                  <th class="py-2 pr-3">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th class="py-2 pr-3">–Ø—á–µ–π–∫–∞</th>
                  <th class="py-2 pr-3">–ï–¥.</th>
                  <th class="py-2 pr-3 text-right">–ö–æ–ª-–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for it in pick_items %}
                  <tr class="border-b last:border-0">
                    <td class="py-2 pr-3">{{ it.barcode }}</td>
                    <td class="py-2 pr-3">{{ it.name }}</td>
                    <td class="py-2 pr-3">{{ it.location|default:"‚Äî" }}</td>
                    <td class="py-2 pr-3">{{ it.unit }}</td>
                    <td class="py-2 pr-3 text-right">{{ it.qty }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}


<!-- –°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞ (—Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞) -->
{% if request.user|in_groups:"warehouse" and obj.status == "in_progress" %}
  <div class="mt-3">
    <button type="button" class="btn" id="openScanModal">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞</button>
  </div>

  <div id="scanModal" class="fixed inset-0 hidden items-start justify-center z-50" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" data-close></div>

    <div class="relative mt-10 w-[min(1400px,98vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white shadow-xl border">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div class="text-xl font-semibold">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})</div>
        <button type="button" class="text-2xl text-gray-500" data-close title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å -->
      <div class="px-6 pt-4 pb-3 border-b bg-white">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
          <div class="xl:col-span-2">
            <label for="scanInput" class="text-sm text-gray-600 block">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
            <input id="scanInput" class="input w-full text-lg" placeholder="–ù–∞–≤–µ–¥–∏ —Å–∫–∞–Ω–µ—Ä –∏ —Å—á–∏—Ç–∞–π –®–ö (Enter)">
            <div class="text-xs text-gray-500 mt-1">
              Enter ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å, F2 ‚Äî —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º, +/‚àí ‚Äî ¬´–°–æ–±—Ä–∞–Ω–æ¬ª, Space ‚Äî ¬´–ù–µ—Ç¬ª.
              –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–µ–¥–ª–æ–∂–∏–º <b>—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</b>.
            </div>
          </div>
          <div>
            <label for="scanMode" class="text-sm text-gray-600 block">–î–µ–π—Å—Ç–≤–∏–µ</label>
            <select id="scanMode" class="input w-full">
              <option value="add">–ü—Ä–∏–Ω–∏–º–∞–µ–º (—É–≤–µ–ª–∏—á–∏—Ç—å ¬´–°–æ–±—Ä–∞–Ω–æ¬ª)</option>
              <option value="miss">–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ (–ø–æ–º–µ—Ç–∏—Ç—å ¬´–ù–µ—Ç¬ª)</option>
            </select>
            <div class="text-xs text-gray-500 mt-1">F2 ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</div>
          </div>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫–∏ -->
        <div class="mt-3 flex flex-wrap gap-3 text-sm">
          <div class="px-2 py-1 border rounded">–ü–ª–∞–Ω: <span id="ctPlan" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–°–æ–±—Ä–∞–Ω–æ: <span id="ctPicked" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">¬´–ù–µ—Ç¬ª: <span id="ctMissing" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–û—Å—Ç–∞–ª–æ—Å—å: <span id="ctLeft" class="font-semibold">0</span></div>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <div class="overflow-auto" style="max-height: calc(90vh - 260px);">
        <table class="w-full text-sm" id="scanTable">
          <thead class="text-gray-600 border-b sticky top-0 bg-white z-10">
            <tr>
              <th class="py-2 px-4 text-left">–®–ö</th>
              <th class="py-2 px-4 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="py-2 px-4 text-left">–Ø—á–µ–π–∫–∞</th>
              <th class="py-2 px-4 text-left">–ü–ª–∞–Ω</th>
              <th class="py-2 px-4 text-left">–°–æ–±—Ä–∞–Ω–æ</th>
              <th class="py-2 px-4 text-left">–ù–µ—Ç</th>
              <th class="py-2 px-4 text-left">–ü—Ä–∏–º.</th>
              <th class="py-2 px-4 text-left">–°—Ç–∞—Ç—É—Å</th>
            </tr>
          </thead>
          <tbody>
            {% for it in pick_items %}
            <tr data-bc="{{ it.barcode }}" class="state-none">
              <td class="py-2 px-4 font-mono">{{ it.barcode }}</td>
              <td class="py-2 px-4">{{ it.name }}</td>
              <td class="py-2 px-4">{{ it.location|default:"‚Äî" }}</td>
              <td class="py-2 px-4" data-plan>{{ it.qty }}</td>
              <td class="py-2 px-4">
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-ghost h-8 w-8" data-dec>-</button>
                  <input class="input h-8 w-20 text-right" type="number" min="0"
                         value="{{ it.picked_qty|default:0 }}" data-picked>
                  <button type="button" class="btn btn-ghost h-8 w-8" data-inc>+</button>
                </div>
              </td>
              <td class="py-2 px-4">
                <input type="checkbox" data-miss {% if it.missing %}checked{% endif %}>
              </td>
              <td class="py-2 px-4">
                <input type="text" class="input h-8 w-44" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                       data-note value="{{ it.note|default_if_none:'' }}">
              </td>
              <td class="py-2 px-4 whitespace-nowrap" data-status>‚Äî</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- –ü–æ–¥–≤–∞–ª -->
      <div class="px-6 py-3 border-t bg-white">
        <div class="text-xs text-gray-500 mb-3 flex flex-wrap gap-4">
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-gray-200"></span> ‚Äî –Ω–µ –Ω–∞—á–∞—Ç–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-yellow-200"></span> ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-green-200"></span> ‚Äî –≥–æ—Ç–æ–≤–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-red-200"></span> ‚Äî –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</span>
        </div>
        <div class="flex gap-2">
          <button type="button" class="btn" id="saveDraft">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn btn-ghost" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    tr.state-none    { background: #f5f5f5; }
    tr.state-partial { background: #fef3c7; }
    tr.state-ok      { background: #dcfce7; }
    tr.state-miss    { background: #fee2e2; }
  </style>

  <script>
  (function(){
    const modal  = document.getElementById('scanModal');
    const open   = document.getElementById('openScanModal');
    const input  = document.getElementById('scanInput');
    const mode   = document.getElementById('scanMode');
    const tbody  = document.getElementById('scanTable').querySelector('tbody');
    const btnSave   = document.getElementById('saveDraft');

    const ctPlan    = document.getElementById('ctPlan');
    const ctPicked  = document.getElementById('ctPicked');
    const ctMissing = document.getElementById('ctMissing');
    const ctLeft    = document.getElementById('ctLeft');

    let dirty = false;
    let saving = false;
    let autoSaveTimer = null;
    const markDirty = () => { 
      dirty = true; 
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        if(dirty && !saving) {
          autoSave();
        }
      }, 2000);
    };

    const focusInput = () => setTimeout(()=>input && input.focus(), 20);

    function updateRowState(tr){
      const plan   = parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10);
      const picked = parseInt(tr.querySelector('[data-picked]').value||'0',10);
      const miss   = tr.querySelector('[data-miss]').checked;
      const st     = tr.querySelector('[data-status]');
      tr.classList.remove('state-none','state-partial','state-ok','state-miss');

      if(miss){ tr.classList.add('state-miss'); st.textContent = '–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'; return; }
      if(picked === 0){ tr.classList.add('state-none'); st.textContent = '–ù–µ –Ω–∞—á–∞—Ç–æ'; }
      else if(picked < plan){ tr.classList.add('state-partial'); st.textContent = `–ß–∞—Å—Ç–∏—á–Ω–æ (${picked}/${plan})`; }
      else{ tr.classList.add('state-ok'); st.textContent = `–ì–æ—Ç–æ–≤–æ (${picked}/${plan})`; }
    }

    function recalc(){
      const rows    = [...tbody.querySelectorAll('tr[data-bc]')];
      const plan    = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-plan]').textContent || 0), 0);
      const picked  = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-picked]').value || 0), 0);
      const missing = rows.reduce((s,tr)=> s + (tr.querySelector('[data-miss]').checked ? 1 : 0), 0);
      if(ctPlan)   ctPlan.textContent   = plan;
      if(ctPicked) ctPicked.textContent = picked;
      if(ctMissing)ctMissing.textContent= missing;
      if(ctLeft)   ctLeft.textContent   = Math.max(0, plan - picked);
    }

    function initStates(){
      [...tbody.querySelectorAll('tr[data-bc]')].forEach(updateRowState);
      recalc();
    }

    const openM  = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); focusInput(); initStates(); dirty=false; };
    const closeM = () => { modal.classList.add('hidden');  modal.classList.remove('flex'); };

    open.addEventListener('click', openM);
    modal.addEventListener('click', e=>{
      if(e.target.closest('[data-close]')){
        if(dirty){
          if(confirm('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å?')){ save('save', true); return; }
        }
        closeM();
      }
    });

    document.addEventListener('keydown', e=>{
      if(modal.classList.contains('hidden')) return;
      if(e.key==='Escape'){ if(dirty && confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) save('save', true); else closeM(); }
      if(e.key==='F2'){ e.preventDefault(); mode.value = (mode.value==='add' ? 'miss' : 'add'); }
    });

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    input.addEventListener('keydown', e=>{
      if(e.key !== 'Enter') return;
      const bc = input.value.trim(); input.value = '';
      if(!bc) return;

      const tr = tbody.querySelector(`tr[data-bc="${CSS.escape(bc)}"]`);
      if(!tr){ alert('–®–ö –Ω–µ –≤ –ª–∏—Å—Ç–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤ –∑–∞—è–≤–∫—É'); return; }

      const picked = tr.querySelector('[data-picked]');
      const miss   = tr.querySelector('[data-miss]');

      if(mode.value==='miss'){ miss.checked = true; }
      else { picked.value = Math.max(0, parseInt(picked.value||'0',10)+1); }

      updateRowState(tr); recalc(); tr.scrollIntoView({block:'nearest'});
      markDirty();
    });

    // +/- –∏ —Ä—É—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    tbody.addEventListener('click', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.target.matches('[data-inc]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = (+inp.value || 0) + 1;
        updateRowState(tr); recalc(); markDirty();
      }
      if(e.target.matches('[data-dec]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = Math.max(0, (+inp.value || 0) - 1);
        updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('input', e=>{
      if(e.target.matches('[data-picked], [data-miss], [data-note]')){
        const tr = e.target.closest('tr[data-bc]'); updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('keydown', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.key==='+' || e.key==='='){ e.preventDefault(); tr.querySelector('[data-inc]').click(); }
      if(e.key==='-'){ e.preventDefault(); tr.querySelector('[data-dec]').click(); }
      if(e.key===' '){ e.preventDefault(); const m = tr.querySelector('[data-miss]'); m.checked = !m.checked; updateRowState(tr); recalc(); markDirty(); }
    });

    function collectLines(){
      return [...tbody.querySelectorAll('tr[data-bc]')].map(tr=>({
        barcode: tr.dataset.bc,
        picked_qty: parseInt(tr.querySelector('[data-picked]').value||'0',10),
        missing: tr.querySelector('[data-miss]').checked,
        note: tr.querySelector('[data-note]')?.value || '',
        planned_qty: parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10),
      }));
    }

    async function save(commit='save', reloadAfter=true, showNotification=true){
      if(saving) return false;
      saving = true;
      
      if(showNotification && btnSave) {
        const originalText = btnSave.textContent;
        btnSave.disabled = true;
        btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      }

      const lines = collectLines();
      try {
        const resp = await fetch("{{ pick_confirm_url }}", {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':'{{ csrf_token }}'
          },
          body: JSON.stringify({ commit, lines })
        });
        if(!resp.ok){
          const t = await resp.text().catch(()=> '');
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. ' + t);
          if(showNotification && btnSave) {
            btnSave.disabled = false;
            btnSave.textContent = originalText;
          }
          saving = false;
          return false;
        }
        dirty = false;
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(() => {
            if(btnSave) btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          }, 2000);
        }
        if(reloadAfter){ closeM(); location.reload(); }
        saving = false;
        return true;
      } catch(error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
        saving = false;
        return false;
      }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    async function autoSave(){
      await save('save', false, false);
    }

    btnSave.addEventListener('click', ()=> save('save', true, true));   // —Ç–æ–ª—å–∫–æ —á–µ—Ä–Ω–æ–≤–∏–∫
  })();
  </script>
{% endif %}





      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
          {% with history_all=obj.history.all %}
            {% if history_all|length > 3 %}
              <button type="button" id="toggleHistory" class="rq-history-toggle" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            {% endif %}
          {% endwith %}
        </div>
        {% if obj.history.all %}
          <ul class="rq-history" id="historyList">
            {% for h in obj.history.all %}
              <li class="history-item">
                <span class="rq-mono">{{ h.created_at|date:"d.m.Y H:i" }}</span>
                ‚Äî <b>{{ h.author }}</b>:
                <span class="rq-mono">{{ h.from_status|default:"‚Äî" }}</span>
                ‚Üí <span class="rq-mono">{{ h.to_status }}</span>
                <span class="muted">{{ h.note }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">–ü—É—Å—Ç–æ</div>
        {% endif %}
      </section>

    </div>

    <!-- ===== –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–î–µ–π—Å—Ç–≤–∏—è) ===== -->
    <aside class="rq-aside">
      <section class="rq-card rq-sticky">
        <div class="rq-card__head"><h2>–î–µ–π—Å—Ç–≤–∏—è</h2></div>

        <form method="post" action="{% url 'core:request_change_status' obj.pk %}" class="rq-actions__col">
          {% csrf_token %}

          {# –û–ü–ï–†–ê–¢–û–† #}
          {% if request.user|in_groups:"operator" %}
            {% if obj.status == "draft" %}
              <button class="btn" name="to" value="submitted">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            {% elif obj.status == "submitted" %}
              <a href="{% url 'core:request_quote_create' obj.pk %}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ö–ü</a>
              <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            {% elif obj.status == "pending_approval" %}
              <button class="btn" name="to" value="approved">–û–¥–æ–±—Ä–∏—Ç—å</button>
              <button class="btn btn-ghost" name="to" value="rejected">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            {% elif obj.status == "approved" %}
              <button class="btn btn-primary" name="to" value="to_pick">–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Å–±–æ—Ä–∫—É</button>
            {% elif obj.status == "rejected" %}
              <a href="{% url 'core:request_quote_create' obj.pk %}" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü</a>
              <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            {% elif obj.status == "ready_to_ship" %}
              <a href="{% url 'core:request_shipment_create' obj.pk %}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</a>
            {% elif obj.status == "partially_shipped" %}
              <a href="{% url 'core:request_shipment_create' obj.pk %}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</a>
              {% if obj.is_fully_shipped %}
                <button class="btn" name="to" value="shipped">–û—Ç–≥—Ä—É–∂–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é</button>
              {% endif %}
            {% endif %}
          {% endif %}

          {# –ú–ï–ù–ï–î–ñ–ï–† #}
          {% if request.user|in_groups:"manager" %}
            {% if obj.status == "draft" %}
              <button class="btn" name="to" value="submitted">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            {% elif obj.status == "pending_approval" %}
              <button class="btn btn-primary" name="to" value="approved">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</button>
              <button class="btn" name="to" value="rejected">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∏</button>
            {% elif obj.status == "quote" %}
              <button class="btn btn-primary" name="to" value="approved">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</button>
              <button class="btn" name="to" value="rejected">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∏</button>
            {% endif %}
          {% endif %}

          {# –°–ö–õ–ê–î ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Å–±–æ—Ä–∫—É #}
          {% if request.user|in_groups:"warehouse" %}
            {% if obj.status == "to_pick" %}
              <button class="btn" name="to" value="in_progress">–í —Ä–∞–±–æ—Ç—É</button>
            {% elif obj.status == "in_progress" %}
              <button class="btn" name="to" value="ready_to_ship">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</button>
            {% endif %}
          {% endif %}

          {# –î–ò–†–ï–ö–¢–û–† #}
          {% if request.user|in_groups:"director" %}
            {% if obj.status in "draft submitted quote approved to_pick in_progress ready_to_ship delivered" %}
              <button class="btn" name="to" value="quote">–ö–ü</button>
              <button class="btn" name="to" value="approved">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</button>

              {% if obj.status == "approved" %}
                {% if latest_pick %}
                  <button class="btn" name="to" value="to_pick">–í —Å–±–æ—Ä–∫—É (—Å–∫–ª–∞–¥)</button>
                {% else %}
                  <button type="button" class="btn"
        onclick="document.getElementById('openPickModal')?.click()">
  –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–±–æ—Ä–∫–µ –Ω–∞ —Å–∫–ª–∞–¥
</button>
                {% endif %}
              {% endif %}

              <button class="btn" name="to" value="in_progress">–í —Ä–∞–±–æ—Ç—É</button>
              <button class="btn" name="to" value="ready_to_ship">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</button>
              <button class="btn" name="to" value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞</button>
            {% endif %}
            {% if obj.status == "rejected" %}
              <button class="btn" name="to" value="quote">–ö–ü</button>
              <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            {% endif %}
            <button class="btn" name="to" value="done">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            <button class="btn" name="to" value="rejected">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∏</button>
            <button class="btn btn-ghost" name="to" value="canceled">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          {% endif %}
        </form>
      </section>

      {# –û–ü–õ–ê–¢–ê: —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä/–æ–ø–µ—Ä–∞—Ç–æ—Ä #}
      {% if request.user|in_groups:"director,operator" %}
        {% if obj.status != 'canceled' %}
        <section class="rq-card rq-sticky">
          <div class="rq-card__head">
            <h2>–û–ø–ª–∞—Ç–∞</h2>
            {% if obj.is_paid %}
              <span class="rq-chip" style="background:#dcfce7;border-color:#86efac;color:#166534">–û–ø–ª–∞—á–µ–Ω–æ</span>
            {% endif %}
          </div>
          <form method="post" action="{% url 'core:request_toggle_payment' obj.pk %}">
            {% csrf_token %}
            <label class="rq-pay" style="display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer">
              <input type="checkbox" name="is_paid" value="1" {% if obj.is_paid %}checked{% endif %} onchange="this.form.submit()" style="width:20px;height:20px;cursor:pointer">
              <span style="font-weight:600;font-size:15px">–ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞</span>
            </label>
            {% if obj.status == 'delivered' and not obj.is_paid %}
              <div style="padding:8px 14px;margin:0 14px 12px;background:#fef3c7;border:1px solid #fde68a;border-radius:8px;font-size:12px;color:#78350f">
                üí° –û—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—Ç—É, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É
              </div>
            {% elif obj.status == 'done' and not obj.is_paid %}
              <div style="padding:8px 14px;margin:0 14px 12px;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;font-size:12px;color:#7f1d1d">
                ‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞. –°–Ω–∏–º–∏—Ç–µ –æ—Ç–º–µ—Ç–∫—É, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤ —Å—Ç–∞—Ç—É—Å ¬´–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞¬ª
              </div>
            {% endif %}
          </form>
        </section>
        {% endif %}
      {% endif %}
    </aside>
  </div>
</div>

{# ===== –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ö–ü ===== #}
<div id="previewModal" class="fixed inset-0 bg-black/60 hidden z-50 items-center justify-center" style="display:none">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:92vw;max-width:800px;max-height:90vh;display:flex;flex-direction:column;position:relative">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <div id="previewTitle" style="font-size:16px;font-weight:700;color:var(--text)"></div>
      <button id="closePreview" type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:14px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <iframe id="previewFrame" src="" style="width:100%;flex:1;min-height:400px;border:none;border-radius:0 0 18px 18px"></iframe>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('previewModal');
  const closeBtn = document.getElementById('closePreview');
  const titleEl = document.getElementById('previewTitle');
  const frameEl = document.getElementById('previewFrame');
  
  document.querySelectorAll('.open-preview').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const name = this.dataset.name || '–§–∞–π–ª';
      if (titleEl) titleEl.textContent = name;
      if (frameEl) frameEl.src = url;
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    });
  });
  
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    if (frameEl) frameEl.src = '';
  }
  
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.style.display !== 'none') {
      closeModal();
    }
  });
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ #}
<script>
(function(){
  const toggleBtn = document.getElementById('toggleHistory');
  const historyList = document.getElementById('historyList');
  
  if (!toggleBtn || !historyList) return;
  
  const allItems = Array.from(historyList.querySelectorAll('.history-item'));
  const totalItems = allItems.length;
  const showItems = 3;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3
  if (totalItems > showItems) {
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        item.style.display = 'none';
      }
    });
  }
  
  let isExpanded = false;
  
  toggleBtn.addEventListener('click', function() {
    isExpanded = !isExpanded;
    
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        if (isExpanded) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      }
    });
    
    if (isExpanded) {
      toggleBtn.classList.add('expanded');
      toggleBtn.setAttribute('aria-label', '–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
    } else {
      toggleBtn.classList.remove('expanded');
      toggleBtn.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é');
    }
  });
})();
</script>

<style>
:root{ --bg:#f6f7f8; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --accent:#111; --radius:14px; }
.rq-container{max-width:1100px;margin:0 auto;padding:10px 0 28px;}
.rq-title{font-size:26px;font-weight:800;color:var(--text);}
.rq-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;}
.rq-header{margin-bottom:6px;}
.rq-meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);margin-top:6px;align-items:center}

.rq-grid{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:16px;margin-top:10px;}
.rq-main{display:grid;gap:12px;}
.rq-aside{display:grid;gap:12px;}
.rq-sticky{position:sticky; top:12px}

.rq-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);}
.rq-card__head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
.rq-card__head h2{font-size:16px;font-weight:800}
.rq-card__body{padding:12px 14px}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
.modern-steps-container{position:relative;padding:20px 0}
.modern-steps-track{display:flex;flex-direction:column;gap:24px;position:relative}

.modern-step{display:flex;align-items:flex-start;gap:16px;position:relative;transition:all 0.3s ease}
.modern-step__icon{display:flex;flex-direction:column;align-items:center;flex-shrink:0;position:relative;z-index:2}
.modern-step__circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;border:3px solid #e5e7eb;background:#fff;color:#6b7280;transition:all 0.3s ease;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.modern-step__connector{width:3px;height:32px;background:#e5e7eb;margin:4px 0;transition:all 0.3s ease;border-radius:2px}

.modern-step.is-completed .modern-step__circle{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(10,132,255,0.3)}
.modern-step.is-completed .modern-step__connector{background:var(--primary)}
.modern-step.is-active .modern-step__circle{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 0 0 8px rgba(10,132,255,0.1),0 4px 16px rgba(10,132,255,0.3);transform:scale(1.1);animation:pulse 2s infinite}
.modern-step.is-active .modern-step__title{color:var(--primary);font-weight:700}
.modern-step--error .modern-step__circle{background:#ef4444;border-color:#ef4444;color:#fff;box-shadow:0 4px 12px rgba(239,68,68,0.3)}
.modern-step--error .modern-step__title{color:#ef4444;font-weight:700}

.modern-step__content{flex:1;padding-top:8px}
.modern-step__title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px;transition:color 0.3s}
.modern-step__date{font-size:12px;color:var(--muted);margin-bottom:2px}
.modern-step__author{font-size:12px;color:var(--muted)}

@keyframes pulse{0%,100%{box-shadow:0 0 0 8px rgba(10,132,255,0.1),0 4px 16px rgba(10,132,255,0.3)}50%{box-shadow:0 0 0 12px rgba(10,132,255,0.05),0 4px 16px rgba(10,132,255,0.4)}}

/* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
.rq-steps{display:flex;flex-wrap:wrap;gap:8px;margin:0;padding:0;list-style:none}
.rq-step{display:flex;align-items:center;gap:6px;padding:8px 12px;border:2px solid var(--line);border-radius:12px;background:#fff;font-weight:600;font-size:13px;color:var(--text);transition:all 0.2s;position:relative}
.rq-step__number{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--bg);color:var(--text);font-weight:700;font-size:12px;flex-shrink:0}
.rq-step.is-done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-step.is-done .rq-step__number{background:rgba(255,255,255,0.2);color:#fff}
.rq-step.is-current{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:scale(1.05)}
.rq-step.is-current .rq-step__number{background:rgba(255,255,255,0.3);color:#fff;font-weight:800}
.rq-step--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.rq-step--rejected .rq-step__number{background:#fecaca;color:#7f1d1d}

.btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:700;text-decoration:none}
.btn:hover{opacity:.92}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:#fff;color:#111;border-color:#111}
.btn-primary{background:#111;color:#fff;border-color:#111}
.btn-danger{background:#fff;color:#7f1d1d;border-color:#ef4444}
.btn-danger:hover{background:#fee2e2}

.rq-actions__col{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:8px;padding:10px 12px;}
.rq-aside .btn{width:100%;padding:7px 10px;border-radius:10px;font-weight:600;font-size:14px;line-height:1.1;}
.rq-aside .btn-ghost,.rq-aside .btn-danger,.rq-aside .btn-primary{padding:7px 10px;border-radius:10px;font-weight:600;}
.rq-aside .rq-card__head{padding:10px 12px;}

.rq-pay{display:flex;align-items:center;gap:8px;padding:12px 14px}
.rq-upload{display:flex;gap:8px;align-items:center}
.rq-upload__input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
.rq-upload__label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px dashed #111;border-radius:12px;background:#fff;color:#111;font-weight:700;cursor:pointer}

.rq-table{display:grid;border-top:1px solid var(--line)}
.rq-trow{display:grid;grid-template-columns:1fr 120px 1fr;gap:10px;padding:10px 14px;border-bottom:1px solid var(--line)}
.rq-trow--head{background:#fbfbfb;font-weight:700}
.ta-right{text-align:right}

.rq-file{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted var(--line)}
.rq-file:last-child{border-bottom:0}
.rq-file__meta{min-width:0}
.rq-file__actions{display:flex;gap:6px}
.rq-file__actions form{display:inline}

.rq-additem{display:grid;grid-template-columns:1fr 120px 1fr auto;gap:8px;align-items:center}
.rq-additem__field input,.rq-additem__qty input,.rq-additem__note input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--line);background:#fff;color:#111}
.rq-chip--paid{border-style:dashed}
.rq-chip--done{background:#111;border-color:#111;color:#fff}
.rq-chip--flag-danger{background:#fff;border:1px dashed #ef4444;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:10px;padding:26px;border:1px dashed var(--line);border-radius:12px;color:#757b82;background:#fff}

.rq-history{padding:12px 14px}
.rq-history li{padding:6px 0;border-bottom:1px dotted var(--line)}
.rq-history li:last-child{border-bottom:0}
.history-item-hidden{display:none}
.rq-history-toggle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;padding:0}
.rq-history-toggle:hover{background:var(--bg);border-color:var(--primary);color:var(--primary)}
.rq-history-toggle:active{transform:scale(0.95)}
.rq-history-toggle.expanded{transform:rotate(180deg)}
.rq-history-toggle svg{transition:transform 0.2s}

@media (max-width: 980px){
  .rq-grid{grid-template-columns:1fr}
  .rq-sticky{position:static}
  .rq-additem{grid-template-columns:1fr 120px 1fr auto}
  .rq-actions__col{grid-template-columns:1fr;}
  .rq-header{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-file{flex-direction:column;align-items:flex-start;gap:8px}
  .rq-file__actions{width:100%;flex-wrap:wrap}
}
@media (max-width: 640px){
  .rq-title{font-size:20px}
  .rq-meta{flex-direction:column;align-items:flex-start;gap:6px}
  .modern-step{flex-direction:row;gap:12px}
  .modern-step__circle{width:40px;height:40px;font-size:14px}
  .modern-step__connector{height:24px}
  .modern-step__title{font-size:14px}
  .modern-step__date,.modern-step__author{font-size:11px}
  .rq-steps{overflow-x:auto;flex-wrap:nowrap;padding-bottom:4px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .rq-steps::-webkit-scrollbar{display:none}
  .rq-step{flex-shrink:0;font-size:12px;padding:5px 10px}
  .rq-additem{grid-template-columns:1fr 1fr;gap:8px}
  .rq-additem__note{grid-column:1 / -1}
  .rq-trow{grid-template-columns:1fr 90px 1fr;gap:8px;padding:8px 12px}
  .rq-file__actions{flex-direction:column;width:100%}
  .rq-file__actions .btn{width:100%;justify-content:center}
  .rq-card__head{flex-wrap:wrap;gap:12px}
  #previewModal > div{width:98vw;max-width:98vw;height:95vh;max-height:95vh;margin:2.5vh auto}
}
</style>
{% endblock %}
