{% extends "base.html" %}
{% load access %}
{% load static access %}
{% block title %}–ó–∞—è–≤–∫–∞ #{{ obj.number }}{% endblock %}

{% block content %}
<div class="rq-container">

  <!-- ===== –®–∞–ø–∫–∞ ===== -->
  <header class="request-header">
    <div class="request-header__top">
      <div class="request-header__title-group">
        <h1 class="request-header__title">–ó–∞—è–≤–∫–∞ <span class="request-header__number">#{{ obj.number }}</span></h1>
        <p class="request-header__subtitle">{{ obj.title }}</p>
      </div>
      <div class="request-header__status-group">
        {% if obj.status == 'canceled' %}
          <span class="status-badge status-badge--done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          <span class="status-badge status-badge--danger">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
        {% else %}
          <span class="status-badge status-badge--{{ obj.status }}">{{ obj.get_status_display }}</span>
        {% endif %}
      </div>
    </div>
    <div class="request-header__payment-section">
      {% if obj.is_paid %}
        <div class="payment-status payment-status--paid">
          <div class="payment-status__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="payment-status__content">
            <div class="payment-status__label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</div>
            <div class="payment-status__value">–û–ø–ª–∞—á–µ–Ω–æ</div>
          </div>
        </div>
      {% else %}
        <div class="payment-status payment-status--unpaid">
          <div class="payment-status__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2.5"/>
              <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="payment-status__content">
            <div class="payment-status__label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</div>
            <div class="payment-status__value">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</div>
          </div>
        </div>
      {% endif %}
    </div>
    <div class="request-header__meta">
      <div class="request-header__meta-item">
        <span class="request-header__meta-label">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:</span>
        <span class="request-header__meta-value">{{ obj.initiator }}</span>
      </div>
      {% if obj.company %}
        <div class="request-header__meta-item">
          <span class="request-header__meta-label">–ö–æ–º–ø–∞–Ω–∏—è (–ø—Ä–æ–¥–∞–≤–µ—Ü):</span>
          {% if can_edit_company and companies %}
            <select id="company-select" class="request-header__company-select" style="border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:14px;background:var(--card);color:var(--text);cursor:pointer;min-width:200px">
              {% for company in companies %}
                <option value="{{ company.pk }}" {% if company.pk == obj.company.pk %}selected{% endif %}>
                  {{ company.name }}
                </option>
              {% endfor %}
            </select>
          {% else %}
            <span class="request-header__meta-value">{{ obj.company.name }}</span>
          {% endif %}
        </div>
      {% elif can_edit_company and companies %}
        <div class="request-header__meta-item">
          <span class="request-header__meta-label">–ö–æ–º–ø–∞–Ω–∏—è (–ø—Ä–æ–¥–∞–≤–µ—Ü):</span>
          <select id="company-select" class="request-header__company-select" style="border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:14px;background:var(--card);color:var(--text);cursor:pointer;min-width:200px">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é --</option>
            {% for company in companies %}
              <option value="{{ company.pk }}">{{ company.name }}</option>
            {% endfor %}
          </select>
        </div>
      {% endif %}
      {% if obj.counterparty %}
        <div class="request-header__meta-item">
          <span class="request-header__meta-label">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</span>
          <span class="request-header__meta-value">{{ obj.counterparty.name }}</span>
        </div>
      {% endif %}
      <div class="request-header__meta-item">
        <span class="request-header__meta-label">–°–æ–∑–¥–∞–Ω–∞:</span>
        <span class="request-header__meta-value">{{ obj.created_at|date:"d.m.Y H:i" }}</span>
      </div>
    </div>
  </header>

  <!-- ===== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ (–ø—Ä–æ–¥–∞–≤—Ü–µ) ===== -->
  {% if obj.company %}
  <div class="collapsible-card">
    <button type="button" class="collapsible-card__header" data-collapse-target="company-info">
      <div class="collapsible-card__header-left">
        <div class="collapsible-card__icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 7H15M9 11H15M9 15H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3 class="collapsible-card__title">–ö–æ–º–ø–∞–Ω–∏—è (–ø—Ä–æ–¥–∞–≤–µ—Ü)</h3>
      </div>
      <div class="collapsible-card__arrow">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </button>
    <div class="collapsible-card__content" id="company-info">
      <div class="collapsible-card__body">
        <div style="display: grid; gap: 12px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
            <div>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
              <div style="font-weight: 600; font-size: 15px;">{{ obj.company.name }}</div>
              {% if obj.company.full_name %}
                <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">{{ obj.company.full_name }}</div>
              {% endif %}
            </div>
            <div>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">–ò–ù–ù / –ö–ü–ü</div>
              <div style="font-weight: 600; font-size: 14px; font-family: monospace;">
                {{ obj.company.inn }}{% if obj.company.kpp %} / {{ obj.company.kpp }}{% endif %}
              </div>
              {% if obj.company.ogrn %}
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">–û–ì–†–ù: {{ obj.company.ogrn }}</div>
              {% endif %}
            </div>
          </div>
          {% if obj.company.address %}
            <div>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">–ê–¥—Ä–µ—Å</div>
              <div style="font-size: 14px;">{{ obj.company.address }}</div>
            </div>
          {% endif %}
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            {% if obj.company.phone %}
              <div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                <div style="font-size: 14px;">
                  <a href="tel:{{ obj.company.phone }}" style="color: var(--primary); text-decoration: none;">{{ obj.company.phone }}</a>
                </div>
              </div>
            {% endif %}
            {% if obj.company.email %}
              <div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Email</div>
                <div style="font-size: 14px;">
                  <a href="mailto:{{ obj.company.email }}" style="color: var(--primary); text-decoration: none;">{{ obj.company.email }}</a>
                </div>
              </div>
            {% endif %}
          </div>
          {% if obj.company.bank_name or obj.company.bank_account %}
            <div style="padding-top: 12px; border-top: 1px solid var(--border);">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 13px;">
                {% if obj.company.bank_name %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">–ë–∞–Ω–∫</div>
                    <div>{{ obj.company.bank_name }}</div>
                  </div>
                {% endif %}
                {% if obj.company.bank_bik %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">–ë–ò–ö</div>
                    <div style="font-family: monospace;">{{ obj.company.bank_bik }}</div>
                  </div>
                {% endif %}
                {% if obj.company.bank_account %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</div>
                    <div style="font-family: monospace;">{{ obj.company.bank_account }}</div>
                  </div>
                {% endif %}
                {% if obj.company.bank_corr_account %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">–ö–æ—Ä—Ä. —Å—á–µ—Ç</div>
                    <div style="font-family: monospace;">{{ obj.company.bank_corr_account }}</div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          {% if obj.company.director_name or obj.company.accountant_name %}
            <div style="padding-top: 12px; border-top: 1px solid var(--border);">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 13px;">
                {% if obj.company.director_name %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">{{ obj.company.director_position|default:"–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å" }}</div>
                    <div>{{ obj.company.director_name }}</div>
                  </div>
                {% endif %}
                {% if obj.company.accountant_name %}
                  <div>
                    <div style="color: var(--muted); margin-bottom: 2px;">{{ obj.company.accountant_position|default:"–ì–ª–∞–≤–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä" }}</div>
                    <div>{{ obj.company.accountant_name }}</div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ ===== -->
  {% if obj.delivery_date or obj.delivery_contact or obj.delivery_address %}
  <div class="collapsible-card">
    <button type="button" class="collapsible-card__header" data-collapse-target="delivery-info">
      <div class="collapsible-card__header-left">
        <div class="collapsible-card__icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <h3 class="collapsible-card__title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ</h3>
      </div>
      <div class="collapsible-card__arrow">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </button>
    <div class="collapsible-card__content" id="delivery-info">
    <div class="delivery-info-content">
      {% if obj.delivery_date %}
        <div class="delivery-info-item">
          <div class="delivery-info-item__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="delivery-info-item__content">
            <div class="delivery-info-item__label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="delivery-info-item__value">{{ obj.delivery_date|date:"d.m.Y" }}</div>
          </div>
        </div>
      {% endif %}
      
      {% if obj.delivery_contact %}
        <div class="delivery-info-item">
          <div class="delivery-info-item__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 16.92V19.92C22 20.52 21.52 21 20.92 21C9.4 21 0 11.6 0 0.08C0 -0.52 0.48 -1 1.08 -1H4.08C4.68 -1 5.16 -0.52 5.16 0.08V3.08C5.16 3.68 4.68 4.16 4.08 4.16H2.04C2.65 7.19 4.81 9.35 7.84 9.96V7.92C7.84 7.32 8.32 6.84 8.92 6.84H11.92C12.52 6.84 13 7.32 13 7.92V10.92C13 11.52 12.52 12 11.92 12H8.92C8.32 12 7.84 11.52 7.84 10.92V8.88C4.81 8.27 2.65 6.11 2.04 3.08H4.08C4.68 3.08 5.16 2.6 5.16 2V-1.08C5.16 -1.68 4.68 -2.16 4.08 -2.16H1.08C0.48 -2.16 0 -1.68 0 -1.08C0 10.4 10.4 21 21.92 21C22.52 21 23 20.52 23 19.92V16.92C23 16.32 22.52 15.84 21.92 15.84H18.92C18.32 15.84 17.84 16.32 17.84 16.92V19.92C17.84 20.52 18.32 21 18.92 21H21.92C22.52 21 23 20.52 23 19.92V16.92Z" fill="currentColor"/>
            </svg>
          </div>
          <div class="delivery-info-item__content">
            <div class="delivery-info-item__label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</div>
            <div class="delivery-info-item__value">
              <div class="delivery-contact-name">{{ obj.delivery_contact.full_name }}</div>
              {% if obj.delivery_contact.position %}
                <div class="delivery-contact-position">{{ obj.delivery_contact.position }}</div>
              {% endif %}
              {% if obj.delivery_contact.phone or obj.delivery_contact.mobile %}
                <div class="delivery-contact-phone">
                  {% if obj.delivery_contact.phone %}
                    <a href="tel:{{ obj.delivery_contact.phone }}" class="delivery-info-item__link">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle;margin-right:4px;">
                        <path d="M22 16.92V19.92C22 20.52 21.52 21 20.92 21C9.4 21 0 11.6 0 0.08C0 -0.52 0.48 -1 1.08 -1H4.08C4.68 -1 5.16 -0.52 5.16 0.08V3.08C5.16 3.68 4.68 4.16 4.08 4.16H2.04C2.65 7.19 4.81 9.35 7.84 9.96V7.92C7.84 7.32 8.32 6.84 8.92 6.84H11.92C12.52 6.84 13 7.32 13 7.92V10.92C13 11.52 12.52 12 11.92 12H8.92C8.32 12 7.84 11.52 7.84 10.92V8.88C4.81 8.27 2.65 6.11 2.04 3.08H4.08C4.68 3.08 5.16 2.6 5.16 2V-1.08C5.16 -1.68 4.68 -2.16 4.08 -2.16H1.08C0.48 -2.16 0 -1.68 0 -1.08C0 10.4 10.4 21 21.92 21C22.52 21 23 20.52 23 19.92V16.92C23 16.32 22.52 15.84 21.92 15.84H18.92C18.32 15.84 17.84 16.32 17.84 16.92V19.92C17.84 20.52 18.32 21 18.92 21H21.92C22.52 21 23 20.52 23 19.92V16.92Z" fill="currentColor"/>
                      </svg>
                      {{ obj.delivery_contact.phone }}
                    </a>
                  {% endif %}
                  {% if obj.delivery_contact.mobile %}
                    <a href="tel:{{ obj.delivery_contact.mobile }}" class="delivery-info-item__link" style="margin-left:12px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle;margin-right:4px;">
                        <path d="M17 2H7C5.89543 2 5 2.89543 5 4V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V4C19 2.89543 18.1046 2 17 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 18H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      {{ obj.delivery_contact.mobile }}
                    </a>
                  {% endif %}
                </div>
              {% endif %}
              {% if obj.delivery_contact.email %}
                <div class="delivery-contact-email">
                  <a href="mailto:{{ obj.delivery_contact.email }}" class="delivery-info-item__link">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle;margin-right:4px;">
                      <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M22 6L12 13L2 6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    {{ obj.delivery_contact.email }}
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
      
      {% if obj.delivery_address %}
        <div class="delivery-info-item delivery-info-item--address">
          <div class="delivery-info-item__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2"/>
              <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="delivery-info-item__content">
            <div class="delivery-info-item__label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="delivery-info-item__value">{{ obj.delivery_address.address }}</div>
            <a href="https://yandex.ru/maps/?text={{ obj.delivery_address.address|urlencode }}" 
               target="_blank" 
               class="delivery-info-item__map-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
            </a>
          </div>
        </div>
      {% endif %}
    </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (—Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π) ===== -->
  {% if request.user|in_groups:"operator,director,warehouse" %}
  <section class="modern-actions-card modern-actions-card--top">
    <div class="modern-actions-header">
      <div class="modern-actions-header__icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2 class="modern-actions-header__title">–î–µ–π—Å—Ç–≤–∏—è</h2>
    </div>

    <form method="post" action="{% url 'core:request_change_status' obj.pk %}" class="modern-actions-form" id="statusChangeForm">
      {% csrf_token %}

      {# –û–ü–ï–†–ê–¢–û–† –ò –î–ò–†–ï–ö–¢–û–† - –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é —Å–æ –≤—Å–µ–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ #}
      {% if request.user|in_groups:"operator,director" %}
        <div class="status-select-wrapper">
          <label for="statusSelect" class="status-select-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
          <select id="statusSelect" name="to" class="status-select" data-current-status="{{ obj.status }}">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
            {% if obj.status != "draft" %}
              <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
          {% endif %}
            {% if obj.status != "submitted" %}
              <option value="submitted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</option>
        {% endif %}
            {% if obj.status != "quote" %}
              <option value="quote">–ö–ü</option>
      {% endif %}
            {% if obj.status != "pending_approval" %}
              <option value="pending_approval">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
        {% endif %}
            {% if obj.status != "approved" %}
              <option value="approved">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</option>
      {% endif %}
            {% if obj.status != "rejected" %}
              <option value="rejected">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</option>
        {% endif %}
            {% if obj.status != "to_pick" %}
              <option value="to_pick">–ù–∞ —Å–±–æ—Ä–∫—É</option>
      {% endif %}
            {% if obj.status != "in_progress" %}
              <option value="in_progress">–í —Ä–∞–±–æ—Ç—É</option>
            {% endif %}
            {% if obj.status != "ready_to_ship" %}
              <option value="ready_to_ship">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</option>
          {% endif %}
            {% if obj.status != "in_delivery" %}
              <option value="in_delivery">–í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
            {% endif %}
            {% if obj.status != "partially_shipped" %}
              <option value="partially_shipped">–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞</option>
            {% endif %}
            {% if obj.status != "shipped" %}
              <option value="shipped">–û—Ç–≥—Ä—É–∂–µ–Ω–∞</option>
            {% endif %}
            {% if obj.status != "delivered" %}
              <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞</option>
            {% endif %}
            {% if obj.status != "done" %}
              <option value="done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
            {% endif %}
            {% if obj.status != "canceled" %}
              <option value="canceled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
            {% endif %}
          </select>
          <button type="submit" class="status-submit-btn" id="statusSubmitBtn" disabled>
            <span class="status-submit-btn__icon">‚úì</span>
            <span class="status-submit-btn__text">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
          </button>
        </div>
        
        {# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ #}
        {% if request.user|in_groups:"operator" %}
          {% if obj.status == "submitted" or obj.status == "rejected" %}
            <div class="modern-actions-divider"></div>
            <a href="{% url 'core:request_quote_create' obj.pk %}" class="action-link-btn">
              <span class="action-link-btn__icon">‚ûï</span>
              <span class="action-link-btn__text">{% if obj.status == "rejected" %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü{% else %}–°–æ–∑–¥–∞—Ç—å –ö–ü{% endif %}</span>
            </a>
        {% endif %}
          {% if obj.status == "ready_to_ship" or obj.status == "partially_shipped" %}
            <div class="modern-actions-divider"></div>
            <a href="{% url 'core:request_shipment_create' obj.pk %}" class="action-link-btn">
              <span class="action-link-btn__icon">‚ûï</span>
              <span class="action-link-btn__text">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</span>
            </a>
        {% endif %}
        {% endif %}
      {% endif %}

      {# –°–ö–õ–ê–î - —Ç–æ–ª—å–∫–æ "–í —Ä–∞–±–æ—Ç—É" –∏ "–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ" #}
      {% if request.user|in_groups:"warehouse" %}
        <div class="status-select-wrapper">
          <label for="statusSelectWarehouse" class="status-select-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</label>
          <select id="statusSelectWarehouse" name="to" class="status-select" data-current-status="{{ obj.status }}">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
            {% if obj.status == "to_pick" %}
              <option value="in_progress">–í —Ä–∞–±–æ—Ç—É</option>
            {% elif obj.status == "in_progress" %}
              <option value="ready_to_ship">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</option>
            {% elif obj.status == "ready_to_ship" %}
              <option value="in_delivery">–í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
            {% endif %}
          </select>
          <button type="submit" class="status-submit-btn" id="statusSubmitBtnWarehouse" disabled>
            <span class="status-submit-btn__icon">‚úì</span>
            <span class="status-submit-btn__text">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
          </button>
        </div>
      {% endif %}
    </form>
  </section>
  {% endif %}


  <!-- ===== –û–ø–ª–∞—Ç–∞ (–≤—Ç–æ—Ä–æ–π –±–ª–æ–∫) ===== -->
  {% if request.user|in_groups:"director,operator" %}
    {% if obj.status != 'canceled' %}
    <section class="rq-card rq-card--payment">
      <div class="rq-card__head">
        <h2>–û–ø–ª–∞—Ç–∞</h2>
        {% if obj.is_paid %}
          <span class="rq-chip" style="background:#dcfce7;border-color:#86efac;color:#166534">–û–ø–ª–∞—á–µ–Ω–æ</span>
        {% endif %}
      </div>
      <form method="post" action="{% url 'core:request_toggle_payment' obj.pk %}">
        {% csrf_token %}
        <label class="rq-pay" style="display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer">
          <input type="checkbox" name="is_paid" value="1" {% if obj.is_paid %}checked{% endif %} onchange="this.form.submit()" style="width:20px;height:20px;cursor:pointer">
          <span style="font-weight:600;font-size:15px">–ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞</span>
        </label>
        {% if obj.status == 'delivered' and not obj.is_paid %}
          <div style="padding:8px 14px;margin:0 14px 12px;background:#fef3c7;border:1px solid #fde68a;border-radius:8px;font-size:12px;color:#78350f">
            üí° –û—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—Ç—É, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É
          </div>
        {% elif obj.status == 'done' and not obj.is_paid %}
          <div style="padding:8px 14px;margin:0 14px 12px;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;font-size:12px;color:#7f1d1d">
            ‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞. –°–Ω–∏–º–∏—Ç–µ –æ—Ç–º–µ—Ç–∫—É, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤ —Å—Ç–∞—Ç—É—Å ¬´–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞¬ª
          </div>
        {% endif %}
      </form>
    </section>
    {% endif %}
  {% endif %}

  <!-- ===== –î–æ–∫—É–º–µ–Ω—Ç—ã (–µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫, –Ω–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏) ===== -->
  {% if obj.status not in 'ready_to_ship partially_shipped shipped in_delivery' and obj.delivery_address %}
  <section class="rq-card">
    <div class="rq-card__head">
      <h2>–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
    </div>
    <div style="padding: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
      {% if active_quote %}
        <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
          üìÑ –£–ü–î (HTML)
        </a>
        <a href="{% url 'core:request_upd' obj.pk %}?format=excel" class="btn btn-ghost">
          üìä –£–ü–î (Excel)
        </a>
        <a href="{% url 'core:request_upd_xml' obj.pk %}" class="btn btn-ghost">
          üì• –£–ü–î (XML)
        </a>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
  <div class="collapsible-card">
    <button type="button" class="collapsible-card__header" data-collapse-target="comment">
      <div class="collapsible-card__header-left">
        <div class="collapsible-card__icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3 class="collapsible-card__title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
      </div>
      <div class="collapsible-card__arrow">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </button>
    <div class="collapsible-card__content" id="comment">
      <div class="collapsible-card__body">
        {% if obj.comment_internal %}
          {{ obj.comment_internal|linebreaksbr }}
        {% else %}
          <span class="muted">‚Äî</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ===== –ü—Ä–æ–≥—Ä–µ—Å—Å-—ç—Ç–∞–ø—ã ===== -->
  <div class="collapsible-card">
    <button type="button" class="collapsible-card__header" data-collapse-target="steps-timeline">
      <div class="collapsible-card__header-left">
        <div class="collapsible-card__icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3 class="collapsible-card__title">–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏</h3>
      </div>
      <div class="collapsible-card__arrow">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </button>
    <div class="collapsible-card__content" id="steps-timeline">
      <div class="steps-timeline-wrapper">
        <div class="steps-timeline">
          {% for step in display_steps %}
            <div class="step-card step-card--{{ step.type }}{% if step.status == 'rejected' or step.status == 'canceled' %} step-card--error{% endif %}">
              <div class="step-card__indicator">
                {% if step.is_completed %}
                  <div class="step-card__icon step-card__icon--completed">‚úì</div>
                {% elif step.type == 'current' %}
                  <div class="step-card__icon step-card__icon--current">
                    {% if step.status == 'rejected' %}‚úó{% elif step.status == 'canceled' %}‚úó{% else %}‚óè{% endif %}
                  </div>
                {% else %}
                  <div class="step-card__icon step-card__icon--pending">‚óã</div>
                {% endif %}
              </div>
              <div class="step-card__content">
                <div class="step-card__title">{{ step.label }}</div>
                {% if step.date %}
                  <div class="step-card__date">{{ step.date|date:"d.m.Y H:i" }}</div>
                {% endif %}
                {% if step.author %}
                  <div class="step-card__author">{{ step.author }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞) ===== -->
  <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>

          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            {% if can_edit_quote %}
              {% if active_quote %}
                <a href="{% url 'core:request_quote_edit' obj.pk active_quote.pk %}" class="btn btn-primary">
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% else %}
                <a href="{% url 'core:request_quote_create' obj.pk %}" class="btn btn-primary">
                  –°–æ–∑–¥–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% endif %}
            {% endif %}
            
          </div>
        </div>

        {% if active_quote and quote_items %}
          <div style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 16px; font-weight: 600;">–¢–æ–≤–∞—Ä—ã –≤ –ö–ü</h3>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);">
                –ò—Ç–æ–≥–æ: {{ quote_total|floatformat:2 }} ‚ÇΩ
              </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for item in quote_items %}
                  <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                    <td style="padding: 10px 8px;">{{ item.title }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2 }} ‚ÇΩ</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600;">{{ item.total|floatformat:2 }} ‚ÇΩ</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% if obj.quotes.all %}
          <ul class="rq-history" style="padding:12px 14px;">
            {% for q in obj.quotes.all %}
              <li class="rq-file">
                <div class="rq-file__meta">
                  <span class="rq-mono">{{ q.created_at|date:"d.m.Y H:i" }}</span>
                  ‚Äî {{ q.original_name|default:"–ö–ü —Å —Ü–µ–Ω–∞–º–∏" }}
                  <span class="muted">, –∑–∞–≥—Ä—É–∑–∏–ª: {{ q.uploaded_by }}</span>
                </div>
                <div class="rq-file__actions">
                  {% if q.file %}
                  <button class="btn btn-ghost open-preview"
                          data-url="{% url 'core:request_quote_preview' obj.pk q.pk %}"
                            data-name="{{ q.original_name|default:'–ö–ü' }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                  <a class="btn" href="{{ q.file.url }}" download>–°–∫–∞—á–∞—Ç—å</a>
                  {% endif %}
                  {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
                  <form method="post" action="{% url 'core:request_quote_delete' obj.pk q.pk %}"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ö–ü {% if q.original_name %}¬´{{ q.original_name }}¬ª{% else %}—Å —Ü–µ–Ω–∞–º–∏{% endif %}?');">
                    {% csrf_token %}
                    <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">–§–∞–π–ª—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</div>
        {% endif %}
      </section>

    <!-- ===== –û—Ç–≥—Ä—É–∑–∫–∏ ===== -->
    {% if obj.status in 'ready_to_ship in_delivery partially_shipped shipped' %}
    <section class="rq-card">
      <div class="rq-card__head">
        <h2>–û—Ç–≥—Ä—É–∑–∫–∏</h2>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          {% if can_create_shipment %}
            <a href="{% url 'core:request_shipment_create' obj.pk %}" class="btn btn-primary">
              –°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É
            </a>
          {% endif %}
          {% if obj.status == 'ready_to_ship' %}
            {% if obj.delivery_address or obj.delivery_contact %}
              <a href="{% url 'core:request_route_sheet' obj.pk %}" target="_blank" class="btn btn-ghost">
                üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
              </a>
            {% endif %}
          {% endif %}
          {% if obj.delivery_address or obj.delivery_contact %}
            <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
              üìÑ –£–ü–î (HTML)
            </a>
            <a href="{% url 'core:request_upd' obj.pk %}?format=excel" class="btn btn-ghost">
              üìä –£–ü–î (Excel)
            </a>
            <a href="{% url 'core:request_upd_xml' obj.pk %}" class="btn btn-ghost">
              üì• –£–ü–î (XML)
            </a>
          {% endif %}
        </div>
      </div>

      {% if shipments %}
        {% for shipment in shipments %}
          <div style="padding: 16px; border-bottom: 1px solid var(--border); {% if not forloop.last %}margin-bottom: 16px;{% endif %}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                  –û—Ç–≥—Ä—É–∑–∫–∞ #{{ shipment.shipment_number|default:shipment.pk }}
                </h3>
                <div style="margin-top: 4px; font-size: 13px; color: var(--muted);">
                  {{ shipment.shipped_at|date:"d.m.Y H:i" }} ¬∑ {{ shipment.shipped_by }}
                  {% if shipment.is_partial %}
                    <span style="color: #f59e0b;">(–ß–∞—Å—Ç–∏—á–Ω–∞—è)</span>
                  {% endif %}
                </div>
              </div>
              <div style="font-size: 16px; font-weight: 700; color: var(--primary);">
                –ò—Ç–æ–≥–æ: {{ shipment.get_total|floatformat:2 }} ‚ÇΩ
              </div>
            </div>
            
            {% if shipment.comment %}
              <div style="padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 12px; font-size: 13px; color: var(--muted);">
                {{ shipment.comment }}
              </div>
            {% endif %}
            
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for item in shipment.items.all %}
                  <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                    <td style="padding: 10px 8px;">{{ item.title }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2|default:"‚Äî" }} {% if item.price %}‚ÇΩ{% endif %}</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600;">
                      {% if item.price %}
                        {% widthratio item.quantity 1 item.price as item_total %}
                        {{ item_total|floatformat:2 }} ‚ÇΩ
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <a href="{% url 'core:request_upd_shipment' obj.pk shipment.pk %}" target="_blank" class="btn btn-ghost" style="font-size: 13px;">
                üìÑ –£–ü–î (HTML)
              </a>
              <a href="{% url 'core:request_upd_shipment' obj.pk shipment.pk %}?format=excel" class="btn btn-ghost" style="font-size: 13px;">
                üìä –£–ü–î (Excel)
              </a>
              <a href="{% url 'core:request_upd_xml_shipment' obj.pk shipment.pk %}" class="btn btn-ghost" style="font-size: 13px;">
                üì• –£–ü–î (XML)
              </a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="rq-empty">–û—Ç–≥—Ä—É–∑–æ–∫ –Ω–µ—Ç</div>
      {% endif %}
    </section>
    {% endif %}

    <!-- ===== –ü–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∫–∏ ===== -->
    <section class="rq-card">
      <div class="rq-card__head">
        <h2>–ü–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∫–∏</h2>
        {% if can_add_items %}
          <form method="post" action="{% url 'core:request_add_item' obj.pk %}" class="rq-additem">
            {% csrf_token %}
            <div class="rq-additem__field">{{ item_form.title }}</div>
            <div class="rq-additem__qty">{{ item_form.quantity }}</div>
            <div class="rq-additem__note">{{ item_form.note }}</div>
            <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
          </form>
        {% endif %}
      </div>

      {% if items_with_relations %}
        <div class="rq-table">
          <div class="rq-trow rq-trow--head">
            <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
            <div class="ta-right">–ö–æ–ª-–≤–æ</div>
            <div>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>
            <div>–ò—Å—Ç–æ—á–Ω–∏–∫</div>
            <div class="ta-center {% if not can_edit_items %}rq-hidden{% endif %}">–î–µ–π—Å—Ç–≤–∏—è</div>
          </div>
          {% for item_data in items_with_relations %}
            {% with it=item_data.item quote_item=item_data.quote_item %}
              <div class="rq-trow rq-trow--item" data-item-id="{{ it.pk }}">
                <div class="rq-item-name">
                  {% if it.title %}{{ it.title }}{% else %}{{ it.product.name }}{% endif %}
                </div>
                <div class="ta-right rq-item-qty">{{ it.quantity }}</div>
                <div class="muted rq-item-note">{{ it.note|default:"‚Äî" }}</div>
                <div class="rq-item-source">
                  <div class="rq-source-badges">
                    <span class="rq-source-badge rq-source-badge--request" title="–ü–æ–∑–∏—Ü–∏—è –∏–∑ –∑–∞—è–≤–∫–∏">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      –ó–∞—è–≤–∫–∞
                    </span>
                    {% if quote_item %}
                      <span class="rq-source-badge rq-source-badge--quote" title="–ï—Å—Ç—å –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        –ö–ü
                      </span>
                      {% if item_data.has_shipments %}
                        <span class="rq-source-badge rq-source-badge--shipment" title="–ß–∞—Å—Ç–∏—á–Ω–æ –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–≥—Ä—É–∂–µ–Ω–æ">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V8L16 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 3V8H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                          –û—Ç–≥—Ä—É–∑–∫–∞
                        </span>
                      {% endif %}
                      {% if item_data.shipped_quantity > 0 %}
                        <span class="rq-source-info" title="–û—Ç–≥—Ä—É–∂–µ–Ω–æ: {{ item_data.shipped_quantity }} –∏–∑ {{ quote_item.quantity }}">
                          ({{ item_data.shipped_quantity }}/{{ quote_item.quantity }})
                        </span>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
                <div class="rq-item-actions ta-center {% if not can_edit_items %}rq-hidden{% endif %}">
                  <button type="button" class="rq-edit-btn" data-edit-item="{{ it.pk }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <form method="post" action="{% url 'core:request_delete_item' obj.pk it.pk %}" class="rq-delete-form" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?');">
                    {% csrf_token %}
                    <button type="submit" class="rq-delete-btn" title="–£–¥–∞–ª–∏—Ç—å">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </div>
              <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
              {% if can_edit_items %}
                <div class="rq-trow rq-trow--edit" data-edit-form="{{ it.pk }}" style="display: none;">
                  <form method="post" action="{% url 'core:request_update_item' obj.pk it.pk %}" class="rq-edit-form">
                    {% csrf_token %}
                    <div class="rq-edit-form__field">
                      <input type="text" name="title" value="{{ it.title }}" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required class="rq-edit-input">
                    </div>
                    <div class="rq-edit-form__qty">
                      <input type="number" name="quantity" value="{{ it.quantity }}" step="0.001" min="0" placeholder="–ö–æ–ª-–≤–æ" required class="rq-edit-input">
                    </div>
                    <div class="rq-edit-form__note">
                      <input type="text" name="note" value="{{ it.note }}" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="rq-edit-input">
                    </div>
                    <div></div>
                    <div class="rq-edit-form__actions ta-center {% if not can_edit_items %}rq-hidden{% endif %}">
                      <button type="submit" class="rq-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button type="button" class="rq-cancel-btn" data-cancel-edit="{{ it.pk }}">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                  </form>
                </div>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </div>
      {% else %}
        <div class="rq-empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      {% endif %}
    </section>

      <!-- –°–µ–∫—Ü–∏—è ¬´–°–±–æ—Ä–∫–∞ —Å–æ —Å–∫–ª–∞–¥–∞¬ª (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ approved) -->
      {% if show_pick_section %}
        {% include "core/_pick_section.html" with req=obj formset=pick_formset csrf_token=csrf_token %}
      {% endif %}

      {# –°–ø–∏—Å–æ–∫ –∫ —Å–±–æ—Ä–∫–µ –¥–ª—è —Å–∫–ª–∞–¥–∞ #}
      {% if latest_pick and pick_items %}
        <div class="mt-6 border border-gray-200 rounded-xl">
          <div class="px-4 py-3 border-b bg-white flex items-center justify-between">
            <div class="font-semibold">–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})
<!--            {# detail.html ‚Äî –≤ –±–ª–æ–∫–µ "–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ...)" —Å–ø—Ä–∞–≤–∞ –¥–æ–±–∞–≤–∏–º #}-->
            <a href="{% url 'core:pick_print' obj.pk %}" class="btn btn-ghost" target="_blank">–ü–µ—á–∞—Ç—å</a>
            </div>
            <div class="text-sm text-gray-500">–°–æ–∑–¥–∞–ª: {{ latest_pick.created_by }} ¬∑ {{ latest_pick.created_at|date:"d.m.Y H:i" }}</div>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-gray-500 border-b">
                <tr class="text-left">
                  <th class="py-2 pr-3">–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
                  <th class="py-2 pr-3">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th class="py-2 pr-3">–Ø—á–µ–π–∫–∞</th>
                  <th class="py-2 pr-3">–ï–¥.</th>
                  <th class="py-2 pr-3 text-right">–ö–æ–ª-–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for it in pick_items %}
                  <tr class="border-b last:border-0">
                    <td class="py-2 pr-3">{{ it.barcode }}</td>
                    <td class="py-2 pr-3">{{ it.name }}</td>
                    <td class="py-2 pr-3">{{ it.location|default:"‚Äî" }}</td>
                    <td class="py-2 pr-3">{{ it.unit }}</td>
                    <td class="py-2 pr-3 text-right">{{ it.qty }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}


<!-- –°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞ (—Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞) -->
{% if request.user|in_groups:"warehouse" and obj.status == "in_progress" %}
  <div class="mt-3">
    <button type="button" class="btn" id="openScanModal">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞</button>
  </div>

  <div id="scanModal" class="fixed inset-0 hidden items-start justify-center z-50" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" data-close></div>

    <div class="relative mt-10 w-[min(1400px,98vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white shadow-xl border">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div class="text-xl font-semibold">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})</div>
        <button type="button" class="text-2xl text-gray-500" data-close title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å -->
      <div class="px-6 pt-4 pb-3 border-b bg-white">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
          <div class="xl:col-span-2">
            <label for="scanInput" class="text-sm text-gray-600 block">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
            <input id="scanInput" class="input w-full text-lg" placeholder="–ù–∞–≤–µ–¥–∏ —Å–∫–∞–Ω–µ—Ä –∏ —Å—á–∏—Ç–∞–π –®–ö (Enter)">
            <div class="text-xs text-gray-500 mt-1">
              Enter ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å, F2 ‚Äî —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º, +/‚àí ‚Äî ¬´–°–æ–±—Ä–∞–Ω–æ¬ª, Space ‚Äî ¬´–ù–µ—Ç¬ª.
              –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–µ–¥–ª–æ–∂–∏–º <b>—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</b>.
            </div>
          </div>
          <div>
            <label for="scanMode" class="text-sm text-gray-600 block">–î–µ–π—Å—Ç–≤–∏–µ</label>
            <select id="scanMode" class="input w-full">
              <option value="add">–ü—Ä–∏–Ω–∏–º–∞–µ–º (—É–≤–µ–ª–∏—á–∏—Ç—å ¬´–°–æ–±—Ä–∞–Ω–æ¬ª)</option>
              <option value="miss">–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ (–ø–æ–º–µ—Ç–∏—Ç—å ¬´–ù–µ—Ç¬ª)</option>
            </select>
            <div class="text-xs text-gray-500 mt-1">F2 ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</div>
          </div>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫–∏ -->
        <div class="mt-3 flex flex-wrap gap-3 text-sm">
          <div class="px-2 py-1 border rounded">–ü–ª–∞–Ω: <span id="ctPlan" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–°–æ–±—Ä–∞–Ω–æ: <span id="ctPicked" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">¬´–ù–µ—Ç¬ª: <span id="ctMissing" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–û—Å—Ç–∞–ª–æ—Å—å: <span id="ctLeft" class="font-semibold">0</span></div>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <div class="overflow-auto" style="max-height: calc(90vh - 260px);">
        <table class="w-full text-sm" id="scanTable">
          <thead class="text-gray-600 border-b sticky top-0 bg-white z-10">
            <tr>
              <th class="py-2 px-4 text-left">–®–ö</th>
              <th class="py-2 px-4 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="py-2 px-4 text-left">–Ø—á–µ–π–∫–∞</th>
              <th class="py-2 px-4 text-left">–ü–ª–∞–Ω</th>
              <th class="py-2 px-4 text-left">–°–æ–±—Ä–∞–Ω–æ</th>
              <th class="py-2 px-4 text-left">–ù–µ—Ç</th>
              <th class="py-2 px-4 text-left">–ü—Ä–∏–º.</th>
              <th class="py-2 px-4 text-left">–°—Ç–∞—Ç—É—Å</th>
            </tr>
          </thead>
          <tbody>
            {% for it in pick_items %}
            <tr data-bc="{{ it.barcode }}" class="state-none">
              <td class="py-2 px-4 font-mono">{{ it.barcode }}</td>
              <td class="py-2 px-4">{{ it.name }}</td>
              <td class="py-2 px-4">{{ it.location|default:"‚Äî" }}</td>
              <td class="py-2 px-4" data-plan>{{ it.qty }}</td>
              <td class="py-2 px-4">
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-ghost h-8 w-8" data-dec>-</button>
                  <input class="input h-8 w-20 text-right" type="number" min="0"
                         value="{{ it.picked_qty|default:0 }}" data-picked>
                  <button type="button" class="btn btn-ghost h-8 w-8" data-inc>+</button>
                </div>
              </td>
              <td class="py-2 px-4">
                <input type="checkbox" data-miss {% if it.missing %}checked{% endif %}>
              </td>
              <td class="py-2 px-4">
                <input type="text" class="input h-8 w-44" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                       data-note value="{{ it.note|default_if_none:'' }}">
              </td>
              <td class="py-2 px-4 whitespace-nowrap" data-status>‚Äî</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- –ü–æ–¥–≤–∞–ª -->
      <div class="px-6 py-3 border-t bg-white">
        <div class="text-xs text-gray-500 mb-3 flex flex-wrap gap-4">
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-gray-200"></span> ‚Äî –Ω–µ –Ω–∞—á–∞—Ç–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-yellow-200"></span> ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-green-200"></span> ‚Äî –≥–æ—Ç–æ–≤–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-red-200"></span> ‚Äî –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</span>
        </div>
        <div class="flex gap-2">
          <button type="button" class="btn" id="saveDraft">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn btn-ghost" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    tr.state-none    { background: #f5f5f5; }
    tr.state-partial { background: #fef3c7; }
    tr.state-ok      { background: #dcfce7; }
    tr.state-miss    { background: #fee2e2; }
  </style>

  <script>
  (function(){
    const modal  = document.getElementById('scanModal');
    const open   = document.getElementById('openScanModal');
    const input  = document.getElementById('scanInput');
    const mode   = document.getElementById('scanMode');
    const tbody  = document.getElementById('scanTable').querySelector('tbody');
    const btnSave   = document.getElementById('saveDraft');

    const ctPlan    = document.getElementById('ctPlan');
    const ctPicked  = document.getElementById('ctPicked');
    const ctMissing = document.getElementById('ctMissing');
    const ctLeft    = document.getElementById('ctLeft');

    let dirty = false;
    let saving = false;
    let autoSaveTimer = null;
    const markDirty = () => { 
      dirty = true; 
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        if(dirty && !saving) {
          autoSave();
        }
      }, 2000);
    };

    const focusInput = () => setTimeout(()=>input && input.focus(), 20);

    function updateRowState(tr){
      const plan   = parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10);
      const picked = parseInt(tr.querySelector('[data-picked]').value||'0',10);
      const miss   = tr.querySelector('[data-miss]').checked;
      const st     = tr.querySelector('[data-status]');
      tr.classList.remove('state-none','state-partial','state-ok','state-miss');

      if(miss){ tr.classList.add('state-miss'); st.textContent = '–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'; return; }
      if(picked === 0){ tr.classList.add('state-none'); st.textContent = '–ù–µ –Ω–∞—á–∞—Ç–æ'; }
      else if(picked < plan){ tr.classList.add('state-partial'); st.textContent = `–ß–∞—Å—Ç–∏—á–Ω–æ (${picked}/${plan})`; }
      else{ tr.classList.add('state-ok'); st.textContent = `–ì–æ—Ç–æ–≤–æ (${picked}/${plan})`; }
    }

    function recalc(){
      const rows    = [...tbody.querySelectorAll('tr[data-bc]')];
      const plan    = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-plan]').textContent || 0), 0);
      const picked  = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-picked]').value || 0), 0);
      const missing = rows.reduce((s,tr)=> s + (tr.querySelector('[data-miss]').checked ? 1 : 0), 0);
      if(ctPlan)   ctPlan.textContent   = plan;
      if(ctPicked) ctPicked.textContent = picked;
      if(ctMissing)ctMissing.textContent= missing;
      if(ctLeft)   ctLeft.textContent   = Math.max(0, plan - picked);
    }

    function initStates(){
      [...tbody.querySelectorAll('tr[data-bc]')].forEach(updateRowState);
      recalc();
    }

    const openM  = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); focusInput(); initStates(); dirty=false; };
    const closeM = () => { modal.classList.add('hidden');  modal.classList.remove('flex'); };

    open.addEventListener('click', openM);
    modal.addEventListener('click', e=>{
      if(e.target.closest('[data-close]')){
        if(dirty){
          if(confirm('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å?')){ save('save', true); return; }
        }
        closeM();
      }
    });

    document.addEventListener('keydown', e=>{
      if(modal.classList.contains('hidden')) return;
      if(e.key==='Escape'){ if(dirty && confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) save('save', true); else closeM(); }
      if(e.key==='F2'){ e.preventDefault(); mode.value = (mode.value==='add' ? 'miss' : 'add'); }
    });

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    input.addEventListener('keydown', e=>{
      if(e.key !== 'Enter') return;
      const bc = input.value.trim(); input.value = '';
      if(!bc) return;

      const tr = tbody.querySelector(`tr[data-bc="${CSS.escape(bc)}"]`);
      if(!tr){ alert('–®–ö –Ω–µ –≤ –ª–∏—Å—Ç–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤ –∑–∞—è–≤–∫—É'); return; }

      const picked = tr.querySelector('[data-picked]');
      const miss   = tr.querySelector('[data-miss]');

      if(mode.value==='miss'){ miss.checked = true; }
      else { picked.value = Math.max(0, parseInt(picked.value||'0',10)+1); }

      updateRowState(tr); recalc(); tr.scrollIntoView({block:'nearest'});
      markDirty();
    });

    // +/- –∏ —Ä—É—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    tbody.addEventListener('click', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.target.matches('[data-inc]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = (+inp.value || 0) + 1;
        updateRowState(tr); recalc(); markDirty();
      }
      if(e.target.matches('[data-dec]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = Math.max(0, (+inp.value || 0) - 1);
        updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('input', e=>{
      if(e.target.matches('[data-picked], [data-miss], [data-note]')){
        const tr = e.target.closest('tr[data-bc]'); updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('keydown', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.key==='+' || e.key==='='){ e.preventDefault(); tr.querySelector('[data-inc]').click(); }
      if(e.key==='-'){ e.preventDefault(); tr.querySelector('[data-dec]').click(); }
      if(e.key===' '){ e.preventDefault(); const m = tr.querySelector('[data-miss]'); m.checked = !m.checked; updateRowState(tr); recalc(); markDirty(); }
    });

    function collectLines(){
      return [...tbody.querySelectorAll('tr[data-bc]')].map(tr=>({
        barcode: tr.dataset.bc,
        picked_qty: parseInt(tr.querySelector('[data-picked]').value||'0',10),
        missing: tr.querySelector('[data-miss]').checked,
        note: tr.querySelector('[data-note]')?.value || '',
        planned_qty: parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10),
      }));
    }

    async function save(commit='save', reloadAfter=true, showNotification=true){
      if(saving) return false;
      saving = true;
      
      if(showNotification && btnSave) {
        const originalText = btnSave.textContent;
        btnSave.disabled = true;
        btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      }

      const lines = collectLines();
      try {
        const resp = await fetch("{{ pick_confirm_url }}", {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':'{{ csrf_token }}'
          },
          body: JSON.stringify({ commit, lines })
        });
        if(!resp.ok){
          const t = await resp.text().catch(()=> '');
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. ' + t);
          if(showNotification && btnSave) {
            btnSave.disabled = false;
            btnSave.textContent = originalText;
          }
          saving = false;
          return false;
        }
        dirty = false;
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(() => {
            if(btnSave) btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          }, 2000);
        }
        if(reloadAfter){ closeM(); location.reload(); }
        saving = false;
        return true;
      } catch(error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
        saving = false;
        return false;
      }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    async function autoSave(){
      await save('save', false, false);
    }

    btnSave.addEventListener('click', ()=> save('save', true, true));   // —Ç–æ–ª—å–∫–æ —á–µ—Ä–Ω–æ–≤–∏–∫
  })();
  </script>
{% endif %}





    <!-- ===== –ò—Å—Ç–æ—Ä–∏—è ===== -->
    <section class="rq-card">
      <div class="rq-card__head">
        <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
        {% with history_all=obj.history.all %}
          {% if history_all|length > 3 %}
            <button type="button" id="toggleHistory" class="rq-history-toggle" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          {% endif %}
        {% endwith %}
      </div>
      {% if obj.history.all %}
        <ul class="rq-history" id="historyList">
          {% for h in obj.history.all %}
            <li class="history-item">
              <span class="rq-mono">{{ h.created_at|date:"d.m.Y H:i" }}</span>
              ‚Äî <b>{{ h.author }}</b>:
              <span class="rq-mono">{{ h.from_status|default:"‚Äî" }}</span>
              ‚Üí <span class="rq-mono">{{ h.to_status }}</span>
              <span class="muted">{{ h.note }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="rq-empty">–ü—É—Å—Ç–æ</div>
      {% endif %}
    </section>
</div>

{# ===== –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ö–ü ===== #}
<div id="previewModal" class="fixed inset-0 bg-black/60 hidden z-50 items-center justify-center" style="display:none">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:92vw;max-width:800px;max-height:90vh;display:flex;flex-direction:column;position:relative">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <div id="previewTitle" style="font-size:16px;font-weight:700;color:var(--text)"></div>
      <button id="closePreview" type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:14px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <iframe id="previewFrame" src="" style="width:100%;flex:1;min-height:400px;border:none;border-radius:0 0 18px 18px"></iframe>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('previewModal');
  const closeBtn = document.getElementById('closePreview');
  const titleEl = document.getElementById('previewTitle');
  const frameEl = document.getElementById('previewFrame');
  
  document.querySelectorAll('.open-preview').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const name = this.dataset.name || '–§–∞–π–ª';
      if (titleEl) titleEl.textContent = name;
      if (frameEl) frameEl.src = url;
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    });
  });
  
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    if (frameEl) frameEl.src = '';
  }
  
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.style.display !== 'none') {
      closeModal();
    }
  });
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ #}
<script>
(function(){
  const toggleBtn = document.getElementById('toggleHistory');
  const historyList = document.getElementById('historyList');
  
  if (!toggleBtn || !historyList) return;
  
  const allItems = Array.from(historyList.querySelectorAll('.history-item'));
  const totalItems = allItems.length;
  const showItems = 3;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3
  if (totalItems > showItems) {
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        item.style.display = 'none';
      }
    });
  }
  
  let isExpanded = false;
  
  toggleBtn.addEventListener('click', function() {
    isExpanded = !isExpanded;
    
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        if (isExpanded) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      }
    });
    
    if (isExpanded) {
      toggleBtn.classList.add('expanded');
      toggleBtn.setAttribute('aria-label', '–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
    } else {
      toggleBtn.classList.remove('expanded');
      toggleBtn.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é');
    }
  });
})();
</script>


{# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏–π —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º –º–µ–Ω—é #}
<script>
(function(){
  const statusForm = document.getElementById('statusChangeForm');
  if (!statusForm) return;
  
  const statusLabels = {
    'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
    'submitted': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',
    'quote': '–ö–ü',
    'pending_approval': '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏',
    'approved': '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞',
    'rejected': '–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞',
    'to_pick': '–ù–∞ —Å–±–æ—Ä–∫—É',
    'in_progress': '–í —Ä–∞–±–æ—Ç—É',
    'ready_to_ship': '–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ',
    'in_delivery': '–í –¥–æ—Å—Ç–∞–≤–∫–µ',
    'partially_shipped': '–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞',
    'shipped': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
    'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞',
    'done': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
    'canceled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
  };
  
  const dangerStatuses = ['canceled', 'rejected'];
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤
  const statusSelect = document.getElementById('statusSelect');
  const statusSubmitBtn = document.getElementById('statusSubmitBtn');
  
  if (statusSelect && statusSubmitBtn) {
    statusSelect.addEventListener('change', function() {
      statusSubmitBtn.disabled = !this.value;
    });
    
    statusSubmitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      const newStatus = statusSelect.value;
      if (!newStatus) return;
      
      const currentStatus = statusSelect.dataset.currentStatus;
      const statusLabel = statusLabels[newStatus] || newStatus;
      const currentLabel = statusLabels[currentStatus] || currentStatus;
      
      // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      const confirmMessage = `–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ —Å "${currentLabel}" –Ω–∞ "${statusLabel}"?`;
      
      if (!confirm(confirmMessage)) {
        statusSelect.value = '';
        statusSubmitBtn.disabled = true;
        return false;
      }
      
      // –î–ª—è –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (dangerStatuses.includes(newStatus)) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ "${statusLabel}" –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã–º.`)) {
          statusSelect.value = '';
          statusSubmitBtn.disabled = true;
          return false;
        }
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      statusSubmitBtn.disabled = true;
      statusSubmitBtn.style.opacity = '0.6';
      statusSubmitBtn.style.cursor = 'wait';
      statusSubmitBtn.querySelector('.status-submit-btn__text').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      
      // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'to';
      hiddenInput.value = newStatus;
      statusForm.appendChild(hiddenInput);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      statusForm.submit();
    });
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞
  const statusSelectWarehouse = document.getElementById('statusSelectWarehouse');
  const statusSubmitBtnWarehouse = document.getElementById('statusSubmitBtnWarehouse');
  
  if (statusSelectWarehouse && statusSubmitBtnWarehouse) {
    statusSelectWarehouse.addEventListener('change', function() {
      statusSubmitBtnWarehouse.disabled = !this.value;
    });
    
    statusSubmitBtnWarehouse.addEventListener('click', function(e) {
      e.preventDefault();
      
      const newStatus = statusSelectWarehouse.value;
      if (!newStatus) return;
      
      const currentStatus = statusSelectWarehouse.dataset.currentStatus;
      const statusLabel = statusLabels[newStatus] || newStatus;
      const currentLabel = statusLabels[currentStatus] || currentStatus;
      
      if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ —Å "${currentLabel}" –Ω–∞ "${statusLabel}"?`)) {
        statusSelectWarehouse.value = '';
        statusSubmitBtnWarehouse.disabled = true;
        return false;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      statusSubmitBtnWarehouse.disabled = true;
      statusSubmitBtnWarehouse.style.opacity = '0.6';
      statusSubmitBtnWarehouse.style.cursor = 'wait';
      statusSubmitBtnWarehouse.querySelector('.status-submit-btn__text').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      
      // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'to';
      hiddenInput.value = newStatus;
      statusForm.appendChild(hiddenInput);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      statusForm.submit();
    });
  }
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤ #}
<script>
(function(){
  const collapseButtons = document.querySelectorAll('[data-collapse-target]');
  
  collapseButtons.forEach(button => {
    const targetId = button.getAttribute('data-collapse-target');
    const content = document.getElementById(targetId);
    
    if (!content) return;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –±–ª–æ–∫–∏ —Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    button.setAttribute('aria-expanded', 'false');
    content.setAttribute('aria-hidden', 'true');
    
    button.addEventListener('click', function() {
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
        button.setAttribute('aria-expanded', 'false');
        content.setAttribute('aria-hidden', 'true');
      } else {
        // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
        button.setAttribute('aria-expanded', 'true');
        content.setAttribute('aria-hidden', 'false');
      }
    });
  });
})();
</script>

<style>
:root{ --bg:#f6f7f8; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --accent:#111; --radius:14px; }
.rq-container{max-width:1200px;margin:0 auto;padding:20px 16px 28px;}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∞–ø–∫–∞ –∑–∞—è–≤–∫–∏ */
.request-header{
  background:#fff;
  border:1px solid var(--line);
  border-radius:16px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
}
.request-header__top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:20px;
  margin-bottom:16px;
  padding-bottom:16px;
  border-bottom:1px solid var(--line);
}
.request-header__title-group{
  flex:1;
}
.request-header__title{
  font-size:28px;
  font-weight:800;
  color:var(--text);
  margin:0 0 6px 0;
  letter-spacing:-0.02em;
  line-height:1.2;
}
.request-header__number{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;
  color:#0A84FF;
}
.request-header__subtitle{
  font-size:16px;
  color:var(--muted);
  margin:0;
  font-weight:500;
}
.request-header__status-group{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.status-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:8px 14px;
  border-radius:10px;
  font-size:13px;
  font-weight:700;
  border:1.5px solid;
  white-space:nowrap;
}
.status-badge--draft{background:#f3f4f6;border-color:#d1d5db;color:#374151}
.status-badge--submitted{background:#eef2ff;border-color:#c7d2fe;color:#1f2937}
.status-badge--quote{background:#fef3c7;border-color:#fde68a;color:#78350f}
.status-badge--approved{background:#e0f2fe;border-color:#bae6fd;color:#075985}
.status-badge--to_pick{background:#f5f3ff;border-color:#ddd6fe;color:#3730a3}
.status-badge--in_progress{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
.status-badge--ready_to_ship{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
.status-badge--in_delivery{background:#e0e7ff;border-color:#c7d2fe;color:#3730a3}
.status-badge--delivered{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
.status-badge--done{background:#0A84FF;border-color:#0A84FF;color:#fff}
.status-badge--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.status-badge--danger{background:#ef4444;border-color:#ef4444;color:#fff}

/* –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã */
.request-header__payment-section{
  margin-top:16px;
  padding-top:16px;
  border-top:1px solid var(--line);
}
.payment-status{
  display:flex;
  align-items:center;
  gap:14px;
  padding:16px 20px;
  border-radius:12px;
  border:2px solid;
  transition:all 0.2s ease;
}
.payment-status--paid{
  background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
  border-color:#86efac;
  box-shadow:0 2px 8px rgba(16,185,129,0.15);
}
.payment-status--unpaid{
  background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  border-color:#fca5a5;
  box-shadow:0 2px 8px rgba(239,68,68,0.15);
  animation:pulse-unpaid 2s ease-in-out infinite;
}
@keyframes pulse-unpaid{
  0%,100%{box-shadow:0 2px 8px rgba(239,68,68,0.15)}
  50%{box-shadow:0 4px 16px rgba(239,68,68,0.25)}
}
.payment-status__icon{
  flex-shrink:0;
  width:48px;
  height:48px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  background:rgba(255,255,255,0.6);
  backdrop-filter:blur(10px);
}
.payment-status--paid .payment-status__icon{
  color:#166534;
}
.payment-status--unpaid .payment-status__icon{
  color:#991b1b;
}
.payment-status__content{
  flex:1;
}
.payment-status__label{
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:4px;
  opacity:0.8;
}
.payment-status--paid .payment-status__label{
  color:#166534;
}
.payment-status--unpaid .payment-status__label{
  color:#991b1b;
}
.payment-status__value{
  font-size:18px;
  font-weight:800;
  letter-spacing:-0.01em;
}
.payment-status--paid .payment-status__value{
  color:#166534;
}
.payment-status--unpaid .payment-status__value{
  color:#991b1b;
}

.delivery-contact-name{
  font-size:16px;
  font-weight:700;
  color:var(--text);
  margin-bottom:6px;
  line-height:1.3;
}
.delivery-contact-position{
  font-size:13px;
  color:var(--muted);
  margin-bottom:10px;
  font-style:italic;
}
.delivery-contact-phone{
  margin-bottom:6px;
}
.delivery-contact-email{
  margin-top:4px;
}

.request-header__meta{
  display:flex;
  flex-wrap:wrap;
  gap:16px 24px;
  align-items:center;
}
.request-header__meta-item{
  display:flex;
  align-items:center;
  gap:8px;
}
.request-header__meta-label{
  font-size:14px;
  color:var(--muted);
  font-weight:500;
}
.request-header__meta-value{
  font-size:14px;
  color:var(--text);
  font-weight:600;
}

/* –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.collapsible-card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:16px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
  overflow:hidden;
  transition:all 0.2s ease;
}
.collapsible-card:hover{
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}
.collapsible-card__header{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding:18px 20px;
  background:linear-gradient(135deg, #fafafa 0%, #f8f9fa 100%);
  border:none;
  cursor:pointer;
  transition:all 0.2s ease;
  text-align:left;
  position:relative;
}
.collapsible-card__header::after{
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  height:1px;
  background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.08) 50%, transparent 100%);
  transition:opacity 0.2s ease;
}
.collapsible-card__header[aria-expanded="true"]::after{
  opacity:1;
}
.collapsible-card__header[aria-expanded="false"]::after{
  opacity:0;
}
.collapsible-card__header:hover{
  background:linear-gradient(135deg, #f5f5f5 0%, #f0f0f0 100%);
}
.collapsible-card__header-left{
  display:flex;
  align-items:center;
  gap:12px;
  flex:1;
}
.collapsible-card__icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg, rgba(10,132,255,0.12) 0%, rgba(10,132,255,0.08) 100%);
  border-radius:12px;
  color:#0A84FF;
  border:1px solid rgba(10,132,255,0.2);
  flex-shrink:0;
  box-shadow:0 2px 4px rgba(10,132,255,0.1);
  transition:all 0.2s ease;
}
.collapsible-card__header:hover .collapsible-card__icon{
  background:linear-gradient(135deg, rgba(10,132,255,0.18) 0%, rgba(10,132,255,0.12) 100%);
  box-shadow:0 3px 6px rgba(10,132,255,0.15);
}
.collapsible-card__title{
  font-size:17px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.01em;
  line-height:1.3;
}
.collapsible-card__arrow{
  flex-shrink:0;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--muted);
  background:rgba(0,0,0,0.04);
  border-radius:8px;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapsible-card__header:hover .collapsible-card__arrow{
  background:rgba(0,0,0,0.06);
  color:var(--text);
}
.collapsible-card__header[aria-expanded="true"] .collapsible-card__arrow{
  transform:rotate(180deg);
  background:rgba(10,132,255,0.1);
  color:#0A84FF;
}
.collapsible-card__content{
  overflow:hidden;
  transition:max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s ease, opacity 0.3s ease;
  max-height:0;
  padding:0 20px;
  opacity:0;
}
.collapsible-card__content[aria-hidden="false"]{
  max-height:5000px;
  padding:20px;
  opacity:1;
}
.collapsible-card__body{
  padding:0;
}
.delivery-info-content{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
  gap:20px;
  padding:0;
}
.delivery-info-item{
  display:flex;
  gap:14px;
  padding:16px;
  background:#fafafa;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.06);
  transition:all 0.2s ease;
}
.delivery-info-item:hover{
  background:#f5f5f5;
  border-color:rgba(0,0,0,0.1);
}
.delivery-info-item--address{
  grid-column:1 / -1;
}
.delivery-info-item__icon{
  flex-shrink:0;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(10,132,255,0.08);
  border-radius:10px;
  color:#0A84FF;
}
.delivery-info-item__content{
  flex:1;
  min-width:0;
}
.delivery-info-item__label{
  font-size:12px;
  font-weight:600;
  color:var(--muted);
  margin-bottom:6px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.delivery-info-item__value{
  font-size:15px;
  font-weight:600;
  color:var(--text);
  line-height:1.4;
  margin-bottom:8px;
}
.delivery-info-item__link{
  display:inline-block;
  color:#0A84FF;
  text-decoration:none;
  font-size:14px;
  font-weight:500;
  margin-top:4px;
  transition:color 0.2s;
}
.delivery-info-item__link:hover{
  color:#0077ED;
  text-decoration:underline;
}
.delivery-info-item__map-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:8px 14px;
  background:#0A84FF;
  color:#fff;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  text-decoration:none;
  transition:all 0.2s ease;
  margin-top:8px;
}
.delivery-info-item__map-btn:hover{
  background:#0077ED;
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(10,132,255,0.3);
}
.delivery-info-item__map-btn:active{
  transform:translateY(0);
}

.rq-header{margin-bottom:6px;}
.rq-meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);margin-top:6px;align-items:center}

.rq-grid{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:16px;margin-top:10px;}
.rq-main{display:grid;gap:12px;}
.rq-aside{display:grid;gap:12px;}
.rq-sticky{position:sticky; top:12px}

.rq-card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
  overflow:hidden;
}
.rq-card--payment{
  margin-bottom: 16px;
  border: 2px solid #059669;
  box-shadow: 0 4px 12px rgba(5,150,105,0.15);
}
.rq-card--payment .rq-card__head{
  background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
  border-bottom-color: #86efac;
}
.rq-card__head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:18px 20px;
  border-bottom:1px solid var(--line);
  background:#fafafa;
}
.rq-card__head h2{
  font-size:17px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.01em;
}
.rq-card__body{
  padding:20px;
}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ä—É—Å–µ–ª—å —ç—Ç–∞–ø–æ–≤ 2025 */
/* –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω —ç—Ç–∞–ø–æ–≤ */

.steps-timeline-wrapper{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:thin;
  padding:4px 0;
}
.steps-timeline-wrapper::-webkit-scrollbar{
  height:6px;
}
.steps-timeline-wrapper::-webkit-scrollbar-track{
  background:rgba(0,0,0,0.04);
  border-radius:3px;
}
.steps-timeline-wrapper::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,0.2);
  border-radius:3px;
}
.steps-timeline-wrapper::-webkit-scrollbar-thumb:hover{
  background:rgba(0,0,0,0.3);
}
.steps-timeline{
  display:flex;
  gap:16px;
  min-width:max-content;
  padding:12px 0;
}

.step-card{
  flex:0 0 280px;
  display:flex;
  gap:14px;
  padding:18px;
  background:#fafafa;
  border-radius:14px;
  border:1.5px solid rgba(0,0,0,0.08);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 1px 3px rgba(0,0,0,0.05);
}
.step-card:hover{
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  transform:translateY(-1px);
}
.step-card--prev{
  opacity:0.65;
  background:#f8f9fa;
}
.step-card--current{
  background:#fff;
  border-color:rgba(10,132,255,0.3);
  box-shadow:0 4px 16px rgba(10,132,255,0.15), 0 2px 8px rgba(10,132,255,0.1);
  transform:scale(1.02);
  z-index:2;
  position:relative;
}
.step-card--next{
  opacity:0.6;
  background:#f8f9fa;
}
.step-card--error{
  border-color:rgba(239,68,68,0.3);
  background:#fef2f2;
}
.step-card--error.step-card--current{
  box-shadow:0 4px 16px rgba(239,68,68,0.15), 0 2px 8px rgba(239,68,68,0.1);
}

.step-card__indicator{
  flex-shrink:0;
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.step-card__icon{
  width:44px;
  height:44px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:600;
  transition:all 0.2s ease;
}
.step-card__icon--completed{
  background:#10b981;
  color:#fff;
  box-shadow:0 2px 8px rgba(16,185,129,0.25);
}
.step-card__icon--current{
  background:#0A84FF;
  color:#fff;
  box-shadow:0 4px 12px rgba(10,132,255,0.3);
  font-size:16px;
}
.step-card--error .step-card__icon--current{
  background:#ef4444;
  box-shadow:0 4px 12px rgba(239,68,68,0.3);
}
.step-card__icon--pending{
  background:rgba(107,114,128,0.1);
  color:rgba(107,114,128,0.5);
  border:2px solid rgba(107,114,128,0.2);
  font-size:24px;
}

.step-card__content{
  flex:1;
  min-width:0;
}
.step-card__title{
  font-size:15px;
  font-weight:700;
  color:var(--text);
  margin-bottom:8px;
  letter-spacing:-0.01em;
  line-height:1.3;
}
.step-card--current .step-card__title{
  font-weight:800;
  color:var(--text);
}
.step-card__date{
  font-size:13px;
  color:var(--muted);
  margin-bottom:4px;
  font-weight:500;
}
.step-card__author{
  font-size:12px;
  color:var(--muted);
  opacity:0.85;
}
.modern-steps-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:linear-gradient(90deg, #0A84FF 0%, #0077ED 50%, #0A84FF 100%);
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

.modern-steps-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
.modern-steps-header__icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-radius:12px;
  color:#fff;
  box-shadow:0 4px 12px rgba(10,132,255,0.25);
}
.modern-steps-header__title{
  font-size:18px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.02em;
}

.modern-steps-carousel{
  position:relative;
  display:flex;
  align-items:center;
  gap:16px;
}
.modern-steps-viewport{
  flex:1;
  overflow:hidden;
  position:relative;
}
.modern-steps-container{
  display:flex;
  transition:transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  will-change:transform;
}

.modern-step-item{
  flex:0 0 calc(33.333% - 16px);
  min-width:0;
  padding:20px;
  background:rgba(255,255,255,0.6);
  backdrop-filter:blur(10px);
  border:1.5px solid rgba(255,255,255,0.8);
  border-radius:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  transition:all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  position:relative;
  margin:0 8px;
  opacity:0.5;
  transform:scale(0.85);
}
.modern-step-item[data-position="prev"],
.modern-step-item[data-position="next"]{
  opacity:0.6;
  transform:scale(0.9);
}
.modern-step-item[data-position="current"]{
  opacity:1;
  transform:scale(1);
  background:rgba(255,255,255,0.95);
  border-color:rgba(10,132,255,0.3);
  box-shadow:0 12px 40px rgba(10,132,255,0.15), 0 4px 16px rgba(0,0,0,0.08);
  z-index:2;
}

.modern-step-item__circle{
  width:64px;
  height:64px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:20px;
  border:3px solid #e5e7eb;
  background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color:#9ca3af;
  transition:all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  position:relative;
  margin-bottom:16px;
}
.modern-step-item[data-status="completed"] .modern-step-item__circle{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-color:#0A84FF;
  color:#fff;
  box-shadow:0 6px 20px rgba(10,132,255,0.3);
}
.modern-step-item[data-status="active"] .modern-step-item__circle{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-color:#0A84FF;
  color:#fff;
  box-shadow:0 0 0 8px rgba(10,132,255,0.1), 0 8px 24px rgba(10,132,255,0.35);
  animation:stepPulse 2s ease-in-out infinite;
  transform:scale(1.1);
}
.modern-step-item--error .modern-step-item__circle{
  background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border-color:#ef4444;
  color:#fff;
  box-shadow:0 6px 20px rgba(239,68,68,0.3);
}
.modern-step-item__number{font-size:20px;font-weight:700}
.modern-step-item__icon{font-size:28px;line-height:1;font-weight:700}

.modern-step-item__content{
  width:100%;
}
.modern-step-item__title{
  font-size:15px;
  font-weight:700;
  color:var(--text);
  margin-bottom:8px;
  transition:color 0.3s;
  letter-spacing:-0.01em;
}
.modern-step-item[data-status="active"] .modern-step-item__title{
  color:var(--primary);
  font-size:16px;
}
.modern-step-item__meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
  font-weight:500;
}
.modern-step-item__author{
  font-size:11px;
  color:var(--muted);
  opacity:0.8;
}
.modern-step-item__badge{
  display:inline-block;
  font-size:10px;
  padding:4px 10px;
  border-radius:12px;
  margin-top:8px;
  font-weight:600;
}
.modern-step-item__badge--warning{
  background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color:#78350f;
}
.modern-step-item__badge--success{
  background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
  color:#166534;
}

.modern-steps-nav{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(10px);
  border:1.5px solid rgba(10,132,255,0.2);
  color:var(--primary);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  flex-shrink:0;
  position:relative;
  z-index:10;
}
.modern-steps-nav:hover{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  color:#fff;
  transform:scale(1.1);
  box-shadow:0 6px 20px rgba(10,132,255,0.35);
  border-color:transparent;
}
.modern-steps-nav:active{
  transform:scale(0.95);
}
.modern-steps-nav:disabled{
  opacity:0.3;
  cursor:not-allowed;
  transform:none;
}
.modern-steps-nav:disabled:hover{
  background:rgba(255,255,255,0.9);
  color:var(--primary);
  transform:none;
}

@keyframes stepPulse{
  0%,100%{
    box-shadow:0 0 0 8px rgba(10,132,255,0.1), 0 8px 24px rgba(10,132,255,0.35);
    transform:scale(1.1);
  }
  50%{
    box-shadow:0 0 0 12px rgba(10,132,255,0.08), 0 8px 28px rgba(10,132,255,0.4);
    transform:scale(1.12);
  }
}

@media (max-width: 768px){
  .step-card{flex:0 0 240px;padding:14px;gap:12px}
  .step-card__indicator{width:36px;height:36px}
  .step-card__icon{width:36px;height:36px;font-size:18px}
  .step-card__icon--current{font-size:14px}
  .step-card__icon--pending{font-size:20px}
  .step-card__title{font-size:14px}
  .step-card__date{font-size:12px}
  .step-card__author{font-size:11px}
}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π 2025 */
/* –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.modern-actions-card--top{
  margin-bottom: 20px;
  margin-top: 0;
  border: 2px solid #111;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.06);
  background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
}
.modern-actions-card--top .modern-actions-header__icon{
  background: rgba(17, 17, 17, 0.1);
  border-color: rgba(17, 17, 17, 0.15);
}

.modern-actions-card{
  background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.98) 100%);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(255,255,255,0.8);
  border-radius:24px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.9);
  position:relative;
  overflow:hidden;
}
.modern-actions-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:1px;
  background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.06) 50%, transparent 100%);
}

.modern-actions-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
.modern-actions-header__icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(107,114,128,0.1);
  border-radius:12px;
  color:var(--text);
  border:1px solid rgba(0,0,0,0.08);
}
.modern-actions-header__title{
  font-size:18px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.02em;
}

.modern-actions-form{
  display:flex;
  flex-direction:column;
  gap:16px;
}
.modern-actions-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
}
.modern-actions-divider{
  height:1px;
  background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.08) 50%, transparent 100%);
  margin:12px 0;
}

/* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤ */
.status-select-wrapper{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.status-select-label{
  font-size:13px;
  font-weight:600;
  color:var(--muted);
  margin-bottom:4px;
}
.status-select{
  width:100%;
  padding:12px 16px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--text);
  font-weight:500;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  background-size:12px;
  padding-right:40px;
}
.status-select:hover{
  border-color:rgba(0,0,0,0.2);
  background-color:#fafafa;
}
.status-select:focus{
  outline:none;
  border-color:rgba(10,132,255,0.4);
  box-shadow:0 0 0 4px rgba(10,132,255,0.1);
  background-color:#fff;
}
.status-select:disabled{
  opacity:0.5;
  cursor:not-allowed;
  background-color:#f5f5f5;
}

.status-submit-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 20px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--text);
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
}
.status-submit-btn:hover:not(:disabled){
  background:#f8f9fa;
  border-color:rgba(0,0,0,0.18);
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
.status-submit-btn:active:not(:disabled){
  transform:translateY(0);
}
.status-submit-btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
  background:#f5f5f5;
}
.status-submit-btn__icon{
  font-size:16px;
  line-height:1;
}
.status-submit-btn__text{
  letter-spacing:-0.01em;
}

.action-link-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 20px;
  border-radius:12px;
  border:1.5px solid rgba(0,0,0,0.12);
  background:#fff;
  color:var(--text);
  font-weight:600;
  font-size:14px;
  text-decoration:none;
  transition:all 0.2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
}
.action-link-btn:hover{
  background:#f8f9fa;
  border-color:rgba(0,0,0,0.18);
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
  color:var(--text);
}
.action-link-btn:active{
  transform:translateY(0);
}
.action-link-btn__icon{
  font-size:16px;
  line-height:1;
}
.action-link-btn__text{
  letter-spacing:-0.01em;
}


/* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
.rq-steps{display:flex;flex-wrap:wrap;gap:8px;margin:0;padding:0;list-style:none}
.rq-step{display:flex;align-items:center;gap:6px;padding:8px 12px;border:2px solid var(--line);border-radius:12px;background:#fff;font-weight:600;font-size:13px;color:var(--text);transition:all 0.2s;position:relative}
.rq-step__number{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--bg);color:var(--text);font-weight:700;font-size:12px;flex-shrink:0}
.rq-step.is-done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-step.is-done .rq-step__number{background:rgba(255,255,255,0.2);color:#fff}
.rq-step.is-current{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:scale(1.05)}
.rq-step.is-current .rq-step__number{background:rgba(255,255,255,0.3);color:#fff;font-weight:800}
.rq-step--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.rq-step--rejected .rq-step__number{background:#fecaca;color:#7f1d1d}

.btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:700;text-decoration:none}
.btn:hover{opacity:.92}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:#fff;color:#111;border-color:#111}
.btn-primary{background:#111;color:#fff;border-color:#111}
.btn-danger{background:#fff;color:#7f1d1d;border-color:#ef4444}
.btn-danger:hover{background:#fee2e2}

.rq-actions__col{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:8px;padding:10px 12px;}
.rq-aside .btn{width:100%;padding:7px 10px;border-radius:10px;font-weight:600;font-size:14px;line-height:1.1;}
.rq-aside .btn-ghost,.rq-aside .btn-danger,.rq-aside .btn-primary{padding:7px 10px;border-radius:10px;font-weight:600;}
.rq-aside .rq-card__head{padding:10px 12px;}

.rq-pay{display:flex;align-items:center;gap:8px;padding:12px 14px}
.rq-upload{display:flex;gap:8px;align-items:center}
.rq-upload__input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
.rq-upload__label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px dashed #111;border-radius:12px;background:#fff;color:#111;font-weight:700;cursor:pointer}

.rq-table{display:grid;border-top:1px solid var(--line)}
.rq-trow{display:grid;grid-template-columns:1.5fr 100px 1fr 1.2fr 100px;gap:12px;padding:12px 14px;border-bottom:1px solid var(--line);align-items:center}
.rq-trow--head{background:#fbfbfb;font-weight:700;font-size:13px;color:#666}
.rq-trow--item:hover{background:#fafafa}
.rq-trow--edit{background:#f8f9fa;border-left:3px solid #111}
.ta-right{text-align:right}
.ta-center{text-align:center}
.rq-hidden{display:none}

.rq-file{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted var(--line)}
.rq-file:last-child{border-bottom:0}
.rq-file__meta{min-width:0}
.rq-file__actions{display:flex;gap:6px}
.rq-file__actions form{display:inline}

.rq-additem{display:grid;grid-template-columns:1.5fr 100px 1fr auto;gap:8px;align-items:center}
.rq-additem__field input,.rq-additem__qty input,.rq-additem__note input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –∑–∞—è–≤–∫–∏ */
.rq-item-name{font-weight:500;color:#111}
.rq-item-qty{font-weight:500;color:#111}
.rq-item-note{font-size:13px;color:#777}

/* –ë–µ–π–¥–∂–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ */
.rq-item-source{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.rq-source-badges{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.rq-source-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;white-space:nowrap;transition:all 0.2s}
.rq-source-badge--request{background:#e0e7ff;color:#3730a3;border:1px solid #c7d2fe}
.rq-source-badge--quote{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
.rq-source-badge--shipment{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
.rq-source-badge svg{flex-shrink:0}
.rq-source-info{font-size:11px;color:#666;font-weight:500}

/* –î–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ */
.rq-item-actions{display:flex;align-items:center;justify-content:center;gap:6px}
.rq-edit-btn,.rq-delete-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;padding:0;border:none;border-radius:8px;background:transparent;color:#666;cursor:pointer;transition:all 0.2s}
.rq-edit-btn:hover{background:#e0e7ff;color:#3730a3}
.rq-delete-btn:hover{background:#fee2e2;color:#dc2626}
.rq-edit-btn svg,.rq-delete-btn svg{width:16px;height:16px}
.rq-delete-form{display:inline;margin:0}

/* –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
.rq-edit-form{display:contents}
.rq-edit-form__field,.rq-edit-form__qty,.rq-edit-form__note{display:flex;align-items:center}
.rq-edit-form__actions{display:flex;align-items:center;justify-content:center;gap:6px}
.rq-edit-input{width:100%;padding:8px 10px;border:1px solid #111;border-radius:8px;background:#fff;font-size:14px}
.rq-edit-input:focus{outline:none;border-color:#111;box-shadow:0 0 0 3px rgba(0,0,0,0.1)}
.rq-save-btn,.rq-cancel-btn{padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none}
.rq-save-btn{background:#111;color:#fff}
.rq-save-btn:hover{opacity:0.9}
.rq-cancel-btn{background:#f3f4f6;color:#666;border:1px solid #e5e7eb}
.rq-cancel-btn:hover{background:#e5e7eb}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--line);background:#fff;color:#111}
.rq-chip--paid{border-style:dashed}
.rq-chip--done{background:#111;border-color:#111;color:#fff}
.rq-chip--flag-danger{background:#fff;border:1px dashed #ef4444;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:10px;padding:26px;border:1px dashed var(--line);border-radius:12px;color:#757b82;background:#fff}

.rq-history{padding:12px 14px}
.rq-history li{padding:6px 0;border-bottom:1px dotted var(--line)}
.rq-history li:last-child{border-bottom:0}
.history-item-hidden{display:none}
.rq-history-toggle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;padding:0}
.rq-history-toggle:hover{background:var(--bg);border-color:var(--primary);color:var(--primary)}
.rq-history-toggle:active{transform:scale(0.95)}
.rq-history-toggle.expanded{transform:rotate(180deg)}
.rq-history-toggle svg{transition:transform 0.2s}

@media (max-width: 980px){
  .rq-grid{grid-template-columns:1fr}
  .rq-sticky{position:static}
  .rq-additem{grid-template-columns:1fr 120px 1fr auto}
  .rq-actions__col{grid-template-columns:1fr;}
  .rq-header{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-file{flex-direction:column;align-items:flex-start;gap:8px}
  .rq-file__actions{width:100%;flex-wrap:wrap}
}
@media (max-width: 640px){
  .rq-container{padding:12px 12px 20px}
  .request-header{padding:16px}
  .request-header__top{flex-direction:column;align-items:flex-start;gap:12px}
  .request-header__title{font-size:22px}
  .request-header__subtitle{font-size:14px}
  .request-header__status-group{width:100%}
  .request-header__meta{flex-direction:column;align-items:flex-start;gap:8px}
  .request-header__payment-section{margin-top:12px;padding-top:12px}
  .payment-status{padding:14px 16px;gap:12px}
  .payment-status__icon{width:40px;height:40px}
  .payment-status__value{font-size:16px}
  .collapsible-card__header{padding:14px 16px}
  .collapsible-card__icon{width:32px;height:32px}
  .collapsible-card__title{font-size:16px}
  .collapsible-card__arrow{width:28px;height:28px}
  .collapsible-card__content{padding:16px}
  .collapsible-card__content[aria-hidden="true"]{padding:0 16px}
  .delivery-info-content{grid-template-columns:1fr}
  .delivery-info-item--address{grid-column:1}
  .delivery-contact-name{font-size:15px}
  .delivery-contact-phone{display:flex;flex-direction:column;gap:4px}
  .delivery-contact-phone .delivery-info-item__link{margin-left:0!important}
  .rq-title{font-size:20px}
  .rq-meta{flex-direction:column;align-items:flex-start;gap:6px}
  .modern-step{flex-direction:row;gap:12px}
  .modern-step__circle{width:40px;height:40px;font-size:14px}
  .modern-step__connector{height:24px}
  .modern-step__title{font-size:14px}
  .modern-step__date,.modern-step__author{font-size:11px}
  .rq-steps{overflow-x:auto;flex-wrap:nowrap;padding-bottom:4px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .rq-steps::-webkit-scrollbar{display:none}
  .rq-step{flex-shrink:0;font-size:12px;padding:5px 10px}
  .rq-additem{grid-template-columns:1fr 1fr;gap:8px}
  .rq-additem__note{grid-column:1 / -1}
  .rq-trow{grid-template-columns:1fr 70px 0.8fr 0.8fr 70px;gap:6px;padding:8px 12px;font-size:13px}
  .rq-trow--head{grid-template-columns:1fr 70px 0.8fr 0.8fr 70px;font-size:12px}
  .rq-source-badges{flex-direction:column;align-items:flex-start;gap:4px}
  .rq-item-actions{flex-direction:column;gap:4px}
  .rq-file__actions{flex-direction:column;width:100%}
  .rq-file__actions .btn{width:100%;justify-content:center}
  .rq-card__head{flex-wrap:wrap;gap:12px}
  #previewModal > div{width:98vw;max-width:98vw;height:95vh;max-height:95vh;margin:2.5vh auto}
  .status-select{padding:14px 16px;font-size:15px;padding-right:44px}
  .status-submit-btn{padding:14px 20px;font-size:15px}
  .action-link-btn{padding:14px 20px;font-size:15px}
}
</style>

<script>
// Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∑–∞—è–≤–∫–∏
document.addEventListener('DOMContentLoaded', function() {
  const editButtons = document.querySelectorAll('[data-edit-item]');
  const cancelButtons = document.querySelectorAll('[data-cancel-edit]');
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  editButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.getAttribute('data-edit-item');
      const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
      const editRow = document.querySelector(`[data-edit-form="${itemId}"]`);
      
      if (itemRow && editRow) {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏
        itemRow.style.display = 'none';
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editRow.style.display = 'grid';
        // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
        const firstInput = editRow.querySelector('.rq-edit-input');
        if (firstInput) {
          firstInput.focus();
          firstInput.select();
        }
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
  cancelButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const itemId = this.getAttribute('data-cancel-edit');
      const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
      const editRow = document.querySelector(`[data-edit-form="${itemId}"]`);
      
      if (itemRow && editRow) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏
        itemRow.style.display = 'grid';
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editRow.style.display = 'none';
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const editForms = document.querySelectorAll('.rq-edit-form');
  editForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    });
  });
  
  // ==========================
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏
  // ==========================
  const companySelect = document.getElementById('company-select');
  if (companySelect) {
    let isUpdating = false;
    
    companySelect.addEventListener('change', async function() {
      if (isUpdating) return;
      
      const companyId = this.value;
      if (!companyId) return;
      
      isUpdating = true;
      const originalValue = this.value;
      const selectElement = this;
      selectElement.disabled = true;
      selectElement.style.opacity = '0.6';
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookies
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        
        const formData = new FormData();
        formData.append('company_id', companyId);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        const response = await fetch('{% url "core:request_update_company" obj.pk %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          },
        });
        
        const data = await response.json();
        
        if (data.ok) {
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–∏
          window.location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏');
          selectElement.value = '{{ obj.company.pk|default:"" }}';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏');
        selectElement.value = '{{ obj.company.pk|default:"" }}';
      } finally {
        isUpdating = false;
        selectElement.disabled = false;
        selectElement.style.opacity = '1';
      }
    });
  }
});
</script>
{% endblock %}
