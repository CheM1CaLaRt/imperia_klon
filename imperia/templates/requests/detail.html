{% extends "base.html" %}
{% load access %}
{% load static access %}
{% block title %}Заявка #{{ obj.number }}{% endblock %}

{% block content %}
<div class="rq-container">

  <!-- ===== Шапка ===== -->
  <header class="rq-header">
    <div>
      <h1 class="rq-title">Заявка <span class="rq-mono">#{{ obj.number }}</span> — {{ obj.title }}</h1>
      <div class="rq-meta">
        {% if obj.status == 'canceled' %}
          <span class="rq-chip rq-chip--done">Завершена</span>
          <span class="rq-chip rq-chip--flag-danger">Отменена</span>
        {% else %}
          <span class="rq-chip rq-chip--{{ obj.status }}">{{ obj.get_status_display }}</span>
        {% endif %}
        {% if obj.is_paid %}
          <span class="rq-chip rq-chip--paid" title="Оплачено">Оплачено</span>
        {% endif %}
        <span>Инициатор: <b>{{ obj.initiator }}</b></span>
        {% if obj.counterparty %}<span>Контрагент: <b>{{ obj.counterparty.name }}</b></span>{% endif %}
        <span>Создана: {{ obj.created_at|date:"d.m.Y H:i" }}</span>
      </div>
    </div>
  </header>

  <!-- ===== Прогресс-этапы ===== -->
  {% with s=obj.status %}
  <div class="card" style="padding:16px 20px;margin-bottom:16px">
    <ol class="rq-steps" aria-label="Этапы заявки">
      <li class="rq-step {% if s != 'draft' %}is-done{% endif %} {% if s == 'draft' %}is-current{% endif %}">
        <span class="rq-step__number">1</span>
        <span>Создана</span>
      </li>
      <li class="rq-step {% if s in 'submitted quote approved to_pick in_progress ready_to_ship delivered done rejected canceled' %}is-done{% endif %} {% if s == 'submitted' %}is-current{% endif %}">
        <span class="rq-step__number">2</span>
        <span>На согласовании</span>
      </li>
      <li class="rq-step {% if s in 'quote approved to_pick in_progress ready_to_ship delivered done rejected canceled' %}is-done{% endif %} {% if s == 'quote' %}is-current{% endif %}">
        <span class="rq-step__number">3</span>
        <span>КП</span>
      </li>
      <li class="rq-step {% if s in 'approved to_pick in_progress ready_to_ship delivered done canceled' %}is-done{% endif %} {% if s == 'approved' %}is-current{% endif %}">
        <span class="rq-step__number">4</span>
        <span>Согласована</span>
      </li>
      {% if s == 'rejected' %}
      <li class="rq-step rq-step--rejected is-done is-current">
        <span class="rq-step__number">!</span>
        <span>Не согласована</span>
      </li>
      {% endif %}
      <li class="rq-step {% if s in 'in_progress ready_to_ship delivered done canceled' %}is-done{% endif %} {% if s == 'in_progress' %}is-current{% endif %}">
        <span class="rq-step__number">5</span>
        <span>Собирается</span>
      </li>
      <li class="rq-step {% if s in 'ready_to_ship delivered done canceled' %}is-done{% endif %} {% if s == 'ready_to_ship' %}is-current{% endif %}">
        <span class="rq-step__number">6</span>
        <span>К отгрузке</span>
      </li>
      <li class="rq-step {% if s in 'delivered done canceled' %}is-done{% endif %} {% if s == 'delivered' %}is-current{% endif %}">
        <span class="rq-step__number">7</span>
        <span>Доставлена</span>
      </li>
      <li class="rq-step {% if s in 'done canceled' %}is-done{% endif %} {% if s == 'done' %}is-current{% endif %}">
        <span class="rq-step__number">8</span>
        <span>Завершена</span>
      </li>
    </ol>
  </div>
  {% endwith %}

  <!-- ===== Макет: 2 колонки ===== -->
  <div class="rq-grid">

    <!-- ===== Левая колонка ===== -->
    <div class="rq-main">

      <!-- Коммерческое предложение -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>Коммерческое предложение</h2>

          {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
          <form class="rq-upload" method="post" enctype="multipart/form-data"
                action="{% url 'core:request_upload_quote' obj.pk %}">
            {% csrf_token %}
            <input id="quoteFile" type="file" name="file" class="rq-upload__input"
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.odt,.ods,.rtf,.png,.jpg,.jpeg"
                   onchange="this.form.submit()">
            <label for="quoteFile" class="rq-upload__label">Прикрепить файл</label>
          </form>
          {% endif %}
        </div>

        {% if obj.quotes.all %}
          <ul class="rq-history" style="padding:12px 14px;">
            {% for q in obj.quotes.all %}
              <li class="rq-file">
                <div class="rq-file__meta">
                  <span class="rq-mono">{{ q.created_at|date:"d.m.Y H:i" }}</span>
                  — {{ q.original_name }}
                  <span class="muted">, загрузил: {{ q.uploaded_by }}</span>
                </div>
                <div class="rq-file__actions">
                  <button class="btn btn-ghost open-preview"
                          data-url="{% url 'core:request_quote_preview' obj.pk q.pk %}"
                          data-name="{{ q.original_name }}">Просмотр</button>
                  <a class="btn" href="{{ q.file.url }}" download>Скачать</a>
                  {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
                  <form method="post" action="{% url 'core:request_quote_delete' obj.pk q.pk %}"
                        onsubmit="return confirm('Удалить файл «{{ q.original_name }}»?');">
                    {% csrf_token %}
                    <button class="btn btn-danger" type="submit">Удалить</button>
                  </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">Файлы не прикреплены</div>
        {% endif %}
      </section>

      <!-- Внутренний комментарий -->
      <section class="rq-card">
        <div class="rq-card__head"><h2>Комментарий</h2></div>
        <div class="rq-card__body">
          {% if obj.comment_internal %}
            {{ obj.comment_internal|linebreaksbr }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </div>
      </section>

      <!-- Позиции -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>Позиции</h2>
          {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
            <form method="post" action="{% url 'core:request_add_item' obj.pk %}" class="rq-additem">
              {% csrf_token %}
              <div class="rq-additem__field">{{ item_form.title }}</div>
              <div class="rq-additem__qty">{{ item_form.quantity }}</div>
              <div class="rq-additem__note">{{ item_form.note }}</div>
              <button class="btn">Добавить</button>
            </form>
          {% endif %}
        </div>

        {% if obj.items.all %}
          <div class="rq-table">
            <div class="rq-trow rq-trow--head">
              <div>Наименование</div>
              <div class="ta-right">Кол-во</div>
              <div>Примечание</div>
            </div>
            {% for it in obj.items.all %}
              <div class="rq-trow">
                <div>{% if it.title %}{{ it.title }}{% else %}{{ it.product.name }}{% endif %}</div>
                <div class="ta-right">{{ it.quantity }}</div>
                <div class="muted">{{ it.note }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="rq-empty">Пока пусто</div>
        {% endif %}
      </section>

      <!-- Секция «Сборка со склада» (оператор/директор при статусе approved) -->
      {% if show_pick_section %}
        {% include "core/_pick_section.html" with req=obj formset=pick_formset csrf_token=csrf_token %}
      {% endif %}

      {# Список к сборке для склада #}
      {% if latest_pick and pick_items %}
        <div class="mt-6 border border-gray-200 rounded-xl">
          <div class="px-4 py-3 border-b bg-white flex items-center justify-between">
            <div class="font-semibold">К сборке (лист №{{ latest_pick.id }})
<!--            {# detail.html — в блоке "К сборке (лист №...)" справа добавим #}-->
            <a href="{% url 'core:pick_print' obj.pk %}" class="btn btn-ghost" target="_blank">Печать</a>
            </div>
            <div class="text-sm text-gray-500">Создал: {{ latest_pick.created_by }} · {{ latest_pick.created_at|date:"d.m.Y H:i" }}</div>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-gray-500 border-b">
                <tr class="text-left">
                  <th class="py-2 pr-3">Штрихкод</th>
                  <th class="py-2 pr-3">Название</th>
                  <th class="py-2 pr-3">Ячейка</th>
                  <th class="py-2 pr-3">Ед.</th>
                  <th class="py-2 pr-3 text-right">Кол-во</th>
                </tr>
              </thead>
              <tbody>
                {% for it in pick_items %}
                  <tr class="border-b last:border-0">
                    <td class="py-2 pr-3">{{ it.barcode }}</td>
                    <td class="py-2 pr-3">{{ it.name }}</td>
                    <td class="py-2 pr-3">{{ it.location|default:"—" }}</td>
                    <td class="py-2 pr-3">{{ it.unit }}</td>
                    <td class="py-2 pr-3 text-right">{{ it.qty }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}


<!-- Скан-сборка для склада (только сохранение черновика) -->
{% if request.user|in_groups:"warehouse" and obj.status == "in_progress" %}
  <div class="mt-3">
    <button type="button" class="btn" id="openScanModal">Скан-сборка</button>
  </div>

  <div id="scanModal" class="fixed inset-0 hidden items-start justify-center z-50" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" data-close></div>

    <div class="relative mt-10 w-[min(1400px,98vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white shadow-xl border">
      <!-- Заголовок -->
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div class="text-xl font-semibold">Скан-сборка (лист №{{ latest_pick.id }})</div>
        <button type="button" class="text-2xl text-gray-500" data-close title="Закрыть">×</button>
      </div>

      <!-- Панель -->
      <div class="px-6 pt-4 pb-3 border-b bg-white">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
          <div class="xl:col-span-2">
            <label for="scanInput" class="text-sm text-gray-600 block">Штрихкод</label>
            <input id="scanInput" class="input w-full text-lg" placeholder="Наведи сканер и считай ШК (Enter)">
            <div class="text-xs text-gray-500 mt-1">
              Enter — применить, F2 — сменить режим, +/− — «Собрано», Space — «Нет».
              При закрытии с изменениями предложим <b>сохранить</b>.
            </div>
          </div>
          <div>
            <label for="scanMode" class="text-sm text-gray-600 block">Действие</label>
            <select id="scanMode" class="input w-full">
              <option value="add">Принимаем (увеличить «Собрано»)</option>
              <option value="miss">Нет на складе (пометить «Нет»)</option>
            </select>
            <div class="text-xs text-gray-500 mt-1">F2 — переключить режим</div>
          </div>
        </div>

        <!-- Счётчики -->
        <div class="mt-3 flex flex-wrap gap-3 text-sm">
          <div class="px-2 py-1 border rounded">План: <span id="ctPlan" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">Собрано: <span id="ctPicked" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">«Нет»: <span id="ctMissing" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">Осталось: <span id="ctLeft" class="font-semibold">0</span></div>
        </div>
      </div>

      <!-- Таблица -->
      <div class="overflow-auto" style="max-height: calc(90vh - 260px);">
        <table class="w-full text-sm" id="scanTable">
          <thead class="text-gray-600 border-b sticky top-0 bg-white z-10">
            <tr>
              <th class="py-2 px-4 text-left">ШК</th>
              <th class="py-2 px-4 text-left">Название</th>
              <th class="py-2 px-4 text-left">Ячейка</th>
              <th class="py-2 px-4 text-left">План</th>
              <th class="py-2 px-4 text-left">Собрано</th>
              <th class="py-2 px-4 text-left">Нет</th>
              <th class="py-2 px-4 text-left">Прим.</th>
              <th class="py-2 px-4 text-left">Статус</th>
            </tr>
          </thead>
          <tbody>
            {% for it in pick_items %}
            <tr data-bc="{{ it.barcode }}" class="state-none">
              <td class="py-2 px-4 font-mono">{{ it.barcode }}</td>
              <td class="py-2 px-4">{{ it.name }}</td>
              <td class="py-2 px-4">{{ it.location|default:"—" }}</td>
              <td class="py-2 px-4" data-plan>{{ it.qty }}</td>
              <td class="py-2 px-4">
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-ghost h-8 w-8" data-dec>-</button>
                  <input class="input h-8 w-20 text-right" type="number" min="0"
                         value="{{ it.picked_qty|default:0 }}" data-picked>
                  <button type="button" class="btn btn-ghost h-8 w-8" data-inc>+</button>
                </div>
              </td>
              <td class="py-2 px-4">
                <input type="checkbox" data-miss {% if it.missing %}checked{% endif %}>
              </td>
              <td class="py-2 px-4">
                <input type="text" class="input h-8 w-44" placeholder="Комментарий"
                       data-note value="{{ it.note|default_if_none:'' }}">
              </td>
              <td class="py-2 px-4 whitespace-nowrap" data-status>—</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Подвал -->
      <div class="px-6 py-3 border-t bg-white">
        <div class="text-xs text-gray-500 mb-3 flex flex-wrap gap-4">
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-gray-200"></span> — не начато</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-yellow-200"></span> — частично</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-green-200"></span> — готово</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-red-200"></span> — нет на складе</span>
        </div>
        <div class="flex gap-2">
          <button type="button" class="btn" id="saveDraft">Сохранить</button>
          <button type="button" class="btn btn-ghost" data-close>Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    tr.state-none    { background: #f5f5f5; }
    tr.state-partial { background: #fef3c7; }
    tr.state-ok      { background: #dcfce7; }
    tr.state-miss    { background: #fee2e2; }
  </style>

  <script>
  (function(){
    const modal  = document.getElementById('scanModal');
    const open   = document.getElementById('openScanModal');
    const input  = document.getElementById('scanInput');
    const mode   = document.getElementById('scanMode');
    const tbody  = document.getElementById('scanTable').querySelector('tbody');
    const btnSave   = document.getElementById('saveDraft');

    const ctPlan    = document.getElementById('ctPlan');
    const ctPicked  = document.getElementById('ctPicked');
    const ctMissing = document.getElementById('ctMissing');
    const ctLeft    = document.getElementById('ctLeft');

    let dirty = false;
    const markDirty = () => { dirty = true; };

    const focusInput = () => setTimeout(()=>input && input.focus(), 20);

    function updateRowState(tr){
      const plan   = parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10);
      const picked = parseInt(tr.querySelector('[data-picked]').value||'0',10);
      const miss   = tr.querySelector('[data-miss]').checked;
      const st     = tr.querySelector('[data-status]');
      tr.classList.remove('state-none','state-partial','state-ok','state-miss');

      if(miss){ tr.classList.add('state-miss'); st.textContent = 'Нет на складе'; return; }
      if(picked === 0){ tr.classList.add('state-none'); st.textContent = 'Не начато'; }
      else if(picked < plan){ tr.classList.add('state-partial'); st.textContent = `Частично (${picked}/${plan})`; }
      else{ tr.classList.add('state-ok'); st.textContent = `Готово (${picked}/${plan})`; }
    }

    function recalc(){
      const rows    = [...tbody.querySelectorAll('tr[data-bc]')];
      const plan    = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-plan]').textContent || 0), 0);
      const picked  = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-picked]').value || 0), 0);
      const missing = rows.reduce((s,tr)=> s + (tr.querySelector('[data-miss]').checked ? 1 : 0), 0);
      if(ctPlan)   ctPlan.textContent   = plan;
      if(ctPicked) ctPicked.textContent = picked;
      if(ctMissing)ctMissing.textContent= missing;
      if(ctLeft)   ctLeft.textContent   = Math.max(0, plan - picked);
    }

    function initStates(){
      [...tbody.querySelectorAll('tr[data-bc]')].forEach(updateRowState);
      recalc();
    }

    const openM  = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); focusInput(); initStates(); dirty=false; };
    const closeM = () => { modal.classList.add('hidden');  modal.classList.remove('flex'); };

    open.addEventListener('click', openM);
    modal.addEventListener('click', e=>{
      if(e.target.closest('[data-close]')){
        if(dirty){
          if(confirm('Есть несохранённые изменения. Сохранить?')){ save('save', true); return; }
        }
        closeM();
      }
    });

    document.addEventListener('keydown', e=>{
      if(modal.classList.contains('hidden')) return;
      if(e.key==='Escape'){ if(dirty && confirm('Сохранить изменения?')) save('save', true); else closeM(); }
      if(e.key==='F2'){ e.preventDefault(); mode.value = (mode.value==='add' ? 'miss' : 'add'); }
    });

    // обработка сканера
    input.addEventListener('keydown', e=>{
      if(e.key !== 'Enter') return;
      const bc = input.value.trim(); input.value = '';
      if(!bc) return;

      const tr = tbody.querySelector(`tr[data-bc="${CSS.escape(bc)}"]`);
      if(!tr){ alert('ШК не в листе — добавьте в заявку'); return; }

      const picked = tr.querySelector('[data-picked]');
      const miss   = tr.querySelector('[data-miss]');

      if(mode.value==='miss'){ miss.checked = true; }
      else { picked.value = Math.max(0, parseInt(picked.value||'0',10)+1); }

      updateRowState(tr); recalc(); tr.scrollIntoView({block:'nearest'});
      markDirty();
    });

    // +/- и ручные изменения
    tbody.addEventListener('click', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.target.matches('[data-inc]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = (+inp.value || 0) + 1;
        updateRowState(tr); recalc(); markDirty();
      }
      if(e.target.matches('[data-dec]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = Math.max(0, (+inp.value || 0) - 1);
        updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('input', e=>{
      if(e.target.matches('[data-picked], [data-miss], [data-note]')){
        const tr = e.target.closest('tr[data-bc]'); updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('keydown', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.key==='+' || e.key==='='){ e.preventDefault(); tr.querySelector('[data-inc]').click(); }
      if(e.key==='-'){ e.preventDefault(); tr.querySelector('[data-dec]').click(); }
      if(e.key===' '){ e.preventDefault(); const m = tr.querySelector('[data-miss]'); m.checked = !m.checked; updateRowState(tr); recalc(); markDirty(); }
    });

    function collectLines(){
      return [...tbody.querySelectorAll('tr[data-bc]')].map(tr=>({
        barcode: tr.dataset.bc,
        picked_qty: parseInt(tr.querySelector('[data-picked]').value||'0',10),
        missing: tr.querySelector('[data-miss]').checked,
        note: tr.querySelector('[data-note]')?.value || '',
        planned_qty: parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10),
      }));
    }

    async function save(commit='save', reloadAfter=true){
      const lines = collectLines();
      const resp = await fetch("{{ pick_confirm_url }}", {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-Requested-With':'XMLHttpRequest',
          'X-CSRFToken':'{{ csrf_token }}'
        },
        body: JSON.stringify({ commit, lines })
      });
      if(!resp.ok){
        const t = await resp.text().catch(()=> '');
        alert('Не удалось сохранить. ' + t);
        return false;
      }
      dirty = false;
      if(reloadAfter){ closeM(); location.reload(); }
      return true;
    }

    btnSave.addEventListener('click', ()=> save('save', true));   // только черновик
  })();
  </script>
{% endif %}





      <!-- История -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>История</h2>
          {% with history_all=obj.history.all %}
            {% if history_all|length > 3 %}
              <button type="button" id="toggleHistory" class="rq-history-toggle" aria-label="Показать полную историю">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            {% endif %}
          {% endwith %}
        </div>
        {% if obj.history.all %}
          <ul class="rq-history" id="historyList">
            {% for h in obj.history.all %}
              <li class="history-item">
                <span class="rq-mono">{{ h.created_at|date:"d.m.Y H:i" }}</span>
                — <b>{{ h.author }}</b>:
                <span class="rq-mono">{{ h.from_status|default:"—" }}</span>
                → <span class="rq-mono">{{ h.to_status }}</span>
                <span class="muted">{{ h.note }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">Пусто</div>
        {% endif %}
      </section>

    </div>

    <!-- ===== Правая колонка (Действия) ===== -->
    <aside class="rq-aside">
      <section class="rq-card rq-sticky">
        <div class="rq-card__head"><h2>Действия</h2></div>

        <form method="post" action="{% url 'core:request_change_status' obj.pk %}" class="rq-actions__col">
          {% csrf_token %}

          {# ОПЕРАТОР #}
          {% if request.user|in_groups:"operator" %}
            {% if obj.status == "draft" %}
              <button class="btn" name="to" value="submitted">Отправить</button>
              <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
            {% elif obj.status == "submitted" %}
              <button class="btn" name="to" value="quote">КП</button>
              <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
            {% elif obj.status == "approved" %}
              {% if latest_pick %}
                <button class="btn" name="to" value="to_pick">В сборку (склад)</button>
              {% else %}
                <button type="button" class="btn"
        onclick="document.getElementById('openPickModal')?.click()">
  Перейти к сборке на склад
</button>
              {% endif %}
            {% elif obj.status == "rejected" %}
              <button class="btn" name="to" value="quote">КП</button>
              <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
            {% elif obj.status == "ready_to_ship" %}
              <button class="btn" name="to" value="delivered">Доставлена</button>
            {% endif %}
          {% endif %}

          {# МЕНЕДЖЕР #}
          {% if request.user|in_groups:"manager" %}
            {% if obj.status == "draft" %}
              <button class="btn" name="to" value="submitted">Отправить</button>
              <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
            {% elif obj.status == "quote" %}
              <button class="btn btn-primary" name="to" value="approved">Согласовано</button>
              <button class="btn" name="to" value="rejected">Не согласовали</button>
            {% endif %}
          {% endif %}

          {# СКЛАД — только после передачи в сборку #}
          {% if request.user|in_groups:"warehouse" %}
            {% if obj.status == "to_pick" %}
              <button class="btn" name="to" value="in_progress">В работу</button>
            {% elif obj.status == "in_progress" %}
              <button class="btn" name="to" value="ready_to_ship">Готова к отгрузке</button>
            {% endif %}
          {% endif %}

          {# ДИРЕКТОР #}
          {% if request.user|in_groups:"director" %}
            {% if obj.status in "draft submitted quote approved to_pick in_progress ready_to_ship delivered" %}
              <button class="btn" name="to" value="quote">КП</button>
              <button class="btn" name="to" value="approved">Согласовано</button>

              {% if obj.status == "approved" %}
                {% if latest_pick %}
                  <button class="btn" name="to" value="to_pick">В сборку (склад)</button>
                {% else %}
                  <button type="button" class="btn"
        onclick="document.getElementById('openPickModal')?.click()">
  Перейти к сборке на склад
</button>
                {% endif %}
              {% endif %}

              <button class="btn" name="to" value="in_progress">В работу</button>
              <button class="btn" name="to" value="ready_to_ship">Готова к отгрузке</button>
              <button class="btn" name="to" value="delivered">Доставлена</button>
            {% endif %}
            {% if obj.status == "rejected" %}
              <button class="btn" name="to" value="quote">КП</button>
              <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
            {% endif %}
            <button class="btn" name="to" value="done">Завершить</button>
            <button class="btn" name="to" value="rejected">Не согласовали</button>
            <button class="btn btn-ghost" name="to" value="canceled">Отменить</button>
          {% endif %}
        </form>
      </section>

      {# ОПЛАТА: только директор/оператор И статус НЕ done/canceled #}
      {% if request.user|in_groups:"director,operator" %}
        {% if obj.status != 'done' and obj.status != 'canceled' %}
        <section class="rq-card rq-sticky">
          <div class="rq-card__head"><h2>Оплата</h2></div>
          <form method="post" action="{% url 'core:request_toggle_payment' obj.pk %}">
            {% csrf_token %}
            <label class="rq-pay">
              <input type="checkbox" name="is_paid" value="1" {% if obj.is_paid %}checked{% endif %} onchange="this.form.submit()">
              <span>Оплачено</span>
            </label>
          </form>
        </section>
        {% endif %}
      {% endif %}
    </aside>
  </div>
</div>

{# ===== Модалка предпросмотра КП ===== #}
<div id="previewModal" class="fixed inset-0 bg-black/60 hidden z-50 items-center justify-center" style="display:none">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:92vw;max-width:800px;max-height:90vh;display:flex;flex-direction:column;position:relative">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <div id="previewTitle" style="font-size:16px;font-weight:700;color:var(--text)"></div>
      <button id="closePreview" type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:14px">Закрыть</button>
    </div>
    <iframe id="previewFrame" src="" style="width:100%;flex:1;min-height:400px;border:none;border-radius:0 0 18px 18px"></iframe>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('previewModal');
  const closeBtn = document.getElementById('closePreview');
  const titleEl = document.getElementById('previewTitle');
  const frameEl = document.getElementById('previewFrame');
  
  document.querySelectorAll('.open-preview').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const name = this.dataset.name || 'Файл';
      if (titleEl) titleEl.textContent = name;
      if (frameEl) frameEl.src = url;
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    });
  });
  
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    if (frameEl) frameEl.src = '';
  }
  
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.style.display !== 'none') {
      closeModal();
    }
  });
})();
</script>

{# Скрипт для переключения истории #}
<script>
(function(){
  const toggleBtn = document.getElementById('toggleHistory');
  const historyList = document.getElementById('historyList');
  
  if (!toggleBtn || !historyList) return;
  
  const allItems = Array.from(historyList.querySelectorAll('.history-item'));
  const totalItems = allItems.length;
  const showItems = 3;
  
  // Скрываем все кроме последних 3
  if (totalItems > showItems) {
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        item.style.display = 'none';
      }
    });
  }
  
  let isExpanded = false;
  
  toggleBtn.addEventListener('click', function() {
    isExpanded = !isExpanded;
    
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        if (isExpanded) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      }
    });
    
    if (isExpanded) {
      toggleBtn.classList.add('expanded');
      toggleBtn.setAttribute('aria-label', 'Скрыть историю');
    } else {
      toggleBtn.classList.remove('expanded');
      toggleBtn.setAttribute('aria-label', 'Показать полную историю');
    }
  });
})();
</script>

<style>
:root{ --bg:#f6f7f8; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --accent:#111; --radius:14px; }
.rq-container{max-width:1100px;margin:0 auto;padding:10px 0 28px;}
.rq-title{font-size:26px;font-weight:800;color:var(--text);}
.rq-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;}
.rq-header{margin-bottom:6px;}
.rq-meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);margin-top:6px;align-items:center}

.rq-grid{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:16px;margin-top:10px;}
.rq-main{display:grid;gap:12px;}
.rq-aside{display:grid;gap:12px;}
.rq-sticky{position:sticky; top:12px}

.rq-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);}
.rq-card__head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
.rq-card__head h2{font-size:16px;font-weight:800}
.rq-card__body{padding:12px 14px}

.rq-steps{display:flex;flex-wrap:wrap;gap:8px;margin:0;padding:0;list-style:none}
.rq-step{display:flex;align-items:center;gap:6px;padding:8px 12px;border:2px solid var(--line);border-radius:12px;background:#fff;font-weight:600;font-size:13px;color:var(--text);transition:all 0.2s;position:relative}
.rq-step__number{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--bg);color:var(--text);font-weight:700;font-size:12px;flex-shrink:0}
.rq-step.is-done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-step.is-done .rq-step__number{background:rgba(255,255,255,0.2);color:#fff}
.rq-step.is-current{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:scale(1.05)}
.rq-step.is-current .rq-step__number{background:rgba(255,255,255,0.3);color:#fff;font-weight:800}
.rq-step--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.rq-step--rejected .rq-step__number{background:#fecaca;color:#7f1d1d}

.btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:700;text-decoration:none}
.btn:hover{opacity:.92}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:#fff;color:#111;border-color:#111}
.btn-primary{background:#111;color:#fff;border-color:#111}
.btn-danger{background:#fff;color:#7f1d1d;border-color:#ef4444}
.btn-danger:hover{background:#fee2e2}

.rq-actions__col{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:8px;padding:10px 12px;}
.rq-aside .btn{width:100%;padding:7px 10px;border-radius:10px;font-weight:600;font-size:14px;line-height:1.1;}
.rq-aside .btn-ghost,.rq-aside .btn-danger,.rq-aside .btn-primary{padding:7px 10px;border-radius:10px;font-weight:600;}
.rq-aside .rq-card__head{padding:10px 12px;}

.rq-pay{display:flex;align-items:center;gap:8px;padding:12px 14px}
.rq-upload{display:flex;gap:8px;align-items:center}
.rq-upload__input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
.rq-upload__label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px dashed #111;border-radius:12px;background:#fff;color:#111;font-weight:700;cursor:pointer}

.rq-table{display:grid;border-top:1px solid var(--line)}
.rq-trow{display:grid;grid-template-columns:1fr 120px 1fr;gap:10px;padding:10px 14px;border-bottom:1px solid var(--line)}
.rq-trow--head{background:#fbfbfb;font-weight:700}
.ta-right{text-align:right}

.rq-file{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted var(--line)}
.rq-file:last-child{border-bottom:0}
.rq-file__meta{min-width:0}
.rq-file__actions{display:flex;gap:6px}
.rq-file__actions form{display:inline}

.rq-additem{display:grid;grid-template-columns:1fr 120px 1fr auto;gap:8px;align-items:center}
.rq-additem__field input,.rq-additem__qty input,.rq-additem__note input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--line);background:#fff;color:#111}
.rq-chip--paid{border-style:dashed}
.rq-chip--done{background:#111;border-color:#111;color:#fff}
.rq-chip--flag-danger{background:#fff;border:1px dashed #ef4444;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:10px;padding:26px;border:1px dashed var(--line);border-radius:12px;color:#757b82;background:#fff}

.rq-history{padding:12px 14px}
.rq-history li{padding:6px 0;border-bottom:1px dotted var(--line)}
.rq-history li:last-child{border-bottom:0}
.history-item-hidden{display:none}
.rq-history-toggle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;padding:0}
.rq-history-toggle:hover{background:var(--bg);border-color:var(--primary);color:var(--primary)}
.rq-history-toggle:active{transform:scale(0.95)}
.rq-history-toggle.expanded{transform:rotate(180deg)}
.rq-history-toggle svg{transition:transform 0.2s}

@media (max-width: 980px){
  .rq-grid{grid-template-columns:1fr}
  .rq-sticky{position:static}
  .rq-additem{grid-template-columns:1fr 120px 1fr auto}
  .rq-actions__col{grid-template-columns:1fr;}
  .rq-header{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-file{flex-direction:column;align-items:flex-start;gap:8px}
  .rq-file__actions{width:100%;flex-wrap:wrap}
}
@media (max-width: 640px){
  .rq-title{font-size:20px}
  .rq-meta{flex-direction:column;align-items:flex-start;gap:6px}
  .rq-steps{overflow-x:auto;flex-wrap:nowrap;padding-bottom:4px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .rq-steps::-webkit-scrollbar{display:none}
  .rq-step{flex-shrink:0;font-size:12px;padding:5px 10px}
  .rq-additem{grid-template-columns:1fr 1fr;gap:8px}
  .rq-additem__note{grid-column:1 / -1}
  .rq-trow{grid-template-columns:1fr 90px 1fr;gap:8px;padding:8px 12px}
  .rq-file__actions{flex-direction:column;width:100%}
  .rq-file__actions .btn{width:100%;justify-content:center}
  .rq-card__head{flex-wrap:wrap;gap:12px}
  #previewModal > div{width:98vw;max-width:98vw;height:95vh;max-height:95vh;margin:2.5vh auto}
}
</style>
{% endblock %}
