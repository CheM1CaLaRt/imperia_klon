{% extends "base.html" %}
{% load access %}
{% load static access %}
{% block title %}–ó–∞—è–≤–∫–∞ #{{ obj.number }}{% endblock %}

{% block content %}
<div class="rq-container">

  <!-- ===== –®–∞–ø–∫–∞ ===== -->
  <header class="rq-header">
    <div>
      <h1 class="rq-title">–ó–∞—è–≤–∫–∞ <span class="rq-mono">#{{ obj.number }}</span> ‚Äî {{ obj.title }}</h1>
      <div class="rq-meta">
        {% if obj.status == 'canceled' %}
          <span class="rq-chip rq-chip--done">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          <span class="rq-chip rq-chip--flag-danger">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
        {% else %}
          <span class="rq-chip rq-chip--{{ obj.status }}">{{ obj.get_status_display }}</span>
        {% endif %}
        {% if obj.is_paid %}
          <span class="rq-chip rq-chip--paid" title="–û–ø–ª–∞—á–µ–Ω–æ">–û–ø–ª–∞—á–µ–Ω–æ</span>
        {% endif %}
        <span>–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: <b>{{ obj.initiator }}</b></span>
        {% if obj.counterparty %}<span>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: <b>{{ obj.counterparty.name }}</b></span>{% endif %}
        <span>–°–æ–∑–¥–∞–Ω–∞: {{ obj.created_at|date:"d.m.Y H:i" }}</span>
      </div>
    </div>
  </header>

  <!-- ===== –ü—Ä–æ–≥—Ä–µ—Å—Å-—ç—Ç–∞–ø—ã ===== -->
  {% with s=obj.status %}
  <div class="modern-steps-card">
    <div class="modern-steps-header">
      <div class="modern-steps-header__icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <h2 class="modern-steps-header__title">–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏</h2>
    </div>
    <div class="modern-steps-carousel">
      <button class="modern-steps-nav modern-steps-nav--prev" id="stepsPrev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="modern-steps-viewport" id="stepsViewport">
        <div class="modern-steps-container" id="stepsContainer">
          <!-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∞ -->
          <div class="modern-step-item" data-step="1" data-status="{% if s != 'draft' %}completed{% elif s == 'draft' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s != 'draft' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">1</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–°–æ–∑–¥–∞–Ω–∞</div>
              {% if status_dates.draft %}
                <div class="modern-step-item__meta">{{ status_dates.draft.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.draft.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ -->
          <div class="modern-step-item" data-step="2" data-status="{% if s in 'submitted quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}completed{% elif s == 'submitted' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'submitted quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">2</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
              {% if status_dates.submitted %}
                <div class="modern-step-item__meta">{{ status_dates.submitted.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.submitted.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 3: –ö–ü -->
          <div class="modern-step-item" data-step="3" data-status="{% if s in 'quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}completed{% elif s == 'quote' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'quote pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">3</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ö–ü</div>
              {% if status_dates.quote %}
                <div class="modern-step-item__meta">{{ status_dates.quote.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.quote.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 4: –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ -->
          <div class="modern-step-item" data-step="4" data-status="{% if s in 'pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}completed{% elif s == 'pending_approval' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'pending_approval approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">4</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</div>
              {% if status_dates.pending_approval %}
                <div class="modern-step-item__meta">{{ status_dates.pending_approval.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.pending_approval.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 5: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ -->
          <div class="modern-step-item" data-step="5" data-status="{% if s in 'approved to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}completed{% elif s == 'approved' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'approved to_pick in_progress ready_to_ship partially_shipped shipped done rejected canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">5</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</div>
              {% if status_dates.approved %}
                <div class="modern-step-item__meta">{{ status_dates.approved.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.approved.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å) -->
          {% if s == 'rejected' %}
          <div class="modern-step-item modern-step-item--error" data-step="rejected" data-status="active">
            <div class="modern-step-item__circle">
              <span class="modern-step-item__icon">‚úó</span>
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞</div>
              {% if status_dates.rejected %}
                <div class="modern-step-item__meta">{{ status_dates.rejected.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.rejected.author }}</div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- –®–∞–≥ 6: –ù–∞ —Å–±–æ—Ä–∫—É -->
          <div class="modern-step-item" data-step="6" data-status="{% if s in 'to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}completed{% elif s == 'to_pick' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'to_pick in_progress ready_to_ship partially_shipped shipped done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">6</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ù–∞ —Å–±–æ—Ä–∫—É</div>
              {% if status_dates.to_pick %}
                <div class="modern-step-item__meta">{{ status_dates.to_pick.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.to_pick.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 7: –°–æ–±–∏—Ä–∞–µ—Ç—Å—è -->
          <div class="modern-step-item" data-step="7" data-status="{% if s in 'in_progress ready_to_ship partially_shipped shipped done canceled' %}completed{% elif s == 'in_progress' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'in_progress ready_to_ship partially_shipped shipped done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">7</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–°–æ–±–∏—Ä–∞–µ—Ç—Å—è</div>
              {% if status_dates.in_progress %}
                <div class="modern-step-item__meta">{{ status_dates.in_progress.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.in_progress.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 8: –ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ -->
          <div class="modern-step-item" data-step="8" data-status="{% if s in 'ready_to_ship partially_shipped shipped done canceled' %}completed{% elif s == 'ready_to_ship' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'ready_to_ship partially_shipped shipped done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">8</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</div>
              {% if status_dates.ready_to_ship %}
                <div class="modern-step-item__meta">{{ status_dates.ready_to_ship.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.ready_to_ship.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 9: –û—Ç–≥—Ä—É–∂–µ–Ω–∞ -->
          <div class="modern-step-item" data-step="9" data-status="{% if s in 'partially_shipped shipped done canceled' %}completed{% elif s in 'partially_shipped shipped' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'partially_shipped shipped done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">9</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–û—Ç–≥—Ä—É–∂–µ–Ω–∞</div>
              {% if status_dates.shipped or status_dates.partially_shipped %}
                <div class="modern-step-item__meta">
                  {% if status_dates.shipped %}{{ status_dates.shipped.date|date:"d.m.Y H:i" }}
                  {% elif status_dates.partially_shipped %}{{ status_dates.partially_shipped.date|date:"d.m.Y H:i" }}{% endif %}
                </div>
                <div class="modern-step-item__author">
                  {% if status_dates.shipped %}{{ status_dates.shipped.author }}
                  {% elif status_dates.partially_shipped %}{{ status_dates.partially_shipped.author }}{% endif %}
                </div>
              {% endif %}
              {% if s == 'partially_shipped' %}
                <div class="modern-step-item__badge modern-step-item__badge--warning">–ß–∞—Å—Ç–∏—á–Ω–æ</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 10: –î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ -->
          <div class="modern-step-item" data-step="10" data-status="{% if s in 'delivered done canceled' %}completed{% elif s == 'delivered' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'delivered done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">10</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞</div>
              {% if status_dates.delivered %}
                <div class="modern-step-item__meta">{{ status_dates.delivered.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.delivered.author }}</div>
              {% endif %}
            </div>
          </div>

          <!-- –®–∞–≥ 11: –ó–∞–≤–µ—Ä—à–µ–Ω–∞ -->
          <div class="modern-step-item" data-step="11" data-status="{% if s in 'done canceled' %}completed{% elif s == 'done' %}active{% else %}pending{% endif %}">
            <div class="modern-step-item__circle">
              {% if s in 'done canceled' %}<span class="modern-step-item__icon">‚úì</span>{% else %}<span class="modern-step-item__number">11</span>{% endif %}
            </div>
            <div class="modern-step-item__content">
              <div class="modern-step-item__title">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</div>
              {% if status_dates.done %}
                <div class="modern-step-item__meta">{{ status_dates.done.date|date:"d.m.Y H:i" }}</div>
                <div class="modern-step-item__author">{{ status_dates.done.author }}</div>
              {% endif %}
              {% if obj.status == 'done' and not obj.is_paid %}
                <div class="modern-step-item__badge modern-step-item__badge--warning">–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞</div>
              {% elif obj.status == 'done' and obj.is_paid %}
                <div class="modern-step-item__badge modern-step-item__badge--success">–û–ø–ª–∞—á–µ–Ω–∞</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <button class="modern-steps-nav modern-steps-nav--next" id="stepsNext" aria-label="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
  {% endwith %}

  <!-- ===== –ú–∞–∫–µ—Ç: 2 –∫–æ–ª–æ–Ω–∫–∏ ===== -->
  <div class="rq-grid">

    <!-- ===== –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ===== -->
    <div class="rq-main">

      <!-- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>

          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            {% if can_edit_quote %}
              {% if active_quote %}
                <a href="{% url 'core:request_quote_edit' obj.pk active_quote.pk %}" class="btn btn-primary">
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% else %}
                <a href="{% url 'core:request_quote_create' obj.pk %}" class="btn btn-primary">
                  –°–æ–∑–¥–∞—Ç—å –ö–ü —Å —Ü–µ–Ω–∞–º–∏
                </a>
              {% endif %}
            {% endif %}
            
            {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
            <form class="rq-upload" method="post" enctype="multipart/form-data"
                  action="{% url 'core:request_upload_quote' obj.pk %}"
                  style="display: inline-block;">
              {% csrf_token %}
              <input id="quoteFile" type="file" name="file" class="rq-upload__input"
                     accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.odt,.ods,.rtf,.png,.jpg,.jpeg"
                     onchange="this.form.submit()">
              <label for="quoteFile" class="rq-upload__label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</label>
            </form>
            {% endif %}
          </div>
        </div>

        {% if active_quote and quote_items %}
          <div style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 16px; font-weight: 600;">–¢–æ–≤–∞—Ä—ã –≤ –ö–ü</h3>
              <div style="font-size: 18px; font-weight: 700; color: var(--primary);">
                –ò—Ç–æ–≥–æ: {{ quote_total|floatformat:2 }} ‚ÇΩ
              </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                  <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                  <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for item in quote_items %}
                  <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                    <td style="padding: 10px 8px;">{{ item.title }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                    <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2 }} ‚ÇΩ</td>
                    <td style="padding: 10px 8px; text-align: right; font-weight: 600;">{{ item.total|floatformat:2 }} ‚ÇΩ</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% if obj.quotes.all %}
          <ul class="rq-history" style="padding:12px 14px;">
            {% for q in obj.quotes.all %}
              <li class="rq-file">
                <div class="rq-file__meta">
                  <span class="rq-mono">{{ q.created_at|date:"d.m.Y H:i" }}</span>
                  ‚Äî {{ q.original_name|default:"–ö–ü —Å —Ü–µ–Ω–∞–º–∏" }}
                  <span class="muted">, –∑–∞–≥—Ä—É–∑–∏–ª: {{ q.uploaded_by }}</span>
                </div>
                <div class="rq-file__actions">
                  {% if q.file %}
                    <button class="btn btn-ghost open-preview"
                            data-url="{% url 'core:request_quote_preview' obj.pk q.pk %}"
                            data-name="{{ q.original_name|default:'–ö–ü' }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                    <a class="btn" href="{{ q.file.url }}" download>–°–∫–∞—á–∞—Ç—å</a>
                  {% endif %}
                  {% if obj.is_editable and request.user|in_groups:"manager,operator,director" %}
                  <form method="post" action="{% url 'core:request_quote_delete' obj.pk q.pk %}"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ö–ü {% if q.original_name %}¬´{{ q.original_name }}¬ª{% else %}—Å —Ü–µ–Ω–∞–º–∏{% endif %}?');">
                    {% csrf_token %}
                    <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">–§–∞–π–ª—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</div>
        {% endif %}
      </section>

      <!-- –û—Ç–≥—Ä—É–∑–∫–∏ -->
      {% if obj.status in 'ready_to_ship partially_shipped shipped' %}
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–û—Ç–≥—Ä—É–∑–∫–∏</h2>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            {% if can_create_shipment %}
              <a href="{% url 'core:request_shipment_create' obj.pk %}" class="btn btn-primary">
                –°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É
              </a>
            {% endif %}
            {% if obj.delivery_address or obj.delivery_contact %}
              <a href="{% url 'core:request_route_sheet' obj.pk %}" target="_blank" class="btn btn-ghost">
                üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
              </a>
              <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
                üìÑ –£–ü–î
              </a>
            {% endif %}
          </div>
        </div>

        {% if shipments %}
          {% for shipment in shipments %}
            <div style="padding: 16px; border-bottom: 1px solid var(--border); {% if not forloop.last %}margin-bottom: 16px;{% endif %}">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                    –û—Ç–≥—Ä—É–∑–∫–∞ #{{ shipment.shipment_number|default:shipment.pk }}
                  </h3>
                  <div style="margin-top: 4px; font-size: 13px; color: var(--muted);">
                    {{ shipment.shipped_at|date:"d.m.Y H:i" }} ¬∑ {{ shipment.shipped_by }}
                    {% if shipment.is_partial %}
                      <span style="color: #f59e0b;">(–ß–∞—Å—Ç–∏—á–Ω–∞—è)</span>
                    {% endif %}
                  </div>
                </div>
                <div style="font-size: 16px; font-weight: 700; color: var(--primary);">
                  –ò—Ç–æ–≥–æ: {{ shipment.get_total|floatformat:2 }} ‚ÇΩ
                </div>
              </div>
              
              {% if shipment.comment %}
                <div style="padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 12px; font-size: 13px; color: var(--muted);">
                  {{ shipment.comment }}
                </div>
              {% endif %}
              
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="border-bottom: 1px solid var(--border);">
                    <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">‚Ññ</th>
                    <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--muted);">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–¶–µ–Ω–∞</th>
                    <th style="padding: 8px; text-align: right; font-weight: 600; color: var(--muted);">–ò—Ç–æ–≥–æ</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in shipment.items.all %}
                    <tr style="border-bottom: 1px solid var(--border);">
                      <td style="padding: 10px 8px;">{{ forloop.counter }}</td>
                      <td style="padding: 10px 8px;">{{ item.title }}</td>
                      <td style="padding: 10px 8px; text-align: right;">{{ item.quantity }}</td>
                      <td style="padding: 10px 8px; text-align: right;">{{ item.price|floatformat:2|default:"‚Äî" }} {% if item.price %}‚ÇΩ{% endif %}</td>
                      <td style="padding: 10px 8px; text-align: right; font-weight: 600;">
                        {% if item.price %}
                          {% widthratio item.quantity 1 item.price as item_total %}
                          {{ item_total|floatformat:2 }} ‚ÇΩ
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <a href="{% url 'core:request_upd_shipment' obj.pk shipment.pk %}" target="_blank" class="btn btn-ghost" style="font-size: 13px;">
                  üìÑ –£–ü–î –¥–ª—è —ç—Ç–æ–π –æ—Ç–≥—Ä—É–∑–∫–∏
                </a>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="rq-empty">–û—Ç–≥—Ä—É–∑–æ–∫ –Ω–µ—Ç</div>
        {% endif %}
      </section>
      {% endif %}
      
      <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã (–µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫, –Ω–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏) -->
      {% if obj.status not in 'ready_to_ship partially_shipped shipped' and obj.delivery_address %}
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        </div>
        <div style="padding: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          <a href="{% url 'core:request_route_sheet' obj.pk %}" target="_blank" class="btn btn-ghost">
            üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
          </a>
          {% if active_quote %}
            <a href="{% url 'core:request_upd' obj.pk %}" target="_blank" class="btn btn-ghost">
              üìÑ –£–ü–î
            </a>
          {% endif %}
        </div>
      </section>
      {% endif %}

      <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <section class="rq-card">
        <div class="rq-card__head"><h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2></div>
        <div class="rq-card__body">
          {% if obj.comment_internal %}
            {{ obj.comment_internal|linebreaksbr }}
          {% else %}
            <span class="muted">‚Äî</span>
          {% endif %}
        </div>
      </section>

      <!-- –ü–æ–∑–∏—Ü–∏–∏ -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ü–æ–∑–∏—Ü–∏–∏</h2>
          {% if can_add_items %}
            <form method="post" action="{% url 'core:request_add_item' obj.pk %}" class="rq-additem">
              {% csrf_token %}
              <div class="rq-additem__field">{{ item_form.title }}</div>
              <div class="rq-additem__qty">{{ item_form.quantity }}</div>
              <div class="rq-additem__note">{{ item_form.note }}</div>
              <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
          {% endif %}
        </div>

        {% if obj.items.all %}
          <div class="rq-table">
            <div class="rq-trow rq-trow--head">
              <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
              <div class="ta-right">–ö–æ–ª-–≤–æ</div>
              <div>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>
            </div>
            {% for it in obj.items.all %}
              <div class="rq-trow">
                <div>{% if it.title %}{{ it.title }}{% else %}{{ it.product.name }}{% endif %}</div>
                <div class="ta-right">{{ it.quantity }}</div>
                <div class="muted">{{ it.note }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="rq-empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
        {% endif %}
      </section>

      <!-- –°–µ–∫—Ü–∏—è ¬´–°–±–æ—Ä–∫–∞ —Å–æ —Å–∫–ª–∞–¥–∞¬ª (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ approved) -->
      {% if show_pick_section %}
        {% include "core/_pick_section.html" with req=obj formset=pick_formset csrf_token=csrf_token %}
      {% endif %}

      {# –°–ø–∏—Å–æ–∫ –∫ —Å–±–æ—Ä–∫–µ –¥–ª—è —Å–∫–ª–∞–¥–∞ #}
      {% if latest_pick and pick_items %}
        <div class="mt-6 border border-gray-200 rounded-xl">
          <div class="px-4 py-3 border-b bg-white flex items-center justify-between">
            <div class="font-semibold">–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})
<!--            {# detail.html ‚Äî –≤ –±–ª–æ–∫–µ "–ö —Å–±–æ—Ä–∫–µ (–ª–∏—Å—Ç ‚Ññ...)" —Å–ø—Ä–∞–≤–∞ –¥–æ–±–∞–≤–∏–º #}-->
            <a href="{% url 'core:pick_print' obj.pk %}" class="btn btn-ghost" target="_blank">–ü–µ—á–∞—Ç—å</a>
            </div>
            <div class="text-sm text-gray-500">–°–æ–∑–¥–∞–ª: {{ latest_pick.created_by }} ¬∑ {{ latest_pick.created_at|date:"d.m.Y H:i" }}</div>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-gray-500 border-b">
                <tr class="text-left">
                  <th class="py-2 pr-3">–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
                  <th class="py-2 pr-3">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th class="py-2 pr-3">–Ø—á–µ–π–∫–∞</th>
                  <th class="py-2 pr-3">–ï–¥.</th>
                  <th class="py-2 pr-3 text-right">–ö–æ–ª-–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for it in pick_items %}
                  <tr class="border-b last:border-0">
                    <td class="py-2 pr-3">{{ it.barcode }}</td>
                    <td class="py-2 pr-3">{{ it.name }}</td>
                    <td class="py-2 pr-3">{{ it.location|default:"‚Äî" }}</td>
                    <td class="py-2 pr-3">{{ it.unit }}</td>
                    <td class="py-2 pr-3 text-right">{{ it.qty }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}


<!-- –°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞ (—Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞) -->
{% if request.user|in_groups:"warehouse" and obj.status == "in_progress" %}
  <div class="mt-3">
    <button type="button" class="btn" id="openScanModal">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞</button>
  </div>

  <div id="scanModal" class="fixed inset-0 hidden items-start justify-center z-50" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" data-close></div>

    <div class="relative mt-10 w-[min(1400px,98vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white shadow-xl border">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div class="text-xl font-semibold">–°–∫–∞–Ω-—Å–±–æ—Ä–∫–∞ (–ª–∏—Å—Ç ‚Ññ{{ latest_pick.id }})</div>
        <button type="button" class="text-2xl text-gray-500" data-close title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å -->
      <div class="px-6 pt-4 pb-3 border-b bg-white">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
          <div class="xl:col-span-2">
            <label for="scanInput" class="text-sm text-gray-600 block">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
            <input id="scanInput" class="input w-full text-lg" placeholder="–ù–∞–≤–µ–¥–∏ —Å–∫–∞–Ω–µ—Ä –∏ —Å—á–∏—Ç–∞–π –®–ö (Enter)">
            <div class="text-xs text-gray-500 mt-1">
              Enter ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å, F2 ‚Äî —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º, +/‚àí ‚Äî ¬´–°–æ–±—Ä–∞–Ω–æ¬ª, Space ‚Äî ¬´–ù–µ—Ç¬ª.
              –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–µ–¥–ª–æ–∂–∏–º <b>—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</b>.
            </div>
          </div>
          <div>
            <label for="scanMode" class="text-sm text-gray-600 block">–î–µ–π—Å—Ç–≤–∏–µ</label>
            <select id="scanMode" class="input w-full">
              <option value="add">–ü—Ä–∏–Ω–∏–º–∞–µ–º (—É–≤–µ–ª–∏—á–∏—Ç—å ¬´–°–æ–±—Ä–∞–Ω–æ¬ª)</option>
              <option value="miss">–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ (–ø–æ–º–µ—Ç–∏—Ç—å ¬´–ù–µ—Ç¬ª)</option>
            </select>
            <div class="text-xs text-gray-500 mt-1">F2 ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</div>
          </div>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫–∏ -->
        <div class="mt-3 flex flex-wrap gap-3 text-sm">
          <div class="px-2 py-1 border rounded">–ü–ª–∞–Ω: <span id="ctPlan" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–°–æ–±—Ä–∞–Ω–æ: <span id="ctPicked" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">¬´–ù–µ—Ç¬ª: <span id="ctMissing" class="font-semibold">0</span></div>
          <div class="px-2 py-1 border rounded">–û—Å—Ç–∞–ª–æ—Å—å: <span id="ctLeft" class="font-semibold">0</span></div>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <div class="overflow-auto" style="max-height: calc(90vh - 260px);">
        <table class="w-full text-sm" id="scanTable">
          <thead class="text-gray-600 border-b sticky top-0 bg-white z-10">
            <tr>
              <th class="py-2 px-4 text-left">–®–ö</th>
              <th class="py-2 px-4 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="py-2 px-4 text-left">–Ø—á–µ–π–∫–∞</th>
              <th class="py-2 px-4 text-left">–ü–ª–∞–Ω</th>
              <th class="py-2 px-4 text-left">–°–æ–±—Ä–∞–Ω–æ</th>
              <th class="py-2 px-4 text-left">–ù–µ—Ç</th>
              <th class="py-2 px-4 text-left">–ü—Ä–∏–º.</th>
              <th class="py-2 px-4 text-left">–°—Ç–∞—Ç—É—Å</th>
            </tr>
          </thead>
          <tbody>
            {% for it in pick_items %}
            <tr data-bc="{{ it.barcode }}" class="state-none">
              <td class="py-2 px-4 font-mono">{{ it.barcode }}</td>
              <td class="py-2 px-4">{{ it.name }}</td>
              <td class="py-2 px-4">{{ it.location|default:"‚Äî" }}</td>
              <td class="py-2 px-4" data-plan>{{ it.qty }}</td>
              <td class="py-2 px-4">
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-ghost h-8 w-8" data-dec>-</button>
                  <input class="input h-8 w-20 text-right" type="number" min="0"
                         value="{{ it.picked_qty|default:0 }}" data-picked>
                  <button type="button" class="btn btn-ghost h-8 w-8" data-inc>+</button>
                </div>
              </td>
              <td class="py-2 px-4">
                <input type="checkbox" data-miss {% if it.missing %}checked{% endif %}>
              </td>
              <td class="py-2 px-4">
                <input type="text" class="input h-8 w-44" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                       data-note value="{{ it.note|default_if_none:'' }}">
              </td>
              <td class="py-2 px-4 whitespace-nowrap" data-status>‚Äî</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- –ü–æ–¥–≤–∞–ª -->
      <div class="px-6 py-3 border-t bg-white">
        <div class="text-xs text-gray-500 mb-3 flex flex-wrap gap-4">
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-gray-200"></span> ‚Äî –Ω–µ –Ω–∞—á–∞—Ç–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-yellow-200"></span> ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-green-200"></span> ‚Äî –≥–æ—Ç–æ–≤–æ</span>
          <span><span class="inline-block w-3 h-3 align-middle rounded bg-red-200"></span> ‚Äî –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</span>
        </div>
        <div class="flex gap-2">
          <button type="button" class="btn" id="saveDraft">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn btn-ghost" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    tr.state-none    { background: #f5f5f5; }
    tr.state-partial { background: #fef3c7; }
    tr.state-ok      { background: #dcfce7; }
    tr.state-miss    { background: #fee2e2; }
  </style>

  <script>
  (function(){
    const modal  = document.getElementById('scanModal');
    const open   = document.getElementById('openScanModal');
    const input  = document.getElementById('scanInput');
    const mode   = document.getElementById('scanMode');
    const tbody  = document.getElementById('scanTable').querySelector('tbody');
    const btnSave   = document.getElementById('saveDraft');

    const ctPlan    = document.getElementById('ctPlan');
    const ctPicked  = document.getElementById('ctPicked');
    const ctMissing = document.getElementById('ctMissing');
    const ctLeft    = document.getElementById('ctLeft');

    let dirty = false;
    let saving = false;
    let autoSaveTimer = null;
    const markDirty = () => { 
      dirty = true; 
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        if(dirty && !saving) {
          autoSave();
        }
      }, 2000);
    };

    const focusInput = () => setTimeout(()=>input && input.focus(), 20);

    function updateRowState(tr){
      const plan   = parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10);
      const picked = parseInt(tr.querySelector('[data-picked]').value||'0',10);
      const miss   = tr.querySelector('[data-miss]').checked;
      const st     = tr.querySelector('[data-status]');
      tr.classList.remove('state-none','state-partial','state-ok','state-miss');

      if(miss){ tr.classList.add('state-miss'); st.textContent = '–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'; return; }
      if(picked === 0){ tr.classList.add('state-none'); st.textContent = '–ù–µ –Ω–∞—á–∞—Ç–æ'; }
      else if(picked < plan){ tr.classList.add('state-partial'); st.textContent = `–ß–∞—Å—Ç–∏—á–Ω–æ (${picked}/${plan})`; }
      else{ tr.classList.add('state-ok'); st.textContent = `–ì–æ—Ç–æ–≤–æ (${picked}/${plan})`; }
    }

    function recalc(){
      const rows    = [...tbody.querySelectorAll('tr[data-bc]')];
      const plan    = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-plan]').textContent || 0), 0);
      const picked  = rows.reduce((s,tr)=> s + (+tr.querySelector('[data-picked]').value || 0), 0);
      const missing = rows.reduce((s,tr)=> s + (tr.querySelector('[data-miss]').checked ? 1 : 0), 0);
      if(ctPlan)   ctPlan.textContent   = plan;
      if(ctPicked) ctPicked.textContent = picked;
      if(ctMissing)ctMissing.textContent= missing;
      if(ctLeft)   ctLeft.textContent   = Math.max(0, plan - picked);
    }

    function initStates(){
      [...tbody.querySelectorAll('tr[data-bc]')].forEach(updateRowState);
      recalc();
    }

    const openM  = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); focusInput(); initStates(); dirty=false; };
    const closeM = () => { modal.classList.add('hidden');  modal.classList.remove('flex'); };

    open.addEventListener('click', openM);
    modal.addEventListener('click', e=>{
      if(e.target.closest('[data-close]')){
        if(dirty){
          if(confirm('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å?')){ save('save', true); return; }
        }
        closeM();
      }
    });

    document.addEventListener('keydown', e=>{
      if(modal.classList.contains('hidden')) return;
      if(e.key==='Escape'){ if(dirty && confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) save('save', true); else closeM(); }
      if(e.key==='F2'){ e.preventDefault(); mode.value = (mode.value==='add' ? 'miss' : 'add'); }
    });

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    input.addEventListener('keydown', e=>{
      if(e.key !== 'Enter') return;
      const bc = input.value.trim(); input.value = '';
      if(!bc) return;

      const tr = tbody.querySelector(`tr[data-bc="${CSS.escape(bc)}"]`);
      if(!tr){ alert('–®–ö –Ω–µ –≤ –ª–∏—Å—Ç–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤ –∑–∞—è–≤–∫—É'); return; }

      const picked = tr.querySelector('[data-picked]');
      const miss   = tr.querySelector('[data-miss]');

      if(mode.value==='miss'){ miss.checked = true; }
      else { picked.value = Math.max(0, parseInt(picked.value||'0',10)+1); }

      updateRowState(tr); recalc(); tr.scrollIntoView({block:'nearest'});
      markDirty();
    });

    // +/- –∏ —Ä—É—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    tbody.addEventListener('click', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.target.matches('[data-inc]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = (+inp.value || 0) + 1;
        updateRowState(tr); recalc(); markDirty();
      }
      if(e.target.matches('[data-dec]')){
        const inp = tr.querySelector('[data-picked]'); inp.value = Math.max(0, (+inp.value || 0) - 1);
        updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('input', e=>{
      if(e.target.matches('[data-picked], [data-miss], [data-note]')){
        const tr = e.target.closest('tr[data-bc]'); updateRowState(tr); recalc(); markDirty();
      }
    });
    tbody.addEventListener('keydown', e=>{
      const tr = e.target.closest('tr[data-bc]'); if(!tr) return;
      if(e.key==='+' || e.key==='='){ e.preventDefault(); tr.querySelector('[data-inc]').click(); }
      if(e.key==='-'){ e.preventDefault(); tr.querySelector('[data-dec]').click(); }
      if(e.key===' '){ e.preventDefault(); const m = tr.querySelector('[data-miss]'); m.checked = !m.checked; updateRowState(tr); recalc(); markDirty(); }
    });

    function collectLines(){
      return [...tbody.querySelectorAll('tr[data-bc]')].map(tr=>({
        barcode: tr.dataset.bc,
        picked_qty: parseInt(tr.querySelector('[data-picked]').value||'0',10),
        missing: tr.querySelector('[data-miss]').checked,
        note: tr.querySelector('[data-note]')?.value || '',
        planned_qty: parseInt(tr.querySelector('[data-plan]').textContent.trim()||'0',10),
      }));
    }

    async function save(commit='save', reloadAfter=true, showNotification=true){
      if(saving) return false;
      saving = true;
      
      if(showNotification && btnSave) {
        const originalText = btnSave.textContent;
        btnSave.disabled = true;
        btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      }

      const lines = collectLines();
      try {
        const resp = await fetch("{{ pick_confirm_url }}", {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':'{{ csrf_token }}'
          },
          body: JSON.stringify({ commit, lines })
        });
        if(!resp.ok){
          const t = await resp.text().catch(()=> '');
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. ' + t);
          if(showNotification && btnSave) {
            btnSave.disabled = false;
            btnSave.textContent = originalText;
          }
          saving = false;
          return false;
        }
        dirty = false;
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(() => {
            if(btnSave) btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          }, 2000);
        }
        if(reloadAfter){ closeM(); location.reload(); }
        saving = false;
        return true;
      } catch(error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        if(showNotification && btnSave) {
          btnSave.disabled = false;
          btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
        saving = false;
        return false;
      }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    async function autoSave(){
      await save('save', false, false);
    }

    btnSave.addEventListener('click', ()=> save('save', true, true));   // —Ç–æ–ª—å–∫–æ —á–µ—Ä–Ω–æ–≤–∏–∫
  })();
  </script>
{% endif %}





      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <section class="rq-card">
        <div class="rq-card__head">
          <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
          {% with history_all=obj.history.all %}
            {% if history_all|length > 3 %}
              <button type="button" id="toggleHistory" class="rq-history-toggle" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            {% endif %}
          {% endwith %}
        </div>
        {% if obj.history.all %}
          <ul class="rq-history" id="historyList">
            {% for h in obj.history.all %}
              <li class="history-item">
                <span class="rq-mono">{{ h.created_at|date:"d.m.Y H:i" }}</span>
                ‚Äî <b>{{ h.author }}</b>:
                <span class="rq-mono">{{ h.from_status|default:"‚Äî" }}</span>
                ‚Üí <span class="rq-mono">{{ h.to_status }}</span>
                <span class="muted">{{ h.note }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="rq-empty">–ü—É—Å—Ç–æ</div>
        {% endif %}
      </section>

    </div>

    <!-- ===== –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–î–µ–π—Å—Ç–≤–∏—è) ===== -->
    <aside class="rq-aside">
      {# –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π - —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤ –∏ —Å–∫–ª–∞–¥–∞ (–Ω–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤) #}
      {% if request.user|in_groups:"operator,director,warehouse" %}
      <section class="modern-actions-card rq-sticky">
        <div class="modern-actions-header">
          <div class="modern-actions-header__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 class="modern-actions-header__title">–î–µ–π—Å—Ç–≤–∏—è</h2>
        </div>

        <form method="post" action="{% url 'core:request_change_status' obj.pk %}" class="modern-actions-form" id="statusChangeForm">
          {% csrf_token %}

          {# –û–ü–ï–†–ê–¢–û–† –ò –î–ò–†–ï–ö–¢–û–† #}
          {% if request.user|in_groups:"operator,director" %}
            <div class="modern-actions-grid">
              {# –î–∏—Ä–µ–∫—Ç–æ—Ä –≤–∏–¥–∏—Ç –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã, –æ–ø–µ—Ä–∞—Ç–æ—Ä - —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ #}
              {% if request.user|in_groups:"director" and obj.status != "draft" %}
                <button type="submit" class="modern-action-btn modern-action-btn--primary" name="to" value="draft">
                  <span class="modern-action-btn__icon">üìù</span>
                  <span class="modern-action-btn__text">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                </button>
              {% endif %}
              
              {% if obj.status != "submitted" %}
                <button type="submit" class="modern-action-btn" name="to" value="submitted">
                  <span class="modern-action-btn__icon">üì§</span>
                  <span class="modern-action-btn__text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
              {% endif %}
              
              {% if obj.status != "quote" %}
                <button type="submit" class="modern-action-btn" name="to" value="quote">
                  <span class="modern-action-btn__icon">üìÑ</span>
                  <span class="modern-action-btn__text">–ö–ü</span>
                </button>
              {% endif %}
              
              {% if obj.status != "pending_approval" %}
                <button type="submit" class="modern-action-btn" name="to" value="pending_approval">
                  <span class="modern-action-btn__icon">‚è≥</span>
                  <span class="modern-action-btn__text">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>
                </button>
              {% endif %}
              
              {% if obj.status != "approved" %}
                <button type="submit" class="modern-action-btn modern-action-btn--success" name="to" value="approved">
                  <span class="modern-action-btn__icon">‚úì</span>
                  <span class="modern-action-btn__text">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>
                </button>
              {% endif %}
              
              {% if obj.status != "rejected" %}
                <button type="submit" class="modern-action-btn modern-action-btn--danger" name="to" value="rejected">
                  <span class="modern-action-btn__icon">‚úó</span>
                  <span class="modern-action-btn__text">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∏</span>
                </button>
              {% endif %}
              
              {% if obj.status != "to_pick" %}
                <button type="submit" class="modern-action-btn" name="to" value="to_pick">
                  <span class="modern-action-btn__icon">üì¶</span>
                  <span class="modern-action-btn__text">–ù–∞ —Å–±–æ—Ä–∫—É</span>
                </button>
              {% endif %}
              
              {# in_progress –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É #}
              {% if request.user|in_groups:"director" and obj.status != "in_progress" %}
                <button type="submit" class="modern-action-btn" name="to" value="in_progress">
                  <span class="modern-action-btn__icon">‚öôÔ∏è</span>
                  <span class="modern-action-btn__text">–í —Ä–∞–±–æ—Ç—É</span>
                </button>
              {% endif %}
              
              {% if obj.status != "ready_to_ship" %}
                <button type="submit" class="modern-action-btn" name="to" value="ready_to_ship">
                  <span class="modern-action-btn__icon">üöö</span>
                  <span class="modern-action-btn__text">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</span>
                </button>
              {% endif %}
              
              {% if obj.status != "partially_shipped" %}
                <button type="submit" class="modern-action-btn" name="to" value="partially_shipped">
                  <span class="modern-action-btn__icon">üì¶</span>
                  <span class="modern-action-btn__text">–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞</span>
                </button>
              {% endif %}
              
              {% if obj.status != "shipped" %}
                <button type="submit" class="modern-action-btn" name="to" value="shipped">
                  <span class="modern-action-btn__icon">‚úÖ</span>
                  <span class="modern-action-btn__text">–û—Ç–≥—Ä—É–∂–µ–Ω–∞</span>
                </button>
              {% endif %}
              
              {% if obj.status != "delivered" %}
                <button type="submit" class="modern-action-btn modern-action-btn--success" name="to" value="delivered">
                  <span class="modern-action-btn__icon">üè†</span>
                  <span class="modern-action-btn__text">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞</span>
                </button>
              {% endif %}
              
              {# done –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É #}
              {% if request.user|in_groups:"director" and obj.status != "done" %}
                <button type="submit" class="modern-action-btn modern-action-btn--primary" name="to" value="done">
                  <span class="modern-action-btn__icon">üéâ</span>
                  <span class="modern-action-btn__text">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
                </button>
              {% endif %}
              
              {% if obj.status != "canceled" %}
                <button type="submit" class="modern-action-btn modern-action-btn--danger modern-action-btn--ghost" name="to" value="canceled">
                  <span class="modern-action-btn__icon">üóëÔ∏è</span>
                  <span class="modern-action-btn__text">–û—Ç–º–µ–Ω–∏—Ç—å</span>
                </button>
              {% endif %}
            </div>
            
            {# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ #}
            {% if request.user|in_groups:"operator" %}
              {% if obj.status == "submitted" or obj.status == "rejected" %}
                <div class="modern-actions-divider"></div>
                <a href="{% url 'core:request_quote_create' obj.pk %}" class="modern-action-btn modern-action-btn--primary modern-action-btn--full">
                  <span class="modern-action-btn__icon">‚ûï</span>
                  <span class="modern-action-btn__text">{% if obj.status == "rejected" %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü{% else %}–°–æ–∑–¥–∞—Ç—å –ö–ü{% endif %}</span>
                </a>
              {% endif %}
              {% if obj.status == "ready_to_ship" or obj.status == "partially_shipped" %}
                <div class="modern-actions-divider"></div>
                <a href="{% url 'core:request_shipment_create' obj.pk %}" class="modern-action-btn modern-action-btn--primary modern-action-btn--full">
                  <span class="modern-action-btn__icon">‚ûï</span>
                  <span class="modern-action-btn__text">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</span>
                </a>
              {% endif %}
            {% endif %}
          {% endif %}

          {# –°–ö–õ–ê–î - —Ç–æ–ª—å–∫–æ "–í —Ä–∞–±–æ—Ç—É" –∏ "–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ" #}
          {% if request.user|in_groups:"warehouse" %}
            <div class="modern-actions-grid">
              {% if obj.status == "to_pick" %}
                <button type="submit" class="modern-action-btn modern-action-btn--primary modern-action-btn--full" name="to" value="in_progress">
                  <span class="modern-action-btn__icon">‚öôÔ∏è</span>
                  <span class="modern-action-btn__text">–í —Ä–∞–±–æ—Ç—É</span>
                </button>
              {% elif obj.status == "in_progress" %}
                <button type="submit" class="modern-action-btn modern-action-btn--success modern-action-btn--full" name="to" value="ready_to_ship">
                  <span class="modern-action-btn__icon">üöö</span>
                  <span class="modern-action-btn__text">–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ</span>
                </button>
              {% endif %}
            </div>
          {% endif %}
        </form>
      </section>
      {% endif %}

      {# –û–ü–õ–ê–¢–ê: —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä/–æ–ø–µ—Ä–∞—Ç–æ—Ä #}
      {% if request.user|in_groups:"director,operator" %}
        {% if obj.status != 'canceled' %}
        <section class="rq-card rq-sticky">
          <div class="rq-card__head">
            <h2>–û–ø–ª–∞—Ç–∞</h2>
            {% if obj.is_paid %}
              <span class="rq-chip" style="background:#dcfce7;border-color:#86efac;color:#166534">–û–ø–ª–∞—á–µ–Ω–æ</span>
            {% endif %}
          </div>
          <form method="post" action="{% url 'core:request_toggle_payment' obj.pk %}">
            {% csrf_token %}
            <label class="rq-pay" style="display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer">
              <input type="checkbox" name="is_paid" value="1" {% if obj.is_paid %}checked{% endif %} onchange="this.form.submit()" style="width:20px;height:20px;cursor:pointer">
              <span style="font-weight:600;font-size:15px">–ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞</span>
            </label>
            {% if obj.status == 'delivered' and not obj.is_paid %}
              <div style="padding:8px 14px;margin:0 14px 12px;background:#fef3c7;border:1px solid #fde68a;border-radius:8px;font-size:12px;color:#78350f">
                üí° –û—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—Ç—É, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É
              </div>
            {% elif obj.status == 'done' and not obj.is_paid %}
              <div style="padding:8px 14px;margin:0 14px 12px;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;font-size:12px;color:#7f1d1d">
                ‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞. –°–Ω–∏–º–∏—Ç–µ –æ—Ç–º–µ—Ç–∫—É, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤ —Å—Ç–∞—Ç—É—Å ¬´–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞¬ª
              </div>
            {% endif %}
          </form>
        </section>
        {% endif %}
      {% endif %}
    </aside>
  </div>
</div>

{# ===== –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ö–ü ===== #}
<div id="previewModal" class="fixed inset-0 bg-black/60 hidden z-50 items-center justify-center" style="display:none">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:92vw;max-width:800px;max-height:90vh;display:flex;flex-direction:column;position:relative">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <div id="previewTitle" style="font-size:16px;font-weight:700;color:var(--text)"></div>
      <button id="closePreview" type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:14px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <iframe id="previewFrame" src="" style="width:100%;flex:1;min-height:400px;border:none;border-radius:0 0 18px 18px"></iframe>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('previewModal');
  const closeBtn = document.getElementById('closePreview');
  const titleEl = document.getElementById('previewTitle');
  const frameEl = document.getElementById('previewFrame');
  
  document.querySelectorAll('.open-preview').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const name = this.dataset.name || '–§–∞–π–ª';
      if (titleEl) titleEl.textContent = name;
      if (frameEl) frameEl.src = url;
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    });
  });
  
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    if (frameEl) frameEl.src = '';
  }
  
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) closeModal();
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.style.display !== 'none') {
      closeModal();
    }
  });
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ #}
<script>
(function(){
  const toggleBtn = document.getElementById('toggleHistory');
  const historyList = document.getElementById('historyList');
  
  if (!toggleBtn || !historyList) return;
  
  const allItems = Array.from(historyList.querySelectorAll('.history-item'));
  const totalItems = allItems.length;
  const showItems = 3;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3
  if (totalItems > showItems) {
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        item.style.display = 'none';
      }
    });
  }
  
  let isExpanded = false;
  
  toggleBtn.addEventListener('click', function() {
    isExpanded = !isExpanded;
    
    allItems.forEach(function(item, index) {
      if (index < totalItems - showItems) {
        if (isExpanded) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      }
    });
    
    if (isExpanded) {
      toggleBtn.classList.add('expanded');
      toggleBtn.setAttribute('aria-label', '–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
    } else {
      toggleBtn.classList.remove('expanded');
      toggleBtn.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é');
    }
  });
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—É—Å–µ–ª—å—é —ç—Ç–∞–ø–æ–≤ #}
<script>
(function(){
  const container = document.getElementById('stepsContainer');
  const viewport = document.getElementById('stepsViewport');
  const prevBtn = document.getElementById('stepsPrev');
  const nextBtn = document.getElementById('stepsNext');
  
  if (!container || !viewport || !prevBtn || !nextBtn) return;
  
  const steps = Array.from(container.querySelectorAll('.modern-step-item'));
  let currentIndex = 0;
  
  // –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ç–∞–ø
  steps.forEach((step, index) => {
    if (step.getAttribute('data-status') === 'active') {
      currentIndex = index;
    }
  });
  
  function updateCarousel() {
    const totalSteps = steps.length;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let prevIndex = currentIndex - 1;
    let nextIndex = currentIndex + 1;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—Ü
    if (prevIndex < 0) prevIndex = null;
    if (nextIndex >= totalSteps) nextIndex = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
    steps.forEach((step, index) => {
      step.removeAttribute('data-position');
      
      if (index === currentIndex) {
        step.setAttribute('data-position', 'current');
      } else if (index === prevIndex) {
        step.setAttribute('data-position', 'prev');
      } else if (index === nextIndex) {
        step.setAttribute('data-position', 'next');
      } else {
        step.style.display = 'none';
        return;
      }
      
      step.style.display = 'flex';
    });
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    setTimeout(() => {
      const currentStep = steps[currentIndex];
      if (!currentStep) return;
      
      const stepWidth = currentStep.offsetWidth || 280;
      const viewportWidth = viewport.offsetWidth;
      const stepMargin = 16; // margin –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
      const offset = (viewportWidth / 2) - (stepWidth / 2) - (currentIndex * (stepWidth + stepMargin));
      
      container.style.transform = `translateX(${offset}px)`;
    }, 50);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === totalSteps - 1;
  }
  
  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });
  
  nextBtn.addEventListener('click', () => {
    if (currentIndex < steps.length - 1) {
      currentIndex++;
      updateCarousel();
    }
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
  setTimeout(() => {
    updateCarousel();
  }, 100);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateCarousel, 150);
  });
})();
</script>

{# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏–π #}
<script>
(function(){
  const statusForm = document.getElementById('statusChangeForm');
  if (!statusForm) return;
  
  const statusLabels = {
    'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
    'submitted': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',
    'quote': '–ö–ü',
    'pending_approval': '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏',
    'approved': '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞',
    'rejected': '–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞',
    'to_pick': '–ù–∞ —Å–±–æ—Ä–∫—É',
    'in_progress': '–í —Ä–∞–±–æ—Ç—É',
    'ready_to_ship': '–ì–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ',
    'partially_shipped': '–ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞',
    'shipped': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
    'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–∞',
    'done': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
    'canceled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
  };
  
  const dangerStatuses = ['canceled', 'rejected'];
  
  statusForm.addEventListener('submit', function(e) {
    const submitBtn = e.submitter;
    if (!submitBtn || submitBtn.type !== 'submit') return;
    
    const newStatus = submitBtn.value;
    const statusLabel = statusLabels[newStatus] || newStatus;
    
    // –î–ª—è –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (dangerStatuses.includes(newStatus)) {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "${statusLabel}"?`)) {
        e.preventDefault();
        return false;
      }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'wait';
    
    const originalText = submitBtn.querySelector('.modern-action-btn__text')?.textContent || submitBtn.textContent;
    if (submitBtn.querySelector('.modern-action-btn__text')) {
      submitBtn.querySelector('.modern-action-btn__text').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
    } else {
      submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
    }
    
    // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  });
})();
</script>

<style>
:root{ --bg:#f6f7f8; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --accent:#111; --radius:14px; }
.rq-container{max-width:1100px;margin:0 auto;padding:10px 0 28px;}
.rq-title{font-size:26px;font-weight:800;color:var(--text);}
.rq-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;}
.rq-header{margin-bottom:6px;}
.rq-meta{display:flex;flex-wrap:wrap;gap:8px 12px;color:var(--muted);margin-top:6px;align-items:center}

.rq-grid{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:16px;margin-top:10px;}
.rq-main{display:grid;gap:12px;}
.rq-aside{display:grid;gap:12px;}
.rq-sticky{position:sticky; top:12px}

.rq-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);}
.rq-card__head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
.rq-card__head h2{font-size:16px;font-weight:800}
.rq-card__body{padding:12px 14px}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ä—É—Å–µ–ª—å —ç—Ç–∞–ø–æ–≤ 2025 */
.modern-steps-card{
  background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.98) 100%);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(255,255,255,0.8);
  border-radius:24px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.9);
  position:relative;
  overflow:hidden;
}
.modern-steps-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:linear-gradient(90deg, #0A84FF 0%, #0077ED 50%, #0A84FF 100%);
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

.modern-steps-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
.modern-steps-header__icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-radius:12px;
  color:#fff;
  box-shadow:0 4px 12px rgba(10,132,255,0.25);
}
.modern-steps-header__title{
  font-size:18px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.02em;
}

.modern-steps-carousel{
  position:relative;
  display:flex;
  align-items:center;
  gap:16px;
}
.modern-steps-viewport{
  flex:1;
  overflow:hidden;
  position:relative;
}
.modern-steps-container{
  display:flex;
  transition:transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  will-change:transform;
}

.modern-step-item{
  flex:0 0 calc(33.333% - 16px);
  min-width:0;
  padding:20px;
  background:rgba(255,255,255,0.6);
  backdrop-filter:blur(10px);
  border:1.5px solid rgba(255,255,255,0.8);
  border-radius:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  transition:all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  position:relative;
  margin:0 8px;
  opacity:0.5;
  transform:scale(0.85);
}
.modern-step-item[data-position="prev"],
.modern-step-item[data-position="next"]{
  opacity:0.6;
  transform:scale(0.9);
}
.modern-step-item[data-position="current"]{
  opacity:1;
  transform:scale(1);
  background:rgba(255,255,255,0.95);
  border-color:rgba(10,132,255,0.3);
  box-shadow:0 12px 40px rgba(10,132,255,0.15), 0 4px 16px rgba(0,0,0,0.08);
  z-index:2;
}

.modern-step-item__circle{
  width:64px;
  height:64px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:20px;
  border:3px solid #e5e7eb;
  background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color:#9ca3af;
  transition:all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  position:relative;
  margin-bottom:16px;
}
.modern-step-item[data-status="completed"] .modern-step-item__circle{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-color:#0A84FF;
  color:#fff;
  box-shadow:0 6px 20px rgba(10,132,255,0.3);
}
.modern-step-item[data-status="active"] .modern-step-item__circle{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-color:#0A84FF;
  color:#fff;
  box-shadow:0 0 0 8px rgba(10,132,255,0.1), 0 8px 24px rgba(10,132,255,0.35);
  animation:stepPulse 2s ease-in-out infinite;
  transform:scale(1.1);
}
.modern-step-item--error .modern-step-item__circle{
  background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border-color:#ef4444;
  color:#fff;
  box-shadow:0 6px 20px rgba(239,68,68,0.3);
}
.modern-step-item__number{font-size:20px;font-weight:700}
.modern-step-item__icon{font-size:28px;line-height:1;font-weight:700}

.modern-step-item__content{
  width:100%;
}
.modern-step-item__title{
  font-size:15px;
  font-weight:700;
  color:var(--text);
  margin-bottom:8px;
  transition:color 0.3s;
  letter-spacing:-0.01em;
}
.modern-step-item[data-status="active"] .modern-step-item__title{
  color:var(--primary);
  font-size:16px;
}
.modern-step-item__meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
  font-weight:500;
}
.modern-step-item__author{
  font-size:11px;
  color:var(--muted);
  opacity:0.8;
}
.modern-step-item__badge{
  display:inline-block;
  font-size:10px;
  padding:4px 10px;
  border-radius:12px;
  margin-top:8px;
  font-weight:600;
}
.modern-step-item__badge--warning{
  background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color:#78350f;
}
.modern-step-item__badge--success{
  background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
  color:#166534;
}

.modern-steps-nav{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(10px);
  border:1.5px solid rgba(10,132,255,0.2);
  color:var(--primary);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  flex-shrink:0;
  position:relative;
  z-index:10;
}
.modern-steps-nav:hover{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  color:#fff;
  transform:scale(1.1);
  box-shadow:0 6px 20px rgba(10,132,255,0.35);
  border-color:transparent;
}
.modern-steps-nav:active{
  transform:scale(0.95);
}
.modern-steps-nav:disabled{
  opacity:0.3;
  cursor:not-allowed;
  transform:none;
}
.modern-steps-nav:disabled:hover{
  background:rgba(255,255,255,0.9);
  color:var(--primary);
  transform:none;
}

@keyframes stepPulse{
  0%,100%{
    box-shadow:0 0 0 8px rgba(10,132,255,0.1), 0 8px 24px rgba(10,132,255,0.35);
    transform:scale(1.1);
  }
  50%{
    box-shadow:0 0 0 12px rgba(10,132,255,0.08), 0 8px 28px rgba(10,132,255,0.4);
    transform:scale(1.12);
  }
}

@media (max-width: 768px){
  .modern-step-item{flex:0 0 calc(100% - 16px);padding:16px}
  .modern-step-item__circle{width:56px;height:56px;font-size:18px}
  .modern-step-item__title{font-size:14px}
  .modern-steps-nav{width:40px;height:40px}
}

/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π 2025 */
.modern-actions-card{
  background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.98) 100%);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(255,255,255,0.8);
  border-radius:24px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.9);
  position:relative;
  overflow:hidden;
}
.modern-actions-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:linear-gradient(90deg, #0A84FF 0%, #0077ED 50%, #0A84FF 100%);
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
}

.modern-actions-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
}
.modern-actions-header__icon{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  border-radius:12px;
  color:#fff;
  box-shadow:0 4px 12px rgba(10,132,255,0.25);
}
.modern-actions-header__title{
  font-size:18px;
  font-weight:700;
  color:var(--text);
  margin:0;
  letter-spacing:-0.02em;
}

.modern-actions-form{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.modern-actions-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
}
.modern-actions-divider{
  height:1px;
  background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.1) 50%, transparent 100%);
  margin:8px 0;
}

.modern-action-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 16px;
  border-radius:14px;
  border:1.5px solid rgba(10,132,255,0.2);
  background:rgba(255,255,255,0.8);
  backdrop-filter:blur(10px);
  color:var(--text);
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  position:relative;
  overflow:hidden;
  text-decoration:none;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}
.modern-action-btn::before{
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  border-radius:50%;
  background:rgba(10,132,255,0.1);
  transform:translate(-50%, -50%);
  transition:width 0.6s ease, height 0.6s ease;
}
.modern-action-btn:hover::before{
  width:300%;
  height:300%;
}
.modern-action-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(10,132,255,0.2);
  border-color:rgba(10,132,255,0.4);
  background:rgba(255,255,255,0.95);
}
.modern-action-btn:active{
  transform:translateY(0);
}
.modern-action-btn__icon{
  font-size:18px;
  line-height:1;
  position:relative;
  z-index:1;
}
.modern-action-btn__text{
  position:relative;
  z-index:1;
  letter-spacing:-0.01em;
}

.modern-action-btn--primary{
  background:linear-gradient(135deg, #0A84FF 0%, #0077ED 100%);
  color:#fff;
  border-color:transparent;
  box-shadow:0 4px 16px rgba(10,132,255,0.3);
}
.modern-action-btn--primary:hover{
  background:linear-gradient(135deg, #0077ED 0%, #0051A3 100%);
  box-shadow:0 6px 24px rgba(10,132,255,0.4);
  color:#fff;
}

.modern-action-btn--success{
  background:linear-gradient(135deg, #10b981 0%, #059669 100%);
  color:#fff;
  border-color:transparent;
  box-shadow:0 4px 16px rgba(16,185,129,0.3);
}
.modern-action-btn--success:hover{
  background:linear-gradient(135deg, #059669 0%, #047857 100%);
  box-shadow:0 6px 24px rgba(16,185,129,0.4);
  color:#fff;
}

.modern-action-btn--danger{
  background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color:#fff;
  border-color:transparent;
  box-shadow:0 4px 16px rgba(239,68,68,0.3);
}
.modern-action-btn--danger:hover{
  background:linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  box-shadow:0 6px 24px rgba(239,68,68,0.4);
  color:#fff;
}

.modern-action-btn--ghost{
  background:rgba(255,255,255,0.6);
  border-color:rgba(239,68,68,0.3);
  color:#ef4444;
}
.modern-action-btn--ghost:hover{
  background:rgba(239,68,68,0.1);
  border-color:rgba(239,68,68,0.5);
  color:#dc2626;
}

.modern-action-btn--full{
  grid-column:1 / -1;
}

@media (max-width: 640px){
  .modern-actions-grid{
    grid-template-columns:1fr;
  }
  .modern-action-btn{
    padding:14px 16px;
    font-size:15px;
  }
}

/* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
.rq-steps{display:flex;flex-wrap:wrap;gap:8px;margin:0;padding:0;list-style:none}
.rq-step{display:flex;align-items:center;gap:6px;padding:8px 12px;border:2px solid var(--line);border-radius:12px;background:#fff;font-weight:600;font-size:13px;color:var(--text);transition:all 0.2s;position:relative}
.rq-step__number{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--bg);color:var(--text);font-weight:700;font-size:12px;flex-shrink:0}
.rq-step.is-done{background:var(--primary);border-color:var(--primary);color:#fff}
.rq-step.is-done .rq-step__number{background:rgba(255,255,255,0.2);color:#fff}
.rq-step.is-current{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:scale(1.05)}
.rq-step.is-current .rq-step__number{background:rgba(255,255,255,0.3);color:#fff;font-weight:800}
.rq-step--rejected{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.rq-step--rejected .rq-step__number{background:#fecaca;color:#7f1d1d}

.btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:700;text-decoration:none}
.btn:hover{opacity:.92}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:#fff;color:#111;border-color:#111}
.btn-primary{background:#111;color:#fff;border-color:#111}
.btn-danger{background:#fff;color:#7f1d1d;border-color:#ef4444}
.btn-danger:hover{background:#fee2e2}

.rq-actions__col{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:8px;padding:10px 12px;}
.rq-aside .btn{width:100%;padding:7px 10px;border-radius:10px;font-weight:600;font-size:14px;line-height:1.1;}
.rq-aside .btn-ghost,.rq-aside .btn-danger,.rq-aside .btn-primary{padding:7px 10px;border-radius:10px;font-weight:600;}
.rq-aside .rq-card__head{padding:10px 12px;}

.rq-pay{display:flex;align-items:center;gap:8px;padding:12px 14px}
.rq-upload{display:flex;gap:8px;align-items:center}
.rq-upload__input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
.rq-upload__label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px dashed #111;border-radius:12px;background:#fff;color:#111;font-weight:700;cursor:pointer}

.rq-table{display:grid;border-top:1px solid var(--line)}
.rq-trow{display:grid;grid-template-columns:1fr 120px 1fr;gap:10px;padding:10px 14px;border-bottom:1px solid var(--line)}
.rq-trow--head{background:#fbfbfb;font-weight:700}
.ta-right{text-align:right}

.rq-file{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted var(--line)}
.rq-file:last-child{border-bottom:0}
.rq-file__meta{min-width:0}
.rq-file__actions{display:flex;gap:6px}
.rq-file__actions form{display:inline}

.rq-additem{display:grid;grid-template-columns:1fr 120px 1fr auto;gap:8px;align-items:center}
.rq-additem__field input,.rq-additem__qty input,.rq-additem__note input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

.rq-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--line);background:#fff;color:#111}
.rq-chip--paid{border-style:dashed}
.rq-chip--done{background:#111;border-color:#111;color:#fff}
.rq-chip--flag-danger{background:#fff;border:1px dashed #ef4444;color:#7f1d1d}

.rq-empty{display:grid;place-items:center;gap:10px;padding:26px;border:1px dashed var(--line);border-radius:12px;color:#757b82;background:#fff}

.rq-history{padding:12px 14px}
.rq-history li{padding:6px 0;border-bottom:1px dotted var(--line)}
.rq-history li:last-child{border-bottom:0}
.history-item-hidden{display:none}
.rq-history-toggle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;padding:0}
.rq-history-toggle:hover{background:var(--bg);border-color:var(--primary);color:var(--primary)}
.rq-history-toggle:active{transform:scale(0.95)}
.rq-history-toggle.expanded{transform:rotate(180deg)}
.rq-history-toggle svg{transition:transform 0.2s}

@media (max-width: 980px){
  .rq-grid{grid-template-columns:1fr}
  .rq-sticky{position:static}
  .rq-additem{grid-template-columns:1fr 120px 1fr auto}
  .rq-actions__col{grid-template-columns:1fr;}
  .rq-header{flex-direction:column;align-items:flex-start;gap:12px}
  .rq-file{flex-direction:column;align-items:flex-start;gap:8px}
  .rq-file__actions{width:100%;flex-wrap:wrap}
}
@media (max-width: 640px){
  .rq-title{font-size:20px}
  .rq-meta{flex-direction:column;align-items:flex-start;gap:6px}
  .modern-step{flex-direction:row;gap:12px}
  .modern-step__circle{width:40px;height:40px;font-size:14px}
  .modern-step__connector{height:24px}
  .modern-step__title{font-size:14px}
  .modern-step__date,.modern-step__author{font-size:11px}
  .rq-steps{overflow-x:auto;flex-wrap:nowrap;padding-bottom:4px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .rq-steps::-webkit-scrollbar{display:none}
  .rq-step{flex-shrink:0;font-size:12px;padding:5px 10px}
  .rq-additem{grid-template-columns:1fr 1fr;gap:8px}
  .rq-additem__note{grid-column:1 / -1}
  .rq-trow{grid-template-columns:1fr 90px 1fr;gap:8px;padding:8px 12px}
  .rq-file__actions{flex-direction:column;width:100%}
  .rq-file__actions .btn{width:100%;justify-content:center}
  .rq-card__head{flex-wrap:wrap;gap:12px}
  #previewModal > div{width:98vw;max-width:98vw;height:95vh;max-height:95vh;margin:2.5vh auto}
}
</style>
{% endblock %}
