# План переработки системы заявок

## Текущий статус ✅

### Выполнено:
1. ✅ Обновлены статусы заявки (добавлены pending_approval, partially_shipped, shipped)
2. ✅ Создана модель RequestQuoteItem для товаров в КП с ценами
3. ✅ Создана модель RequestShipment для отслеживания отгрузок
4. ✅ Создана модель RequestShipmentItem для позиций отгрузки
5. ✅ Добавлены методы в Request для работы с КП и отгрузками
6. ✅ Создана миграция 0040_add_quote_items_and_shipments

## Логика работы заявки

### Жизненный цикл:
1. **Черновик** (DRAFT) - менеджер создает заявку с товарами
2. **Отправлена** (SUBMITTED) - менеджер отправляет заявку
3. **КП** (QUOTE) - оператор создает коммерческое предложение с ценами
4. **На согласовании** (PENDING_APPROVAL) - оператор отправляет КП на согласование
5. **Согласована** (APPROVED) - менеджер/директор согласовывает
6. **Передана на сборку** (TO_PICK) - оператор передает на склад (товары попадают в форму сборки)
7. **Собирается** (IN_PROGRESS) - склад начинает сборку
8. **Готова к отгрузке** (READY_TO_SHIP) - склад завершил сборку
9. **Частично отгружена** (PARTIALLY_SHIPPED) - частичная отгрузка
10. **Отгружена** (SHIPPED) - полная отгрузка
11. **Доставлена** (DELIVERED) - заказ доставлен
12. **Завершена** (DONE) - заявка закрыта

### Права доступа:

#### Менеджер:
- Видит заявки контрагентов, к которым прикреплен
- Видит свои собственные заявки
- Может создавать, редактировать (до отправки)
- Может согласовывать/отклонять заявки

#### Оператор и директор:
- Полные права на все заявки
- Могут создавать КП с ценами
- Могут менять статусы (кроме складских)
- Могут добавлять товары в любой момент (кроме завершенных/отмененных)

#### Склад:
- Видит заявки со статусами: TO_PICK, IN_PROGRESS, READY_TO_SHIP
- Может менять статусы: IN_PROGRESS (начало сборки), READY_TO_SHIP (завершение)

## Следующие шаги:

### 1. Обновить права доступа в views_requests.py
- [ ] Переработать request_list() - фильтрация для менеджеров
- [ ] Обновить request_detail() - проверка прав
- [ ] Обновить request_change_status() - разрешенные переходы

### 2. Создать формы для КП
- [ ] RequestQuoteItemForm для редактирования цен
- [ ] RequestQuoteItemFormSet для множественного редактирования

### 3. Создать интерфейс оператора (КП)
- [ ] Страница создания/редактирования КП
- [ ] Форма заполнения цен для товаров
- [ ] Кнопка "Отправить на согласование"

### 4. Обновить логику статусов
- [ ] Автоматический переход QUOTE -> PENDING_APPROVAL при отправке КП
- [ ] Автоматическое создание PickItem при переходе APPROVED -> TO_PICK
- [ ] Логика частичной отгрузки

### 5. Создать современный интерфейс
- [ ] Пошаговая обработка заявки
- [ ] Визуализация этапов
- [ ] Адаптивный дизайн

### 6. Отгрузка
- [ ] Форма создания отгрузки
- [ ] Выбор товаров для отгрузки
- [ ] Обновление статуса при частичной/полной отгрузке

### 7. Дополнительные функции
- [ ] Возможность добавления товаров оператором/директором
- [ ] Маршрутный лист с данными доставки
- [ ] УПД с данными доставки

